让我们将网络安全组应用到我们的网络, 以便我们只允许通过我们的服务器进行 HTTP 通信。

## <a name="create-a-network-security-group"></a>创建网络安全组

Azure 应为我们创建了一个安全组, 因为我们指出我们需要 SSH 访问。 但让我们创建一个新的安全组, 以便您可以完成整个过程。 如果决定在 vm_之前_创建虚拟网络, 这一点尤其重要。 如前面所述, 安全组是_可选_的, 并且不一定是通过网络创建的。

1. 在[Azure 门户](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true)中, 单击左角边栏中的 "**创建资源**" 按钮以启动新的资源创建。

1. 在 "筛选器" 框中键入**网络安全组**, 然后选择列表中的匹配项。

1. 确保选择了 "**资源管理器**" 部署模型, 然后单击 "**创建**"。

1. 为安全组提供**名称**。 同样, 在这里, 命名约定是一个好主意。 我们来使用**eus-nsg1**为**测试 web 网络安全组 #1 美国东部**。 您可能需要更改名称的位置部分, 以反映放置安全组的位置。

1. 选择正确的**订阅**并使用现有的**资源组**。

1. 最后, 将其置于 VM/虚拟网络所在的**位置**。 这一点很重要;如果此资源位于不同的位置, 则不能应用该资源。

1. 单击 "**创建**" 以创建组。

## <a name="add-a-new-inbound-rule-to-our-network-security-group"></a>将新的入站规则添加到我们的网络安全组

部署应很快完成。 完成后, 我们可以将新规则添加到安全组:

1. 查找新的安全组资源并在 Azure 门户中选择它。

1. 在 "概述" 页上, 您会发现它有一些创建的用于锁定网络的默认规则。

    在入站端:

    - 允许从一个 VNet 到另一个 VNet 的所有传入流量。 这样, VNet 中的资源可以相互对话。
    - Azure 负载平衡器**探测**请求, 以确保 VM 处于活动状态。
    - 其他所有入站流量将被拒绝。

    在出站端:
    - VNet 中的所有网络通信都是允许的。
    - 允许到 internet 的所有出站流量。
    - 其他所有出站通信都将被拒绝。

    > [!NOTE]
    > 这些默认规则是使用高优先级值设置的, 这意味着它们_最后_得到评估。 不能更改或删除它们, 但可以通过创建更具体的规则来将您的流量与优先级较低的值相匹配来_覆盖_它们。

1. 在安全组的 "**设置**" 面板中, 单击 "**入站安全规则**" 部分。

1. 单击 " **+ 添加**" 以添加新的安全规则。

    ![显示入站安全规则设置的 Azure 门户屏幕截图, 其中突出显示了 "添加" 按钮。](../media/8-add-rule.png)

    有两种方法可输入安全规则所需的信息: 基本和高级。 您可以通过单击 "**添加**" 面板顶部的按钮在它们之间进行切换。

    ![Azure 门户的一对显示基本和高级规则输入之间切换的屏幕截图, 其中突出显示了切换按钮的两种状态之间的箭头链接。](../media/8-advanced-create-rule.png)

    高级模式提供了完全自定义规则的功能。 但是, 如果您需要配置已知协议, 则使用基本模式要容易得多。

1. 切换到基本模式。

1. 添加有关我们的 HTTP 规则的信息:

    - 将**服务**设置为 HTTP。 这将为你设置你的端口范围。
    - 将**优先级**设置为**1000**。 它的数目必须低于默认**拒绝**规则。 您可以在任何值上启动范围, 但建议您为自己提供一些空间, 以防以后需要创建异常。
    - 为规则命名;我们将使用**允许 http 流量**。
    - 为规则提供说明。

1. 切换回**高级**模式。 请注意, 我们的设置仍存在。 我们可以使用此面板创建更精细的设置。 特别是, 我们可能会将**源**限制为特定于相机的特定 ip 地址或 ip 地址范围。 如果您知道本地计算机的当前 IP 地址, 则可以尝试。 否则, 将设置保留为 "**任意**", 以便可以测试该规则。

1. 单击 "**添加**" 以创建规则。 这将更新入站规则列表-请注意, 它们按优先级顺序排列, 就像检查它们的方式一样。

## <a name="apply-the-security-group"></a>应用安全组

回想一下, 我们可以将安全组应用到网络接口, 以保护单个 VM 或将其应用于该子网上的任何资源的子网。 后一种方法往往是最常见的方法, 因此我们来执行此操作。 我们可以通过虚拟网络资源或通过使用虚拟网络的 VM 间接访问 Azure 中的此资源。

1. 切换到虚拟机的**概述**面板。 你可以在 "**所有资源**" 下找到 VM。

1. 选择 "**设置**" 部分中的 "**网络**" 项。

1. 在网络属性中, 您将找到有关应用到 VM 的网络的信息, 包括**虚拟网络/子网**。 这是一个可单击的链接, 可用于访问资源。 单击它以打开虚拟网络。 此外, VM 的**概述**面板中_也_提供了此链接。 这两种方法都将打开虚拟网络的**概述**。

1. 在 "**设置**" 部分中, 选择 "**子网**" 项。

1. 在前面创建 VM + 网络时, 应定义单个子网 (默认)。 单击列表中的项目以打开详细信息。

1. 单击 "**网络安全组**" 条目。

1. 选择您的新安全组: **test-web-eus-nsg1**。 在这里, 还应存在另一个与 VM 一起创建的组。

1. 单击 "**保存**" 以保存更改。 将需要一分钟才能应用到网络。

## <a name="update-the-nsg-on-the-network-interface"></a>在网络接口上更新 NSG

端口80在应用于子网的 NSG 上是打开的, 但仍将被阻止, 因为它在应用于网络接口的 NSG 上当前不允许。 我们来修复此问题, 然后我们应该能够进行连接。

1. 切换回虚拟机的**概述**面板。 你可以在 "**所有资源**" 下找到 VM。

1. 在 "**设置**" 部分中, 选择 "**网络**" 项目。

1. 在 "**入站端口规则**" 部分, 您应该会看到子网的 NSG 规则, 然后是该子网正下方的网络接口的 NSG 规则。 在网络接口的 NSG 规则中, 选择 "**添加入站端口规则**"。

1. 切换到基本模式。

1. 添加有关我们的 HTTP 规则的信息:

    - 将**服务**设置为 HTTP。 这将为你设置你的端口范围。
    - 将**优先级**设置为**310**。
    - 为规则命名;我们将使用**允许 http 流量**。
    - 为规则提供说明。

1. 单击 "**添加**" 以创建规则。

## <a name="verify-the-rules"></a>验证规则

让我们验证更改:

1. 切换回虚拟机的**概述**面板。 你可以在 "**所有资源**" 下找到 VM。

1. 选择 "**设置**" 部分中的 "**网络**" 项。

1. 在网络接口的详细信息中, 有一个用于**有效安全规则**的链接, 可快速向您显示规则的评估方式。 单击该链接打开分析并确保您可以看到新的规则。

    ![显示为我们的网络提供有效安全规则的 Azure 门户的屏幕截图。](../media/8-effective-rules.png)

1. 当然, 验证其全部工作的最佳方式是通过 HTTP 请求访问我们的服务器。 它现在应该能够正常工作。

    ![显示在新 Linux 虚拟机的 IP 上托管的 Apache 默认网页的 web 浏览器的屏幕截图。](../media/6-apache-works.png)

## <a name="one-more-thing"></a>另一件事

安全规则的获取权限非常困难。 我们在应用此新安全组时出错了, 我们丢失了 SSH 访问! 若要解决此问题, 可以将另一条规则添加到应用到子网的安全组, 以允许 SSH 访问。 请务必将规则的入站 tcp/ip 地址限制为您拥有的。

> [!WARNING]
> 始终确保锁定用于管理访问的端口。 更好的方法是创建 VPN 以将虚拟网络链接到专用网络, 并只允许来自该地址范围的 RDP 或 SSH 请求。 您还可以将 SSH 使用的端口更改为除默认值之外的其他内容。 请注意, 更改端口不足以停止攻击。 它只是让它变得更难发现。