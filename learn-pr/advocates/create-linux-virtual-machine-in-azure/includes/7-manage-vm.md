对服务器配置进行调整通常是在本地环境中使用设备执行的。 在这种意义上, 可以将 Azure 虚拟机视为该环境的扩展。 您可以通过 azure 门户、azure CLI 或 azure PowerShell 工具更改配置、管理网络、打开或阻止流量。

我们的服务器已运行, 并且已安装 Apache 并提供页面。 我们的安全团队规定我们锁定所有服务器, 但我们尚未对此 VM 执行任何操作。 我们没有执行任何操作, 它允许 Apache 侦听端口80。 让我们浏览 Azure 网络配置, 了解如何使用内置安全支持来强化我们的服务器。

## <a name="opening-ports-in-azure-vms"></a>在 Azure 虚拟机中打开端口

默认情况下, 新的 vm 将被锁定。 

应用可以发出传出请求, 但仅允许来自虚拟网络 (例如, 在同一本地网络上的其他资源) 和 Azure 负载平衡器 (探测器检查) 的入站流量。

可通过两个步骤来调整配置, 以支持网络上的不同协议。 当您创建新的 VM 时, 您有机会打开几个常用端口 (RDP、HTTP、HTTPS 和 SSH)。 但是, 如果需要对防火墙进行其他更改, 则需要手动进行调整。

此过程的过程包括两个步骤:

1. 创建网络安全组。
2. 创建允许在所需端口上进行通信的入站规则。

### <a name="what-is-a-network-security-group"></a>什么是网络安全组？

虚拟网络 (vnet) 是 Azure 网络模型的基础, 提供隔离和保护。 网络安全组 (NSGs) 是用于在网络级别强制和控制网络流量规则的主要工具。 NSGs 是一个可选的安全层, 它通过筛选 VNet 中的入站和出站流量来提供软件防火墙。 

安全组可以与网络接口 (针对每个主机规则)、虚拟网络中的子网 (应用于多个资源) 或这两个级别相关联。 

#### <a name="security-group-rules"></a>安全组规则

NGSs 使用_规则_来允许或拒绝在网络中移动的流量。 每个规则标识源地址和目标地址 (或范围)、协议、端口 (或范围)、方向 (入站或出站)、数字优先级以及是否允许或拒绝匹配该规则的流量。

![该图显示了两个不同子网中的网络安全组的体系结构。 在一个子网中, 有两台虚拟机, 每台虚拟机都有自己的网络接口规则。  子网本身具有一组适用于虚拟机的规则。 ](../media/7-nsg-rules.png)

每个安全组都有一组默认的安全规则, 以应用上面所述的默认网络规则。 这些默认规则不能修改, 但_可以_重写。

#### <a name="how-azure-uses-network-rules"></a>Azure 如何使用网络规则

对于入站流量, Azure 将处理与子网关联的安全组, 然后处理应用于网络接口的安全组。 以相反顺序处理出站通信 (首先是网络接口, 然后是子网)。

> [!WARNING]  
> 请记住, 安全组在这两个级别都是可选的。 如果未应用安全组, 则 Azure**允许所有流量**。 如果 VM 具有公用 IP, 这可能是一个严重风险, 尤其是在操作系统不提供内置防火墙的情况下。

规则按_优先级顺序_计算, 从**最低优先级**规则开始。 拒绝规则总是**停止**求值。 例如, 如果网络接口规则阻止出站请求, 则任何应用于该子网的规则都不会进行检查。 若要通过安全组允许流量, 则必须通过_所有_已应用的组进行传递。

最后一个规则始终是 "**全部拒绝**" 规则。 这是添加到优先级为65500的入站和出站通信的每个安全组的默认规则。 这意味着流量通过安全组,_您必须具有允许规则_, 否则最终的默认规则将阻止它。

> [!NOTE]  
> SMTP (端口 25) 是一种特殊情况。 根据你的订阅级别和创建帐户的时间, 可能会阻止出站 SMTP 流量。 您可以请求删除此限制和业务理由。

由于我们没有为此 VM 创建安全组, 因此, 请执行此操作并应用它。

## <a name="creating-network-security-groups"></a>创建网络安全组

安全组是托管资源, 如 Azure 中的大多数内容。您可以在 Azure 门户中或通过命令行脚本工具创建它们。 困难在于定义规则。 让我们来看一下如何定义一个新规则以允许 HTTP 访问并阻止其他所有内容。