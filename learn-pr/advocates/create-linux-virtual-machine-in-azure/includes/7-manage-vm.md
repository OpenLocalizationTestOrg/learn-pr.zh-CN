<span data-ttu-id="fd6e0-101">对服务器配置进行调整通常是在本地环境中使用设备执行的。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-101">Making adjustments to server configuration is commonly performed with equipment in your on-premises environment.</span></span> <span data-ttu-id="fd6e0-102">在这种意义上, 可以将 Azure 虚拟机视为该环境的扩展。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-102">In this sense, you can consider Azure VMs to be an extension of that environment.</span></span> <span data-ttu-id="fd6e0-103">您可以通过 azure 门户、azure CLI 或 azure PowerShell 工具更改配置、管理网络、打开或阻止流量。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-103">You can alter configuration, manage networks, open or block traffic, and more through the Azure portal, the Azure CLI, or Azure PowerShell tools.</span></span>

<span data-ttu-id="fd6e0-104">我们的服务器已运行, 并且已安装 Apache 并提供页面。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-104">We've got our server running, and Apache is installed and serving up pages.</span></span> <span data-ttu-id="fd6e0-105">我们的安全团队规定我们锁定所有服务器, 但我们尚未对此 VM 执行任何操作。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-105">Our security team mandates that we lock down all our servers, and we've not done anything to this VM yet.</span></span> <span data-ttu-id="fd6e0-106">我们没有执行任何操作, 它允许 Apache 侦听端口80。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-106">We didn't do anything, and it let Apache listen on port 80.</span></span> <span data-ttu-id="fd6e0-107">让我们浏览 Azure 网络配置, 了解如何使用内置安全支持来强化我们的服务器。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-107">Let's explore the Azure network configuration to see how to use the built-in security support to harden our server.</span></span>

## <a name="opening-ports-in-azure-vms"></a><span data-ttu-id="fd6e0-108">在 Azure 虚拟机中打开端口</span><span class="sxs-lookup"><span data-stu-id="fd6e0-108">Opening ports in Azure VMs</span></span>

<span data-ttu-id="fd6e0-109">默认情况下, 新的 vm 将被锁定。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-109">By default, new VMs are locked down.</span></span> 

<span data-ttu-id="fd6e0-110">应用可以发出传出请求, 但仅允许来自虚拟网络 (例如, 在同一本地网络上的其他资源) 和 Azure 负载平衡器 (探测器检查) 的入站流量。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-110">Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g., other resources on the same local network) and from Azure Load Balancer (probe checks).</span></span>

<span data-ttu-id="fd6e0-111">可通过两个步骤来调整配置, 以支持网络上的不同协议。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-111">There are two steps to adjusting the configuration to support different protocols on the network.</span></span> <span data-ttu-id="fd6e0-112">当您创建新的 VM 时, 您有机会打开几个常用端口 (RDP、HTTP、HTTPS 和 SSH)。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-112">When you create a new VM, you have an opportunity to open a few common ports (RDP, HTTP, HTTPS, and SSH).</span></span> <span data-ttu-id="fd6e0-113">但是, 如果需要对防火墙进行其他更改, 则需要手动进行调整。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-113">However, if you require other changes to the firewall, you will need to adjust them manually.</span></span>

<span data-ttu-id="fd6e0-114">此过程的过程包括两个步骤:</span><span class="sxs-lookup"><span data-stu-id="fd6e0-114">The process for this involves two steps:</span></span>

1. <span data-ttu-id="fd6e0-115">创建网络安全组。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-115">Create a network security group.</span></span>
2. <span data-ttu-id="fd6e0-116">创建允许在所需端口上进行通信的入站规则。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-116">Create an inbound rule allowing traffic on the ports you need.</span></span>

### <a name="what-is-a-network-security-group"></a><span data-ttu-id="fd6e0-117">什么是网络安全组？</span><span class="sxs-lookup"><span data-stu-id="fd6e0-117">What is a network security group?</span></span>

<span data-ttu-id="fd6e0-118">虚拟网络 (vnet) 是 Azure 网络模型的基础, 提供隔离和保护。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-118">Virtual networks (VNets) are the foundation of the Azure networking model and provide isolation and protection.</span></span> <span data-ttu-id="fd6e0-119">网络安全组 (NSGs) 是用于在网络级别强制和控制网络流量规则的主要工具。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-119">Network security groups (NSGs) are the primary tool you use to enforce and control network traffic rules at the networking level.</span></span> <span data-ttu-id="fd6e0-120">NSGs 是一个可选的安全层, 它通过筛选 VNet 中的入站和出站流量来提供软件防火墙。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-120">NSGs are an optional security layer that provides a software firewall by filtering inbound and outbound traffic on the VNet.</span></span> 

<span data-ttu-id="fd6e0-121">安全组可以与网络接口 (针对每个主机规则)、虚拟网络中的子网 (应用于多个资源) 或这两个级别相关联。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-121">Security groups can be associated to a network interface (for per host rules), a subnet in the virtual network (to apply to multiple resources), or both levels.</span></span> 

#### <a name="security-group-rules"></a><span data-ttu-id="fd6e0-122">安全组规则</span><span class="sxs-lookup"><span data-stu-id="fd6e0-122">Security group rules</span></span>

<span data-ttu-id="fd6e0-123">NGSs 使用_规则_来允许或拒绝在网络中移动的流量。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-123">NGSs use _rules_ to allow or deny traffic moving through the network.</span></span> <span data-ttu-id="fd6e0-124">每个规则标识源地址和目标地址 (或范围)、协议、端口 (或范围)、方向 (入站或出站)、数字优先级以及是否允许或拒绝匹配该规则的流量。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-124">Each rule identifies the source and destination address (or range), protocol, port (or range), direction (inbound or outbound), a numeric priority, and whether to allow or deny the traffic that matches the rule.</span></span>

![<span data-ttu-id="fd6e0-125">该图显示了两个不同子网中的网络安全组的体系结构。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-125">An illustration showing the architecture of network security groups in two different subnets.</span></span> <span data-ttu-id="fd6e0-126">在一个子网中, 有两台虚拟机, 每台虚拟机都有自己的网络接口规则。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-126">In one subnet, there are two virtual machines, each with their own network interface rules.</span></span>  <span data-ttu-id="fd6e0-127">子网本身具有一组适用于虚拟机的规则。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-127">The subnet itself has a set of rules that applies to both the virtual machines.</span></span> ](../media/7-nsg-rules.png)

<span data-ttu-id="fd6e0-128">每个安全组都有一组默认的安全规则, 以应用上面所述的默认网络规则。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-128">Each security group has a set of default security rules to apply the default network rules described above.</span></span> <span data-ttu-id="fd6e0-129">这些默认规则不能修改, 但_可以_重写。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-129">These default rules cannot be modified but _can_ be overridden.</span></span>

#### <a name="how-azure-uses-network-rules"></a><span data-ttu-id="fd6e0-130">Azure 如何使用网络规则</span><span class="sxs-lookup"><span data-stu-id="fd6e0-130">How Azure uses network rules</span></span>

<span data-ttu-id="fd6e0-131">对于入站流量, Azure 将处理与子网关联的安全组, 然后处理应用于网络接口的安全组。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-131">For inbound traffic, Azure processes the security group associated to the subnet and then the security group applied to the network interface.</span></span> <span data-ttu-id="fd6e0-132">以相反顺序处理出站通信 (首先是网络接口, 然后是子网)。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-132">Outbound traffic is handled in the opposite order (the network interface first, followed by the subnet).</span></span>

> [!WARNING]  
> <span data-ttu-id="fd6e0-133">请记住, 安全组在这两个级别都是可选的。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-133">Keep in mind that security groups are optional at both levels.</span></span> <span data-ttu-id="fd6e0-134">如果未应用安全组, 则 Azure**允许所有流量**。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-134">If no security group is applied, then **all traffic is allowed** by Azure.</span></span> <span data-ttu-id="fd6e0-135">如果 VM 具有公用 IP, 这可能是一个严重风险, 尤其是在操作系统不提供内置防火墙的情况下。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-135">If the VM has a public IP, this could be a serious risk, particularly if the OS doesn't provide a built-in firewall.</span></span>

<span data-ttu-id="fd6e0-136">规则按_优先级顺序_计算, 从**最低优先级**规则开始。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-136">The rules are evaluated in _priority order_, starting with the **lowest priority** rule.</span></span> <span data-ttu-id="fd6e0-137">拒绝规则总是**停止**求值。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-137">Deny rules always **stop** the evaluation.</span></span> <span data-ttu-id="fd6e0-138">例如, 如果网络接口规则阻止出站请求, 则任何应用于该子网的规则都不会进行检查。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-138">For example, if a network interface rule blocks an outbound request, any rules applied to the subnet will not be checked.</span></span> <span data-ttu-id="fd6e0-139">若要通过安全组允许流量, 则必须通过_所有_已应用的组进行传递。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-139">For traffic to be allowed through the security group, it must pass through _all_ applied groups.</span></span>

<span data-ttu-id="fd6e0-140">最后一个规则始终是 "**全部拒绝**" 规则。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-140">The last rule is always a **Deny All** rule.</span></span> <span data-ttu-id="fd6e0-141">这是添加到优先级为65500的入站和出站通信的每个安全组的默认规则。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-141">This is a default rule added to every security group for both inbound and outbound traffic with a priority of 65500.</span></span> <span data-ttu-id="fd6e0-142">这意味着流量通过安全组,_您必须具有允许规则_, 否则最终的默认规则将阻止它。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-142">That means to have traffic pass through the security group, _you must have an allow rule_, or the final default rule will block it.</span></span>

> [!NOTE]  
> <span data-ttu-id="fd6e0-143">SMTP (端口 25) 是一种特殊情况。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-143">SMTP (port 25) is a special case.</span></span> <span data-ttu-id="fd6e0-144">根据你的订阅级别和创建帐户的时间, 可能会阻止出站 SMTP 流量。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-144">Depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked.</span></span> <span data-ttu-id="fd6e0-145">您可以请求删除此限制和业务理由。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-145">You can request to remove this restriction with business justification.</span></span>

<span data-ttu-id="fd6e0-146">由于我们没有为此 VM 创建安全组, 因此, 请执行此操作并应用它。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-146">Since we didn't create a security group for this VM, let's do that and apply it.</span></span>

## <a name="creating-network-security-groups"></a><span data-ttu-id="fd6e0-147">创建网络安全组</span><span class="sxs-lookup"><span data-stu-id="fd6e0-147">Creating network security groups</span></span>

<span data-ttu-id="fd6e0-148">安全组是托管资源, 如 Azure 中的大多数内容。您可以在 Azure 门户中或通过命令行脚本工具创建它们。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-148">Security groups are managed resources like most everything in Azure; you can create them in the Azure portal or through command-line scripting tools.</span></span> <span data-ttu-id="fd6e0-149">困难在于定义规则。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-149">The challenge is in defining the rules.</span></span> <span data-ttu-id="fd6e0-150">让我们来看一下如何定义一个新规则以允许 HTTP 访问并阻止其他所有内容。</span><span class="sxs-lookup"><span data-stu-id="fd6e0-150">Let's look at defining a new rule to allow HTTP access and block everything else.</span></span>