我们有一个在本地 Ubuntu Linux 服务器上运行的现有网站。 我们的目标是使用最新的 Ubuntu 图像创建 Azure 虚拟机 (VM), 然后将该网站迁移到云。 在此单元中, 你将了解在 Azure 中创建虚拟机时需要评估的选项。

## <a name="introduction-to-azure-virtual-machines"></a>Azure 虚拟机简介

Azure 虚拟机是一个按需的可扩展云计算资源。 其中包括处理器、内存、存储和网络资源。 你可以随时启动和停止虚拟机, 也可以从 azure 门户或 azure CLI 进行管理。 您还可以使用远程安全命令行管理程序 (SSH) 直接连接到正在运行的 VM, 并执行命令, 就像您在本地计算机上一样。

### <a name="running-linux-in-azure"></a>在 Azure 中运行 Linux

在 Azure 中创建基于 Linux 的 vm 非常简单。 Microsoft 已与主要的 Linux 供应商合作, 以确保为 Azure 平台优化其分发。 您可以从预构建的映像创建虚拟机, 以用于各种流行的 linux 分布 (如 SUSE、红色帽子和 Ubuntu), 或者构建您自己的 linux 分发以在云中运行。

## <a name="creating-an-azure-vm"></a>创建 Azure 虚拟机

可以通过以下几种方式在 Azure 上定义和部署 vm: azure 门户、脚本 (使用 Azure CLI 或 azure PowerShell) 或 Azure 资源管理器模板。 在所有情况下, 您都需要提供一些我们将很快包含的信息。

Azure Marketplace 还提供了预配置的图像, 其中包括为特定方案安装的操作系统和喜爱的软件工具。

![在 azure Marketplace 中显示多个虚拟机选项的 azure 门户的屏幕截图。](../media/2-marketplace-vm-choices.png)

## <a name="resources-used-in-a-linux-vm"></a>Linux VM 中使用的资源

在 Azure 中创建 Linux VM 时, 还会创建资源以托管 VM。 这些资源协同工作以虚拟化计算机并运行 Linux 操作系统。 这些项必须存在 (并在创建 vm 时选择), 否则将使用 vm 创建它们:

- 提供 CPU 和内存资源的虚拟机
- 用于保存虚拟硬盘的 Azure 存储帐户
- 用于存放 OS、应用程序和数据的虚拟磁盘
- 用于将 VM 连接到其他 Azure 服务或本地硬件的虚拟网络 (VNet)
- 与 VNet 通信的网络接口
- 一个可选的公共 IP 地址, 以便你可以访问 VM

与其他 Azure 服务一样, 你需要一个**资源组**来包含 VM (并可以选择对这些资源进行管理)。 创建新的 VM 时, 可以使用现有的资源组, 也可以创建一个新的虚拟机。

## <a name="choose-the-vm-image"></a>选择虚拟机映像

选择图像是创建 VM 时第一次也是最重要的决策之一。 图像是用于创建虚拟机的模板。 这些模板包括操作系统, 通常是其他软件, 如开发工具或 web 托管环境。

计算机可以安装的任何内容都可以包含在映像中。 您可以从已预先配置为您所需的任务的映像中创建 VM, 例如在 Apache HTTP 服务器上承载 web 应用程序。

> [!TIP]
> 您还可以创建和上载自定义磁盘映像。

## <a name="sizing-your-vm"></a>调整你的 VM 的大小

正如物理计算机具有一定数量的内存和 CPU 功能一样, 虚拟机也是如此。 Azure 以不同的价位提供了一系列不同大小的虚拟机。 您选择的大小将确定虚拟机的处理能力、内存和最大存储容量。

> [!WARNING]
> 对可以影响 VM 创建的每个订阅都有配额限制。 如果你遇到这些配额限制, 你可以[打开一个在线客户支持请求](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request)来增加你的限制。

VM 大小按类别进行分组, 从 B 系列开始, 以进行基本测试, 并在高达 H 系列中为大型计算任务运行。 应根据要执行的工作负荷选择 VM 的大小。 在创建虚拟机后, 可以更改其大小, 但必须先停止 vm。 因此, 最好在可能的情况下正确地调整其大小。

#### <a name="here-are-some-guidelines-based-on-the-scenario-you-are-targeting"></a>下面是基于您设定的方案的一些准则

| 你在做什么？ | 考虑这些大小
|-------|------------------|
| **常规使用计算/web**: 测试和开发、小型到中型数据库或低到中型流量 web 服务器。 | B、Dsv3、Dv3、DSv2、Dv2 |
| **重计算任务**: 中型流量 web 服务器、网络设备、批处理过程和应用程序服务器。 | Fsv2, Fs, F |
| **较大的内存使用率**: 关系数据库服务器、大型缓存和内存中的分析。 | Esv3、Ev3、M、GS、G、DSv2、Dv2 |
| **数据存储和处理**: 需要高磁盘吞吐量和 i/o 的大型数据、SQL 和 NoSQL 数据库。 | ! |
| **较高的图形呈现**或视频编辑, 以及深入学习的模型培训和 inferencing (ND)。 | NV、NC、NCv2、NCv3、ND |
| **高性能计算 (HPC)**: 您的工作负载需要具有可选择的高吞吐量网络接口的速度最快且功能最强大的 CPU 虚拟机。 | 水平 |

## <a name="choosing-storage-options"></a>选择存储选项

下一组决策围绕存储。 首先, 可以选择磁盘技术。 选项包括传统的基于磁盘驱动器的硬盘驱动器 (HDD) 或更新式的固态驱动器 (SSD)。 就像购买的硬件一样, SSD 存储成本更高, 但提供了更好的性能。

> [!TIP]
> 有两个级别的 SSD 存储可供使用: 标准版和高级版。 如果你具有正常工作负载但需要更好的性能, 请选择标准 SSD 磁盘。 如果您具有需要非常快地处理数据的 i/o 密集型工作负荷或任务关键型系统, 请选择 "高级 SSD 磁盘"。

### <a name="mapping-storage-to-disks"></a>将存储映射到磁盘

Azure 使用虚拟硬盘 (vhd) 来表示虚拟机的物理磁盘。 vhd 复制磁盘驱动器的逻辑格式和数据, 但存储为 Azure 存储帐户中的页面 blob。 可以基于每个磁盘选择它应使用的存储类型 (SSD 或 HDD)。 这使您可以控制每个磁盘的性能, 这可能取决于您计划在其上执行的 i/o。

默认情况下, 将为你的 Linux VM 创建两个虚拟硬盘 (vhd):

1. **操作系统磁盘**: 这是主驱动器, 最大容量为 2048 GB。 默认情况下, 它`/dev/sda`会被标记为。

1. **临时磁盘**: 这将为 OS 或任何应用程序提供临时存储空间。 在 Linux 虚拟机上, 磁盘已`/dev/sdb`格式化并由 Azure Linux 代理`/mnt`安装到。 根据 VM 大小调整大小, 并用于存储交换文件。

> [!WARNING]
> 临时磁盘不是永久性的。 你应该只向此磁盘写入对系统不重要的数据。

#### <a name="what-about-data"></a>数据是什么？

您可以在主驱动器和操作系统上存储数据, 但更好的方法是创建专用的_数据磁盘_。 你可以创建其他磁盘并将其附加到 VM。 每个磁盘最多可以包含 4095 GB 的数据, 最大存储量取决于所选的 VM 大小。

> [!NOTE]
> 一种有趣的功能是从实际磁盘创建 VHD 映像。 这使您可以轻松地将_现有_信息从本地计算机迁移到云。

### <a name="unmanaged-vs-managed-disks"></a>非托管磁盘与托管磁盘

你将做出的最终存储选择是使用**非托管**磁盘还是**托管**磁盘。

对于非托管磁盘, 您负责处理用于保存与您的 VM 磁盘对应的 vhd 的存储帐户。 您为所使用的空间量支付存储帐户费率。 一个存储帐户的速率限制为每秒20000个 i/o 操作数。这意味着单个存储帐户能够在完全限制的情况支持40标准虚拟硬盘。 如果需要向外扩展, 则需要多个存储帐户, 这可能会变得复杂。

托管磁盘是较新的推荐磁盘存储模型。 它们通过将管理存储帐户的负担放到 Azure 上来解决此复杂性。 elegantly 您可以指定磁盘类型 ("最优" 或 "标准") 和磁盘大小, 并且 Azure 将创建并管理它所使用的磁盘_和_存储。 您无需担心存储帐户限制, 这样就可以更轻松地向外扩展。它们还提供了其他几项好处:

- **增强了可靠性**: azure 可确保与高可靠性虚拟机相关联的 vhd 放置在 Azure 存储的不同部分, 以提供类似的恢复级别。
- **更好的安全性**: 托管磁盘是资源组中的真正管理的资源。 这意味着他们可以使用基于角色的访问控制来限制可处理 VHD 数据的人员。
- **快照支持**: 快照可用于创建 VHD 的只读副本。 您必须关闭拥有的 VM, 但创建快照只需几秒钟。 完成后, 可以打开 vm 并使用快照创建一个重复的 vm, 以解决生产问题, 或将 vm 回滚到拍摄快照的时间点。
- **备份支持**: 可以将托管磁盘自动备份到不同区域, 以使用 Azure 备份进行灾难恢复, 而不会影响 VM 的服务。

## <a name="network-communication"></a>网络通信

虚拟机使用虚拟网络 (VNet) 与外部资源进行通信。 VNet 表示您的资源在单个区域中进行通信的专用网络。 虚拟网络就像您在本地管理的网络一样。 您可以使用子网将它们划分为隔离资源, 将它们连接到其他网络 (包括您的本地网络), 并应用流量规则来控制入站和出站连接。

### <a name="planning-your-network"></a>规划网络

创建新的 VM 时, 可以选择创建新的虚拟网络或使用区域中现有的 VNet。

将 Azure 与 VM 一起创建的网络非常简单, 但很可能不适合大多数方案。 最好_提前_规划体系结构中所有组件的网络要求并单独创建 VNet 结构。 然后, 创建虚拟机并将其放入已创建的 vnet 中。 我们将在本模块后面的虚拟网络中详细介绍。

在创建虚拟机之前, 我们需要决定如何管理 VM。 让我们来看一下我们的选项。