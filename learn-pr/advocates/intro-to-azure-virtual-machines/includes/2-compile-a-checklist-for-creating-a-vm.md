在将本地服务器迁移到 Azure 时, 需要进行规划和维护。 您可以一次移动所有内容, 或者更可能的是小批量甚至单独移动。 在创建单个 VM 之前, 您应该坐下来, 草拟出您的当前基础结构模型, 并查看它如何映射到云。

#### <a name="required-resources-for-iaas-virtual-machines"></a>IaaS 虚拟机所需的资源

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RWjVUg]

我们来演练一下要考虑的事项清单。

- 从网络开始
- 命名虚拟机
- 确定虚拟机的位置
- 确定虚拟机的大小
- 了解定价模型
- 虚拟机的存储
- 选择操作系统

## <a name="start-with-the-network"></a>从网络开始

您应考虑的第一件事是, 虚拟机不是虚拟机的网络。

虚拟网络 (vnet) 在 azure 中用于提供 azure 虚拟机和其他 azure 服务之间的专用连接。 属于同一虚拟网络的 vm 和服务可以访问另一个虚拟网络。 默认情况下, 虚拟网络外部的服务无法连接到虚拟网络中的服务。 但是, 可以将网络配置为允许访问外部服务, 包括本地服务器。

这一点是为什么你应花一些时间思考你的网络配置的原因。 一旦设置了网络地址和子网并将其设置为将专用公司网络连接到 Azure 服务, 则需要确保在将任何 vm 放置到位之前考虑拓扑。

设置虚拟网络时, 请指定可用的地址空间、子网和安全性。 如果 VNet 将连接到其他 vnet, 则必须选择不重叠的地址范围。 这是你的网络中的虚拟机和服务可以使用的专用地址范围。 您可以使用 unrouteable IP 地址 (如 10.0.0.0/8、172.16.0.0/12 或 192.168.0.0/16) 或定义自己的范围。 如果仅在 VNet、相互连接的 vnet 和内部部署位置中可访问任何地址范围, 则 Azure 会将其视为专用 VNet IP 地址空间的一部分。 如果其他人负责内部网络, 则应在选择地址空间之前与此人合作, 以确保没有重叠, 并让他们知道要使用的空间, 以便它们不会尝试使用相同范围的 IP 地址。

### <a name="segregate-your-network"></a>隔离网络

在确定虚拟网络地址空间之后, 可以为虚拟网络创建一个或多个子网。 这样做是为了将网络分成更易于管理的部分。 例如, 您可以将10.1.0.0 分配给 vm、10.2.0.0 到后端服务和10.3.0.0 到 SQL Server 虚拟机。

> [!NOTE]
> Azure 在每个子网中保留前四个地址和最后一个地址供其使用。

### <a name="secure-the-network"></a>保护网络

默认情况下, 子网之间没有安全边界, 因此这些子网中的每个子网中的服务可以相互对话。 但是, 您可以设置网络安全组 (NSGs), 以便控制进出子网以及从 vm 到之间的通信流。 NSGs 充当软件防火墙, 将自定义规则应用于网络接口和子网级别的每个入站或出站请求。 这使您可以完全控制传入或传出 VM 的每个网络请求。

## <a name="plan-each-vm-deployment"></a>规划每个 VM 部署

一旦您映射了通信和网络要求, 就可以开始考虑要创建的虚拟机。 一个理想的计划是选择服务器并进行清点:

- 服务器与之通信的是什么？
- 哪些端口是打开的？
- 使用哪种 OS？
- 使用了多少磁盘空间？
- 这将使用哪种类型的数据？ 在内部部署中是否有限制 (法律或其他) 限制？
- 服务器有什么类型的 CPU、内存和磁盘 i/o 负载？ 是否有要考虑的突发流量流量？

接下来, 我们可以开始回答 Azure 将为新的虚拟机提供的一些问题。

### <a name="name-the-vm"></a>命名虚拟机

一件信息人员通常不会将大量想法放入虚拟机的**名称**。 虚拟机名称将用作计算机名称, 该名称被配置为操作系统的一部分。 您可以在 Linux vm 上的 Windows vm 和64字符上指定最长为15个字符的名称。

此名称还定义了一个可管理的**Azure 资源**, 在以后更改时并不容易这样做。 这意味着您应选择有意义且一致的名称, 这样您就可以轻松地识别 VM 的功能。 一个很棒的约定是在名称中包含以下信息:

| 元素 | 示例 | Notes |
| --- | --- | --- |
| 环境 |开发、生产、QA |标识资源的环境 |
| 位置 |uw (美国西部), ue (美国东部) |标识资源的部署区域 |
| 情况 |01, 02 |对于具有多个命名实例 (web 服务器等) 的资源 |
| 产品或服务 |服务台 |标识资源支持的产品、应用程序或服务 |
| Role |sql、web、消息传递 |标识关联资源的角色 | 

例如, `devusc-webvm01`可能表示第一个开发 web 服务器托管在美国南部的中央位置。 

#### <a name="what-is-an-azure-resource"></a>什么是 Azure 资源？

**azure 资源**是 azure 中可管理的项。 就像您的数据中心中的物理计算机一样, vm 具有完成其工作所需的多个元素:

- VM 本身
- 磁盘的存储帐户
- 虚拟网络 (与其他 vm 和服务共享)
- 网络上进行通信的网络接口
- 用于保护网络流量的网络安全组
- 公共 Internet 地址 (可选)

Azure 将创建所有这些资源 (如有必要), 也可以将现有资源作为部署过程的一部分提供。 每个资源都需要一个将用于标识它的名称。 如果 Azure 创建资源, 它将使用 VM 名称生成资源名称-与你的 VM 名称非常一致的另一个理由!

### <a name="decide-the-location-for-the-vm"></a>确定虚拟机的位置

Azure 在世界各地的数据中心都充满了服务器和磁盘。 这些数据中心分为地理_区域_("West US"、"北欧"、"东南部亚洲" 等), 以提供冗余和可用性。

在创建和部署虚拟机时, 必须选择要分配资源 (CPU、存储等) 的区域。 这样, 你就可以将 vm 尽可能地接近你的用户, 以提高性能并满足任何法律、合规性或税款要求。

有关位置选择, 需要考虑的两个问题。 首先, 位置可以限制可用的选项。 每个区域都有不同的可用硬件, 并且某些配置在所有区域中均不可用。 其次, 位置之间存在价格差异。 如果工作负载未绑定到特定位置, 则在多个区域中检查所需的配置以找出最低价格可能会非常经济高效。

### <a name="determine-the-size-of-the-vm"></a>确定虚拟机的大小

一旦设置了名称和位置, 您需要决定 VM 的大小。 Azure 提供了不同的_VM 大小_, 而不是单独指定处理能力、内存和存储容量, 而是以不同大小提供这些元素的变体。 Azure 提供了多种 VM 大小选项, 使您可以为您要执行的操作选择适当的计算、内存和存储组合。

确定合适的 vm 大小的最佳方法是考虑 vm 需要运行的工作负荷类型。 根据工作负载, 你可以从可用 VM 大小的子集中进行选择。 工作负荷选项在 Azure 上分为以下几种:

| 可选              | 说明 |
|---------------------|-------------|
| **常规用途** | 通用虚拟机旨在实现平衡 CPU 与内存的比率。 是测试和开发的理想选择、中小型数据库和低到中型流量的 web 服务器。 |
| **计算优化** | 计算优化的虚拟机旨在使 CPU 与内存的比率较高。 适用于中型流量 web 服务器、网络设备、批处理过程和应用程序服务器。 |
| **内存优化** | 内存优化的虚拟机旨在实现高内存到 CPU 的比率。 非常适合于关系数据库服务器、大中型缓存和内存中的分析。 |
| **存储优化** | 存储优化的虚拟机旨在实现高磁盘吞吐量和 IO。 是运行数据库的虚拟机的理想选择。 |
| **GPU** | GPU 虚拟机是专门针对较重的图形呈现和视频编辑的专用虚拟机。 这些虚拟机是使用深入学习的模型培训和 inferencing 的理想选项。 |
| **高性能计算** | 高性能计算是具有可选高吞吐量网络接口的速度最快且功能最强大的 CPU 虚拟机。 |

当您在 Azure 中配置 VM 大小时, 您可以筛选工作负载类型。 您选择的大小会直接影响服务的成本。 您需要的 CPU、内存和 GPU 越多, 价格点就越高。

### <a name="what-if-my-size-needs-change"></a>如果我的大小需要更改, 该怎么办？

当现有的大小不再满足您的需求时, Azure 允许您更改 VM 大小。 您可以升级或降级虚拟机-只要新大小允许使用当前硬件配置。 这为 VM 管理提供了完全灵活且灵活的方法。

vm 的大小可以在运行 vm 时更改, 只要新大小在运行虚拟机的当前硬件群集中可用。 Azure 门户仅显示可用的大小选择, 从而使这一点显而易见。 如果尝试将 VM 大小调整为不可用的大小, 则命令行工具将报告错误。 更改正在运行的 VM 大小将自动重新启动计算机以完成请求。

如果您停止并取消分配 vm, 则可以选择任何在您的区域中可用的大小, 因为这会从运行它的群集中删除你的 vm。

> [!WARNING]
> 请注意调整生产虚拟机的大小-将自动重新启动, 这可能会导致临时中断并更改某些配置设置 (如 IP 地址)。

### <a name="understanding-the-pricing-model"></a>了解定价模型

对于每个 VM, 订阅将收取两个独立的开销: 计算和存储。 通过将这些成本分开, 可以独立地扩展它们, 并仅支付所需的费用。

**计算成本**-计算费用以每小时为单位定价, 但以每分钟为单位收费。 例如, 如果 VM 部署的时间为55分钟, 则仅收取55分钟的使用率。 如果你停止并取消分配 VM, 则不会对计算容量收费, 因为这将释放硬件。 每小时价格根据您选择的 VM 大小和 OS 而有所不同。 VM 的成本包括 Windows 操作系统的费用。 基于 Linux 的实例成本更低, 因为没有操作系统许可证费用。

> [!TIP]
> 通过使用具有**Azure 混合优势**的 Windows 现有许可证, 可以节省资金。

**存储成本**-为 VM 使用的存储单独收取费用。 VM 的状态与将导致的存储费用无关;即使 vm 已停止/解除分配且你不会对正在运行的 VM 计费, 你也需要为磁盘使用的存储付费。

你可以从两个付款选项中选择用于计算成本。

| 可选 | 说明 |
|--------|-------------|
| **开始时付费** | 使用 "**即点即**用" 选项, 可以按第二个计算容量付费, 而无需长期承诺或前期付款。 您可以根据需要增加或减少计算容量, 也可以随时启动或停止计算。 如果运行的应用程序具有不能中断的短期或不可预知的工作负载, 则首选此选项。 例如, 如果您正在执行快速测试或在 VM 中开发应用程序, 则可以选择此选项。 |
| **保留的虚拟机实例** | 保留的虚拟机实例 (RI) 选项是在指定区域中的一到三年的虚拟机的提前购买。 承诺的提前和回报, 与按即点即用定价相比, 价格节省了 72%。 **RIs**非常灵活, 可以轻松地交换或返回, 以获得提前终止费用。 如果 VM 必须连续运行, 或者需要预算可预测性,**并且**您可以至少在一年中使用虚拟机, 则首选此选项。 |

### <a name="storage-for-the-vm"></a>虚拟机的存储

所有 Azure 虚拟机都至少有两个虚拟硬盘 (vhd)。 第一个磁盘存储操作系统, 第二个磁盘用作临时存储。 您可以添加其他磁盘来存储应用程序数据;最大数量由 VM 大小选择 (每个 CPU 通常为两个) 决定。 创建一个或多个数据磁盘很常见, 尤其是因为 OS 磁盘往往相当小。 此外, 将数据分离到不同的 vhd 允许您单独管理磁盘的安全性、可靠性和性能。

每个 VHD 的数据都以页面 blob 的形式保存在**azure 存储**中, 从而允许 Azure 仅为你使用的存储分配空间。 它也是存储成本的度量方式;您为要使用的存储付费。

#### <a name="what-is-azure-storage"></a>什么是 Azure 存储？

Azure 存储是 Microsoft 基于云的数据存储解决方案。 它支持几乎任何类型的数据, 并提供对存储数据的安全性、冗余和可缩放的访问。 存储帐户为特定订阅提供对 Azure 存储中的对象的访问权限。 虚拟机始终具有一个或多个存储帐户, 用于保存每个附加的虚拟磁盘。

可以通过**标准**或**高级**存储帐户来支持虚拟磁盘。 Azure Premium 存储利用固态驱动器 (ssd) 为运行 i/o 密集型工作负荷的 vm 启用高性能和低延迟。 将 Azure Premium 存储用于生产工作负载, 尤其是那些对性能变体或 i/o 密集型的敏感存储。 对于开发或测试, 标准存储是完好的。

创建磁盘时, 有两个选项可用于管理存储帐户和每个 VHD 之间的关系。 可以选择 "**非托管磁盘**" 或 "**托管磁盘**"。

| 可选 | 说明 |
|--------|-------------|
| **非托管磁盘** | 对于非托管磁盘, 您负责处理用于保存与您的 VM 磁盘对应的 vhd 的存储帐户。 您为所使用的空间量支付存储帐户费率。 一个存储帐户具有每秒 20000 i/o 操作数的固定速率限制。这意味着存储帐户能够以充分利用的方式支持40标准虚拟硬盘。 如果需要向外扩展更多磁盘, 则需要更多的存储帐户, 这可能会变得复杂。 |
| **托管磁盘** | 托管磁盘是**较新的推荐磁盘存储模型**。 它们通过将管理存储帐户的负担放到 Azure 上来解决此复杂性。 elegantly 您可以指定磁盘的大小 (最大为 4 TB), 并且 Azure 将创建和管理磁盘_和_存储。 您无需担心存储帐户限制, 这将使托管磁盘更易于扩展。 |

### <a name="select-an-operating-system"></a>选择操作系统

Azure 提供多种 OS 映像, 可以将其安装到 VM 中, 包括多个版本的 Windows 和 Linux 的各种风格。 如前所述, 操作系统的选择会影响你的每小时计算定价, 因为 Azure 捆绑了 os 许可证的成本价格。

如果你要查找的不仅仅是基本 OS 映像, 可以搜索 Azure Marketplace 以获取更复杂的安装映像, 其中包括为特定方案安装的操作系统和热门软件工具。 例如, 如果您需要一个新的 WordPress 网站, 标准技术堆栈将由 Linux 服务器、Apache web 服务器、MySQL 数据库和 PHP 组成。 除了设置和配置每个组件之外, 您还可以利用 Marketplace 图像并一次性安装整个堆栈。

最后, 如果找不到合适的操作系统映像, 可以使用所需的磁盘映像, 将其上载到 azure 存储, 并使用它来创建 azure VM。 请记住, Azure 仅支持64位操作系统。
