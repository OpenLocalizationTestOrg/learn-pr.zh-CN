为实现高可用性进行设计有助于让应用程序或进程在有不利的事件和负面条件的情况时保持运行。 但是, 如果出现过多的数据而导致您的应用程序和进程无法继续运行, 您该怎么办？ 灾难发生时, 您需要制定一个计划, 让服务再次运行。 您应了解要恢复的目标和预期、您的计划的成本和限制以及您的计划的执行方式和限制。

## <a name="what-is-disaster-recovery"></a>什么是灾难恢复？

灾难恢复是指从导致宕机和数据丢失的*影响较大的事件中恢复*。 灾难是单一的主要事件, 其影响大大增加且长期, 而不是应用程序可以通过其设计的高可用性部分进行缓解。

"灾难" 一词通常 evokes*自然*灾难和外部事件 (地震、洪水、tropical 风暴等) 的想法, 但也存在许多其他类型的灾难。 失败的部署或升级可能会使应用程序处于无法识别的状态。 恶意黑客可以加密或删除数据, 并对使某个应用程序脱机或消除某些功能的其他种类的损坏造成损害。

无论其原因如何, 发生灾难的最佳补救措施是定义完善的、经过测试的灾难恢复计划, 以及在其设计中主动支持灾难恢复工作的应用程序。

## <a name="how-to-create-a-disaster-recovery-plan"></a>如何创建灾难恢复计划

灾难恢复计划是一个文档, 该文档详细介绍了从灾难导致的数据丢失和停机中恢复所需的过程, 并确定将这些过程定向到谁负责。 在灾难发生之后, 操作员应能够使用计划作为恢复应用程序连接和恢复数据的一种手动方式。 专用于灾难恢复的一个详细的书面计划对于确保理想的结果至关重要。 创建计划的过程将有助于组合应用程序的完整图。 在灾难事件的 panicked、chaotic aftermath 中, 生成的编写步骤将促进良好的决策制定和跟进。

创建灾难恢复计划需要具备对应用程序工作流、数据、基础结构和依赖项的专业知识。

### <a name="risk-assessment-and-process-inventory"></a>风险评估和处理清单

创建灾难恢复计划的第一步是执行风险分析, 以检查应用程序中不同类型的灾难的影响。 灾难的确切性质并不像其数据丢失和应用程序停机造成的潜在影响那样重要。 探索各种假设的灾难并在考虑其效果时尽量具体。 例如, 目标恶意攻击可能会修改产生与地震不同的代码或数据, 而不会影响网络连接和数据中心可用性。

风险评估需要考虑*每个*无法无限期停机的过程, 以及无法承受无限损失的每个数据类别。 在影响多个应用程序组件的灾难发生时, 计划所有者可以使用计划来充分了解需要注意的事项以及如何设置每个项目的优先级, 这一点非常重要。

某些应用程序可能仅构成数据的单个过程或分类。 请务必注意这一点, 因为应用程序可能是更大灾难恢复计划中的一个组件, 其中包括多个组织的应用程序。

### <a name="recovery-objectives"></a>恢复目标

完整的计划需要为应用程序实现的每个进程指定两个关键的业务要求:

* **恢复点目标 (RPO)**: 可接受数据丢失的最长持续时间。 RPO 以时间单位计量, 而不是按卷: "30 分钟的数据"、"四个小时的数据" 等。 RPO 是关于限制和恢复数据*丢失*, 而不是数据*泄露*。
* **恢复时间目标 (RTO)**: 可接受停机时间的最长持续时间, 其中 "停机时间" 需要由你的规范定义。 例如, 如果灾难发生时可接受的停机时间为8小时, 则 RTO 为8小时。

![图中显示恢复点目标和灾难恢复时间目标的持续时间 (以小时为单位)。](../media/rto-rpo.png)

应用程序实现的每个主要进程或工作负荷应具有单独的 RPO 和 RTO 值。 即使您为不同的进程提供了相同的值, 也应通过单独的分析来生成每个进程, 以检查灾难方案风险和每个各自的过程的潜在恢复策略。

指定 RPO 和 RTO 的过程实际上是创建应用程序的灾难恢复要求的过程。 它要求制定每个工作负载和数据类别的优先级, 并执行成本效益分析。 分析包括一些顾虑, 如实施和维护成本、运营费用、处理开销、性能影响, 以及停机时间和丢失数据的影响。 您需要为您的应用程序准确定义 "宕机" 的含义, 在某些情况下, 您可以为不同的功能级别建立不同的 RPO 和 RTO 值。 指定 RPO 和 RTO 不只是选择任意值。 灾难恢复计划的大部分价值都来自研究和分析, 以发现灾难的潜在影响和缓解风险的成本。

### <a name="detailing-recovery-steps"></a>详细介绍恢复步骤

最终计划应详细介绍应采取哪些步骤来还原丢失的数据和应用程序连接。 步骤通常包括有关以下内容的信息:

* **备份**: 创建的频率、位置, 以及如何从这些备份中还原数据。
* **数据副本**: 副本的数量和位置、复制数据的性质和一致性特征, 以及如何切换到不同的副本。
* **部署**: 如何执行部署、回滚的发生方式以及部署的故障方案。
* **基础结构**: 内部部署和云资源、网络基础结构和硬件清单。
* **依赖项**: 应用程序使用的外部服务, 包括 sla 和联系信息。
* **配置和通知**: 可设置为能够正常降低应用程序的标志或选项, 以及用于向用户通知应用程序影响的服务。

所需的确切步骤将很大程度上取决于应用程序的实施细节, 这使规划更新的重要性非常重要。 定期测试计划将有助于识别空缺和过时的部分。

## <a name="designing-for-disaster-recovery"></a>用于灾难恢复的设计

灾难恢复并不是一项自动功能。 必须对其进行设计、构建和测试。 需要支持稳定灾难恢复策略的应用程序必须从基本的灾难恢复中进行构建。 Azure 提供了服务、功能和指南, 可帮助您创建支持灾难恢复的应用程序, 但你可以在设计中加入这些应用。

用于灾难恢复的设计有两个主要问题:

* **数据恢复**: 使用备份和复制来还原丢失的数据。
* **进程恢复**: 恢复服务和部署代码以从中断中恢复。

### <a name="data-recovery-and-replication"></a>数据恢复和复制

复制在多个数据存储副本之间重复存储数据。 与*backup*(用于创建用于恢复的数据的长期、只读快照) 不同, 复制创建实时数据的实时或近乎实时的副本。 复制的目标是使副本保持尽可能少的延迟, 同时保持应用程序响应。 复制是为实现高可用性和灾难恢复而设计的关键组件, 是生产级应用程序的常见功能。

通过执行*故障转移*, 可使用复制来缓解故障或不可访问的数据存储: 更改应用程序配置以将数据请求路由到工作副本。 故障转移通常是自动进行的, 由内置于数据存储产品中的错误检测触发, 或者是通过监控解决方案实现的检测。 根据实现和方案, 可能需要由系统操作员手动执行故障转移。

复制不是从头开始实施的内容。 由于功能和性能要求, 大多数功能最重要的数据库系统和其他数据存储产品和服务包括一些复制, 这是一种紧密集成的功能。 但是, 您可以在应用程序设计中包含这些功能, 并对它们进行适当的使用。

不同的 Azure 服务支持复制的各种级别和概念。 例如：

* **Azure 存储**复制功能取决于为存储帐户选择的复制类型。 此复制可以是本地的 (数据中心内)、区域性 (区域内的数据中心之间) 或区域 (区域之间)。 您的应用程序和运算符都不直接与之进行交互。 故障转移是自动且透明的, 只需选择平衡成本和风险的复制级别即可。
* **Azure SQL 数据库**复制在很小的范围内是自动进行的, 但从完整的 Azure 数据中心或区域中断恢复需要异地复制。 设置异地复制是手动进行的, 但它是服务的第一类功能, 并且文档受到充分支持。
* **Cosmos DB**是一个全局分布式数据库系统, 复制是其实现的中心。 使用 Azure Cosmos DB, 不是直接配置复制, 而是配置与分区和数据一致性相关的选项。

存在许多不同的复制设计, 它们对数据一致性、性能和成本进行了不同的优先级。 *主动*复制需要更新以同时在多个副本上进行, 从而以吞吐量的成本来保证一致性。 相比之下,*被动*复制在后台执行同步, 将复制作为对应用程序性能的限制进行删除, 但要提高 RPO。 *主动-主动*或*多主机*复制允许多个副本同时使用, 从而以降低数据一致性的成本实现负载平衡, 同时*主动-被动*复制保留副本用于实时仅在故障转移期间使用。

![显示地理复制示例的插图。 主要可更新数据库位于南部中部, 而可读辅助数据库放在两个不同的位置: 美国西部和东 (美国)。](../media/geo-replication.png)

> [!IMPORTANT]
> **复制和备份都不是完全独立的灾难恢复解决方案**。 数据恢复只是灾难恢复的一个组件, 并且复制将不会完全满足多种灾难恢复方案。 例如, 在数据损坏的情况下, 损坏的性质可能允许它从主数据存储传播到副本, 从而使所有副本都毫无用处且需要备份以进行恢复。

### <a name="process-recovery"></a>进程恢复

灾难发生之后, 业务数据不是唯一需要恢复的资产。 灾难方案通常也会导致停机, 无论是由于网络连接问题、数据中心中断还是虚拟机实例或软件部署损坏。 您的应用程序的设计需要使您能够将其还原到工作状态。

在大多数情况下, 进程还原涉及到单独的工作部署的故障转移。 根据应用场景的不同, 地理位置可能是一个关键方面。 例如, 将整个 Azure 区域脱机引入的大规模自然灾难将需要还原另一个区域中的服务。 您的应用程序的灾难恢复要求 (尤其是 RTO) 应驱动您的设计, 并帮助您确定应拥有的复制环境的数量、应在哪里, 以及它们是应在准备运行状态下维护还是应准备好在发生灾难时接受部署。

根据应用程序的设计, 您可以利用几种不同的策略和功能, 以改进应用程序在灾难发生后对进程恢复的支持。

#### <a name="azure-site-recovery"></a>Azure Site Recovery

Azure Site Recovery 是专门用于管理在部署到 Azure 的 vm、在物理服务器上运行的 vm 以及直接在物理服务器上运行的工作负荷的进程恢复的服务。 网站恢复将工作负荷复制到备用位置, 并在发生中断时帮助您进行故障转移, 并支持对灾难恢复计划进行测试。

![图中显示了 Azure site recovery 在将位于美国东部的三个虚拟机上的工作负荷复制到美国西部我们的角色。](../media/asr.png)

网站恢复支持复制整个 vm 和物理服务器映像以及单个*工作*负荷, 其中工作负荷可能是单个应用程序或整个 VM 或操作系统及其应用程序。 可以复制任何应用程序工作负载, 但网站恢复具有对许多 Microsoft 服务器应用程序的第一类集成支持, 如 SQL server 和 SharePoint 以及 SAP 等第三方应用程序。

在 vm 或物理服务器上运行的任何应用程序都应至少调查 Azure Site Recovery 的使用。 这是发现和探索过程恢复的方案和可能性的一种非常好的方法。

#### <a name="service-specific-features"></a>特定于服务的功能

对于在 Azure PaaS 产品 (如应用服务) 上运行的应用程序, 大多数此类服务提供了支持灾难恢复的功能和指南。 在某些情况下, 您可以使用特定于服务的功能来支持快速恢复。 例如, Azure SQL Server 支持异地复制以在另一个区域中快速还原服务。 azure 应用服务具有备份和还原功能, 并且文档包含有关使用 Azure 流量管理器支持到辅助区域的路由流量的指南。

![显示单个数据中心的地理位置中的区域对的插图。](../media/AzRegionPairs.png)

## <a name="testing-a-disaster-recovery-plan"></a>测试灾难恢复计划

一旦准备好了计划, 灾难恢复规划就不会结束。 测试计划是灾难恢复的一个关键方面, 以确保说明和说明清楚且最新。

选择每隔6个月执行不同类型和测试范围的间隔, 如每月测试备份和故障转移机制, 并执行完全规模的灾难恢复模拟。 始终按照在计划中记录的步骤和详细信息中的说明操作, 并考虑让不熟悉计划的人对任何可能变得更清楚的内容进行学习。 在执行测试时, 请确定差距、改进的领域以及实现自动化的位置, 并将这些增强功能添加到您的计划中。

此外, 请务必在测试中包含监视系统。 例如, 如果您的应用程序支持自动故障转移, 则在依赖项或其他关键组件中引入故障, 以确保应用程序的行为正确端到端, 包括检测到故障并触发自动故障.

 通过仔细确定您的要求并布置计划, 您将能够确定需要使用哪些类型的服务来满足您的恢复目标。 Azure 提供了多种服务和功能, 可帮助您实现这些目标。
