许多应用程序使用发布订阅模型通知分布式组件发生了问题, 或某些对象发生了更改。 假设您有一个带有 Web API 的音乐共享应用程序, 该应用程序在 Azure 中运行。 当用户上载新歌曲时, 您需要通知世界各地的用户设备上安装的所有移动应用程序是否有兴趣使用该流派的用户。

在此体系结构中, 声音文件的发布者无需了解对共享音乐感兴趣的任何订阅者。 此外, 我们还需要具有一对多关系, 在此关系中, 可以有多个订阅者可以选择决定是否对此新歌曲感兴趣。 Azure 事件网格是此类体系结构的理想解决方案。

## <a name="what-is-azure-event-grid"></a>什么是 Azure 事件网格？
azure 事件网格是在 Azure service Fabric 顶部运行的完全管理的事件路由服务。 事件网格将来自不同源 (如 azure Blob 存储帐户或 azure 媒体服务) 的_事件_分发到不同的处理程序, 如 azure 函数或 webhook。 创建了事件网格, 以便更轻松地在 Azure 上构建基于事件的应用程序和无服务器应用程序。

事件网格支持作为发布服务器或订阅者的大多数 Azure 服务, 可与第三方服务一起使用。 它提供了可动态缩放的低成本邮件系统, 允许发布者通知订阅者有关状态更改。 下图显示了从多个源接收邮件并根据订阅将它们分发到事件处理程序的 Azure 事件网格。

Azure 事件网格中有几个将源连接到订阅者的概念:

1. **事件:** 发生了什么事。
1. **事件源:** 事件发生的位置。
1. **主题:** 发布服务器发送事件的终结点。
1. **事件订阅:** 用于路由事件的终结点或内置机制 (有时指向多个处理程序)。 处理程序还使用订阅来智能地筛选传入事件。
1. **事件处理程序:** 应用或服务对事件做出反应。

![显示在多个事件源和多个事件处理程序之间定位的 Azure 事件网格的插图。 事件源向事件网格中发送事件, 事件网格将相关事件转发给订阅者。 事件网格使用主题决定要发送到哪些处理程序的事件。 事件源使用一个或多个主题标记每个事件, 事件处理程序将订阅他们感兴趣的主题。](../media/4-event-grid.png)

### <a name="what-is-an-event"></a>什么是事件？
**事件**是通过事件网格传递的数据消息, 用于描述所发生的情况。 每个事件都是独立的, 最多可达 64 KB, 并根据事件网格定义的架构包含多条信息:

```json
[
  {
    "topic": string,
    "subject": string,
    "id": string,
    "eventType": string,
    "eventTime": string,
    "data":{
      object-unique-to-each-publisher
    },
    "dataVersion": string,
    "metadataVersion": string
  }
]
```

| Field | 说明 |
|-------|-------------|
| **标题** | 事件源的完整资源路径。 事件网格提供此值。 |
| **主题** | 发布者定义的事件主题的路径。 |
| **id** | 事件的唯一标识符。 |
| **事件** | 此事件源的已注册事件类型之一。 这是您可以为其创建筛选器的值, `CustomerCreated`例如`BlobDeleted` `HttpRequestReceived`、、等。 |
| **eventTime** | 根据提供程序的 UTC 时间生成事件的时间。 |
| **数据** | 与事件类型相关的特定信息。 例如, 有关在 Azure 存储中创建的新文件的事件包含有关该文件的详细信息, 例如`lastTimeModified`值。 或者, 事件中心事件具有捕获文件的 URL。 此字段是可选的。 |
| **dataVersion** | 数据对象的架构版本。 发布服务器定义架构版本。 |
| **metadataVersion** | 事件元数据的架构版本。 事件网格定义顶级属性的架构。 事件网格提供此值。 |

> [!TIP]
> 事件网格发送事件, 以指示发生了什么情况或已更改。 但是, 已更改的_实际对象_不是事件数据的一部分。 相反, URL 或标识符通常会传递给引用已更改的对象。

### <a name="what-is-an-event-source"></a>什么是事件源？
事件源负责将事件发送到事件网格。 每个事件源与一个或多个事件类型相关。 例如, Azure 存储是 blob 创建事件的事件源。 IoT 中心是设备创建事件的事件源。 您的应用程序是您定义的自定义事件的事件源。 我们将在一段时间内更详细地查看事件源。

> [!NOTE]
> Azure 事件中心还定义了事件发布者的概念。 事件中心的发布者是决定将事件发送到事件网格的用户或组织。 例如, Microsoft 发布几个 Azure 服务的事件。 您可以发布自己的应用程序中的事件。 在 Azure 外部托管服务的组织可以通过事件网格发布事件。 这通常与事件源混合使用。 完全定义的事件源是发布者和为该发布服务器生成事件的特定服务。 在这里, 我们将使用 "发布服务器" 和 "事件源" 来表示将消息发送到事件中心的实体。

### <a name="what-is-an-event-topic"></a>什么是事件主题？
事件主题将事件分类为组。 主题由公共终结点表示, 并且是事件源向其发送事件__ 的位置。 在设计应用程序时, 您可以决定要创建多少个主题。 较大的解决方案将为每个相关事件类别创建一个自定义主题, 而较小的解决方案可能会将所有事件发送到单个主题。 例如, 请考虑发送与修改用户帐户和处理订单相关的事件的应用程序。 任何事件处理程序都不可能需要这两种类型的事件。 创建两个自定义主题, 让事件处理程序订阅他们感兴趣的主题。 事件订阅者可以从特定主题中筛选出所需的事件类型。

主题分为**系统**主题和**自定义**主题。

#### <a name="system-topics"></a>系统主题
系统主题是由 Azure 服务提供的内置主题。 你在 Azure 订阅中看不到系统主题, 因为发布者拥有这些主题, 但你可以订阅这些主题。 若要订阅, 请提供有关要从中接收事件的资源的信息。 只要您具有对资源的访问权限, 就可以订阅其事件。

#### <a name="custom-topics"></a>自定义主题
自定义主题是应用程序和第三方主题。 在创建或分配对自定义主题的访问权限时, 您会在订阅中看到该自定义主题。

### <a name="what-is-an-event-subscription"></a>什么是事件订阅？
事件订阅定义事件处理程序要接收的主题中的哪些事件。 订阅还可以按其类型或主题筛选事件, 因此您可以确保事件处理程序只接收相关事件。

### <a name="what-is-an-event-handler"></a>什么是事件处理程序？
事件处理程序 (有时称为 "订阅者") 是可以从事件网格接收事件的任何组件 (应用程序或资源)。 例如, Azure 函数可以执行代码以响应添加到 Blob 存储帐户中的新歌曲。 订阅者可以决定要处理的事件, 事件网格将在有新事件可用时有效地通知每个相关订阅者-不需要轮询。

## <a name="types-of-event-sources"></a>事件源的类型
事件可以由以下 Azure 资源类型生成:

- **Azure 订阅和资源组:** 订阅和资源组会生成与 Azure 中的管理操作相关的事件。 例如, 当用户创建虚拟机时, 此源将生成一个事件。
- **容器注册表:** 当添加、删除或更改注册表中的图像时, Azure 容器注册表服务将生成事件。
- **事件中心:** 事件中心可用于处理和存储来自各种数据源 (通常是日志记录或遥测相关) 的事件。 捕获文件时, 事件中心可以向事件网格生成事件。
- **服务总线:** 当活动邮件没有活动的侦听器时, 服务总线可以向事件网格生成事件。
- **存储帐户:** 存储帐户可以在用户添加 blob、文件、表项或队列消息时生成事件。 可以将 blob 帐户和常规用途的 V2 帐户用作事件源。
- **媒体服务:** 媒体服务承载视频和音频媒体并为媒体文件提供高级管理功能。 媒体服务可在视频文件上启动或完成编码作业时生成事件。
- **Azure IoT 中心:** iot 中心与 iot 设备通信并从中收集遥测。 它可以在此类通信到达时生成事件。
- **自定义事件:** 可以使用 REST API 或在 Java、GO、.net、Node、Python 和 Ruby 中使用 Azure SDK 生成自定义事件。 例如, 可以在 Azure 应用服务的 Web 应用功能中创建自定义事件。 在 worker 角色中, 从存储队列中选取邮件时, 这可能会发生。

这种与 azure 中的不同事件源的深层集成可确保事件网格可以分发与几乎任何 Azure 资源相关的事件。

## <a name="event-handlers"></a>事件处理程序
Azure 中的以下对象类型可接收和处理事件网格中的事件:

- **Azure 函数:** 在 Azure 中运行的自定义代码, 无需显式配置主机虚拟服务器或容器。 当您想要对事件的自定义响应进行编码时, 可将 Azure 函数用作事件处理程序。
- **webhook:** webhook 是一个实现推送体系结构的 web API。
- **Azure 逻辑应用程序:** Azure 逻辑应用程序将业务流程作为工作流承载。
- **Microsoft Flow:** 流也承载工作流, 但非技术人员更易于使用。

## <a name="should-you-use-event-grid"></a>是否应使用事件网格？
当您需要这些功能时, 请使用事件网格:

- **简洁性:** 将源连接到事件网格中的订阅者非常简单。
- **高级筛选:** 订阅可以对他们从主题收到的事件进行关闭控制。
- **扇出:** 您可以为相同的事件和主题订阅不限数量的终结点。
- **可靠性:** 每个订阅的事件网格重试最长为24小时的事件传递。
- **按事件付费:** 仅支付要传输的事件数。

事件网格是一个简单但通用的事件分布系统。 使用它将不连续的事件传递给订阅者, 这将以可靠且快速的速度快速接收这些事件。 我们有一个更多的消息传递模型-如果我们想要传递一个大型事件_流_, 该怎么办？ 在这种情况下, 事件网格不是一种很好的解决方案, 因为它是为一次性的一次性传递而设计的。 相反, 我们需要转到另一个 Azure 服务: 事件中心。
