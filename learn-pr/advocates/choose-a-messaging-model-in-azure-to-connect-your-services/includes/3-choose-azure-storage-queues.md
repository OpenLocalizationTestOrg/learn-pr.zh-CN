假设您正在规划您的音乐共享应用程序的体系结构。 您希望确保将音乐文件从移动应用程序中可靠地上传到 web API, 然后, 我们希望在艺术家将新音乐添加到其集合时, 将新歌曲的详细信息直接传递给应用程序。 这是基于邮件的系统的理想使用, 并且 Azure 为此问题提供了两种解决方案:

- Azure 队列存储
- Azure 服务总线

## <a name="what-is-azure-queue-storage"></a>什么是 Azure 队列存储？
队列存储是一项服务, 它使用 Azure 存储空间存储大量邮件, 可以使用简单的基于 REST 的界面从世界上的任何位置安全地访问这些邮件。 队列可以包含数百万封邮件, 仅受拥有它的存储帐户容量的限制。

## <a name="what-is-azure-service-bus-queues"></a>什么是 Azure 服务总线队列？
服务总线是一种面向企业应用程序的消息代理系统。 这些应用程序经常利用多个通信协议, 具有不同的数据约定, 更高的安全要求, 并且可以同时包含云和本地服务。 服务总线建立在专门用于恰好为这些方案的专用邮件基础结构之上。

这两种服务都是基于 "queue" 的概念, 该 "队列" 在目标准备接收邮件之前将其保留。

## <a name="what-are-azure-service-bus-topics"></a>什么是 Azure 服务总线主题？
Azure 服务总线主题类似于队列, 但可以具有多个订阅者。 将邮件发送到主题而不是队列时, 可以触发多个组件以完成其工作。 设想一下, 在音乐共享应用程序中, 用户正在收听歌曲。 移动应用程序可能会向 "收听" 主题发送一条消息。 该主题将包含针对 "UpdateUserListenHistory" 和 "UpdateArtistsFanList" 的其他订阅的订阅。 每个函数都由接收其自己的邮件副本的不同组件处理。

在内部, 主题使用队列。 当您发布到某个主题时, 会将该邮件复制并放入每个订阅的队列中。 队列意味着**每个订阅分支**都将持续处理邮件副本, 即使处理该订阅太忙而无法继续进行也是如此。

## <a name="benefits-of-queues"></a>队列的优势
队列基础结构可支持许多高级功能, 这些功能使它们在中非常有用 

### <a name="increased-reliability"></a>提高可靠性
分布式应用程序将队列用作临时存储位置, 用于等待传递到目标组件的邮件。 源组件可以向队列中添加消息, 目标组件可以检索队列前面的消息以进行处理。 队列提高了邮件交换的可靠性, 因为在高要求的情况下, 邮件可以简单地等待, 直到目标组件准备好处理它们。

### <a name="message-delivery-guarantees"></a>邮件传递保证
队列系统通常可确保将队列中的每个邮件传递到目标组件。 但是, 这些保证可以采用不同的方法:

- **最少一次性传递:** 在此方法中, 每封邮件都保证至少传递到一个从队列中检索邮件的组件。 但请注意, 在某些情况下, 可能会多次传递相同的邮件。 例如, 如果有两个 web 应用程序实例从队列中检索邮件, 则通常每封邮件仅转到其中一个实例。 但是, 如果一个实例处理邮件需要很长时间, 并且超时过期, 则邮件也可能发送到其他实例。 web 应用代码的设计应考虑到这种可能性。

- 一次性**传递:** 在此方法中, 不能保证每个邮件都能被传递, 并且可能无法到达的可能性极小。 但是, 与最小一次性传递不同, 该邮件将不会被传递两次。 这有时称为 "自动重复检测"。

- 先进**先出 (FIFO):** 在大多数邮件系统中, 邮件通常会使队列的顺序与添加队列的顺序相同, 但您应考虑是否保证此顺序。 如果分布式应用程序要求按正确的顺序处理邮件, 则必须选择包含 FIFO 保证的队列系统。

### <a name="transactional-support"></a>事务性支持
当组中的一封邮件传递失败时, 一些密切相关的邮件组可能会导致问题。

例如, 考虑电子商务应用程序。 当用户单击 "**购买**" 按钮时, 可能会生成一系列消息, 并将其发送到各种处理目标:

- 将订单详细信息发送到履行中心的邮件
- 将包含总和付款详细信息的邮件发送到信用卡处理者。 
- 将包含回执信息的邮件发送到数据库, 以便为客户生成发票

在这种情况下, 我们希望确保处理_所有_邮件, 或不处理任何邮件。 如果信用卡邮件未送达且所有订单均未付款, 我们将不会在业务中长时间地完成! 通过将这两个邮件组合到一个事务中, 可以避免这些类型的问题。 就像在数据库世界中一样, 邮件事务以单个单位成功或失败。 如果信用卡详细信息邮件传递失败, 则 "订单详细信息" 消息将会失败。

## <a name="which-service-should-i-choose"></a>我应选择哪种服务？
已理解, 此体系结构的通信策略应该是一条消息, 您必须选择是否使用 azure 存储队列或 Azure 服务总线, 这两种服务都可用于在组件之间存储和传递邮件。 每个功能集都略有不同的功能集, 这意味着您可以选择其中一个或另一个, 也可以使用这两者, 具体取决于您要解决的问题。

#### <a name="choose-service-bus-topics-if"></a>选择服务总线主题 (如果

- 您需要多个接收器来处理每封邮件


#### <a name="choose-service-bus-queues-if"></a>在以下情况中选择服务总线队列:

- 您需要一项最多的交付保证。
- 您需要一个 FIFO 保证。
- 您需要将邮件分组为事务。
- 您希望在不轮询队列的情况下接收邮件。
- 您需要为队列提供基于角色的访问模型。
- 您需要处理大于 64 kb 但小于 256 kb 的邮件。
- 您的队列大小不会增长大于 80 GB。
- 您希望能够发布和使用批量邮件。

队列存储不像功能丰富, 但如果您不需要这些功能中的任何一个, 则可以选择更简单的方法。 此外, 如果您的应用程序具有以下任一要求, 它也是最佳解决方案。

#### <a name="choose-queue-storage-if"></a>在以下情况中选择队列存储:

- 您需要通过队列的所有邮件的审核跟踪。
- 您预计队列的大小超过 80 GB。
- 您希望跟踪队列中的邮件处理进度。

队列是一个简单的临时存储位置, 用于在分布式应用程序的组件之间发送的邮件。 使用队列可对邮件进行组织, 并妥善处理预期的不可预测的浪涌。 

当您需要简单而简单的代码队列系统时, 请使用存储队列。 若要获得更高级的需求, 请使用服务总线队列。 如果您有单个邮件的多个目标, 但需要类似于队列的行为, 请使用主题。