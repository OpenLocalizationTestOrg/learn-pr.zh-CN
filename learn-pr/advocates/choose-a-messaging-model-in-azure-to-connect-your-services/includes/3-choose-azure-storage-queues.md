<span data-ttu-id="bcd81-101">假设您正在规划您的音乐共享应用程序的体系结构。</span><span class="sxs-lookup"><span data-stu-id="bcd81-101">Suppose you are planning the architecture for your music-sharing application.</span></span> <span data-ttu-id="bcd81-102">您希望确保将音乐文件从移动应用程序中可靠地上传到 web API, 然后, 我们希望在艺术家将新音乐添加到其集合时, 将新歌曲的详细信息直接传递给应用程序。</span><span class="sxs-lookup"><span data-stu-id="bcd81-102">You want to ensure that music files are uploaded to the web API reliably from the mobile app - we then want to deliver the details about new songs directly to the app when an artist adds new music to their collection.</span></span> <span data-ttu-id="bcd81-103">这是基于邮件的系统的理想使用, 并且 Azure 为此问题提供了两种解决方案:</span><span class="sxs-lookup"><span data-stu-id="bcd81-103">This is a perfect use of a message-based system and Azure offers two solutions to this problem:</span></span>

- <span data-ttu-id="bcd81-104">Azure 队列存储</span><span class="sxs-lookup"><span data-stu-id="bcd81-104">Azure Queue Storage</span></span>
- <span data-ttu-id="bcd81-105">Azure 服务总线</span><span class="sxs-lookup"><span data-stu-id="bcd81-105">Azure Service Bus</span></span>

## <a name="what-is-azure-queue-storage"></a><span data-ttu-id="bcd81-106">什么是 Azure 队列存储？</span><span class="sxs-lookup"><span data-stu-id="bcd81-106">What is Azure Queue Storage?</span></span>
<span data-ttu-id="bcd81-107">队列存储是一项服务, 它使用 Azure 存储空间存储大量邮件, 可以使用简单的基于 REST 的界面从世界上的任何位置安全地访问这些邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-107">Queue storage is a service that uses Azure Storage to store large numbers of messages that can be securely accessed from anywhere in the world using a simple REST-based interface.</span></span> <span data-ttu-id="bcd81-108">队列可以包含数百万封邮件, 仅受拥有它的存储帐户容量的限制。</span><span class="sxs-lookup"><span data-stu-id="bcd81-108">Queues can contain millions of messages, limited only by the capacity of the storage account that owns it.</span></span>

## <a name="what-is-azure-service-bus-queues"></a><span data-ttu-id="bcd81-109">什么是 Azure 服务总线队列？</span><span class="sxs-lookup"><span data-stu-id="bcd81-109">What is Azure Service Bus Queues?</span></span>
<span data-ttu-id="bcd81-110">服务总线是一种面向企业应用程序的消息代理系统。</span><span class="sxs-lookup"><span data-stu-id="bcd81-110">Service Bus is a message broker system intended for enterprise applications.</span></span> <span data-ttu-id="bcd81-111">这些应用程序经常利用多个通信协议, 具有不同的数据约定, 更高的安全要求, 并且可以同时包含云和本地服务。</span><span class="sxs-lookup"><span data-stu-id="bcd81-111">These apps often utilize multiple communication protocols, have different data contracts, higher security requirements, and can include both cloud and on-premises services.</span></span> <span data-ttu-id="bcd81-112">服务总线建立在专门用于恰好为这些方案的专用邮件基础结构之上。</span><span class="sxs-lookup"><span data-stu-id="bcd81-112">Service Bus is built on top of a dedicated messaging infrastructure designed for exactly these scenarios.</span></span>

<span data-ttu-id="bcd81-113">这两种服务都是基于 "queue" 的概念, 该 "队列" 在目标准备接收邮件之前将其保留。</span><span class="sxs-lookup"><span data-stu-id="bcd81-113">Both of these services are based on the idea of a "queue" which holds sent messages until the target is ready to receive them.</span></span>

## <a name="what-are-azure-service-bus-topics"></a><span data-ttu-id="bcd81-114">什么是 Azure 服务总线主题？</span><span class="sxs-lookup"><span data-stu-id="bcd81-114">What are Azure Service Bus Topics?</span></span>
<span data-ttu-id="bcd81-115">Azure 服务总线主题类似于队列, 但可以具有多个订阅者。</span><span class="sxs-lookup"><span data-stu-id="bcd81-115">Azure Service Bus topics are like queues, but can have multiple subscribers.</span></span> <span data-ttu-id="bcd81-116">将邮件发送到主题而不是队列时, 可以触发多个组件以完成其工作。</span><span class="sxs-lookup"><span data-stu-id="bcd81-116">When a message is sent to a topic instead of a queue multiple components can be triggered to do their work.</span></span> <span data-ttu-id="bcd81-117">设想一下, 在音乐共享应用程序中, 用户正在收听歌曲。</span><span class="sxs-lookup"><span data-stu-id="bcd81-117">Imagine in a music sharing application, a user listening to a song.</span></span> <span data-ttu-id="bcd81-118">移动应用程序可能会向 "收听" 主题发送一条消息。</span><span class="sxs-lookup"><span data-stu-id="bcd81-118">The mobile app might send a message to the "Listened" topic.</span></span> <span data-ttu-id="bcd81-119">该主题将包含针对 "UpdateUserListenHistory" 和 "UpdateArtistsFanList" 的其他订阅的订阅。</span><span class="sxs-lookup"><span data-stu-id="bcd81-119">That topic will have a subscription for "UpdateUserListenHistory" and a different subscription for "UpdateArtistsFanList".</span></span> <span data-ttu-id="bcd81-120">每个函数都由接收其自己的邮件副本的不同组件处理。</span><span class="sxs-lookup"><span data-stu-id="bcd81-120">Each of those functions is handled by a different component that receives its own copy of the message.</span></span>

<span data-ttu-id="bcd81-121">在内部, 主题使用队列。</span><span class="sxs-lookup"><span data-stu-id="bcd81-121">Internally, topics use queues.</span></span> <span data-ttu-id="bcd81-122">当您发布到某个主题时, 会将该邮件复制并放入每个订阅的队列中。</span><span class="sxs-lookup"><span data-stu-id="bcd81-122">When you post to a topic, the message is copied and dropped into the queue for each subscription.</span></span> <span data-ttu-id="bcd81-123">队列意味着**每个订阅分支**都将持续处理邮件副本, 即使处理该订阅太忙而无法继续进行也是如此。</span><span class="sxs-lookup"><span data-stu-id="bcd81-123">The queue means that the message copy will stay around to be processed **by each subscription branch** even if the component processing that subscription is too busy to keep up.</span></span>

## <a name="benefits-of-queues"></a><span data-ttu-id="bcd81-124">队列的优势</span><span class="sxs-lookup"><span data-stu-id="bcd81-124">Benefits of queues</span></span>
<span data-ttu-id="bcd81-125">队列基础结构可支持许多高级功能, 这些功能使它们在中非常有用</span><span class="sxs-lookup"><span data-stu-id="bcd81-125">Queue infrastructures can support many advanced features that make them very useful in</span></span> 

### <a name="increased-reliability"></a><span data-ttu-id="bcd81-126">提高可靠性</span><span class="sxs-lookup"><span data-stu-id="bcd81-126">Increased reliability</span></span>
<span data-ttu-id="bcd81-127">分布式应用程序将队列用作临时存储位置, 用于等待传递到目标组件的邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-127">Queues are used by distributed applications as a temporary storage location for messages pending delivery to a destination component.</span></span> <span data-ttu-id="bcd81-128">源组件可以向队列中添加消息, 目标组件可以检索队列前面的消息以进行处理。</span><span class="sxs-lookup"><span data-stu-id="bcd81-128">The source component can add a message to the queue and destination components can retrieve the message at the front of the queue for processing.</span></span> <span data-ttu-id="bcd81-129">队列提高了邮件交换的可靠性, 因为在高要求的情况下, 邮件可以简单地等待, 直到目标组件准备好处理它们。</span><span class="sxs-lookup"><span data-stu-id="bcd81-129">Queues increase the reliability of the message exchange because, at times of high demand, messages can simply wait until a destination component is ready to process them.</span></span>

### <a name="message-delivery-guarantees"></a><span data-ttu-id="bcd81-130">邮件传递保证</span><span class="sxs-lookup"><span data-stu-id="bcd81-130">Message delivery guarantees</span></span>
<span data-ttu-id="bcd81-131">队列系统通常可确保将队列中的每个邮件传递到目标组件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-131">Queuing systems usually guarantee delivery of each message in the queue to a destination component.</span></span> <span data-ttu-id="bcd81-132">但是, 这些保证可以采用不同的方法:</span><span class="sxs-lookup"><span data-stu-id="bcd81-132">However, these guarantees can take different approaches:</span></span>

- <span data-ttu-id="bcd81-133">**最少一次性传递:** 在此方法中, 每封邮件都保证至少传递到一个从队列中检索邮件的组件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-133">**At-Least-Once Delivery:** In this approach, each message is guaranteed to be delivered to at least one of the components that retrieve messages from the queue.</span></span> <span data-ttu-id="bcd81-134">但请注意, 在某些情况下, 可能会多次传递相同的邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-134">Note, however, that in certain circumstances, it is possible that the same message may be delivered more than once.</span></span> <span data-ttu-id="bcd81-135">例如, 如果有两个 web 应用程序实例从队列中检索邮件, 则通常每封邮件仅转到其中一个实例。</span><span class="sxs-lookup"><span data-stu-id="bcd81-135">For example, if there are two instances of a web app retrieving messages from a queue, ordinarily each message goes to only one of those instances.</span></span> <span data-ttu-id="bcd81-136">但是, 如果一个实例处理邮件需要很长时间, 并且超时过期, 则邮件也可能发送到其他实例。</span><span class="sxs-lookup"><span data-stu-id="bcd81-136">However, if one instance takes a long time to process the message, and a time-out expires, the message may be sent to the other instance as well.</span></span> <span data-ttu-id="bcd81-137">web 应用代码的设计应考虑到这种可能性。</span><span class="sxs-lookup"><span data-stu-id="bcd81-137">Your web app code should be designed with this possibility in mind.</span></span>

- <span data-ttu-id="bcd81-138">一次性**传递:** 在此方法中, 不能保证每个邮件都能被传递, 并且可能无法到达的可能性极小。</span><span class="sxs-lookup"><span data-stu-id="bcd81-138">**At-Most-Once Delivery:** In this approach, each message is not guaranteed to be delivered, and there is a very small chance that it may not arrive.</span></span> <span data-ttu-id="bcd81-139">但是, 与最小一次性传递不同, 该邮件将不会被传递两次。</span><span class="sxs-lookup"><span data-stu-id="bcd81-139">However, unlike At-Least-Once delivery, there is no chance that the message will be delivered twice.</span></span> <span data-ttu-id="bcd81-140">这有时称为 "自动重复检测"。</span><span class="sxs-lookup"><span data-stu-id="bcd81-140">This is sometimes referred to as "automatic duplicate detection".</span></span>

- <span data-ttu-id="bcd81-141">先进**先出 (FIFO):** 在大多数邮件系统中, 邮件通常会使队列的顺序与添加队列的顺序相同, 但您应考虑是否保证此顺序。</span><span class="sxs-lookup"><span data-stu-id="bcd81-141">**First-In-First-Out (FIFO):** In most messaging systems, messages usually leave the queue in the same order in which they were added, but you should consider whether this order is guaranteed.</span></span> <span data-ttu-id="bcd81-142">如果分布式应用程序要求按正确的顺序处理邮件, 则必须选择包含 FIFO 保证的队列系统。</span><span class="sxs-lookup"><span data-stu-id="bcd81-142">If your distributed application requires that messages are processed in precisely the correct order, you must choose a queue system that includes a FIFO guarantee.</span></span>

### <a name="transactional-support"></a><span data-ttu-id="bcd81-143">事务性支持</span><span class="sxs-lookup"><span data-stu-id="bcd81-143">Transactional support</span></span>
<span data-ttu-id="bcd81-144">当组中的一封邮件传递失败时, 一些密切相关的邮件组可能会导致问题。</span><span class="sxs-lookup"><span data-stu-id="bcd81-144">Some closely related groups of messages may cause problems when delivery fails for one message in the group.</span></span>

<span data-ttu-id="bcd81-145">例如, 考虑电子商务应用程序。</span><span class="sxs-lookup"><span data-stu-id="bcd81-145">For example, consider an e-commerce application.</span></span> <span data-ttu-id="bcd81-146">当用户单击 "**购买**" 按钮时, 可能会生成一系列消息, 并将其发送到各种处理目标:</span><span class="sxs-lookup"><span data-stu-id="bcd81-146">When the user clicks the **Buy** button, a series of messages might be generated and sent off to various processing destinations:</span></span>

- <span data-ttu-id="bcd81-147">将订单详细信息发送到履行中心的邮件</span><span class="sxs-lookup"><span data-stu-id="bcd81-147">A message with the order details is sent to a fulfillment center</span></span>
- <span data-ttu-id="bcd81-148">将包含总和付款详细信息的邮件发送到信用卡处理者。</span><span class="sxs-lookup"><span data-stu-id="bcd81-148">A message with the total and payment details is sent to a credit card processor.</span></span> 
- <span data-ttu-id="bcd81-149">将包含回执信息的邮件发送到数据库, 以便为客户生成发票</span><span class="sxs-lookup"><span data-stu-id="bcd81-149">A message with the receipt information is sent to a database to generate an invoice for the customer</span></span>

<span data-ttu-id="bcd81-150">在这种情况下, 我们希望确保处理_所有_邮件, 或不处理任何邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-150">In this case, we want to make sure _all_ messages get processed, or none of them are processed.</span></span> <span data-ttu-id="bcd81-151">如果信用卡邮件未送达且所有订单均未付款, 我们将不会在业务中长时间地完成!</span><span class="sxs-lookup"><span data-stu-id="bcd81-151">We won't be in business long if the credit card message is not delivered, and all our orders are fulfilled without payment!</span></span> <span data-ttu-id="bcd81-152">通过将这两个邮件组合到一个事务中, 可以避免这些类型的问题。</span><span class="sxs-lookup"><span data-stu-id="bcd81-152">You can avoid these kinds of problems by grouping the two messages into a transaction.</span></span> <span data-ttu-id="bcd81-153">就像在数据库世界中一样, 邮件事务以单个单位成功或失败。</span><span class="sxs-lookup"><span data-stu-id="bcd81-153">Message transactions succeed or fail as a single unit - just like in the database world.</span></span> <span data-ttu-id="bcd81-154">如果信用卡详细信息邮件传递失败, 则 "订单详细信息" 消息将会失败。</span><span class="sxs-lookup"><span data-stu-id="bcd81-154">If the credit card details message delivery fails, then so will the order details message.</span></span>

## <a name="which-service-should-i-choose"></a><span data-ttu-id="bcd81-155">我应选择哪种服务？</span><span class="sxs-lookup"><span data-stu-id="bcd81-155">Which service should I choose?</span></span>
<span data-ttu-id="bcd81-156">已理解, 此体系结构的通信策略应该是一条消息, 您必须选择是否使用 azure 存储队列或 Azure 服务总线, 这两种服务都可用于在组件之间存储和传递邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-156">Having understood that the communication strategy for this architecture should be a message, you must choose whether to use Azure Storage queues or Azure Service Bus, both of which can be used to store and deliver messages between your components.</span></span> <span data-ttu-id="bcd81-157">每个功能集都略有不同的功能集, 这意味着您可以选择其中一个或另一个, 也可以使用这两者, 具体取决于您要解决的问题。</span><span class="sxs-lookup"><span data-stu-id="bcd81-157">Each has a slightly different feature set, which means you can choose one or the other, or use both, depending on the problem you are solving.</span></span>

#### <a name="choose-service-bus-topics-if"></a><span data-ttu-id="bcd81-158">选择服务总线主题 (如果</span><span class="sxs-lookup"><span data-stu-id="bcd81-158">Choose Service Bus Topics if</span></span>

- <span data-ttu-id="bcd81-159">您需要多个接收器来处理每封邮件</span><span class="sxs-lookup"><span data-stu-id="bcd81-159">you need multiple receivers to handle each message</span></span>


#### <a name="choose-service-bus-queues-if"></a><span data-ttu-id="bcd81-160">在以下情况中选择服务总线队列:</span><span class="sxs-lookup"><span data-stu-id="bcd81-160">Choose Service Bus queues if:</span></span>

- <span data-ttu-id="bcd81-161">您需要一项最多的交付保证。</span><span class="sxs-lookup"><span data-stu-id="bcd81-161">You need an At-Most-Once delivery guarantee.</span></span>
- <span data-ttu-id="bcd81-162">您需要一个 FIFO 保证。</span><span class="sxs-lookup"><span data-stu-id="bcd81-162">You need a FIFO guarantee.</span></span>
- <span data-ttu-id="bcd81-163">您需要将邮件分组为事务。</span><span class="sxs-lookup"><span data-stu-id="bcd81-163">You need to group messages into transactions.</span></span>
- <span data-ttu-id="bcd81-164">您希望在不轮询队列的情况下接收邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-164">You want to receive messages without polling the queue.</span></span>
- <span data-ttu-id="bcd81-165">您需要为队列提供基于角色的访问模型。</span><span class="sxs-lookup"><span data-stu-id="bcd81-165">You need to provide a role-based access model to the queues.</span></span>
- <span data-ttu-id="bcd81-166">您需要处理大于 64 kb 但小于 256 kb 的邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-166">You need to handle messages larger than 64 KB but less than 256 KB.</span></span>
- <span data-ttu-id="bcd81-167">您的队列大小不会增长大于 80 GB。</span><span class="sxs-lookup"><span data-stu-id="bcd81-167">Your queue size will not grow larger than 80 GB.</span></span>
- <span data-ttu-id="bcd81-168">您希望能够发布和使用批量邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-168">You would like to be able to publish and consume batches of messages.</span></span>

<span data-ttu-id="bcd81-169">队列存储不像功能丰富, 但如果您不需要这些功能中的任何一个, 则可以选择更简单的方法。</span><span class="sxs-lookup"><span data-stu-id="bcd81-169">Queue storage isn't quite as feature-rich, but if you don't need any of those features, it can be a simpler choice.</span></span> <span data-ttu-id="bcd81-170">此外, 如果您的应用程序具有以下任一要求, 它也是最佳解决方案。</span><span class="sxs-lookup"><span data-stu-id="bcd81-170">In addition, it's the best solution if your app has any of the following requirements.</span></span>

#### <a name="choose-queue-storage-if"></a><span data-ttu-id="bcd81-171">在以下情况中选择队列存储:</span><span class="sxs-lookup"><span data-stu-id="bcd81-171">Choose Queue storage if:</span></span>

- <span data-ttu-id="bcd81-172">您需要通过队列的所有邮件的审核跟踪。</span><span class="sxs-lookup"><span data-stu-id="bcd81-172">You need an audit trail of all messages that pass through the queue.</span></span>
- <span data-ttu-id="bcd81-173">您预计队列的大小超过 80 GB。</span><span class="sxs-lookup"><span data-stu-id="bcd81-173">You expect the queue to exceed 80 GB in size.</span></span>
- <span data-ttu-id="bcd81-174">您希望跟踪队列中的邮件处理进度。</span><span class="sxs-lookup"><span data-stu-id="bcd81-174">You want to track progress for processing a message inside of the queue.</span></span>

<span data-ttu-id="bcd81-175">队列是一个简单的临时存储位置, 用于在分布式应用程序的组件之间发送的邮件。</span><span class="sxs-lookup"><span data-stu-id="bcd81-175">A queue is a simple, temporary storage location for messages sent between the components of a distributed application.</span></span> <span data-ttu-id="bcd81-176">使用队列可对邮件进行组织, 并妥善处理预期的不可预测的浪涌。</span><span class="sxs-lookup"><span data-stu-id="bcd81-176">Use a queue to organize messages and gracefully handle unpredictable surges in demand.</span></span> 

<span data-ttu-id="bcd81-177">当您需要简单而简单的代码队列系统时, 请使用存储队列。</span><span class="sxs-lookup"><span data-stu-id="bcd81-177">Use Storage queues when you want a simple and easy-to-code queue system.</span></span> <span data-ttu-id="bcd81-178">若要获得更高级的需求, 请使用服务总线队列。</span><span class="sxs-lookup"><span data-stu-id="bcd81-178">For more advanced needs, use Service Bus queues.</span></span> <span data-ttu-id="bcd81-179">如果您有单个邮件的多个目标, 但需要类似于队列的行为, 请使用主题。</span><span class="sxs-lookup"><span data-stu-id="bcd81-179">If you have multiple destinations for a single message, but need queue-like behavior, use topics.</span></span>