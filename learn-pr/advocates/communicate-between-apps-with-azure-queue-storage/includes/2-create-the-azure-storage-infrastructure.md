<span data-ttu-id="10bca-101">分布式应用程序组件之间的直接通信可能会出现问题, 因为当网络带宽较低或需求较高时, 它可能会中断。</span><span class="sxs-lookup"><span data-stu-id="10bca-101">Direct communication between the components of a distributed application can be problematic because it might be disrupted when network bandwidth is low or when demand is high.</span></span>

<span data-ttu-id="10bca-102">我们在我们的系统中看到了这一点: web 门户会调用 web 服务, 如果该服务及时响应, 这将非常有用。</span><span class="sxs-lookup"><span data-stu-id="10bca-102">We've seen this in our system: the web portal calls a web service, which works great if the service responds in a timely manner.</span></span> <span data-ttu-id="10bca-103">较高的流量会导致问题, 因此计划将使用队列消除前端应用程序和中间层 web 服务之间的直接链接。</span><span class="sxs-lookup"><span data-stu-id="10bca-103">High traffic causes problems and so the plan is to use a queue to eliminate the direct link between the front-end apps and your middle-tier web service.</span></span>

## <a name="what-is-azure-queue-storage"></a><span data-ttu-id="10bca-104">什么是 Azure 队列存储？</span><span class="sxs-lookup"><span data-stu-id="10bca-104">What is Azure Queue storage?</span></span>

<span data-ttu-id="10bca-105">azure 队列存储是一个实现基于云的队列的 azure 服务。</span><span class="sxs-lookup"><span data-stu-id="10bca-105">Azure Queue storage is an Azure service that implements cloud-based queues.</span></span> <span data-ttu-id="10bca-106">每个队列维护一系列邮件。</span><span class="sxs-lookup"><span data-stu-id="10bca-106">Each queue maintains a list of messages.</span></span> <span data-ttu-id="10bca-107">应用程序组件使用 REST API 或 Azure 提供的客户端库访问队列。</span><span class="sxs-lookup"><span data-stu-id="10bca-107">Application components access a queue using a REST API or an Azure-supplied client library.</span></span> <span data-ttu-id="10bca-108">通常情况下, 您将拥有一个或多个_发件人_组件以及一个或多个_接收器_组件。</span><span class="sxs-lookup"><span data-stu-id="10bca-108">Typically, you will have one or more _sender_ components and one or more _receiver_ components.</span></span> <span data-ttu-id="10bca-109">发件人组件将邮件添加到队列中。</span><span class="sxs-lookup"><span data-stu-id="10bca-109">Sender components add messages to the queue.</span></span> <span data-ttu-id="10bca-110">接收器组件从队列前端检索邮件以进行处理。</span><span class="sxs-lookup"><span data-stu-id="10bca-110">Receiver components retrieve messages from the front of the queue for processing.</span></span> <span data-ttu-id="10bca-111">下图显示了多个发件人应用程序将邮件添加到 Azure 队列和检索邮件的一个接收器应用程序。</span><span class="sxs-lookup"><span data-stu-id="10bca-111">The following illustration shows multiple sender applications adding messages to the Azure Queue and one receiver application retrieving the messages.</span></span>

![显示 Azure 队列存储的高级别体系结构的插图](../media/2-queue-overview.png)

<span data-ttu-id="10bca-113">定价基于队列大小和操作数。</span><span class="sxs-lookup"><span data-stu-id="10bca-113">Pricing is based on queue size and number of operations.</span></span> <span data-ttu-id="10bca-114">较大的邮件队列成本大于较小的队列。</span><span class="sxs-lookup"><span data-stu-id="10bca-114">Larger message queues cost more than smaller queues.</span></span> <span data-ttu-id="10bca-115">对于每个操作 (如添加邮件和删除邮件), 也会产生费用。</span><span class="sxs-lookup"><span data-stu-id="10bca-115">Charges are also incurred for each operation, such as adding a message and deleting a message.</span></span> <span data-ttu-id="10bca-116">有关定价详细信息, 请参阅[Azure 队列存储定价](https://azure.microsoft.com/pricing/details/storage/queues/)。</span><span class="sxs-lookup"><span data-stu-id="10bca-116">For pricing details, see [Azure Queue storage pricing](https://azure.microsoft.com/pricing/details/storage/queues/).</span></span>

## <a name="why-use-queues"></a><span data-ttu-id="10bca-117">为什么要使用队列？</span><span class="sxs-lookup"><span data-stu-id="10bca-117">Why use queues?</span></span>

<span data-ttu-id="10bca-118">队列通过临时存储等待邮件来提高恢复能力。</span><span class="sxs-lookup"><span data-stu-id="10bca-118">A queue increases resiliency by temporarily storing waiting messages.</span></span> <span data-ttu-id="10bca-119">在低需求或普通需求的情况下, 队列的大小会保持很小, 因为目标组件从队列中删除邮件的速度比添加的邮件快。</span><span class="sxs-lookup"><span data-stu-id="10bca-119">At times of low or normal demand, the size of the queue remains small because the destination component removes messages from the queue faster than they are added.</span></span> <span data-ttu-id="10bca-120">在高需求的情况下, 队列的大小可能会增加, 但邮件不会丢失。</span><span class="sxs-lookup"><span data-stu-id="10bca-120">At times of high demand, the queue may increase in size, but messages are not lost.</span></span> <span data-ttu-id="10bca-121">目标组件可以在按需返回正常状态时捕获队列并清空队列。</span><span class="sxs-lookup"><span data-stu-id="10bca-121">The destination component can catch up and empty the queue as demand returns to normal.</span></span>

<span data-ttu-id="10bca-122">单个队列的大小最高可达**500 TB** , 因此可能会存储_数百万_封邮件。</span><span class="sxs-lookup"><span data-stu-id="10bca-122">A single queue can be up to **500 TB** in size, so it can potentially store _millions_ of messages.</span></span> <span data-ttu-id="10bca-123">单个队列的目标吞吐量为每秒2000个邮件, 从而使其可以处理高容量方案。</span><span class="sxs-lookup"><span data-stu-id="10bca-123">The target throughput for a single queue is 2000 messages per second, allowing it to handle high-volume scenarios.</span></span>

<span data-ttu-id="10bca-124">队列允许应用程序在需求更改时自动扩展和立即扩展。</span><span class="sxs-lookup"><span data-stu-id="10bca-124">Queues let your application scale automatically and immediately when demand changes.</span></span> <span data-ttu-id="10bca-125">这使它们对可能损坏的关键业务数据非常有用。</span><span class="sxs-lookup"><span data-stu-id="10bca-125">This makes them useful for critical business data that would be damaging to lose.</span></span> <span data-ttu-id="10bca-126">Azure 提供了许多其他可自动扩展的服务。</span><span class="sxs-lookup"><span data-stu-id="10bca-126">Azure offers many other services that scale automatically.</span></span> <span data-ttu-id="10bca-127">例如,**自动缩放**功能在 Azure 虚拟机规模集、云服务、Azure 应用服务计划和应用服务环境中可用。</span><span class="sxs-lookup"><span data-stu-id="10bca-127">For example, the **Autoscale** feature is available on Azure virtual machine scale sets, cloud services, Azure App Service plans, and App Service environments.</span></span> <span data-ttu-id="10bca-128">这样, 您就可以定义 Azure 用来确定高需求时段的规则, 并在不涉及管理员的情况下自动添加容量。</span><span class="sxs-lookup"><span data-stu-id="10bca-128">This lets you define rules that Azure uses to identify periods of high demand and automatically add capacity without involving an administrator.</span></span> <span data-ttu-id="10bca-129">自动缩放快速响应需求, 但不是即时。</span><span class="sxs-lookup"><span data-stu-id="10bca-129">Autoscaling responds to demand quickly, but not instantaneously.</span></span> <span data-ttu-id="10bca-130">相比之下, Azure 队列存储在处理资源可用之前, 通过存储邮件即时处理高需求。</span><span class="sxs-lookup"><span data-stu-id="10bca-130">By contrast, Azure Queue storage instantaneously handles high demand by storing messages until processing resources are available.</span></span>

## <a name="what-is-a-message"></a><span data-ttu-id="10bca-131">什么是邮件？</span><span class="sxs-lookup"><span data-stu-id="10bca-131">What is a message?</span></span>

<span data-ttu-id="10bca-132">队列中的消息是最大为 64 KB 的字节数组。</span><span class="sxs-lookup"><span data-stu-id="10bca-132">A message in a queue is a byte array of up to 64 KB.</span></span> <span data-ttu-id="10bca-133">任何 Azure 组件根本不会解释邮件内容。</span><span class="sxs-lookup"><span data-stu-id="10bca-133">Message contents are not interpreted at all by any Azure component.</span></span>

<span data-ttu-id="10bca-134">如果要创建结构化邮件, 可以使用 XML 或 JSON 格式化邮件内容。</span><span class="sxs-lookup"><span data-stu-id="10bca-134">If you want to create a structured message, you could format the message content using XML or JSON.</span></span> <span data-ttu-id="10bca-135">您的代码负责生成和解释您的自定义格式。</span><span class="sxs-lookup"><span data-stu-id="10bca-135">Your code is responsible for generating and interpreting your custom format.</span></span> <span data-ttu-id="10bca-136">例如, 您可以创建类似于以下内容的自定义 JSON 消息:</span><span class="sxs-lookup"><span data-stu-id="10bca-136">For example, you could make a custom JSON message that looks like the following:</span></span>

```json
{
    "Message": {
        "To": "news@contoso.com",
        "From": "writer@contoso.com",
        "Subject": "Support request",
        "Body": "Send me a photographer!"
    }
}
```

## <a name="creating-a-storage-account"></a><span data-ttu-id="10bca-137">创建存储帐户</span><span class="sxs-lookup"><span data-stu-id="10bca-137">Creating a storage account</span></span>

<span data-ttu-id="10bca-138">队列必须是存储帐户的一部分。</span><span class="sxs-lookup"><span data-stu-id="10bca-138">A queue must be part of a storage account.</span></span> <span data-ttu-id="10bca-139">您可以使用 azure CLI (或 PowerShell) 或 azure 门户创建存储帐户。</span><span class="sxs-lookup"><span data-stu-id="10bca-139">You can create a storage account using the Azure CLI (or PowerShell), or Azure portal.</span></span> <span data-ttu-id="10bca-140">门户是最简单的, 因为它是全引导的, 并提示您提供每条信息。</span><span class="sxs-lookup"><span data-stu-id="10bca-140">The portal is easiest because it's all guided and prompts you for each piece of information.</span></span> 

<span data-ttu-id="10bca-141">下面的屏幕截图显示存储帐户类别的位置。</span><span class="sxs-lookup"><span data-stu-id="10bca-141">The following screenshot shows the location of the Storage accounts category.</span></span>

![突出显示 "存储帐户" 类别的 "所有服务" 边栏屏幕截图。](../media/2-create-storage-account-1.png)

<span data-ttu-id="10bca-143">您可以在创建帐户时提供多个选项, 您可以在其中使用默认选择。</span><span class="sxs-lookup"><span data-stu-id="10bca-143">There are several options you can supply when you create the account, most of which you can use the default selection.</span></span> <span data-ttu-id="10bca-144">我们在以前的模块中介绍了这些选项, 但您可以将`(i)`其悬停在与每个选项相关联的提示上, 以获取它所执行的操作的提示。</span><span class="sxs-lookup"><span data-stu-id="10bca-144">We covered these options in a previous module, but you can hover over the `(i)` tip associated with each option to get a reminder of what it does.</span></span> <span data-ttu-id="10bca-145">下面的示例展示了如何填写门户边栏。</span><span class="sxs-lookup"><span data-stu-id="10bca-145">Here's an example of filling out the portal blade.</span></span>

<span data-ttu-id="10bca-146">下面的屏幕截图显示了创建存储帐户刀片和创建存储帐户所需的信息。</span><span class="sxs-lookup"><span data-stu-id="10bca-146">The following screenshot displays the Create storage account blade and the information required to create a storage account.</span></span>

![创建存储帐户边栏显示要在创建存储帐户时指定的选项的屏幕截图。](../media/2-create-storage-account-2.png)

### <a name="settings-for-queues"></a><span data-ttu-id="10bca-148">队列设置</span><span class="sxs-lookup"><span data-stu-id="10bca-148">Settings for queues</span></span>
<span data-ttu-id="10bca-149">当您创建将包含队列的存储帐户时, 应考虑以下设置:</span><span class="sxs-lookup"><span data-stu-id="10bca-149">When you create a storage account that will contain queues, you should consider the following settings:</span></span>

- <span data-ttu-id="10bca-150">队列仅作为 Azure 常规用途存储帐户 (v1 或 v2) 的一部分提供。</span><span class="sxs-lookup"><span data-stu-id="10bca-150">Queues are only available as part of Azure general-purpose storage accounts (v1 or v2).</span></span> <span data-ttu-id="10bca-151">无法将其添加到 Blob 存储帐户。</span><span class="sxs-lookup"><span data-stu-id="10bca-151">You cannot add them to Blob storage accounts.</span></span>
- <span data-ttu-id="10bca-152">为 StorageV2 帐户显示的**访问层**设置仅适用于 Blob 存储, 不会影响队列。</span><span class="sxs-lookup"><span data-stu-id="10bca-152">The **Access tier** setting which is shown for StorageV2 accounts applies only to Blob storage and does not affect queues.</span></span>
- <span data-ttu-id="10bca-153">您应选择一个接近源组件或目标组件的位置, 或者 (最好是这两个)。</span><span class="sxs-lookup"><span data-stu-id="10bca-153">You should choose a location that is close to either the source components or destination components or (preferably) both.</span></span>
- <span data-ttu-id="10bca-154">始终将数据复制到多台服务器, 以防止磁盘故障和其他硬件问题。</span><span class="sxs-lookup"><span data-stu-id="10bca-154">Data is always replicated to multiple servers to guard against disk failures and other hardware problems.</span></span> <span data-ttu-id="10bca-155">您可以选择复制策略:**本地冗余存储 (LRS)** 是低成本的, 但易受影响整个数据中心的灾难, 而**地域冗余存储 (GRS)** 将数据复制到其他 Azure 数据中心。</span><span class="sxs-lookup"><span data-stu-id="10bca-155">You have a choice of replication strategies: **Locally Redundant Storage (LRS)** is low-cost but vulnerable to disasters that affect an entire data center while **Geo-Redundant Storage (GRS)** replicates data to other Azure data centers.</span></span> <span data-ttu-id="10bca-156">选择满足您的冗余需求的复制策略。</span><span class="sxs-lookup"><span data-stu-id="10bca-156">Choose the replication strategy that meets your redundancy needs.</span></span>
- <span data-ttu-id="10bca-157">性能层决定了邮件的存储方式:**标准**使用磁驱动器, 而**Premium**使用固态驱动器。</span><span class="sxs-lookup"><span data-stu-id="10bca-157">The performance tier determines how your message are stored: **Standard** uses magnetic drives while **Premium** uses solid-state drives.</span></span> <span data-ttu-id="10bca-158">如果预计要求峰值较短, 请选择 "标准"。</span><span class="sxs-lookup"><span data-stu-id="10bca-158">Choose Standard if you expect peaks in demand to be short.</span></span> <span data-ttu-id="10bca-159">如果队列长度有时会变长, 并且需要最大限度地减少访问邮件的时间, 请考虑 "高级"。</span><span class="sxs-lookup"><span data-stu-id="10bca-159">Consider Premium if queue length sometimes becomes long and you need to minimize the time to access messages.</span></span>
- <span data-ttu-id="10bca-160">如果敏感信息可能通过队列传递, 则需要安全传输。</span><span class="sxs-lookup"><span data-stu-id="10bca-160">Require secure transfer if sensitive information may pass through the queue.</span></span> <span data-ttu-id="10bca-161">此设置可确保使用安全套接字层 (SSL) 对队列的所有连接进行加密。</span><span class="sxs-lookup"><span data-stu-id="10bca-161">This setting ensures that all connections to the queue are encrypted using Secure Sockets Layer (SSL).</span></span>