分布式应用程序组件之间的直接通信可能会出现问题, 因为当网络带宽较低或需求较高时, 它可能会中断。

我们在我们的系统中看到了这一点: web 门户会调用 web 服务, 如果该服务及时响应, 这将非常有用。 较高的流量会导致问题, 因此计划将使用队列消除前端应用程序和中间层 web 服务之间的直接链接。

## <a name="what-is-azure-queue-storage"></a>什么是 Azure 队列存储？

azure 队列存储是一个实现基于云的队列的 azure 服务。 每个队列维护一系列邮件。 应用程序组件使用 REST API 或 Azure 提供的客户端库访问队列。 通常情况下, 您将拥有一个或多个_发件人_组件以及一个或多个_接收器_组件。 发件人组件将邮件添加到队列中。 接收器组件从队列前端检索邮件以进行处理。 下图显示了多个发件人应用程序将邮件添加到 Azure 队列和检索邮件的一个接收器应用程序。

![显示 Azure 队列存储的高级别体系结构的插图](../media/2-queue-overview.png)

定价基于队列大小和操作数。 较大的邮件队列成本大于较小的队列。 对于每个操作 (如添加邮件和删除邮件), 也会产生费用。 有关定价详细信息, 请参阅[Azure 队列存储定价](https://azure.microsoft.com/pricing/details/storage/queues/)。

## <a name="why-use-queues"></a>为什么要使用队列？

队列通过临时存储等待邮件来提高恢复能力。 在低需求或普通需求的情况下, 队列的大小会保持很小, 因为目标组件从队列中删除邮件的速度比添加的邮件快。 在高需求的情况下, 队列的大小可能会增加, 但邮件不会丢失。 目标组件可以在按需返回正常状态时捕获队列并清空队列。

单个队列的大小最高可达**500 TB** , 因此可能会存储_数百万_封邮件。 单个队列的目标吞吐量为每秒2000个邮件, 从而使其可以处理高容量方案。

队列允许应用程序在需求更改时自动扩展和立即扩展。 这使它们对可能损坏的关键业务数据非常有用。 Azure 提供了许多其他可自动扩展的服务。 例如,**自动缩放**功能在 Azure 虚拟机规模集、云服务、Azure 应用服务计划和应用服务环境中可用。 这样, 您就可以定义 Azure 用来确定高需求时段的规则, 并在不涉及管理员的情况下自动添加容量。 自动缩放快速响应需求, 但不是即时。 相比之下, Azure 队列存储在处理资源可用之前, 通过存储邮件即时处理高需求。

## <a name="what-is-a-message"></a>什么是邮件？

队列中的消息是最大为 64 KB 的字节数组。 任何 Azure 组件根本不会解释邮件内容。

如果要创建结构化邮件, 可以使用 XML 或 JSON 格式化邮件内容。 您的代码负责生成和解释您的自定义格式。 例如, 您可以创建类似于以下内容的自定义 JSON 消息:

```json
{
    "Message": {
        "To": "news@contoso.com",
        "From": "writer@contoso.com",
        "Subject": "Support request",
        "Body": "Send me a photographer!"
    }
}
```

## <a name="creating-a-storage-account"></a>创建存储帐户

队列必须是存储帐户的一部分。 您可以使用 azure CLI (或 PowerShell) 或 azure 门户创建存储帐户。 门户是最简单的, 因为它是全引导的, 并提示您提供每条信息。 

下面的屏幕截图显示存储帐户类别的位置。

![突出显示 "存储帐户" 类别的 "所有服务" 边栏屏幕截图。](../media/2-create-storage-account-1.png)

您可以在创建帐户时提供多个选项, 您可以在其中使用默认选择。 我们在以前的模块中介绍了这些选项, 但您可以将`(i)`其悬停在与每个选项相关联的提示上, 以获取它所执行的操作的提示。 下面的示例展示了如何填写门户边栏。

下面的屏幕截图显示了创建存储帐户刀片和创建存储帐户所需的信息。

![创建存储帐户边栏显示要在创建存储帐户时指定的选项的屏幕截图。](../media/2-create-storage-account-2.png)

### <a name="settings-for-queues"></a>队列设置
当您创建将包含队列的存储帐户时, 应考虑以下设置:

- 队列仅作为 Azure 常规用途存储帐户 (v1 或 v2) 的一部分提供。 无法将其添加到 Blob 存储帐户。
- 为 StorageV2 帐户显示的**访问层**设置仅适用于 Blob 存储, 不会影响队列。
- 您应选择一个接近源组件或目标组件的位置, 或者 (最好是这两个)。
- 始终将数据复制到多台服务器, 以防止磁盘故障和其他硬件问题。 您可以选择复制策略:**本地冗余存储 (LRS)** 是低成本的, 但易受影响整个数据中心的灾难, 而**地域冗余存储 (GRS)** 将数据复制到其他 Azure 数据中心。 选择满足您的冗余需求的复制策略。
- 性能层决定了邮件的存储方式:**标准**使用磁驱动器, 而**Premium**使用固态驱动器。 如果预计要求峰值较短, 请选择 "标准"。 如果队列长度有时会变长, 并且需要最大限度地减少访问邮件的时间, 请考虑 "高级"。
- 如果敏感信息可能通过队列传递, 则需要安全传输。 此设置可确保使用安全套接字层 (SSL) 对队列的所有连接进行加密。