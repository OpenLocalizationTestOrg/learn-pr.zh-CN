您的团队已决定利用 Azure 事件中心的功能来管理和处理系统中不断增加的事务量。

事件中心是 azure 资源, 因此第一步是在 azure 中创建新集线器, 并将其配置为符合应用程序的特定要求。

## <a name="what-is-an-azure-event-hub"></a>什么是 Azure 事件中心？

Azure 事件中心是一项基于云的事件处理服务, 能够接收和处理数百万个事件 (每秒)。 事件中心充当事件管道的前向门, 在其中接收传入的数据并存储它, 直到处理资源可用。

将数据发送到事件中心的实体称为 "*发布者*", 从事件中心读取数据的实体称为 "*使用者*" 或 "*订阅*者"。 Azure 事件中心位于这两个实体之间, 用于划分事件流的生产 (从发布服务器) 和消耗 (到订阅者)。 这种分离有助于管理事件生产速率高于消耗量的情况。 下图显示了事件中心的角色。

![显示在四个发布者和两个订阅者之间放置的 Azure 事件中心的插图。 事件中心接收来自发布服务器的多个事件, 将事件序列化为数据流, 并使订阅者可以使用数据流。](../media/2-event-hub-overview.png)

### <a name="events"></a>事件

**事件**是包含通知的小型信息数据包 (*数据报*)。 事件可以单独发布, 也可以成批发布, 但单个出版物 (个人或批处理) 不能超过 256 KB。

### <a name="publishers-and-subscribers"></a>发布服务器和订阅者

事件发布者是可以使用 HTTPS 或高级消息队列协议 (AMQP) 1.0 发送事件的任何应用程序或设备。

对于经常发送数据的发布服务器, AMQP 具有更好的性能。 但是, 它会有更高的初始会话开销, 因为必须首先设置持久性双向套接字和传输级别安全性 (TLS) 或 SSL/TLS。 

若要进行更多间歇发布, HTTPS 是更好的选择。 尽管 HTTPS 对每个请求都需要额外开销, 但没有会话初始化开销。

> [!NOTE] 
> 使用 Apache Kafka 1.0 和更高版本的客户端版本的基于 Kafka 的现有客户端也可以充当事件中心发布者。

事件订阅者是使用两种受支持的编程方法之一来接收和处理来自事件中心的事件的应用程序。

- **EventHubReceiver** -提供有限的管理选项的简单方法。
- **EventProcessorHost** -我们稍后将在本模块中使用的一种有效方法。

### <a name="consumer-groups"></a>使用者组

事件中心**使用者组**表示事件中心数据流的特定视图。 通过使用单独的使用者组, 多个订阅者应用程序可以独立处理事件流, 而不会影响其他应用程序。 但是, 不要求使用多个使用者组, 而对于许多应用程序, 单个默认的使用者组就足够了。

### <a name="pricing"></a>特价

Azure 事件中心有三个定价层: Basic、Standard 和专职。 层的不同之处在于受支持的连接的数量、可用的使用者组数以及吞吐量。 使用 Azure CLI 创建事件中心命名空间时, 如果不指定定价层, 则分配默认的**标准**(20 个使用者组、1000个连接)。

## <a name="creating-and-configuring-a-new-azure-event-hubs"></a>创建和配置新的 Azure 事件中心

创建和配置新的 Azure 事件中心时有两个主要步骤。 第一步是定义事件中心**命名空间**。 第二步是在该命名空间中创建事件中心。

### <a name="defining-an-event-hubs-namespace"></a>定义事件中心命名空间

事件中心命名空间是用于管理一个或多个事件中心的包含实体。 创建事件中心命名空间通常涉及以下内容:

1. 定义命名空间级设置。 某些设置 (如命名空间容量配置使用**吞吐量单位**)、定价层和性能指标在命名空间级定义。 这些应用程序适用于该命名空间中的所有事件中心。 如果未定义这些设置, 则将使用默认值: *1*表示价格层的容量和*标准*。

    一旦设置了吞吐量单位, 就不能再对其进行更改。 您必须将您的配置与您的 Azure 预算预期进行权衡。 您可以考虑为不同的吞吐量要求配置不同的事件中心。 例如, 如果您有一个销售数据应用程序, 并且正在规划两个事件中心, 一个用于实时销售数据遥测的高吞吐量集合, 另一个用于不经常发生的事件日志收集, 则对每个中心使用单独的命名空间是有意义的。 这样一来, 您只需在遥测集线器上配置 (和支付) 高吞吐量容量。

1. 为命名空间选择唯一名称。 可通过此 url 访问命名空间: * __ servicebus.windows.net*

1. 定义以下可选属性:

    - 启用 Kafka。 此选项使 Kafka 应用程序能够将事件发布到事件中心。
    - 将此命名空间区域设为冗余。 区域冗余跨不同的数据中心复制数据, 其自身独立的电源、网络和冷却基础结构。
    - 启用自动大吞吐量和自动放入最大吞吐量单位。 通过将吞吐量单位的数量增加到最大值, 自动扩展可提供自动向上扩展选项。 这有助于避免在传入或传出数据速率超出当前设置的吞吐量单位的情况下进行限制。

### <a name="azure-cli-commands-for-creating-an-event-hubs-namespace"></a>用于创建事件中心命名空间的 Azure CLI 命令

若要创建新的事件中心命名空间, 您将`az eventhubs namespace`使用这些命令。 以下是我们将在练习中使用的子命令的简短说明。

| 指挥 | 说明 |
|---------|-------------|
| `create` | 创建事件中心命名空间。 |
| `authorization-rule` | 同一事件中心命名空间中的所有事件中心共享公用连接凭据。 当您将应用程序配置为使用事件中心发送和接收邮件时, 将需要这些凭据。 此命令返回事件中心命名空间的连接字符串。 |

### <a name="configuring-a-new-event-hub"></a>配置新的事件中心

创建事件中心命名空间后, 可以创建事件中心。 创建新的事件中心时, 有几个强制参数。

创建事件中心需要以下参数:

- **事件中心名称**-在订阅中唯一的事件中心名称和:
  - 长度介于1到50个字符之间
  - 仅包含字母、数字、句点、连字符和下划线
  - 以字母或数字开头和结尾
- **分区计数**-事件中心中所需的分区数 (介于2和32之间)。 应直接与预期的并发使用者数相关。 创建中心后, 不能更改此字段。 分区将分隔邮件流, 以便使用者或接收器应用程序只需读取数据流的特定子集。 如果未定义, 则默认值为*4*。
- **邮件保留**时间 (1 到7之间的天数), 如果由于某种原因需要重播数据流, 则邮件将保持可用。 如果未定义, 则默认为*7*。

您还可以选择将事件中心配置为将数据流式传输到 azure Blob 存储或 azure data Lake store 帐户。

### <a name="azure-cli-commands-for-creating-an-event-hub"></a>用于创建事件中心的 Azure CLI 命令

若要使用 Azure CLI 创建新的事件中心, 您需要使用`az eventhubs eventhub`命令集。 以下是我们将使用的子命令的简要说明:

| 指挥 | 说明 |
|---------|-------------|
| `create` | 这将在指定的命名空间中创建事件中心。 |
| `show` | 这将显示事件中心的详细信息。 |

## <a name="summary"></a>摘要

若要部署 Azure 事件中心, 必须配置事件中心命名空间, 然后配置事件中心本身。 在下一节中, 您将完成详细的配置步骤, 以创建新的命名空间和事件中心。