我们已看到您可以选择预测磁盘性能的设置和属性, 现在让我们来看一下通过_缓存_改进的方法。

## <a name="disk-caching"></a>磁盘缓存

缓存是存储数据的专用组件, 通常位于内存中, 以便可以更快地访问它。 缓存中的数据通常是之前已读过的数据, 或者是以前的计算产生的数据。 目标是比从磁盘获取数据更快地访问数据。

缓存使用专用的、有时成本较高的临时存储, 与永久存储相比具有更快的读取和写入性能。 由于缓存存储经常受到限制, 因此需要做出的决策取决于缓存的最大数据操作对哪些方面的好处。 但是, 即使在可以广泛地提供缓存 (如在 Azure 中), 在决定使用哪种缓存类型之前, 了解每个磁盘的工作负荷模式仍然很重要。

**读取缓存**尝试加快数据_检索_速度。 从更快的缓存中读取数据, 而不是从永久存储区读取。 在下列情况下, 数据读取命中缓存:

- 数据已在缓存中读取和已存在。
- 缓存大小足以容纳所有数据。

需要注意的重要一点是, 读缓存在对读取队列有一定的可_预测_性时, 例如一组顺序读取。 对于随机 i/o, 要访问的数据分散在存储中, 缓存将很少或没有好处, 甚至可以降低磁盘性能。

**写缓存**尝试加快将_数据写入_永久存储的速度。 通过使用写缓存, 应用可以考虑要保存的数据。 实际上, 数据在缓存中排队, 等待写入磁盘。 您可以想象, 这种机制可能是可能的故障点, 如系统在写入缓存数据之前关机。 有些系统 (如 SQL Server) 会将缓存数据单独处理写入永久磁盘存储。

### <a name="azure-disk-caching"></a>Azure 磁盘缓存

有两种类型的磁盘缓存需要考虑磁盘存储:

- Azure 存储缓存
- Azure 虚拟机 (VM) 磁盘缓存

azure 存储缓存为 azure Blob 存储、azure 文件和 azure 中的其他内容提供缓存服务。 这些类型的缓存的配置超出了本模块的范围。

azure 虚拟机磁盘缓存是为了优化对附加到 Azure 虚拟机的虚拟硬盘 (VHD) 文件的读取和写入访问。 我们将重点介绍此模块中的磁盘缓存。

### <a name="azure-virtual-machine-disk-types"></a>Azure 虚拟机磁盘类型

有三种类型的用于 Azure 虚拟机的磁盘:

- **OS 磁盘**: 创建 azure VM 时, azure 会自动为操作系统 (OS) 附加 VHD。

- **临时磁盘**: 创建 azure VM 时, azure 也会自动添加临时磁盘。 此磁盘用于数据, 如页面和交换文件。 在维护或 VM 重新部署过程中, 此磁盘上的数据可能会丢失。 请勿使用它来存储永久数据, 如数据库文件或事务日志。

- **数据磁盘**: 数据磁盘是连接到虚拟机以存储应用程序数据或需要保留的其他数据的 VHD。

操作系统磁盘和数据磁盘利用 Azure VM 磁盘缓存。 vm 磁盘的缓存大小取决于 vm 实例的大小和 vm 上装载的磁盘数。 只能为最大为四个数据磁盘启用缓存。

## <a name="cache-options-for-azure-vms"></a>Azure 虚拟机的缓存选项

虚拟机磁盘缓存有三个常用选项:

- **读/写**–回写高速缓存。 仅当应用程序在需要时正确处理将缓存数据写入永久性磁盘时, 才使用此选项。
- **只读**-读取是从缓存中完成的。
- **无**-无缓存。 为只写和写粗磁盘选择此选项。 日志文件是一个很好的候选方案, 因为它们是写操作。

并不是每个缓存选项都适用于每种类型的磁盘。 下表显示了每种磁盘类型的缓存选项:

|               | **只读**  | **读/写** | **None** |
|---------------|----------------|----------------|----------|
| OS 磁盘       | 是            | 是 (默认)  | 是      |
| 数据磁盘     | 是 (默认)  | 是            | 是      |
| 临时磁盘     | 否             | 否             | 否       |

> [!NOTE]
> 对于**L 系列**和**B 系列**虚拟机, 无法更改磁盘缓存选项。

## <a name="performance-considerations-for-azure-vm-disk-caching"></a>Azure VM 磁盘缓存的性能注意事项

那么, 您的缓存设置如何影响 Azure vm 上运行的工作负荷的性能？

### <a name="os-disk"></a>OS 磁盘

对于 VM OS 磁盘, 默认行为是在读/写模式下使用缓存。 如果您的应用程序将数据文件存储在 OS 磁盘上, 并且应用程序对数据文件执行大量随机读/写操作, 请考虑将这些文件移动到已关闭缓存的数据磁盘。 为什么？ 嗯, 如果读取队列不包含顺序读取, 缓存将很少或没有任何好处。 维护缓存的开销 (如数据是连续的) 可能会降低磁盘性能。

### <a name="data-disks"></a>数据磁盘

对于性能敏感的应用程序, 应使用数据磁盘, 而不是 OS 磁盘。 通过使用单独的磁盘, 可以为每个磁盘配置适当的缓存设置。

例如, 在运行 SQL Server 的 Azure vm 上启用数据磁盘上的**只读**缓存 (对于常规数据和 TempDB 数据) 可能会导致显著的性能改进。 另一方面, 日志文件是不进行缓存的数据磁盘的理想候选项。

> [!WARNING]
> 更改 Azure 磁盘的缓存设置分离, 然后将目标磁盘。 如果它是操作系统磁盘, 则会重新启动虚拟机。 在更改磁盘缓存设置之前, 请停止可能影响此中断的所有应用程序/服务。

您可以使用以下任一工具配置虚拟机磁盘缓存设置:

- Azure 门户
- Azure CLI
- Azure PowerShell
- 资源管理器模板

## <a name="using-the-azure-portal-to-configure-caching"></a>使用 Azure 门户配置缓存

使用 Azure 门户设置新的 VM 时, 不能在部署虚拟机之前将 OS 磁盘的默认缓存配置更改为读/写模式。

将数据磁盘添加到现有 VM 中时, 可以在将磁盘部署到 VM 之前配置缓存选项。

更改 Azure 磁盘的缓存设置分离和将目标磁盘。 如果它是操作系统磁盘, 则会重新启动虚拟机。 在更改磁盘缓存设置之前, 请停止可能影响此中断的所有应用程序/服务。

让我们创建一个 VM, 并使用 Azure 门户更改缓存设置。
