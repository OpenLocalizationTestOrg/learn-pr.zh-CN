<span data-ttu-id="9d75a-101">我们已看到您可以选择预测磁盘性能的设置和属性, 现在让我们来看一下通过_缓存_改进的方法。</span><span class="sxs-lookup"><span data-stu-id="9d75a-101">We've seen settings and properties you can select to predict your disk performance, now let's look at ways to improve that through _caching_.</span></span>

## <a name="disk-caching"></a><span data-ttu-id="9d75a-102">磁盘缓存</span><span class="sxs-lookup"><span data-stu-id="9d75a-102">Disk caching</span></span>

<span data-ttu-id="9d75a-103">缓存是存储数据的专用组件, 通常位于内存中, 以便可以更快地访问它。</span><span class="sxs-lookup"><span data-stu-id="9d75a-103">A cache is a specialized component that stores data, typically in memory so that it can be accessed more quickly.</span></span> <span data-ttu-id="9d75a-104">缓存中的数据通常是之前已读过的数据, 或者是以前的计算产生的数据。</span><span class="sxs-lookup"><span data-stu-id="9d75a-104">The data in a cache is often data that has been read previously or data that resulted from an earlier calculation.</span></span> <span data-ttu-id="9d75a-105">目标是比从磁盘获取数据更快地访问数据。</span><span class="sxs-lookup"><span data-stu-id="9d75a-105">The goal is to access data faster than getting it from the disk.</span></span>

<span data-ttu-id="9d75a-106">缓存使用专用的、有时成本较高的临时存储, 与永久存储相比具有更快的读取和写入性能。</span><span class="sxs-lookup"><span data-stu-id="9d75a-106">Caching uses specialized, and sometimes expensive, temporary storage that has faster read and write performance than permanent storage.</span></span> <span data-ttu-id="9d75a-107">由于缓存存储经常受到限制, 因此需要做出的决策取决于缓存的最大数据操作对哪些方面的好处。</span><span class="sxs-lookup"><span data-stu-id="9d75a-107">Because cache storage is often limited, decisions need to be made as to what data operations will benefit most from caching.</span></span> <span data-ttu-id="9d75a-108">但是, 即使在可以广泛地提供缓存 (如在 Azure 中), 在决定使用哪种缓存类型之前, 了解每个磁盘的工作负荷模式仍然很重要。</span><span class="sxs-lookup"><span data-stu-id="9d75a-108">But even where the cache can be made widely available, such as in Azure, it's still important to know the workload patterns of each disk before deciding which caching type to use.</span></span>

<span data-ttu-id="9d75a-109">**读取缓存**尝试加快数据_检索_速度。</span><span class="sxs-lookup"><span data-stu-id="9d75a-109">**Read caching** tries to speed up data _retrieval_.</span></span> <span data-ttu-id="9d75a-110">从更快的缓存中读取数据, 而不是从永久存储区读取。</span><span class="sxs-lookup"><span data-stu-id="9d75a-110">Instead of reading from permanent storage, the data is read from the faster cache.</span></span> <span data-ttu-id="9d75a-111">在下列情况下, 数据读取命中缓存:</span><span class="sxs-lookup"><span data-stu-id="9d75a-111">Data reads hit the cache under the following conditions:</span></span>

- <span data-ttu-id="9d75a-112">数据已在缓存中读取和已存在。</span><span class="sxs-lookup"><span data-stu-id="9d75a-112">The data has been read before and exists in the cache.</span></span>
- <span data-ttu-id="9d75a-113">缓存大小足以容纳所有数据。</span><span class="sxs-lookup"><span data-stu-id="9d75a-113">The cache is large enough to hold all the data.</span></span>

<span data-ttu-id="9d75a-114">需要注意的重要一点是, 读缓存在对读取队列有一定的可_预测_性时, 例如一组顺序读取。</span><span class="sxs-lookup"><span data-stu-id="9d75a-114">It's important to note that read caching helps when there is some _predictability_ to the read queue, such as a set of sequential reads.</span></span> <span data-ttu-id="9d75a-115">对于随机 i/o, 要访问的数据分散在存储中, 缓存将很少或没有好处, 甚至可以降低磁盘性能。</span><span class="sxs-lookup"><span data-stu-id="9d75a-115">For random I/O, where the data you're accessing is scattered across storage, caching will be of little or no benefit and can even reduce disk performance.</span></span>

<span data-ttu-id="9d75a-116">**写缓存**尝试加快将_数据写入_永久存储的速度。</span><span class="sxs-lookup"><span data-stu-id="9d75a-116">**Write caching** tries to speed up _writing data_ to persistent storage.</span></span> <span data-ttu-id="9d75a-117">通过使用写缓存, 应用可以考虑要保存的数据。</span><span class="sxs-lookup"><span data-stu-id="9d75a-117">By using a write cache, the app can consider the data to be saved.</span></span> <span data-ttu-id="9d75a-118">实际上, 数据在缓存中排队, 等待写入磁盘。</span><span class="sxs-lookup"><span data-stu-id="9d75a-118">In reality, the data is queued in a cache, waiting to be written to a disk.</span></span> <span data-ttu-id="9d75a-119">您可以想象, 这种机制可能是可能的故障点, 如系统在写入缓存数据之前关机。</span><span class="sxs-lookup"><span data-stu-id="9d75a-119">As you can imagine, this mechanism can be a potential point of failure, such as when a system shuts down before the cached data is written.</span></span> <span data-ttu-id="9d75a-120">有些系统 (如 SQL Server) 会将缓存数据单独处理写入永久磁盘存储。</span><span class="sxs-lookup"><span data-stu-id="9d75a-120">Some systems, such as SQL Server, handle writing cached data to persistent disk storage themselves.</span></span>

### <a name="azure-disk-caching"></a><span data-ttu-id="9d75a-121">Azure 磁盘缓存</span><span class="sxs-lookup"><span data-stu-id="9d75a-121">Azure disk caching</span></span>

<span data-ttu-id="9d75a-122">有两种类型的磁盘缓存需要考虑磁盘存储:</span><span class="sxs-lookup"><span data-stu-id="9d75a-122">There are two types of disk caching that concern disk storage:</span></span>

- <span data-ttu-id="9d75a-123">Azure 存储缓存</span><span class="sxs-lookup"><span data-stu-id="9d75a-123">Azure storage caching</span></span>
- <span data-ttu-id="9d75a-124">Azure 虚拟机 (VM) 磁盘缓存</span><span class="sxs-lookup"><span data-stu-id="9d75a-124">Azure virtual machine (VM) disk caching</span></span>

<span data-ttu-id="9d75a-125">azure 存储缓存为 azure Blob 存储、azure 文件和 azure 中的其他内容提供缓存服务。</span><span class="sxs-lookup"><span data-stu-id="9d75a-125">Azure storage caching provides cache services for Azure Blob storage, Azure Files, and other content in Azure.</span></span> <span data-ttu-id="9d75a-126">这些类型的缓存的配置超出了本模块的范围。</span><span class="sxs-lookup"><span data-stu-id="9d75a-126">Configuration of these types of cache is beyond the scope of this module.</span></span>

<span data-ttu-id="9d75a-127">azure 虚拟机磁盘缓存是为了优化对附加到 Azure 虚拟机的虚拟硬盘 (VHD) 文件的读取和写入访问。</span><span class="sxs-lookup"><span data-stu-id="9d75a-127">Azure virtual machine disk caching is about optimizing read and write access to the virtual hard disk (VHD) files attached to Azure VMs.</span></span> <span data-ttu-id="9d75a-128">我们将重点介绍此模块中的磁盘缓存。</span><span class="sxs-lookup"><span data-stu-id="9d75a-128">We'll focus on disk caching in this module.</span></span>

### <a name="azure-virtual-machine-disk-types"></a><span data-ttu-id="9d75a-129">Azure 虚拟机磁盘类型</span><span class="sxs-lookup"><span data-stu-id="9d75a-129">Azure virtual machine disk types</span></span>

<span data-ttu-id="9d75a-130">有三种类型的用于 Azure 虚拟机的磁盘:</span><span class="sxs-lookup"><span data-stu-id="9d75a-130">There are three types of disks used with Azure VMs:</span></span>

- <span data-ttu-id="9d75a-131">**OS 磁盘**: 创建 azure VM 时, azure 会自动为操作系统 (OS) 附加 VHD。</span><span class="sxs-lookup"><span data-stu-id="9d75a-131">**OS disk**: When you create an Azure VM, Azure automatically attaches a VHD for the operating system (OS).</span></span>

- <span data-ttu-id="9d75a-132">**临时磁盘**: 创建 azure VM 时, azure 也会自动添加临时磁盘。</span><span class="sxs-lookup"><span data-stu-id="9d75a-132">**Temporary disk**: When you create an Azure VM, Azure also automatically adds a temporary disk.</span></span> <span data-ttu-id="9d75a-133">此磁盘用于数据, 如页面和交换文件。</span><span class="sxs-lookup"><span data-stu-id="9d75a-133">This disk is used for data, such as page and swap files.</span></span> <span data-ttu-id="9d75a-134">在维护或 VM 重新部署过程中, 此磁盘上的数据可能会丢失。</span><span class="sxs-lookup"><span data-stu-id="9d75a-134">The data on this disk may be lost during maintenance or a VM redeploy.</span></span> <span data-ttu-id="9d75a-135">请勿使用它来存储永久数据, 如数据库文件或事务日志。</span><span class="sxs-lookup"><span data-stu-id="9d75a-135">Don't use it for storing permanent data, such as database files or transaction logs.</span></span>

- <span data-ttu-id="9d75a-136">**数据磁盘**: 数据磁盘是连接到虚拟机以存储应用程序数据或需要保留的其他数据的 VHD。</span><span class="sxs-lookup"><span data-stu-id="9d75a-136">**Data disks**: A data disk is a VHD that's attached to a virtual machine to store application data or other data you need to keep.</span></span>

<span data-ttu-id="9d75a-137">操作系统磁盘和数据磁盘利用 Azure VM 磁盘缓存。</span><span class="sxs-lookup"><span data-stu-id="9d75a-137">OS disks and data disks take advantage of Azure VM disk caching.</span></span> <span data-ttu-id="9d75a-138">vm 磁盘的缓存大小取决于 vm 实例的大小和 vm 上装载的磁盘数。</span><span class="sxs-lookup"><span data-stu-id="9d75a-138">The cache size for a VM disk depends on the VM instance size and the number of disks mounted on the VM.</span></span> <span data-ttu-id="9d75a-139">只能为最大为四个数据磁盘启用缓存。</span><span class="sxs-lookup"><span data-stu-id="9d75a-139">Caching can be enabled for only up to four data disks.</span></span>

## <a name="cache-options-for-azure-vms"></a><span data-ttu-id="9d75a-140">Azure 虚拟机的缓存选项</span><span class="sxs-lookup"><span data-stu-id="9d75a-140">Cache options for Azure VMs</span></span>

<span data-ttu-id="9d75a-141">虚拟机磁盘缓存有三个常用选项:</span><span class="sxs-lookup"><span data-stu-id="9d75a-141">There are three common options for VM disk caching:</span></span>

- <span data-ttu-id="9d75a-142">**读/写**–回写高速缓存。</span><span class="sxs-lookup"><span data-stu-id="9d75a-142">**Read/write** – Write-back cache.</span></span> <span data-ttu-id="9d75a-143">仅当应用程序在需要时正确处理将缓存数据写入永久性磁盘时, 才使用此选项。</span><span class="sxs-lookup"><span data-stu-id="9d75a-143">Use this option only if your application properly handles writing cached data to persistent disks when needed.</span></span>
- <span data-ttu-id="9d75a-144">**只读**-读取是从缓存中完成的。</span><span class="sxs-lookup"><span data-stu-id="9d75a-144">**Read-only** - Reads are done from the cache.</span></span>
- <span data-ttu-id="9d75a-145">**无**-无缓存。</span><span class="sxs-lookup"><span data-stu-id="9d75a-145">**None** - No cache.</span></span> <span data-ttu-id="9d75a-146">为只写和写粗磁盘选择此选项。</span><span class="sxs-lookup"><span data-stu-id="9d75a-146">Select this option for write-only and write-heavy disks.</span></span> <span data-ttu-id="9d75a-147">日志文件是一个很好的候选方案, 因为它们是写操作。</span><span class="sxs-lookup"><span data-stu-id="9d75a-147">Log files are a good candidate because they're write-heavy operations.</span></span>

<span data-ttu-id="9d75a-148">并不是每个缓存选项都适用于每种类型的磁盘。</span><span class="sxs-lookup"><span data-stu-id="9d75a-148">Not every caching option is available for each type of disk.</span></span> <span data-ttu-id="9d75a-149">下表显示了每种磁盘类型的缓存选项:</span><span class="sxs-lookup"><span data-stu-id="9d75a-149">The following table shows you the caching options for each disk type:</span></span>

|               | <span data-ttu-id="9d75a-150">**只读**</span><span class="sxs-lookup"><span data-stu-id="9d75a-150">**Read-only**</span></span>  | <span data-ttu-id="9d75a-151">**读/写**</span><span class="sxs-lookup"><span data-stu-id="9d75a-151">**Read/write**</span></span> | <span data-ttu-id="9d75a-152">**None**</span><span class="sxs-lookup"><span data-stu-id="9d75a-152">**None**</span></span> |
|---------------|----------------|----------------|----------|
| <span data-ttu-id="9d75a-153">OS 磁盘</span><span class="sxs-lookup"><span data-stu-id="9d75a-153">OS disk</span></span>       | <span data-ttu-id="9d75a-154">是</span><span class="sxs-lookup"><span data-stu-id="9d75a-154">yes</span></span>            | <span data-ttu-id="9d75a-155">是 (默认)</span><span class="sxs-lookup"><span data-stu-id="9d75a-155">yes (default)</span></span>  | <span data-ttu-id="9d75a-156">是</span><span class="sxs-lookup"><span data-stu-id="9d75a-156">yes</span></span>      |
| <span data-ttu-id="9d75a-157">数据磁盘</span><span class="sxs-lookup"><span data-stu-id="9d75a-157">Data disk</span></span>     | <span data-ttu-id="9d75a-158">是 (默认)</span><span class="sxs-lookup"><span data-stu-id="9d75a-158">yes (default)</span></span>  | <span data-ttu-id="9d75a-159">是</span><span class="sxs-lookup"><span data-stu-id="9d75a-159">yes</span></span>            | <span data-ttu-id="9d75a-160">是</span><span class="sxs-lookup"><span data-stu-id="9d75a-160">yes</span></span>      |
| <span data-ttu-id="9d75a-161">临时磁盘</span><span class="sxs-lookup"><span data-stu-id="9d75a-161">Temp disk</span></span>     | <span data-ttu-id="9d75a-162">否</span><span class="sxs-lookup"><span data-stu-id="9d75a-162">no</span></span>             | <span data-ttu-id="9d75a-163">否</span><span class="sxs-lookup"><span data-stu-id="9d75a-163">no</span></span>             | <span data-ttu-id="9d75a-164">否</span><span class="sxs-lookup"><span data-stu-id="9d75a-164">no</span></span>       |

> [!NOTE]
> <span data-ttu-id="9d75a-165">对于**L 系列**和**B 系列**虚拟机, 无法更改磁盘缓存选项。</span><span class="sxs-lookup"><span data-stu-id="9d75a-165">Disk caching options can't be changed for **L-Series** and **B-series** virtual machines.</span></span>

## <a name="performance-considerations-for-azure-vm-disk-caching"></a><span data-ttu-id="9d75a-166">Azure VM 磁盘缓存的性能注意事项</span><span class="sxs-lookup"><span data-stu-id="9d75a-166">Performance considerations for Azure VM disk caching</span></span>

<span data-ttu-id="9d75a-167">那么, 您的缓存设置如何影响 Azure vm 上运行的工作负荷的性能？</span><span class="sxs-lookup"><span data-stu-id="9d75a-167">So, how can your cache settings affect the performance of your workloads running on Azure VMs?</span></span>

### <a name="os-disk"></a><span data-ttu-id="9d75a-168">OS 磁盘</span><span class="sxs-lookup"><span data-stu-id="9d75a-168">OS disk</span></span>

<span data-ttu-id="9d75a-169">对于 VM OS 磁盘, 默认行为是在读/写模式下使用缓存。</span><span class="sxs-lookup"><span data-stu-id="9d75a-169">For a VM OS disk, the default behavior is to use the cache in read/write mode.</span></span> <span data-ttu-id="9d75a-170">如果您的应用程序将数据文件存储在 OS 磁盘上, 并且应用程序对数据文件执行大量随机读/写操作, 请考虑将这些文件移动到已关闭缓存的数据磁盘。</span><span class="sxs-lookup"><span data-stu-id="9d75a-170">If you have applications that store data files on the OS disk and the apps do lots of random read/write operations to data files, consider moving those files to a data disk that has the caching turned off.</span></span> <span data-ttu-id="9d75a-171">为什么？</span><span class="sxs-lookup"><span data-stu-id="9d75a-171">Why is that?</span></span> <span data-ttu-id="9d75a-172">嗯, 如果读取队列不包含顺序读取, 缓存将很少或没有任何好处。</span><span class="sxs-lookup"><span data-stu-id="9d75a-172">Well, if the read queue does not contain sequential reads, caching will be of little or no benefit.</span></span> <span data-ttu-id="9d75a-173">维护缓存的开销 (如数据是连续的) 可能会降低磁盘性能。</span><span class="sxs-lookup"><span data-stu-id="9d75a-173">The overhead of maintaining the cache, as if the data was sequential, can reduce disk performance.</span></span>

### <a name="data-disks"></a><span data-ttu-id="9d75a-174">数据磁盘</span><span class="sxs-lookup"><span data-stu-id="9d75a-174">Data disks</span></span>

<span data-ttu-id="9d75a-175">对于性能敏感的应用程序, 应使用数据磁盘, 而不是 OS 磁盘。</span><span class="sxs-lookup"><span data-stu-id="9d75a-175">For performance-sensitive applications, you should use data disks rather than the OS disk.</span></span> <span data-ttu-id="9d75a-176">通过使用单独的磁盘, 可以为每个磁盘配置适当的缓存设置。</span><span class="sxs-lookup"><span data-stu-id="9d75a-176">Using separate disks allows you to configure the appropriate cache settings for each one.</span></span>

<span data-ttu-id="9d75a-177">例如, 在运行 SQL Server 的 Azure vm 上启用数据磁盘上的**只读**缓存 (对于常规数据和 TempDB 数据) 可能会导致显著的性能改进。</span><span class="sxs-lookup"><span data-stu-id="9d75a-177">For example, on Azure VMs running SQL Server, enabling **Read-only** caching on the data disks (for regular and TempDB data) can result in significant performance improvements.</span></span> <span data-ttu-id="9d75a-178">另一方面, 日志文件是不进行缓存的数据磁盘的理想候选项。</span><span class="sxs-lookup"><span data-stu-id="9d75a-178">Log files, on the other hand, are good candidates for data disks with no caching.</span></span>

> [!WARNING]
> <span data-ttu-id="9d75a-179">更改 Azure 磁盘的缓存设置分离, 然后将目标磁盘。</span><span class="sxs-lookup"><span data-stu-id="9d75a-179">Changing the cache setting of an Azure disk detaches and then reattaches the target disk.</span></span> <span data-ttu-id="9d75a-180">如果它是操作系统磁盘, 则会重新启动虚拟机。</span><span class="sxs-lookup"><span data-stu-id="9d75a-180">If it's the operating system disk, the VM is restarted.</span></span> <span data-ttu-id="9d75a-181">在更改磁盘缓存设置之前, 请停止可能影响此中断的所有应用程序/服务。</span><span class="sxs-lookup"><span data-stu-id="9d75a-181">Stop all applications/services that might be affected by this disruption before changing the disk cache setting.</span></span>

<span data-ttu-id="9d75a-182">您可以使用以下任一工具配置虚拟机磁盘缓存设置:</span><span class="sxs-lookup"><span data-stu-id="9d75a-182">You can configure virtual machine disk cache settings with any of the following tools:</span></span>

- <span data-ttu-id="9d75a-183">Azure 门户</span><span class="sxs-lookup"><span data-stu-id="9d75a-183">Azure portal</span></span>
- <span data-ttu-id="9d75a-184">Azure CLI</span><span class="sxs-lookup"><span data-stu-id="9d75a-184">Azure CLI</span></span>
- <span data-ttu-id="9d75a-185">Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="9d75a-185">Azure PowerShell</span></span>
- <span data-ttu-id="9d75a-186">资源管理器模板</span><span class="sxs-lookup"><span data-stu-id="9d75a-186">Resource Manager templates</span></span>

## <a name="using-the-azure-portal-to-configure-caching"></a><span data-ttu-id="9d75a-187">使用 Azure 门户配置缓存</span><span class="sxs-lookup"><span data-stu-id="9d75a-187">Using the Azure portal to configure caching</span></span>

<span data-ttu-id="9d75a-188">使用 Azure 门户设置新的 VM 时, 不能在部署虚拟机之前将 OS 磁盘的默认缓存配置更改为读/写模式。</span><span class="sxs-lookup"><span data-stu-id="9d75a-188">When you provision a new VM using the Azure portal, you can't change the default caching configuration for the OS disk from read/write until the VM is deployed.</span></span>

<span data-ttu-id="9d75a-189">将数据磁盘添加到现有 VM 中时, 可以在将磁盘部署到 VM 之前配置缓存选项。</span><span class="sxs-lookup"><span data-stu-id="9d75a-189">When you add a data disk to an existing VM, you can configure the cache option before the disk is deployed to the VM.</span></span>

<span data-ttu-id="9d75a-190">更改 Azure 磁盘的缓存设置分离和将目标磁盘。</span><span class="sxs-lookup"><span data-stu-id="9d75a-190">Changing the cache setting of an Azure disk detaches and reattaches the target disk.</span></span> <span data-ttu-id="9d75a-191">如果它是操作系统磁盘, 则会重新启动虚拟机。</span><span class="sxs-lookup"><span data-stu-id="9d75a-191">If it's the operating system disk, the VM is restarted.</span></span> <span data-ttu-id="9d75a-192">在更改磁盘缓存设置之前, 请停止可能影响此中断的所有应用程序/服务。</span><span class="sxs-lookup"><span data-stu-id="9d75a-192">Stop all applications/services that might be affected by this disruption before changing the disk cache setting.</span></span>

<span data-ttu-id="9d75a-193">让我们创建一个 VM, 并使用 Azure 门户更改缓存设置。</span><span class="sxs-lookup"><span data-stu-id="9d75a-193">Let's create a VM and change the cache settings using the Azure portal.</span></span>
