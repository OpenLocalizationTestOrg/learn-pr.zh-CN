让我们更新函数实现以调用文本分析 API 服务, 并返回看法分数。

1. 在门户的函数[!INCLUDE [func-name-discover](./func-name-discover.md)]应用中, 选择我们的函数。

1. 展开屏幕右侧的 "**查看文件**" 菜单。

1. 在 "**查看文件**" 选项卡下, 选择**index .js**以在编辑器中打开代码文件。

1. 将包含以下 JavaScript 的**** 所有内容替换为以下 JavaScript 并**保存**。

    [!code-javascript[](../code/discover-sentiment-sort.js?highlight=7)]

1. 使用您之前在`accessKey`本模块中保存的文本分析 API 的访问键更新您粘贴的代码中的值。 

1. 使用从中`uri`获取访问键的区域更新值。

让我们看一下此代码中发生的情况:

- 每次调用 Text Analytics service 时, 都需要访问密钥, 我们将其添加为`Ocp-Apim-Subscription-Key`标头。 
- 每次调用的区域特定终结点, `uri`在我们的代码中进行定义。
- 在代码文件的底部, 定义了一个`documents`数组。 此数组是我们向 Text Analytics service 发送的有效负载。
- 在`documents`这种情况下, 该数组具有单个条目, 即触发我们的函数的队列消息。 尽管我们的数组中仅有一个文档, 但并不意味着我们的解决方案一次只能处理一封邮件。 Azure 函数运行时以批处理方式检索和处理消息,*同时*调用我们的函数的多个实例。 目前, 默认批次大小为 16, 最大批处理大小为32。
- 在`id`数组中必须是唯一的。 `language`属性指定文档文本的语言。
- 然后, 我们调用方法`get_sentiments`, 该方法使用 HTTPS 模块对 Text Analytics API 进行调用。 请注意, 我们会在每个请求的标头中传递订阅或访问密钥。
- 当服务返回时, 我们`response_handler`将被称为, 我们会将此响应记录在使用`context.log`


## <a name="try-it-out"></a>试用

在查看队列中的排序之前, 让我们对测试运行采取相应的操作。

1. 使用我们的函数[!INCLUDE [func-name-discover](./func-name-discover.md)], 在门户的 "函数应用" 区域中选择, 单击最右侧的 "**测试**" 菜单项。

1. 选择 "**测试**" 菜单项, 并验证是否打开了测试面板。

1. 将文本字符串添加到请求正文中, 如屏幕截图中所示。

    ![显示已展开的函数测试面板的屏幕截图。](../media/test-panel-open-small.png)

1.  单击 "测试" 面板底部的 "**运行**"。

1. 请确保 "**日志**" 选项卡在主屏幕的左下角展开, 在代码编辑器下。

1. 验证 "**日志**" 选项卡是否显示函数已完成的日志信息。 该窗口还将显示来自文本分析 API 调用的响应。

    ![显示测试面板和成功测试结果的屏幕截图。](../media/sentiment-response-log1.png)

!! 按[!INCLUDE [func-name-discover](./func-name-discover.md)]设计方式工作。 在此示例中, 我们传递了一个非常 upbeat 的邮件并收到超过0.98 的分数。 尝试将邮件更改为 "乐观不变", 再重新运行测试, 并记下响应。

## <a name="add-a-message-to-the-queue"></a>向队列中添加消息

让我们重复此测试。 在这段时间, 我们实际上会将一条消息放入输入队列并观看所发生的情况, 而不是使用门户的测试窗口。

1. 导航到门户的 "**资源组**" 部分中的资源组。

1. 选择<rgn>[沙盒资源组名称]</rgn>, 在本课中使用的资源组。

1. 在出现的 "**资源组**" 面板中, 找到 "存储帐户" 条目, 然后选择它。

    ![在资源组窗口中选择的屏幕截图存储帐户](../media/select-storage-account.png)

1. 从 "存储帐户" 主窗口的左侧菜单中选择 "**存储资源管理器 (预览)** "。 此操作将在门户中打开 Azure 存储资源管理器。 

    ![存储资源管理器显示存储帐户的屏幕截图, 当前没有队列。](../media/sa-no-queue.png)

    正如你所看到的, 我们尚未拥有此存储帐户中的任何队列, 因此我们添加一个队列。

1. 如果您记得本课前面的部分, 我们命名了与我们的触发**新反馈-q**关联的队列。 右键单击存储资源管理器中的 "**队列**" 项, 然后选择 "*创建队列*"。

1. 在打开的对话框中, 输入 "**新反馈-q** ", 然后单击 **"确定"**。 现在, 我们提供了输入队列。

1. 在左侧菜单中选择新队列, 以查看此队列的数据资源管理器。 正如预期的那样, 队列是空的。 让我们使用窗口顶部的 "**添加消息**" 命令向队列中添加一条消息。

1. 在 "**添加消息**" 对话框中, 在 "**消息" 文本**字段中输入 "此消息来自我们的输入队列, 新的反馈-q", 然后单击对话框底部的 **"确定**"。

1. 在数据浏览器中观察消息, 与以下屏幕截图中的消息类似。
    ![显示存储资源管理器的屏幕截图, 其中包含我们在队列中创建的消息。](../media/message-in-input-queue.png)

1. 几秒钟后, 单击 "**刷新**" 以刷新队列视图。 再次观察队列是否为**空**。 必须已从队列中读取邮件。

1. 导航回门户中的函数, 并打开 "**监视器**" 选项卡。选择列表中的最新邮件。 请注意, 我们的函数处理了我们发布到新反馈-q 的队列消息。 在此日志中可能会延迟结果, 因此您可能需要等待几分钟, 然后再进行命中*刷新*。

    ![监视器仪表板的屏幕截图, 显示一个条目, 告诉我们我们的函数处理了我们发布到新反馈-q 的队列消息。](../media/message-in-monitor.png)

    在此测试中, 我们完成了在队列中发布内容的完整往返行程, 然后查看函数对其进行处理。

我们正在为我们的解决方案做进展! 我们的函数现在要做一些有用的事情。 它从输入队列中接收文本, 然后调出到文本分析 API 服务, 以获取看法分数。 我们还学习了如何通过 Azure 门户和存储浏览器测试函数。 在下一个练习中, 我们将了解使用输出绑定向队列中写入的难易程度。