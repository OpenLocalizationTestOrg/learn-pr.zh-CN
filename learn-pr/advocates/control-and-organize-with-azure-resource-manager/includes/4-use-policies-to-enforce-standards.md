您要在资源组中更好地组织资源, 并已将标记应用于您的资源, 以便在帐单报告和监控解决方案中使用它们。 资源分组和标记在现有资源中有差异, 但如何确保新资源遵循规则？ 让我们来看看策略如何帮助您在 Azure 环境中强制实施标准。

## <a name="what-is-azure-policy"></a>什么是 Azure 策略？

Azure Policy 是一种可用于创建、分配和管理策略的服务。 这些策略将应用并强制执行您的资源需要遵循的规则。 这些策略可在创建资源时强制实施这些规则, 并且可以依据现有资源对其进行评估, 以提供符合性。

策略可以强制执行某些操作, 例如只允许创建特定类型的资源, 或仅允许特定 Azure 区域中的资源。 您可以在您的 Azure 环境中强制实施命名约定。 您还可以强制将特定标记应用于资源。 让我们来看看策略的工作原理。

## <a name="create-a-policy"></a>创建策略

我们希望确保所有资源都有与其相关联的**部门**标签, 如果不存在, 则阻止创建。 我们需要创建一个新的策略定义, 然后将其分配给一个作用域;在这种情况下, 作用域将成为我们的**mslearn-rg**资源组。 可以通过 azure 门户、azure PowerShell 或 azure CLI 创建和分配策略。 我们来演练一下如何在门户中创建策略。

### <a name="create-the-policy-definition"></a>创建策略定义

1. 如果你还没有, 请继续在 web 浏览器中提取[Azure 门户](https://portal.azure.com/?azure-portal=true)(如果尚不存在)。 在顶部导航栏的搜索框中, 搜索**策略**并选择**策略**服务。

1. 在 "**创作**" 部分的左侧菜单中, 选择 "**定义**"。

1. 您应该会看到可使用的内置策略列表。 在这种情况下, 我们将创建自己的自定义策略。 在顶部菜单中单击 " **+ 策略定义**"。

1. 这将显示 "**新建策略定义**" 对话框。 若要设置**定义位置**, 请单击蓝色 **...**。选择要在其中存储策略的订阅, 它应与我们的资源组具有相同的订阅。 单击 "**选择**"。

1. 返回到 "**新建策略定义**" 对话框的 "**名称**" 为策略指定**资源上的 "强制" 标记**的名称。

1. 在 "**说明**" 中, 输入**此策略将强制存在对资源的标记。**

1. 对于 "**类别**", 选择 "**使用现有**", 然后选择 "**常规**" 类别。

1. 对于**策略规则**, 删除框中的所有文本, 并粘贴以下 JSON。

    ```json
    {
      "mode": "indexed",
      "policyRule": {
        "if": {
          "field": "[concat('tags[', parameters('tagName'), ']')]",
          "exists": "false"
        },
        "then": {
          "effect": "deny"
        }
      },
      "parameters": {
        "tagName": {
          "type": "String",
          "metadata": {
            "displayName": "Tag Name",
            "description": "Name of the tag, such as 'environment'"
          }
        }
      }
    }
    ```

    您的策略定义应如下所示。 单击 "**保存**" 以保存策略定义。

    ![显示 "新建策略定义" 对话框的门户的图像](../media/4-policy-definition.PNG)

### <a name="create-a-policy-assignment"></a>创建策略分配

我们已经创建了策略, 但实际上并不会使其生效。 若要启用该策略, 我们需要创建一个工作分配。 在这种情况下, 我们会将其分配给我们的**msftlearn-rg**资源组的范围, 以便它适用于资源组中的任何内容。

1. 在策略窗格中, 在左侧的 "**创作**" 部分中, 选择 "**分配**"。

1. 选择顶部的 "**分配策略**"。

1. 在 "**分配策略**" 窗格中, 我们会将策略分配给资源组。 对于 "**范围**", 单击蓝色 **...**。选择您的订阅和**msftlearn-rg**资源组, 然后单击 "**选择**"。

1. 对于 "**策略定义**", 单击 "蓝色 **...**"。在 "**类型**" 下拉中, 选择 "**自定义**", 选择 "在您创建的**资源策略上强制标记**", 然后单击 "**选择**"。

1. 在 "**参数**" 部分的 "**标记名称**"**部门**中。 单击 "**分配**" 以分配策略。

### <a name="test-out-the-policy"></a>测试策略

至此, 我们已将策略分配给资源组, 任何创建没有**部门**标记的资源的尝试都将失败。 让我们试一试。

1. 单击 "+ 在门户左上角**创建资源**"。

1. 搜索**存储帐户**并在结果中选择**存储帐户-blob、文件、表、队列**。 单击"创建"。

1. 选择您的订阅和**msftlearn-rg**资源组。

1. 对于**存储帐户名称**, 请为其指定您选择的任何名称, 但请注意, 它必须是一个全局唯一名称。

1. 保留其余选项的默认值, 请单击 "**审阅 + 创建**"。

    对资源创建的验证将失败, 因为我们没有对该资源应用**部门**标记。

    ![显示违反策略的门户的图像](../media/4-policy-violation.PNG)

    让我们修复冲突, 以便我们可以成功部署存储帐户。

1. 在 tht 的 "**创建存储帐户**" 窗格顶部选择**标记**。

1. 将 "**部门: 财务**" 标记添加到列表中。

    ![显示新 "部门" 标记的门户的图像](../media/4-add-department-tag.PNG)

1. 现在, 单击 "**审阅 + 创建**"。 验证现在应传递, 如果单击 "**创建**", 则将创建存储帐户。

## <a name="use-policies-to-enforce-standards"></a>使用策略强制实施标准

我们已了解如何使用策略来确保我们的资源具有可组织我们的资源的标记。 有其他方法可用于我们的福利。

我们可以使用策略限制可将资源部署到的 Azure 区域。 对于管控程度较高或对数据可以驻留的领域具有法律或法规限制的组织而言, 策略有助于确保不会在地理区域中预配不符合这些要求的资源。

我们可以使用策略来限制可部署的虚拟机大小的类型。 您可能需要在生产订阅中允许较大的 VM 大小, 但也许您希望确保在开发订阅中保持最小化的成本。 通过在 dev 订阅中通过策略拒绝大型 VM 大小, 可以确保它们不会在这些环境中部署。

我们还可以使用策略强制实施命名约定。 如果我们的组织已根据特定的命名约定进行了标准化, 则使用策略强制实施约定可帮助我们在 Azure 资源中保持一致的命名标准。
