在体系结构中包含存储性能注意事项非常重要。 就像网络延迟一样, 存储层性能较差可能会影响最终用户的体验。 如何优化数据存储？ 您需要考虑的事项, 以确保您不会将存储瓶颈引入您的体系结构中？ 在这里, 我们将介绍如何在体系结构中优化存储性能。

## <a name="optimize-virtual-machine-storage-performance"></a>优化虚拟机存储性能

首先, 我们来看一下优化虚拟机的存储。 磁盘存储在虚拟机的性能方面发挥着重要作用, 为应用程序选择正确的磁盘类型是一项重要决定。

不同的应用程序将具有不同的存储要求。 您的应用程序可能对磁盘读取和写入的延迟敏感, 或者可能需要处理大量的输入/输出操作数 (IOPS) 或更高的总体磁盘吞吐量。

构建 IaaS 工作负载时, 应使用哪种类型的磁盘？ 有四个选项:

- **本地 ssd 存储**-每个 VM 都有一个由本地 SSD 存储支持的临时磁盘。 此磁盘的大小取决于虚拟机的大小。 由于此磁盘是本地 SSD, 因此性能较高, 但在维护事件或 VM 重新部署过程中可能会丢失数据。 此磁盘仅适用于临时存储不需要永久存储的数据。 此磁盘非常适合于页面或交换文件, 以及 SQL Server 中的 tempdb 等内容。 此存储不收费。 它包括在 VM 的成本中。

- **标准存储 HDD** -这是磁盘轴磁盘存储, 可适合您的应用程序不受不一致延迟或较低级别的吞吐量的限制。 对于此磁盘类型, 不需要保证性能的开发/测试工作负载是一个很好的用例。

- **标准存储 ssd** -这是 ssd 备份的存储, 具有有限的 ssd 延迟, 但吞吐量级别较低。 对于此磁盘类型, 非生产 web 服务器是一个很有用的用例。

- **高级存储 ssd** -此 SSD 备份的存储非常适合于要投入生产的工作负载, 需要最大的可靠性和需求一致的低延迟时间, 或者需要高级别的吞吐量和 IOPS。 由于这些磁盘具有更高的性能和可靠性功能, 因此建议用于所有生产工作负载。

高级存储只能附加到特定的虚拟机 (VM) 大小。 可在名称中使用 "s" 指定 "特优存储" 大小, 例如 D2**s**_v3 或 Standard_F2**s**_v2。 任何虚拟机类型 (名称中带有或不包含 "s") 均可附加标准存储 HDD 或 SSD 驱动器。

可以使用条带技术 (如 Windows 上的 Storage Spaces Direct 或 Linux 上的 mdadm) 对磁盘进行条带化, 从而提高吞吐量和 IOPS, 具体方法是将磁盘活动分布在多个磁盘上。 通过使用磁盘条带化, 可以真正推送磁盘的性能限制, 并且在高性能数据库系统和具有大量存储要求的其他系统中, 通常会出现这种情况。

依赖虚拟机工作负载时, 您需要评估应用程序的性能要求, 以确定您将为虚拟机预配的基础存储。

## <a name="optimize-storage-performance-for-your-application"></a>优化应用程序的存储性能

虽然您可以使用不同的存储技术来提高原始磁盘性能, 但也可以解决在应用程序层访问数据的性能。 让我们来看一看可执行此操作的几种方法。

### <a name="caching"></a>Caching

提高应用程序性能的常用方法是在应用程序和数据存储区之间集成缓存层。 缓存通常将数据存储在内存中, 并允许快速检索。 此数据可以是频繁访问的数据、从数据库指定的数据或临时数据 (如用户状态)。 您可以控制所存储的数据类型、它的刷新频率以及过期时间。 通过在与应用程序和数据库相同的区域中共同定位此缓存, 可以减少两者之间的整体延迟。 将数据从缓存中提取几乎总是比从数据库检索相同数据快得多, 因此通过使用缓存层, 可以极大地提高应用程序的整体性能。 下图显示了应用程序如何从数据库中检索数据, 如何将数据存储在缓存中, 并根据需要使用缓存的值。

![说明从缓存检索数据比从数据库检索更快。](../media/4-cache.png)

Redis 的 azure 缓存是 azure 上的一种将数据存储在内存中的缓存服务。 它基于开放源代码 Redis 缓存, 是 Microsoft 提供的完全托管服务。 选择所需的性能层, 并将应用程序配置为使用该服务。

### <a name="polyglot-persistence"></a>Polyglot 持久性

Polyglot 持久性是使用不同的数据存储技术来处理存储要求。

请考虑一个电子商务示例。 您可以将应用程序资产存储在 blob 存储、在 NoSQL 存储中的产品评论和建议、以及 SQL 数据库中的用户配置文件或帐户数据。 下图显示了应用程序如何使用多种数据存储技术来存储不同类型的数据。

![显示同一应用程序中不同数据存储方法的使用情况以提高性能并降低成本的插图。](../media/4-polyglotpersistence.png)

这一点很重要, 因为不同的数据存储区适用于某些用例, 或者因成本而更易于访问。 例如, 将 blob 存储在 SQL 数据库中可能会花费大量的访问权限, 而比从 blob 存储直接访问要慢得多。

维护跨分布式数据存储的数据一致性可能是一项重大挑战。 问题在于, 只有在所有应用程序实例共享相同的数据存储区, 并且应用程序设计为确保锁定非常短的生存期时, 序列化和锁定等策略才会正常工作。 但是, 如果在不同的数据存储区中对数据进行分区或复制, 则锁定和序列化数据访问以保持一致性可能会成为一种成本高昂的开销, 这会影响系统的吞吐量、响应时间和可伸缩性。 因此, 大多数新式分布式应用程序不会锁定所修改的数据, 而是采用更宽松的一致性方法 (称为 "最终一致性")。

最终一致性意味着副本数据存储最终将聚合, 如果没有进一步的写入。 如果对其中一个数据存储区进行了写入, 则从另一个数据存储读取可能会提供略微过时的数据。 由于读取和写入操作的延迟较短, 而不是等待检查信息在所有存储中是否一致, 因此最终一致性可实现更高的扩展。

## <a name="lamna-healthcare-example"></a>Lamna 保健示例

Lamna 医疗保健的患者预定系统在两个 Azure 区域、西欧和澳大利亚东部之间托管。 他们使用虚拟机作为部署其网站的前端节点, 并将 Azure SQL 数据库作为主要和澳大利亚东部部署到可读辅助副本中, 并将它们部署在西欧。 他们的前端节点不需要高级别磁盘吞吐量, 但需要一致的延迟性能和生产可靠性并已使用高级 SSD 备份存储。

他们将在每个 Azure 区域中本地托管 Redis 的 Azure 缓存, 以存储公共用户请求和医生的可用性。 已实现缓存, 以优化应用程序上观测到的最常见数据读取活动的性能。

我们介绍了几个示例, 这些示例展示了如何在基础结构层中提高存储性能, 具体方法是在使用缓存并为数据选择适当的数据平台的情况中, 选择正确的磁盘体系结构和应用程序级别。 正确设计的解决方案将确保能够更好地执行数据访问。