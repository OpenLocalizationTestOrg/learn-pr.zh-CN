<span data-ttu-id="14d01-101">我们很少能准确预测我们系统上的负载: 面向公众的应用程序可能会迅速增长, 或者内部应用程序可能需要在业务增长时支持更大的用户群体。</span><span class="sxs-lookup"><span data-stu-id="14d01-101">It's rare that we can exactly predict the load on our system: public facing applications might grow rapidly or an internal application might need to support a larger user base as the business grows.</span></span> <span data-ttu-id="14d01-102">即使我们可以预测负载, 也很少出现以下情况: 零售商在 playoffs 期间的假日和体育网站高峰期的需求更多。</span><span class="sxs-lookup"><span data-stu-id="14d01-102">Even when we can predict load, it's rarely flat: retailers have more demand during the holidays and sports websites peak during playoffs.</span></span> <span data-ttu-id="14d01-103">在这里, 我们将定义_向上/向下扩展和向__外扩展_, 涵盖了一些 Azure 可以改善扩展功能的方法, 并介绍了无服务器和容器技术如何能够提高体系结构的扩展能力。</span><span class="sxs-lookup"><span data-stu-id="14d01-103">Here, we'll define _scaling up/down_ and _scaling out/in_, cover some ways Azure can improve your scaling capabilities, and look at how serverless and container technologies can improve your architecture's ability to scale.</span></span>

## <a name="what-is-scaling"></a><span data-ttu-id="14d01-104">扩展是什么？</span><span class="sxs-lookup"><span data-stu-id="14d01-104">What is scaling?</span></span>

<span data-ttu-id="14d01-105">_缩放_是管理您的资源以帮助您的应用程序满足一组性能要求的过程。</span><span class="sxs-lookup"><span data-stu-id="14d01-105">_Scaling_ is the process of managing your resources to help your application meet a set of performance requirements.</span></span>  <span data-ttu-id="14d01-106">如果我们为用户提供了过多的资源, 我们将不会有效地使用它, 我们将浪费资金。</span><span class="sxs-lookup"><span data-stu-id="14d01-106">When we have too many resources serving users, we won't be using it efficiently and we'll be wasting money.</span></span> <span data-ttu-id="14d01-107">可用资源过少意味着应用程序的性能可能会受到影响。</span><span class="sxs-lookup"><span data-stu-id="14d01-107">Too few available resources means that the performance of our application could be impacted.</span></span> <span data-ttu-id="14d01-108">目标是在优化成本时满足已定义的性能要求。</span><span class="sxs-lookup"><span data-stu-id="14d01-108">The goal is to meet our defined performance requirements while optimizing for cost.</span></span> 

<span data-ttu-id="14d01-109">"_资源_" 可以指运行我们的应用程序需要管理的任何内容。</span><span class="sxs-lookup"><span data-stu-id="14d01-109">"_Resources_" can refer to anything we need to manage to run our applications.</span></span> <span data-ttu-id="14d01-110">虚拟机的内存和 CPU 是最明显的资源, 但某些 Azure 服务可能需要考虑带宽或抽象化, 如 Cosmos DB 请求单元。</span><span class="sxs-lookup"><span data-stu-id="14d01-110">Memory and CPU for virtual machines are the most obvious resources, but some Azure services might require you to consider bandwidth or abstractions, like Cosmos DB Request Units.</span></span>

<span data-ttu-id="14d01-111">在应用程序要求是常量的世界中, 很容易预测所需的资源量。</span><span class="sxs-lookup"><span data-stu-id="14d01-111">In a world where application demand is constant, it's easy to predict the right amount of resources you'll need.</span></span> <span data-ttu-id="14d01-112">在现实中, 应用程序的需求随着时间的推移而发生变化, 因此, 所需的资源量可能更难预测。</span><span class="sxs-lookup"><span data-stu-id="14d01-112">In the real world, the demands of applications change over time, so the right amount of resources you'll need can be harder to predict.</span></span> <span data-ttu-id="14d01-113">如果你幸运, 该更改将是可预测的或季节性的, 但不是所有应用程序的典型更改。</span><span class="sxs-lookup"><span data-stu-id="14d01-113">If you're lucky, that change will be predictable or seasonal, but that is not typical of all applications.</span></span> <span data-ttu-id="14d01-114">理想情况下, 您需要调配适当的资源量来满足需求, 并根据需求的变化进行调整。</span><span class="sxs-lookup"><span data-stu-id="14d01-114">Ideally, you want to provision the right amount of resources to meet demand and adjust as demand changes.</span></span>

<span data-ttu-id="14d01-115">在本地方案中, 在购买和管理自己的服务器的情况下, 缩放非常困难。</span><span class="sxs-lookup"><span data-stu-id="14d01-115">Scaling is difficult in an on-premises scenario, where you purchase and manage your own servers.</span></span> <span data-ttu-id="14d01-116">添加资源可能会导致成本高昂且通常需要很长时间才能进入联机状态, 有时比您实际需要的增加的容量长。</span><span class="sxs-lookup"><span data-stu-id="14d01-116">Adding resources can be costly and often takes too much time to bring online, sometimes longer than your actual need for the increased capacity.</span></span> <span data-ttu-id="14d01-117">在系统较低需求的时间内, 可以很难减少容量, 因此您可能会陷入成本增加的情况。</span><span class="sxs-lookup"><span data-stu-id="14d01-117">It can be just as difficult to then reduce capacity during times of low demand on the system, so you may be stuck with the increased cost.</span></span>

<span data-ttu-id="14d01-118">轻松扩展是 Azure 的主要优势。</span><span class="sxs-lookup"><span data-stu-id="14d01-118">Easy scaling is a key benefit of Azure.</span></span> <span data-ttu-id="14d01-119">大多数 Azure 资源可让您轻松地添加或删除资源作为需求更改, 并且许多服务都具有自动化的选项, 以便他们监视需求并为您调整。</span><span class="sxs-lookup"><span data-stu-id="14d01-119">Most Azure resources let you easily add or remove resources as demand changes, and many services have automated options so they monitor demand and adjust for you.</span></span> <span data-ttu-id="14d01-120">此自动缩放功能通常称为自动缩放功能, 可用于设置应可用实例的最小和最大级别的阈值, 并根据性能指标 (例如, CPU 使用率) 添加或删除实例。</span><span class="sxs-lookup"><span data-stu-id="14d01-120">This automatic scaling capability, commonly known as autoscaling, lets you set thresholds for the minimum and maximum level of instances that should be available, and will add or remove instances based upon a performance metric (for example, CPU utilization).</span></span>

#### <a name="scaling-up-and-out"></a><span data-ttu-id="14d01-121">向上扩展和向后扩展</span><span class="sxs-lookup"><span data-stu-id="14d01-121">Scaling up and out</span></span>

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yBWi]

## <a name="what-is-scaling-up-or-down"></a><span data-ttu-id="14d01-122">向上或向下扩展什么？</span><span class="sxs-lookup"><span data-stu-id="14d01-122">What is scaling up or down?</span></span>

<span data-ttu-id="14d01-123">向上扩展是我们增加给定实例容量的过程。</span><span class="sxs-lookup"><span data-stu-id="14d01-123">Scaling up is the process where we increase the capacity of a given instance.</span></span> <span data-ttu-id="14d01-124">可以将虚拟机从 1 vCPU 和 3.5 gb 的 ram 增加到 2 vCPUs 和 7 gb 的 ram, 以提供更多的处理能力。</span><span class="sxs-lookup"><span data-stu-id="14d01-124">A virtual machine could be increased from 1 vCPU and 3.5 GB of RAM to 2 vCPUs and 7 GB of RAM to provide more processing capacity.</span></span> <span data-ttu-id="14d01-125">另一方面, 向下扩展是指降低给定实例容量的过程。</span><span class="sxs-lookup"><span data-stu-id="14d01-125">On the other hand, scaling down is the process where we lower the capacity of a given instance.</span></span> <span data-ttu-id="14d01-126">例如, 将虚拟机的容量从 2 vCPUs 和 7 gb ram 减少到1个 vCPU 和 3.5 gb 的 ram, 同时降低容量和成本。</span><span class="sxs-lookup"><span data-stu-id="14d01-126">For example, reducing a virtual machine's capacity from 2 vCPUs and 7 GB of RAM to 1 vCPU and 3.5 GB of RAM, reducing both capacity and cost.</span></span> <span data-ttu-id="14d01-127">下图显示了更改虚拟机大小的示例。</span><span class="sxs-lookup"><span data-stu-id="14d01-127">The following illustration shows an example of changing the size of a virtual machine.</span></span>

![该图显示了在虚拟机上向上扩展和向下扩展以更改性能功能。](../media/2-ScaleUpDown.png)

<span data-ttu-id="14d01-129">让我们看一下 Azure 资源上下文中的向上或向下扩展是什么意思:</span><span class="sxs-lookup"><span data-stu-id="14d01-129">Let's take a look at what scaling up or down means in the context of Azure resources:</span></span>

- <span data-ttu-id="14d01-130">在 Azure 虚拟机中, 可以根据虚拟机大小进行扩展。</span><span class="sxs-lookup"><span data-stu-id="14d01-130">In Azure virtual machines, you scale based upon a virtual machine size.</span></span> <span data-ttu-id="14d01-131">该大小具有与之关联的一定量的 vCPUs、RAM 和本地存储。</span><span class="sxs-lookup"><span data-stu-id="14d01-131">That size has a certain amount of vCPUs, RAM, and local storage associated with it.</span></span> <span data-ttu-id="14d01-132">例如, 我们可以从 Standard_DS1_v2 虚拟机 (1 vCPU 和 3.5 gb 的 ram) 向上扩展到 Standard_DS2_v2 虚拟机 (2 vCPUs 和 7 gb ram)。</span><span class="sxs-lookup"><span data-stu-id="14d01-132">For example, we could scale up from a Standard_DS1_v2 virtual machine (1 vCPU and 3.5 GB of RAM) to a Standard_DS2_v2 virtual machine (2 vCPUs and 7 GB of RAM).</span></span>
- <span data-ttu-id="14d01-133">Azure SQL Database 是 Microsoft SQL Server 的服务 (PaaS) 实施平台。</span><span class="sxs-lookup"><span data-stu-id="14d01-133">Azure SQL Database is a platform as a service (PaaS) implementation of Microsoft SQL Server.</span></span>  <span data-ttu-id="14d01-134">您可以根据数据库事务单元数 (dtu) 或 vCPUs 扩展数据库。</span><span class="sxs-lookup"><span data-stu-id="14d01-134">You can scale up a database based upon the number of database transaction units (DTUs) or vCPUs.</span></span> <span data-ttu-id="14d01-135">dtu 是底层资源的抽象概念, 并且是 CPU、IO 和内存的混合。</span><span class="sxs-lookup"><span data-stu-id="14d01-135">DTUs are an abstraction of underlying resources and are a blend of CPU, IO, and memory.</span></span> <span data-ttu-id="14d01-136">例如, 您可以将 Azure SQL 数据库从大小为 P2、250 dtu 的 P2 扩展到带 500 dtu 的 P4, 从而为数据库提供更高的吞吐量和容量。</span><span class="sxs-lookup"><span data-stu-id="14d01-136">For instance, you could scale your Azure SQL database from a size of P2 with 250 DTUs up to a P4 with 500 DTUs to give the database more throughput and capacity.</span></span>
- <span data-ttu-id="14d01-137">azure 应用服务是 azure 上的 PaaS 网站托管服务。</span><span class="sxs-lookup"><span data-stu-id="14d01-137">Azure App Service is a PaaS website-hosting service on Azure.</span></span> <span data-ttu-id="14d01-138">网站在虚拟服务器场 (也称为 "应用服务计划") 上运行。</span><span class="sxs-lookup"><span data-stu-id="14d01-138">Websites run on a virtual server farm, also known as an App Service plan.</span></span> <span data-ttu-id="14d01-139">您可以在层之间向上或向下扩展应用服务计划, 并在层中具有容量选项。</span><span class="sxs-lookup"><span data-stu-id="14d01-139">You can scale the App Service plan up or down between tiers and have capacity options within tiers.</span></span> <span data-ttu-id="14d01-140">例如, S1 App Service 计划的每个实例包含 1 vCPU 和 1.75 GB 的 RAM。</span><span class="sxs-lookup"><span data-stu-id="14d01-140">For example, an S1 App Service plan has 1 vCPU and 1.75 GB of RAM per instance.</span></span> <span data-ttu-id="14d01-141">我们可以扩展到 S2 应用服务计划, 每个实例包含 2 vCPUs 和 3 GB RAM。</span><span class="sxs-lookup"><span data-stu-id="14d01-141">We could scale up to an S2 App Service plan, which has 2 vCPUs and 3 GB of RAM per instance.</span></span>

<span data-ttu-id="14d01-142">若要在本地环境中使用这些功能, 通常需要等待采购所需的硬件和安装, 然后才能开始使用新的规模级别。</span><span class="sxs-lookup"><span data-stu-id="14d01-142">To have these capabilities in an on-premises environment you typically have to wait for procurement of the needed hardware and installation before you can start using the new level of scale.</span></span> <span data-ttu-id="14d01-143">在 Azure 中, 物理资源已部署并可供您使用。</span><span class="sxs-lookup"><span data-stu-id="14d01-143">In Azure, the physical resources are already deployed and available for you.</span></span> <span data-ttu-id="14d01-144">只需选择您想要使用的其他级别的小数位数即可。</span><span class="sxs-lookup"><span data-stu-id="14d01-144">You simply need to select the alternate level of scale that you are looking to use.</span></span>

<span data-ttu-id="14d01-145">您可能需要考虑在解决方案中进行扩展时的影响, 具体取决于您选择的云服务。</span><span class="sxs-lookup"><span data-stu-id="14d01-145">You may need to consider the impact of scaling up in your solution, depending upon the cloud services that you have chosen.</span></span>

<span data-ttu-id="14d01-146">例如, 如果选择在 Azure SQL 数据库中进行扩展, 服务将处理各个节点的扩展, 并继续执行服务操作。</span><span class="sxs-lookup"><span data-stu-id="14d01-146">For example, if you choose to scale up in Azure SQL Database, the service deals with scaling up individual nodes and continues the operation of your service.</span></span> <span data-ttu-id="14d01-147">更改数据库的服务层和/或性能级别会在新的性能级别创建原始数据库的副本, 然后将连接切换到该副本。</span><span class="sxs-lookup"><span data-stu-id="14d01-147">Changing the service tier and/or performance level of a database creates a replica of the original database at the new performance level, and then switches connections over to the replica.</span></span> <span data-ttu-id="14d01-148">在此过程中, 不会丢失任何数据, 并且在该服务切换到副本时仅有短暂的中断 (通常不到四秒)。</span><span class="sxs-lookup"><span data-stu-id="14d01-148">No data is lost during this process, and there's only a brief interruption (typically less than four seconds) when the service switches over to the replica.</span></span>

<span data-ttu-id="14d01-149">或者, 如果您选择向上或向下扩展虚拟机, 您可以通过选择其他实例大小来执行此操作。</span><span class="sxs-lookup"><span data-stu-id="14d01-149">Alternatively, if you choose to scale up or down a virtual machine, you do so by selecting a different instance size.</span></span> <span data-ttu-id="14d01-150">在大多数情况下, 这需要重新启动 VM, 因此最好能够预期需要重新启动, 并且在执行此活动时需要考虑。</span><span class="sxs-lookup"><span data-stu-id="14d01-150">In most cases this requires a restart of the VM, so it's best to have the expectation that a reboot will be required and you'll need to account for when performing this activity.</span></span>

<span data-ttu-id="14d01-151">最后, 应始终查看向下扩展的位置是一个选项。</span><span class="sxs-lookup"><span data-stu-id="14d01-151">Finally, you should always look for places where scaling down is an option.</span></span> <span data-ttu-id="14d01-152">如果您的应用程序能够在较低的价位提供充分的性能, 则您的 Azure 帐单将大大降低。</span><span class="sxs-lookup"><span data-stu-id="14d01-152">If your application can provide adequate performance at a lower price tier, your Azure bill could be significantly reduced.</span></span>

## <a name="what-is-scaling-out-or-in"></a><span data-ttu-id="14d01-153">横向或放大了什么？</span><span class="sxs-lookup"><span data-stu-id="14d01-153">What is scaling out or in?</span></span>

<span data-ttu-id="14d01-154">在上下扩展调整单个实例可用的资源量时, 向内扩展和调整总的实例数。</span><span class="sxs-lookup"><span data-stu-id="14d01-154">Where scaling up and down adjusts the amount of resources a single instance has available, scaling out and in adjusts the total number of instances.</span></span>

<span data-ttu-id="14d01-155">向_之外扩展_是添加更多实例以支持解决方案负载的过程。</span><span class="sxs-lookup"><span data-stu-id="14d01-155">_Scaling out_ is the process of adding more instances to support the load of your solution.</span></span> <span data-ttu-id="14d01-156">例如, 如果我们的网站前端托管在虚拟机上, 则可以增加虚拟机的数量 (如果负载级别增加)。</span><span class="sxs-lookup"><span data-stu-id="14d01-156">For example, if our website front end were hosted on virtual machines, we could increase the number of virtual machines if the level of load increased.</span></span>

<span data-ttu-id="14d01-157">__ 放大是指删除不再需要用于支持解决方案负载的实例的过程。</span><span class="sxs-lookup"><span data-stu-id="14d01-157">_Scaling in_ is the process of removing instances that are no longer needed to support the load of your solution.</span></span> <span data-ttu-id="14d01-158">如果网站前端使用率较低, 我们可能想要降低实例数以节省成本。</span><span class="sxs-lookup"><span data-stu-id="14d01-158">If the website front ends have low usage, we may want to lower the number of instances to save cost.</span></span> <span data-ttu-id="14d01-159">下图显示了更改虚拟机实例数的示例。</span><span class="sxs-lookup"><span data-stu-id="14d01-159">The following illustration shows an example of changing the number of virtual machine instances.</span></span>


![展示了如何向外扩展资源以处理需求和在资源中缩放以降低成本。](../media/2-ScaleInOut.png)

<span data-ttu-id="14d01-161">下面的示例展示了在 Azure 资源上下文中扩展或在什么方面的含义:</span><span class="sxs-lookup"><span data-stu-id="14d01-161">Here are some examples of what scaling out or in means in the context of Azure resources:</span></span>

- <span data-ttu-id="14d01-162">对于基础结构层, 您可能会使用虚拟机扩展集自动执行额外实例的添加和删除操作。</span><span class="sxs-lookup"><span data-stu-id="14d01-162">For the infrastructure layer, you would likely use virtual machine scale sets to automate the addition and removal of extra instances.</span></span>
  - <span data-ttu-id="14d01-163">使用虚拟机扩展集, 可以创建和管理一组相同的负载平衡虚拟机。</span><span class="sxs-lookup"><span data-stu-id="14d01-163">Virtual machine scale sets let you create and manage a group of identical, load balanced VMs.</span></span>
  - <span data-ttu-id="14d01-164">VM 实例的数量可以根据需求或定义的计划自动增加或减少。</span><span class="sxs-lookup"><span data-stu-id="14d01-164">The number of VM instances can automatically increase or decrease in response to demand or a defined schedule.</span></span>
- <span data-ttu-id="14d01-165">在 Azure SQL 数据库实现中, 可以通过 sharding 在数据库实例之间共享负载。</span><span class="sxs-lookup"><span data-stu-id="14d01-165">In an Azure SQL Database implementation, you could share the load across database instances by sharding.</span></span> <span data-ttu-id="14d01-166">_Sharding_是一种在许多独立的数据库中分布大量相同结构化数据的技术。</span><span class="sxs-lookup"><span data-stu-id="14d01-166">_Sharding_ is a technique to distribute large amounts of identically structured data across a number of independent databases.</span></span>
- <span data-ttu-id="14d01-167">在 Azure 应用服务中, 应用服务计划是托管应用程序的虚拟 web 服务器场。</span><span class="sxs-lookup"><span data-stu-id="14d01-167">In Azure App Service, the App Service plan is the virtual web server farm hosting your application.</span></span> <span data-ttu-id="14d01-168">以这种方式进行扩展意味着您要增加服务器场中的虚拟机数。</span><span class="sxs-lookup"><span data-stu-id="14d01-168">Scaling out in this way means that you're increasing the number of virtual machines in the farm.</span></span> <span data-ttu-id="14d01-169">与虚拟机规模设置一样, 可以自动提升或降低实例数以响应某些指标或计划。</span><span class="sxs-lookup"><span data-stu-id="14d01-169">As with virtual machine scale sets, the number of instances can be automatically raised or lowered in response to certain metrics or a schedule.</span></span>

<span data-ttu-id="14d01-170">横向扩展通常很容易在 Azure 门户、命令行工具或资源管理器模板中执行, 在大多数情况下, 最终用户是无缝执行的。</span><span class="sxs-lookup"><span data-stu-id="14d01-170">Scaling out is typically easily performed in the Azure portal, command-line tools, or Resource Manager templates, and in most cases is seamless to the end user.</span></span>

### <a name="autoscale"></a><span data-ttu-id="14d01-171">自动</span><span class="sxs-lookup"><span data-stu-id="14d01-171">Autoscale</span></span>

<span data-ttu-id="14d01-172">您可以将其中一些服务配置为使用名为自动缩放的功能。</span><span class="sxs-lookup"><span data-stu-id="14d01-172">You can configure some of these services to use a feature called autoscale.</span></span> <span data-ttu-id="14d01-173">使用自动缩放, 您不再需要担心手动缩放服务。</span><span class="sxs-lookup"><span data-stu-id="14d01-173">With autoscale you no longer have to worry about scaling services manually.</span></span> <span data-ttu-id="14d01-174">相反, 您可以根据特定指标 (队列长度、CPU 使用率) 或计划 (介于 5:00 pm 和 7:00 pm 之间的工作日) 设置实例和规模的最小和最大阈值。</span><span class="sxs-lookup"><span data-stu-id="14d01-174">Instead, you can set a minimum and maximum threshold of instances and scale based upon specific metrics (queue length, CPU utilization) or schedules (weekdays between 5:00 PM and 7:00 PM).</span></span> <span data-ttu-id="14d01-175">下图显示自动缩放功能如何管理实例以处理负载。</span><span class="sxs-lookup"><span data-stu-id="14d01-175">The following illustration shows how the autoscale feature manages instances to handle the load.</span></span>

![该图显示了自动缩放如何监视虚拟机池的 cpu 级别, 并在 CPU 使用率高于阈值时添加实例。](../media/2-autoscale.png)

### <a name="considerations-when-scaling-in-and-out"></a><span data-ttu-id="14d01-177">放大和缩小时的注意事项</span><span class="sxs-lookup"><span data-stu-id="14d01-177">Considerations when scaling in and out</span></span>

<span data-ttu-id="14d01-178">当向外扩展时, 应用程序的启动时间可能会影响应用程序扩展的速度。</span><span class="sxs-lookup"><span data-stu-id="14d01-178">When scaling out, the startup time of your application can impact how quickly your application can scale.</span></span> <span data-ttu-id="14d01-179">如果你的 web 应用需要两分钟才能启动并供用户使用, 则意味着你的每个实例将需要两分钟时间, 直到你的用户可以使用它们。</span><span class="sxs-lookup"><span data-stu-id="14d01-179">If your web app takes two minutes to start up and be available for users, that means each of your instances will take two minutes until they are available to your users.</span></span> <span data-ttu-id="14d01-180">在确定您想要扩展的速度时, 需要考虑此启动时间。</span><span class="sxs-lookup"><span data-stu-id="14d01-180">You'll want to take this startup time into consideration when determining how fast you want to scale.</span></span>

<span data-ttu-id="14d01-181">你还需要考虑应用程序如何处理状态。</span><span class="sxs-lookup"><span data-stu-id="14d01-181">You'll also need to think about how your application handles state.</span></span> <span data-ttu-id="14d01-182">当应用程序在中进行扩展时, 存储在计算机上的任何状态将不再可用。</span><span class="sxs-lookup"><span data-stu-id="14d01-182">When the application scales in, any state stored on the machine is no longer available.</span></span> <span data-ttu-id="14d01-183">如果用户连接到不具有其状态的实例, 则可以强制其登录或重新选择数据, 从而导致用户体验不佳。</span><span class="sxs-lookup"><span data-stu-id="14d01-183">If a user connects to an instance that doesn't have its state, it could force them to sign in or re-select data, leading to a poor user experience.</span></span> <span data-ttu-id="14d01-184">常见模式是 externalize 状态到另一种服务 (如 Redis 缓存或 SQL 数据库), 使 web 服务器无状态。</span><span class="sxs-lookup"><span data-stu-id="14d01-184">A common pattern is to externalize state to another service like Redis Cache or SQL Database, making your web servers stateless.</span></span> <span data-ttu-id="14d01-185">现在, 我们的 web 前端是无状态的, 我们无需担心各个实例的可用性。</span><span class="sxs-lookup"><span data-stu-id="14d01-185">Now that our web front ends are stateless, we don't need to worry about which individual instances are available.</span></span> <span data-ttu-id="14d01-186">它们都执行相同的作业并以相同的方式进行部署。</span><span class="sxs-lookup"><span data-stu-id="14d01-186">They are all doing the same job and are deployed in the same way.</span></span>

## <a name="throttling"></a><span data-ttu-id="14d01-187">限制</span><span class="sxs-lookup"><span data-stu-id="14d01-187">Throttling</span></span>

<span data-ttu-id="14d01-188">我们已确定应用程序上的负载随时间的推移而变化。</span><span class="sxs-lookup"><span data-stu-id="14d01-188">We've established that the load on an application will vary over time.</span></span> <span data-ttu-id="14d01-189">这可能是由于活动用户数、并发用户数以及正在执行的活动数而引起的。</span><span class="sxs-lookup"><span data-stu-id="14d01-189">This may be due to the number of active or concurrent users and the activities being performed.</span></span> <span data-ttu-id="14d01-190">虽然可以使用自动缩放功能添加容量, 但我们也可以使用限制机制来限制来自源的请求数。</span><span class="sxs-lookup"><span data-stu-id="14d01-190">While we could use autoscaling to add capacity, we could also use a throttling mechanism to limit the number of requests from a source.</span></span> <span data-ttu-id="14d01-191">我们可以通过将已知限制放在应用程序级别来保护性能限制, 从而防止应用程序中断。</span><span class="sxs-lookup"><span data-stu-id="14d01-191">We can safeguard performance limits by putting known limits into place at the application level, preventing the application from breaking.</span></span> <span data-ttu-id="14d01-192">限制在公开 API 终结点的应用程序中最常用。</span><span class="sxs-lookup"><span data-stu-id="14d01-192">Throttling is most frequently used in applications exposing API endpoints.</span></span>

<span data-ttu-id="14d01-193">一旦应用程序确定它会破坏限制, 则限制可能会开始, 并确保总体系统 SLA 不受侵害。</span><span class="sxs-lookup"><span data-stu-id="14d01-193">Once the application has identified that it would breach a limit, throttling could begin and ensure the overall system SLA isn't breached.</span></span> <span data-ttu-id="14d01-194">例如, 如果我们公开了一个 API 以供客户获取数据, 我们可以将请求数限制为每分钟100。</span><span class="sxs-lookup"><span data-stu-id="14d01-194">For example, if we exposed an API for customers to get data, we could limit the number of requests to 100 per minute.</span></span> <span data-ttu-id="14d01-195">如果任何一个客户超出了此限制, 我们可以使用 HTTP 429 状态代码进行响应, 包括等待时间, 然后才能成功提交另一个请求。</span><span class="sxs-lookup"><span data-stu-id="14d01-195">If any single customer exceeded this limit, we could respond with an HTTP 429 status code, including the wait time before another request can successfully be submitted.</span></span>

## <a name="serverless"></a><span data-ttu-id="14d01-196">服务器</span><span class="sxs-lookup"><span data-stu-id="14d01-196">Serverless</span></span>

<span data-ttu-id="14d01-197">无服务器计算提供一个云承载的执行环境, 该环境可运行应用程序, 但会完全抽象化基础环境。</span><span class="sxs-lookup"><span data-stu-id="14d01-197">Serverless computing provides a cloud-hosted execution environment that runs your apps but completely abstracts the underlying environment.</span></span> <span data-ttu-id="14d01-198">创建服务的实例, 然后添加代码;不需要基础结构管理或维护, 甚至不允许进行维护。</span><span class="sxs-lookup"><span data-stu-id="14d01-198">You create an instance of the service, and you add your code; no infrastructure management or maintenance is required, or even allowed.</span></span>

<span data-ttu-id="14d01-199">将无服务器应用程序配置为响应事件。</span><span class="sxs-lookup"><span data-stu-id="14d01-199">You configure your serverless apps to respond to events.</span></span> <span data-ttu-id="14d01-200">这可以是 REST 终结点、计时器或从另一个 Azure 服务接收的消息。</span><span class="sxs-lookup"><span data-stu-id="14d01-200">This could be a REST endpoint, a timer, or a message received from another Azure service.</span></span> <span data-ttu-id="14d01-201">无服务器应用程序仅在事件触发时才运行。</span><span class="sxs-lookup"><span data-stu-id="14d01-201">The serverless app runs only when it's triggered by an event.</span></span>

<span data-ttu-id="14d01-202">基础结构不是你的责任。</span><span class="sxs-lookup"><span data-stu-id="14d01-202">Infrastructure isn't your responsibility.</span></span> <span data-ttu-id="14d01-203">扩展和性能会自动处理, 并且您仅对您使用的确切资源计费。</span><span class="sxs-lookup"><span data-stu-id="14d01-203">Scaling and performance are handled automatically, and you are billed only for the exact resources you use.</span></span> <span data-ttu-id="14d01-204">甚至无需预留容量。</span><span class="sxs-lookup"><span data-stu-id="14d01-204">There's no need to even reserve capacity.</span></span> <span data-ttu-id="14d01-205">azure 函数、azure 容器实例和逻辑应用程序是 azure 上提供的无服务器计算的示例。</span><span class="sxs-lookup"><span data-stu-id="14d01-205">Azure Functions, Azure Container Instances, and Logic Apps are examples of serverless computing available on Azure.</span></span>

<span data-ttu-id="14d01-206">让我们重新访问 Lamna 保健示例。</span><span class="sxs-lookup"><span data-stu-id="14d01-206">Let's revisit the Lamna Healthcare example.</span></span> <span data-ttu-id="14d01-207">这可能会导致成本节省和管理轻松。</span><span class="sxs-lookup"><span data-stu-id="14d01-207">There could be some potential for cost saving and ease of management.</span></span> <span data-ttu-id="14d01-208">考虑使用 API 终结点。</span><span class="sxs-lookup"><span data-stu-id="14d01-208">Consider an API endpoint.</span></span> <span data-ttu-id="14d01-209">他们不会在 Azure 应用服务中托管 API, 在其中必须为预留的容量付款, 可以使用由 HTTP 请求触发的 Azure Function App。</span><span class="sxs-lookup"><span data-stu-id="14d01-209">Instead of hosting the API in Azure App Service, where they must pay for reserved capacity, they could use an Azure Function App triggered by an HTTP request.</span></span> <span data-ttu-id="14d01-210">Azure 函数将使团队仅支付处理每个事务所需的资源。</span><span class="sxs-lookup"><span data-stu-id="14d01-210">Azure functions would enable the team to pay only for the resources required to process each transaction.</span></span> <span data-ttu-id="14d01-211">成本和比例与系统中的事务数直接相同。</span><span class="sxs-lookup"><span data-stu-id="14d01-211">The cost and scale would be directly in line with the number of transactions in the system.</span></span>

## <a name="containers"></a><span data-ttu-id="14d01-212">存放</span><span class="sxs-lookup"><span data-stu-id="14d01-212">Containers</span></span>

<span data-ttu-id="14d01-213">容器是在虚拟化环境中运行应用程序的方法。</span><span class="sxs-lookup"><span data-stu-id="14d01-213">A container is a method running applications in a virtualized environment.</span></span> <span data-ttu-id="14d01-214">虚拟机在硬件级别进行虚拟化, 在这种情况下, 虚拟机管理程序可以在单个物理服务器上运行多个虚拟操作系统。</span><span class="sxs-lookup"><span data-stu-id="14d01-214">A virtual machine is virtualized at the hardware level, where a hypervisor makes it possible to run multiple virtualized operating systems on a single physical server.</span></span> <span data-ttu-id="14d01-215">容器使虚拟化成为一个级别。</span><span class="sxs-lookup"><span data-stu-id="14d01-215">Containers take the virtualization up a level.</span></span> <span data-ttu-id="14d01-216">虚拟化是在 OS 级别完成的, 这样就可以在同一 OS 中运行多个相同的应用程序实例。</span><span class="sxs-lookup"><span data-stu-id="14d01-216">The virtualization is done at the OS level, making it possible to run multiple identical application instances within the same OS.</span></span>

<span data-ttu-id="14d01-217">容器非常适合向外扩展应用场景。</span><span class="sxs-lookup"><span data-stu-id="14d01-217">Containers are well suited to scale out scenarios.</span></span> <span data-ttu-id="14d01-218">它们旨在轻量, 旨在在环境和需求变化时动态地进行创建、扩展和停止。</span><span class="sxs-lookup"><span data-stu-id="14d01-218">They are meant to be lightweight and are designed to be created, scaled out, and stopped dynamically as environment and demand change.</span></span>

<span data-ttu-id="14d01-219">使用容器的好处是能够在每台虚拟机上运行多个独立的应用程序。</span><span class="sxs-lookup"><span data-stu-id="14d01-219">A benefit of using containers is the ability to run multiple isolated applications on each virtual machine.</span></span> <span data-ttu-id="14d01-220">由于容器本身在内核级别受到保护和隔离, 因此不一定需要单独的虚拟机来实现不同的工作负载。</span><span class="sxs-lookup"><span data-stu-id="14d01-220">Since containers themselves are secured and isolated at a kernel level, you don't necessarily need separate VMs for separate workloads.</span></span>

<span data-ttu-id="14d01-221">虽然您可以在虚拟机上运行容器, 但有几个 Azure 服务侧重于简化容器的管理和扩展:</span><span class="sxs-lookup"><span data-stu-id="14d01-221">While you can run containers on virtual machines, there are a couple of Azure services that focus on easing the management and scaling of containers:</span></span>

- <span data-ttu-id="14d01-222">**Azure Kubernetes Service (AKS)**</span><span class="sxs-lookup"><span data-stu-id="14d01-222">**Azure Kubernetes Service (AKS)**</span></span>

  <span data-ttu-id="14d01-223">Azure Kubernetes 服务允许你将虚拟机设置为充当你的节点。</span><span class="sxs-lookup"><span data-stu-id="14d01-223">Azure Kubernetes Service allows you to set up virtual machines to act as your nodes.</span></span> <span data-ttu-id="14d01-224">Azure 托管 Kubernetes 管理平面, 并且仅托管承载容器的运行的工作人员节点的帐单。</span><span class="sxs-lookup"><span data-stu-id="14d01-224">Azure hosts the Kubernetes management plane and only bills for the running worker nodes that host your containers.</span></span>

  <span data-ttu-id="14d01-225">若要增加 azure 中的工作线程节点数, 可以使用 azure CLI 手动增加。</span><span class="sxs-lookup"><span data-stu-id="14d01-225">To increase the number of your worker nodes in Azure, you could use the Azure CLI to increase that manually.</span></span> <span data-ttu-id="14d01-226">在写入时, 在 AKS 上有 Autoscaler 的 "群集" 的预览, 可启用辅助角色节点的自动缩放。</span><span class="sxs-lookup"><span data-stu-id="14d01-226">At time of writing, there is a preview of Cluster Autoscaler on AKS available that enables autoscaling of your worker nodes.</span></span> <span data-ttu-id="14d01-227">在您的 Kubernetes 群集上, 您可以使用水平 Pod Autoscaler 来扩展要部署的容器的实例数。</span><span class="sxs-lookup"><span data-stu-id="14d01-227">On your Kubernetes cluster, you could use the Horizontal Pod Autoscaler to scale out the number of instances of the container to be deployed.</span></span>

  <span data-ttu-id="14d01-228">AKS 还可以使用以下所述的虚拟 Kubelet 进行扩展。</span><span class="sxs-lookup"><span data-stu-id="14d01-228">AKS can also scale with the Virtual Kubelet described below.</span></span>

- <span data-ttu-id="14d01-229">**Azure 容器实例 (ACI)**</span><span class="sxs-lookup"><span data-stu-id="14d01-229">**Azure Container Instances (ACI)**</span></span>
  
  <span data-ttu-id="14d01-230">Azure 容器实例是一种无服务器方法, 允许您根据需要创建和执行容器。</span><span class="sxs-lookup"><span data-stu-id="14d01-230">Azure Container Instances is a serverless approach that lets you create and execute containers on demand.</span></span> <span data-ttu-id="14d01-231">仅对每秒的执行时间计费。</span><span class="sxs-lookup"><span data-stu-id="14d01-231">You're charged only for the execution time per second.</span></span>

  <span data-ttu-id="14d01-232">您可以使用 Virtual Kubelet 将 Azure 容器实例连接到您的 Kubernetes 环境中, 包括 AKS。</span><span class="sxs-lookup"><span data-stu-id="14d01-232">You can use Virtual Kubelet to connect Azure Container Instances into your Kubernetes environment, including AKS.</span></span> <span data-ttu-id="14d01-233">使用 Virtual Kubelet 时, 当 Kubernetes 群集需要其他容器实例时, 可以从 ACI 满足这些要求。</span><span class="sxs-lookup"><span data-stu-id="14d01-233">With Virtual Kubelet, when your Kubernetes cluster demands additional container instances, those demands can be met from ACI.</span></span> <span data-ttu-id="14d01-234">由于 ACI 是无服务器的, 因此无需保留容量。</span><span class="sxs-lookup"><span data-stu-id="14d01-234">Since ACI is serverless, there is no need to have reserved capacity.</span></span> <span data-ttu-id="14d01-235">因此, 您可以利用 Kubernetes 扩展的控制和灵活性, 每秒计费为无服务器。</span><span class="sxs-lookup"><span data-stu-id="14d01-235">You can therefore take advantage of the control and flexibility of Kubernetes scaling with the per-second-billing of serverless.</span></span> <span data-ttu-id="14d01-236">在写入时, 虚拟 Kubelet 被描述为实验性软件, 不应在生产方案中使用。</span><span class="sxs-lookup"><span data-stu-id="14d01-236">At time of writing, the Virtual Kubelet is described as experimental software and should not be used in production scenarios.</span></span>

## <a name="scaling-at-lamna-healthcare"></a><span data-ttu-id="14d01-237">在 Lamna 保健中扩展</span><span class="sxs-lookup"><span data-stu-id="14d01-237">Scaling at Lamna Healthcare</span></span>

<span data-ttu-id="14d01-238">Lamna 保健运行患者管理和预订系统。</span><span class="sxs-lookup"><span data-stu-id="14d01-238">Lamna Healthcare operates a patient management and booking system.</span></span> <span data-ttu-id="14d01-239">管理系统跨几十个医院和医疗机构处理约会预定和患者记录。</span><span class="sxs-lookup"><span data-stu-id="14d01-239">The management system handles appointment bookings and patient records across dozens of hospitals and medical facilities.</span></span> <span data-ttu-id="14d01-240">本地运行状况服务以全容量方式运行, 目前不会出现任何增长。</span><span class="sxs-lookup"><span data-stu-id="14d01-240">The local health service is running at full capacity, and no growth is expected at the moment.</span></span> <span data-ttu-id="14d01-241">系统在 Azure 应用服务中托管的 PHP 网站上运行。</span><span class="sxs-lookup"><span data-stu-id="14d01-241">The system is running on a PHP website hosted in Azure App Service.</span></span>

<span data-ttu-id="14d01-242">应用程序的负载模式是可预测的, 因为它们主要在9到5个小时之间运行星期一到星期五。</span><span class="sxs-lookup"><span data-stu-id="14d01-242">The load pattern of the application is predictable, as they primarily operate Monday to Friday between the hours of 9 to 5.</span></span>  <span data-ttu-id="14d01-243">从周二到星期五, 系统在整个系统中平均每小时1200个事务。</span><span class="sxs-lookup"><span data-stu-id="14d01-243">From Tuesday through to Friday, the system averages 1,200 transactions per hour across the entire system.</span></span> <span data-ttu-id="14d01-244">在周末, 它处理每小时500个事务。</span><span class="sxs-lookup"><span data-stu-id="14d01-244">During the weekend, it handles 500 transactions per hour.</span></span> <span data-ttu-id="14d01-245">在周末静音后, 星期一每小时平均可达2000个交易记录。</span><span class="sxs-lookup"><span data-stu-id="14d01-245">After the quiet of the weekend, Mondays are busy with an average of 2,000 transactions per hour.</span></span>

<span data-ttu-id="14d01-246">应用程序托管在 S1 应用服务计划中, 但操作团队已注意到高水平的 CPU 使用率 (超过 95%)在所有实例中。</span><span class="sxs-lookup"><span data-stu-id="14d01-246">The application is hosted on an S1 App Service plan, but the operations team have noticed a high level of CPU utilization (over 95%) across all instances.</span></span> <span data-ttu-id="14d01-247">高使用率会影响应用程序的处理和加载时间。</span><span class="sxs-lookup"><span data-stu-id="14d01-247">The high usage is having an impact on the processing and loading times of the application.</span></span> <span data-ttu-id="14d01-248">在云环境中, 使用率较高的资源不一定是一件好事。</span><span class="sxs-lookup"><span data-stu-id="14d01-248">In a cloud environment, having highly utilized resources is not necessarily a bad thing.</span></span> <span data-ttu-id="14d01-249">这意味着, 如果部署的资源很好地使用, 则会为其获取资金价值。</span><span class="sxs-lookup"><span data-stu-id="14d01-249">It means that they are getting value for their money, as the resources deployed are being well used.</span></span> 

<span data-ttu-id="14d01-250">团队决定将已部署实例的 App Service 计划级别从 S1 (1 vCPU 和 1.75 gb 的 ram)_扩展_到 S2 (2 vCPUs 和 3 GB ram)。</span><span class="sxs-lookup"><span data-stu-id="14d01-250">The team decide to _scale up_ the App Service plan level for the deployed instances from S1 (1 vCPU and 1.75 GB of RAM) to S2 (2 vCPUs and 3 GB of RAM).</span></span> <span data-ttu-id="14d01-251">他们可以使用 azure 门户轻松实现此目的, 但可以使用 azure CLI、azure PowerShell 中的单个命令或使用资源管理器模板实现相同的操作。</span><span class="sxs-lookup"><span data-stu-id="14d01-251">They easily achieve this using the Azure portal, but could have achieved the same thing using a single command in the Azure CLI, Azure PowerShell, or using Resource Manager templates.</span></span>

<span data-ttu-id="14d01-252">团队决定要根据计划自动部署部署的实例数, 因为它们的负载配置文件是可预测的。</span><span class="sxs-lookup"><span data-stu-id="14d01-252">The team decide that they want to automate the number of instances deployed based upon a schedule, as their load profile is predictable.</span></span> <span data-ttu-id="14d01-253">它们配置应用服务计划的自动缩放计划。</span><span class="sxs-lookup"><span data-stu-id="14d01-253">They configure the App Service plan's autoscale schedule.</span></span> <span data-ttu-id="14d01-254">假设有两个实例充分处理每小时500个事务。</span><span class="sxs-lookup"><span data-stu-id="14d01-254">Let's assume two instances sufficiently handle 500 transactions per hour.</span></span> <span data-ttu-id="14d01-255">然后, 团队可以将星期二-星期五和八个实例的6个实例扩展到星期一以满足要求 (根据对负载测试的洞察力和监控)。</span><span class="sxs-lookup"><span data-stu-id="14d01-255">The team could then scale to six instances for Tuesday - Friday and eight instances for a Monday to meet the requirements (based upon insight and monitoring from load tests).</span></span>

<span data-ttu-id="14d01-256">自动缩放还为它们提供了额外的好处, 从而为这些不可预见的方案做准备。</span><span class="sxs-lookup"><span data-stu-id="14d01-256">Autoscale also gives them an added benefit, preparing for those unforeseen scenarios.</span></span> <span data-ttu-id="14d01-257">该网站可能突然在周末 (由于 colds 和 flu 而在冬季中有更多的约会) 执行更多的负载。</span><span class="sxs-lookup"><span data-stu-id="14d01-257">The site may suddenly take higher than expected load on the weekend (more appointments in the winter season because of colds and flu).</span></span> <span data-ttu-id="14d01-258">当 CPU 百分比高于 70%, 并且使用率低于 15% 时, 团队可以设置自动缩放以按一个实例增加一个实例。</span><span class="sxs-lookup"><span data-stu-id="14d01-258">The team can set up autoscale to increase by one instance when CPU percentage is above 70% and reduce by one instance when usage is below 15%.</span></span>

<span data-ttu-id="14d01-259">团队已在患者预订 API 中使用了限制模式, 这些模式已在 Azure API 管理实例的后面公开。</span><span class="sxs-lookup"><span data-stu-id="14d01-259">The team have used the throttling pattern inside of the patient booking API they have exposed behind an Azure API Management instance.</span></span> <span data-ttu-id="14d01-260">这有助于防止系统通过系统仅允许一定量的吞吐量来提高系统的性能。</span><span class="sxs-lookup"><span data-stu-id="14d01-260">This helps prevent the system from performing poorly by only allowing a certain volume of throughput through the system.</span></span>

<span data-ttu-id="14d01-261">我们讨论了向上、向下和向下扩展, 以及如何在体系结构中利用这些选项。</span><span class="sxs-lookup"><span data-stu-id="14d01-261">We've talked about scaling up and down and scaling in and out, and how you can leverage these options in your architecture.</span></span> <span data-ttu-id="14d01-262">我们还介绍了无服务器技术和容器如何帮助发展扩展功能。</span><span class="sxs-lookup"><span data-stu-id="14d01-262">We've also looked at how serverless technologies and containers can help evolve your scaling capabilities.</span></span>