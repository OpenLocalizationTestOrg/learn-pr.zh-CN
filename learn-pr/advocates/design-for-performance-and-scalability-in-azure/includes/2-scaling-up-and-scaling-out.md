我们很少能准确预测我们系统上的负载: 面向公众的应用程序可能会迅速增长, 或者内部应用程序可能需要在业务增长时支持更大的用户群体。 即使我们可以预测负载, 也很少出现以下情况: 零售商在 playoffs 期间的假日和体育网站高峰期的需求更多。 在这里, 我们将定义_向上/向下扩展和向__外扩展_, 涵盖了一些 Azure 可以改善扩展功能的方法, 并介绍了无服务器和容器技术如何能够提高体系结构的扩展能力。

## <a name="what-is-scaling"></a>扩展是什么？

_缩放_是管理您的资源以帮助您的应用程序满足一组性能要求的过程。  如果我们为用户提供了过多的资源, 我们将不会有效地使用它, 我们将浪费资金。 可用资源过少意味着应用程序的性能可能会受到影响。 目标是在优化成本时满足已定义的性能要求。 

"_资源_" 可以指运行我们的应用程序需要管理的任何内容。 虚拟机的内存和 CPU 是最明显的资源, 但某些 Azure 服务可能需要考虑带宽或抽象化, 如 Cosmos DB 请求单元。

在应用程序要求是常量的世界中, 很容易预测所需的资源量。 在现实中, 应用程序的需求随着时间的推移而发生变化, 因此, 所需的资源量可能更难预测。 如果你幸运, 该更改将是可预测的或季节性的, 但不是所有应用程序的典型更改。 理想情况下, 您需要调配适当的资源量来满足需求, 并根据需求的变化进行调整。

在本地方案中, 在购买和管理自己的服务器的情况下, 缩放非常困难。 添加资源可能会导致成本高昂且通常需要很长时间才能进入联机状态, 有时比您实际需要的增加的容量长。 在系统较低需求的时间内, 可以很难减少容量, 因此您可能会陷入成本增加的情况。

轻松扩展是 Azure 的主要优势。 大多数 Azure 资源可让您轻松地添加或删除资源作为需求更改, 并且许多服务都具有自动化的选项, 以便他们监视需求并为您调整。 此自动缩放功能通常称为自动缩放功能, 可用于设置应可用实例的最小和最大级别的阈值, 并根据性能指标 (例如, CPU 使用率) 添加或删除实例。

#### <a name="scaling-up-and-out"></a>向上扩展和向后扩展

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yBWi]

## <a name="what-is-scaling-up-or-down"></a>向上或向下扩展什么？

向上扩展是我们增加给定实例容量的过程。 可以将虚拟机从 1 vCPU 和 3.5 gb 的 ram 增加到 2 vCPUs 和 7 gb 的 ram, 以提供更多的处理能力。 另一方面, 向下扩展是指降低给定实例容量的过程。 例如, 将虚拟机的容量从 2 vCPUs 和 7 gb ram 减少到1个 vCPU 和 3.5 gb 的 ram, 同时降低容量和成本。 下图显示了更改虚拟机大小的示例。

![该图显示了在虚拟机上向上扩展和向下扩展以更改性能功能。](../media/2-ScaleUpDown.png)

让我们看一下 Azure 资源上下文中的向上或向下扩展是什么意思:

- 在 Azure 虚拟机中, 可以根据虚拟机大小进行扩展。 该大小具有与之关联的一定量的 vCPUs、RAM 和本地存储。 例如, 我们可以从 Standard_DS1_v2 虚拟机 (1 vCPU 和 3.5 gb 的 ram) 向上扩展到 Standard_DS2_v2 虚拟机 (2 vCPUs 和 7 gb ram)。
- Azure SQL Database 是 Microsoft SQL Server 的服务 (PaaS) 实施平台。  您可以根据数据库事务单元数 (dtu) 或 vCPUs 扩展数据库。 dtu 是底层资源的抽象概念, 并且是 CPU、IO 和内存的混合。 例如, 您可以将 Azure SQL 数据库从大小为 P2、250 dtu 的 P2 扩展到带 500 dtu 的 P4, 从而为数据库提供更高的吞吐量和容量。
- azure 应用服务是 azure 上的 PaaS 网站托管服务。 网站在虚拟服务器场 (也称为 "应用服务计划") 上运行。 您可以在层之间向上或向下扩展应用服务计划, 并在层中具有容量选项。 例如, S1 App Service 计划的每个实例包含 1 vCPU 和 1.75 GB 的 RAM。 我们可以扩展到 S2 应用服务计划, 每个实例包含 2 vCPUs 和 3 GB RAM。

若要在本地环境中使用这些功能, 通常需要等待采购所需的硬件和安装, 然后才能开始使用新的规模级别。 在 Azure 中, 物理资源已部署并可供您使用。 只需选择您想要使用的其他级别的小数位数即可。

您可能需要考虑在解决方案中进行扩展时的影响, 具体取决于您选择的云服务。

例如, 如果选择在 Azure SQL 数据库中进行扩展, 服务将处理各个节点的扩展, 并继续执行服务操作。 更改数据库的服务层和/或性能级别会在新的性能级别创建原始数据库的副本, 然后将连接切换到该副本。 在此过程中, 不会丢失任何数据, 并且在该服务切换到副本时仅有短暂的中断 (通常不到四秒)。

或者, 如果您选择向上或向下扩展虚拟机, 您可以通过选择其他实例大小来执行此操作。 在大多数情况下, 这需要重新启动 VM, 因此最好能够预期需要重新启动, 并且在执行此活动时需要考虑。

最后, 应始终查看向下扩展的位置是一个选项。 如果您的应用程序能够在较低的价位提供充分的性能, 则您的 Azure 帐单将大大降低。

## <a name="what-is-scaling-out-or-in"></a>横向或放大了什么？

在上下扩展调整单个实例可用的资源量时, 向内扩展和调整总的实例数。

向_之外扩展_是添加更多实例以支持解决方案负载的过程。 例如, 如果我们的网站前端托管在虚拟机上, 则可以增加虚拟机的数量 (如果负载级别增加)。

__ 放大是指删除不再需要用于支持解决方案负载的实例的过程。 如果网站前端使用率较低, 我们可能想要降低实例数以节省成本。 下图显示了更改虚拟机实例数的示例。


![展示了如何向外扩展资源以处理需求和在资源中缩放以降低成本。](../media/2-ScaleInOut.png)

下面的示例展示了在 Azure 资源上下文中扩展或在什么方面的含义:

- 对于基础结构层, 您可能会使用虚拟机扩展集自动执行额外实例的添加和删除操作。
  - 使用虚拟机扩展集, 可以创建和管理一组相同的负载平衡虚拟机。
  - VM 实例的数量可以根据需求或定义的计划自动增加或减少。
- 在 Azure SQL 数据库实现中, 可以通过 sharding 在数据库实例之间共享负载。 _Sharding_是一种在许多独立的数据库中分布大量相同结构化数据的技术。
- 在 Azure 应用服务中, 应用服务计划是托管应用程序的虚拟 web 服务器场。 以这种方式进行扩展意味着您要增加服务器场中的虚拟机数。 与虚拟机规模设置一样, 可以自动提升或降低实例数以响应某些指标或计划。

横向扩展通常很容易在 Azure 门户、命令行工具或资源管理器模板中执行, 在大多数情况下, 最终用户是无缝执行的。

### <a name="autoscale"></a>自动

您可以将其中一些服务配置为使用名为自动缩放的功能。 使用自动缩放, 您不再需要担心手动缩放服务。 相反, 您可以根据特定指标 (队列长度、CPU 使用率) 或计划 (介于 5:00 pm 和 7:00 pm 之间的工作日) 设置实例和规模的最小和最大阈值。 下图显示自动缩放功能如何管理实例以处理负载。

![该图显示了自动缩放如何监视虚拟机池的 cpu 级别, 并在 CPU 使用率高于阈值时添加实例。](../media/2-autoscale.png)

### <a name="considerations-when-scaling-in-and-out"></a>放大和缩小时的注意事项

当向外扩展时, 应用程序的启动时间可能会影响应用程序扩展的速度。 如果你的 web 应用需要两分钟才能启动并供用户使用, 则意味着你的每个实例将需要两分钟时间, 直到你的用户可以使用它们。 在确定您想要扩展的速度时, 需要考虑此启动时间。

你还需要考虑应用程序如何处理状态。 当应用程序在中进行扩展时, 存储在计算机上的任何状态将不再可用。 如果用户连接到不具有其状态的实例, 则可以强制其登录或重新选择数据, 从而导致用户体验不佳。 常见模式是 externalize 状态到另一种服务 (如 Redis 缓存或 SQL 数据库), 使 web 服务器无状态。 现在, 我们的 web 前端是无状态的, 我们无需担心各个实例的可用性。 它们都执行相同的作业并以相同的方式进行部署。

## <a name="throttling"></a>限制

我们已确定应用程序上的负载随时间的推移而变化。 这可能是由于活动用户数、并发用户数以及正在执行的活动数而引起的。 虽然可以使用自动缩放功能添加容量, 但我们也可以使用限制机制来限制来自源的请求数。 我们可以通过将已知限制放在应用程序级别来保护性能限制, 从而防止应用程序中断。 限制在公开 API 终结点的应用程序中最常用。

一旦应用程序确定它会破坏限制, 则限制可能会开始, 并确保总体系统 SLA 不受侵害。 例如, 如果我们公开了一个 API 以供客户获取数据, 我们可以将请求数限制为每分钟100。 如果任何一个客户超出了此限制, 我们可以使用 HTTP 429 状态代码进行响应, 包括等待时间, 然后才能成功提交另一个请求。

## <a name="serverless"></a>服务器

无服务器计算提供一个云承载的执行环境, 该环境可运行应用程序, 但会完全抽象化基础环境。 创建服务的实例, 然后添加代码;不需要基础结构管理或维护, 甚至不允许进行维护。

将无服务器应用程序配置为响应事件。 这可以是 REST 终结点、计时器或从另一个 Azure 服务接收的消息。 无服务器应用程序仅在事件触发时才运行。

基础结构不是你的责任。 扩展和性能会自动处理, 并且您仅对您使用的确切资源计费。 甚至无需预留容量。 azure 函数、azure 容器实例和逻辑应用程序是 azure 上提供的无服务器计算的示例。

让我们重新访问 Lamna 保健示例。 这可能会导致成本节省和管理轻松。 考虑使用 API 终结点。 他们不会在 Azure 应用服务中托管 API, 在其中必须为预留的容量付款, 可以使用由 HTTP 请求触发的 Azure Function App。 Azure 函数将使团队仅支付处理每个事务所需的资源。 成本和比例与系统中的事务数直接相同。

## <a name="containers"></a>存放

容器是在虚拟化环境中运行应用程序的方法。 虚拟机在硬件级别进行虚拟化, 在这种情况下, 虚拟机管理程序可以在单个物理服务器上运行多个虚拟操作系统。 容器使虚拟化成为一个级别。 虚拟化是在 OS 级别完成的, 这样就可以在同一 OS 中运行多个相同的应用程序实例。

容器非常适合向外扩展应用场景。 它们旨在轻量, 旨在在环境和需求变化时动态地进行创建、扩展和停止。

使用容器的好处是能够在每台虚拟机上运行多个独立的应用程序。 由于容器本身在内核级别受到保护和隔离, 因此不一定需要单独的虚拟机来实现不同的工作负载。

虽然您可以在虚拟机上运行容器, 但有几个 Azure 服务侧重于简化容器的管理和扩展:

- **Azure Kubernetes Service (AKS)**

  Azure Kubernetes 服务允许你将虚拟机设置为充当你的节点。 Azure 托管 Kubernetes 管理平面, 并且仅托管承载容器的运行的工作人员节点的帐单。

  若要增加 azure 中的工作线程节点数, 可以使用 azure CLI 手动增加。 在写入时, 在 AKS 上有 Autoscaler 的 "群集" 的预览, 可启用辅助角色节点的自动缩放。 在您的 Kubernetes 群集上, 您可以使用水平 Pod Autoscaler 来扩展要部署的容器的实例数。

  AKS 还可以使用以下所述的虚拟 Kubelet 进行扩展。

- **Azure 容器实例 (ACI)**
  
  Azure 容器实例是一种无服务器方法, 允许您根据需要创建和执行容器。 仅对每秒的执行时间计费。

  您可以使用 Virtual Kubelet 将 Azure 容器实例连接到您的 Kubernetes 环境中, 包括 AKS。 使用 Virtual Kubelet 时, 当 Kubernetes 群集需要其他容器实例时, 可以从 ACI 满足这些要求。 由于 ACI 是无服务器的, 因此无需保留容量。 因此, 您可以利用 Kubernetes 扩展的控制和灵活性, 每秒计费为无服务器。 在写入时, 虚拟 Kubelet 被描述为实验性软件, 不应在生产方案中使用。

## <a name="scaling-at-lamna-healthcare"></a>在 Lamna 保健中扩展

Lamna 保健运行患者管理和预订系统。 管理系统跨几十个医院和医疗机构处理约会预定和患者记录。 本地运行状况服务以全容量方式运行, 目前不会出现任何增长。 系统在 Azure 应用服务中托管的 PHP 网站上运行。

应用程序的负载模式是可预测的, 因为它们主要在9到5个小时之间运行星期一到星期五。  从周二到星期五, 系统在整个系统中平均每小时1200个事务。 在周末, 它处理每小时500个事务。 在周末静音后, 星期一每小时平均可达2000个交易记录。

应用程序托管在 S1 应用服务计划中, 但操作团队已注意到高水平的 CPU 使用率 (超过 95%)在所有实例中。 高使用率会影响应用程序的处理和加载时间。 在云环境中, 使用率较高的资源不一定是一件好事。 这意味着, 如果部署的资源很好地使用, 则会为其获取资金价值。 

团队决定将已部署实例的 App Service 计划级别从 S1 (1 vCPU 和 1.75 gb 的 ram)_扩展_到 S2 (2 vCPUs 和 3 GB ram)。 他们可以使用 azure 门户轻松实现此目的, 但可以使用 azure CLI、azure PowerShell 中的单个命令或使用资源管理器模板实现相同的操作。

团队决定要根据计划自动部署部署的实例数, 因为它们的负载配置文件是可预测的。 它们配置应用服务计划的自动缩放计划。 假设有两个实例充分处理每小时500个事务。 然后, 团队可以将星期二-星期五和八个实例的6个实例扩展到星期一以满足要求 (根据对负载测试的洞察力和监控)。

自动缩放还为它们提供了额外的好处, 从而为这些不可预见的方案做准备。 该网站可能突然在周末 (由于 colds 和 flu 而在冬季中有更多的约会) 执行更多的负载。 当 CPU 百分比高于 70%, 并且使用率低于 15% 时, 团队可以设置自动缩放以按一个实例增加一个实例。

团队已在患者预订 API 中使用了限制模式, 这些模式已在 Azure API 管理实例的后面公开。 这有助于防止系统通过系统仅允许一定量的吞吐量来提高系统的性能。

我们讨论了向上、向下和向下扩展, 以及如何在体系结构中利用这些选项。 我们还介绍了无服务器技术和容器如何帮助发展扩展功能。