网络性能会对用户体验产生显著影响。 在具有多种不同服务的复杂体系结构中, 最大程度地减少每个跃点的延迟可能会对整体性能产生重大影响。 在此单元中, 我们将讨论网络延迟的重要性以及如何在体系结构中对其进行减少。 我们还将讨论 Lamna 保健采用的策略如何最大限度地减少 Azure 资源之间以及用户和 Azure 之间的网络延迟。

## <a name="the-importance-of-network-latency"></a>网络延迟的重要性

延迟是一种延迟指标。 网络延迟是在某个网络基础结构中从一个源到达目标所需的时间。 此时间段通常称为往返延迟, 或从源恢复到目标并再次返回时所需的时间。

在传统数据中心环境中, 延迟可能会很小, 因为资源通常共享相同的位置和一组通用的基础结构。 当资源在物理上断开时, 从源获取到目标所需的时间较低。

相比之下, 云环境是针对规模而构建的。 云托管的资源可能不在同一机架、数据中心, 甚至地区。 这种分布式方法可能会影响网络通信的往返时间。 虽然所有 Azure 区域都是通过高速光纤主干网互连的, 但光的速度仍是物理限制。 不同物理位置中的服务之间的呼叫将仍具有与它们之间的距离直接相关的网络延迟。

在此之上, chattier 应用程序, 需要的往返行程越多。 每个往返行程都带有延迟税, 每个往返行程都添加到整体延迟。 下图显示了用户可检测到的延迟的组合, 以及为请求提供服务所需的往返次数。

![该图显示了位于云中不同地理位置的资源之间的网络延迟。](../media/3-networkLatency.png)

现在, 我们来看看如何提高 azure 资源和最终用户与 azure 资源之间的性能。

## <a name="latency-between-azure-resources"></a>Azure 资源之间的延迟

假设 Lamna 保健正在试验在多台 web 服务器上运行新的患者预订系统, 以及西欧 Azure 区域中的数据库。 此体系结构可将网络上的数据时间减至最少, 因为资源在 Azure 区域中有共同的位置。

假定系统的试用版已顺利完成, 并已扩展到澳大利亚用户。 澳大利亚的用户将发生到欧洲西部的资源的往返时间, 以查看网站, 最终用户体验将因网络延迟而变差。

Lamna 保健团队决定在澳大利亚东部地区托管另一个前端实例, 以减少用户延迟。 虽然此设计有助于缩短 web 服务器将内容返回给最终用户的时间, 但由于澳大利亚东部的前端 web 服务器和西欧的数据库中的前端 web 服务器之间的通信发生重大延迟, 因此其体验仍很差。

可以通过几种方法来减少剩余的延迟:

- 在澳大利亚东部中创建数据库的读取副本。 这将允许读取正常运行, 但写入仍会导致延迟。 Azure SQL 数据库异地复制允许读取副本。
- 在具有 Azure SQL 数据同步的区域之间同步你的数据。
- 使用全局分布式数据库, 如 Azure Cosmos DB。 这将允许读取和写入操作, 而不考虑位置, 但可能需要对应用程序存储和引用数据的方式进行更改。
- 使用缓存技术 (如 Redis 的 Azure 缓存) 将对频繁访问的数据的远程数据库的高延迟调用降至最低。

此处的目标是最大限度地减少应用程序的每个层之间的网络延迟。 此解决方案的解决方式取决于您的应用程序和数据体系结构, 但 Azure 提供了在多个服务上解决这一情况的机制。

## <a name="latency-between-users-and-azure-resources"></a>用户和 Azure 资源之间的延迟

我们查看了 Azure 资源之间的延迟, 但我们还应考虑用户与我们的云应用程序之间的延迟。 我们希望优化对用户的前端用户界面的交付。 让我们来看看在最终用户和应用程序之间提高网络性能的一些方法。

### <a name="use-a-dns-load-balancer-for-endpoint-path-optimization"></a>使用 DNS 负载平衡器进行终结点路径优化

在 Lamna 保健示例中, 我们看到团队在澳大利亚东部中创建了其他 web 前端节点。 但是, 最终用户必须明确指定要使用的前端终结点。 作为解决方案的设计者, Lamna 医疗保健希望为其用户提供尽可能平滑的体验。

Azure 流量管理器可能会有所帮助。 流量管理器是基于 DNS 的负载平衡器, 它使您能够在 Azure 区域内以及在 Azure 区域之间分布流量。 流量管理器可根据一组特征路由用户, 而不是让用户浏览到 web 前端的特定实例:

- **优先级**-指定前端实例的已排序列表。 如果具有最高优先级的用户不可用, 流量管理器会将用户路由到下一个可用的实例。
- **加权**-将为每个前端实例设置权重。 然后, 流量管理器根据已定义的比率来分配流量。
- **性能**流量管理器根据网络延迟将用户路由到最近的前端实例。
- **地理**位置-您可以为前端部署设置地理区域, 并根据数据主权的要求或本地化内容来路由您的用户。

此外, 还可以嵌套流量管理器配置文件。 您可以先使用地理路由在不同地理位置 (例如, 欧洲和澳大利亚) 路由用户, 然后使用性能路由方法将它们路由到本地前端部署。

请注意, Lamna 保健已在西欧和澳大利亚部署了 web 前端。 假定他们已在西欧的主要部署中部署了 Azure SQL 数据库以及在澳大利亚东部的读取副本。 我们还假设应用程序可以连接到本地 SQL 实例以进行读取查询。

团队在性能模式中部署流量管理器实例, 并将这两个前端实例添加为流量管理器配置文件。 作为最终用户, 您可以导航到流量管理器路由到的自定义域名 (例如, lamnahealthcare.com)。 然后, 流量管理器将基于最佳网络延迟性能返回西欧或澳大利亚东前端的 DNS 名称。

请务必注意, 此负载平衡仅通过 DNS 处理, 没有内嵌负载平衡或缓存在此处发生, 而流量管理器只是向用户返回最近前端的 DNS 名称。

### <a name="use-cdn-to-cache-content-close-to-users"></a>使用 CDN 将内容缓存到用户附近

该网站可能会使用某种形式的静态内容 (整页或资产, 如图像和视频)。 此内容可以通过使用内容传递网络 (CDN) (如 Azure CDN) 更快地传递给用户。 

当 Lamna 将内容部署到 Azure CDN 时, 会将这些项目复制到全球范围内的多台服务器上。 假设其中一项是从 blob 存储提供的视频: `HowToCompleteYourBillingForms.MP4`。 然后, 团队将网站配置为, 使每个用户的视频链接实际引用最接近它们的 CDN 边缘服务器, 而不是引用 blob 存储。 此方法将内容放在更接近目标的位置, 从而减少延迟和改善用户体验。 下图显示了如何使用 Azure CDN 将内容放在更接近目标的位置, 从而减少延迟并改善用户体验。

![该图显示了如何使用 Azure 内容传送网络来减少延迟。](../media/3-cdnSketch.png)

内容传递网络也_可_用于承载缓存的动态内容。 但需要额外考虑, 因为缓存的内容与源相比可能已过期。 可以通过将时间设置为生存时间 (TTL) 来控制上下文过期。 如果 TTL 过高, 则可能会显示过时的内容, 并且需要清除缓存。

处理缓存内容的一种方法是一个称为 "**动态网站加速**" 的功能, 它可以提高使用动态内容的网页的性能。 动态网站加速还可以提供到解决方案中的其他服务的低延迟路径 (例如 API 终结点)。

### <a name="use-expressroute-for-connectivity-from-on-premises-to-azure"></a>将 ExpressRoute 用于从本地到 Azure 的连接

优化从本地环境到 Azure 的网络连接也很重要。 对于连接到应用程序的用户, 无论是在虚拟机上还是在与 Azure 应用服务类似的 PaaS 产品上托管, 您都需要确保它们可以与应用程序建立最佳连接。 

您始终可以使用公共 internet 将用户连接到您的服务, 但 internet 性能可能会有所不同, 并且可能会受到外部问题的影响。 在此之上, 你可能不希望通过 internet 公开你的所有服务, 你可能需要与 Azure 资源的专用连接。

internet 上的站点到站点 VPN 也是一个选项, 但对于高吞吐量体系结构, VPN 开销和 internet 可变性可能会显著增加延迟。

Azure ExpressRoute 可帮助。 ExpressRoute 是你的网络与 Azure 之间的专用专用连接, 它为你提供了保证的性能, 并确保最终用户具有你的所有 Azure 资源的最佳路径。 下图显示了 ExpressRoute 电路如何在本地应用程序和 Azure 资源之间提供连接。

![显示与 Azure 资源连接客户网络的 ExpressRoute 电路的体系结构图。](../media/3-expressroute-connection-overview.png)

再次查看 Lamna 的方案后, 他们决定通过在澳大利亚东部和西欧中预配的 ExpressRoute 电路来进一步改进其设施中用户的最终用户体验。 这使他们的最终用户能够直接连接到其预订系统, 并确保其应用程序可能具有最低延迟。

考虑到对体系结构的网络延迟的影响对于确保最终用户可能获得最佳性能非常重要。 我们查看了一些选项, 以降低最终用户和 azure 之间和 azure 资源之间的网络延迟。