最终用户需要来自其应用程序的更多相关信息。 他们希望拥有极好的用户体验, 而不会受到性能问题的影响。 如何将性能瓶颈标识集成到您的体系结构中？ 在此单元中, 我们将介绍可帮助您确保应用程序正常运行的过程和工具, 并帮助您跟踪其是否正常运行的原因。

## <a name="importance-of-requirements"></a>要求的重要性

在讨论性能之前, 务必要讨论要求。 在理论上, 我们可以继续提高可伸缩性和性能, 而无需结束。 然而, 在某些时候, 更好的改进是成本太大、困难, 并且对业务的影响没有足够的价值。 

我们的**非功能性要求**有助于我们找到该点。 这些特殊要求不会告诉我们应用程序必须*执行的操作*。 而是告诉我们它必须满足的质量级别。 作为示例, 我们可以定义这些非功能性要求来告诉我们:

- 事务在给定负载下必须返回的速度。
- 在开始返回错误之前, 我们需要支持多少个同时连接。
- 如果出现服务器故障, 在备份处于联机状态之前, 允许应用程序的最长时间是多少。

在构建解决方案之前定义这些要求对于确保应用程序满足预期, 而不需要更多的努力或增加所需的成本至关重要。 我们还可以围绕这些非功能性要求规划我们的监控和操作规则。 

与您的利益干系人或客户讨论要求、记录这些要求, 并进行全面交流以确保每个人都能同意 "良好性能" 的含义。

## <a name="devops-and-application-performance"></a>DevOps 和应用程序性能

DevOps 背后的理念是, 我们的组织中没有开发和基础结构小仓库。 相反, 它们协同工作以在简化的过程中有效地构建、部署、监视和维护应用程序。

计划、开发、测试和监控在迭代方法中执行。 我们的应用程序的性能和质量成为我们的软件开发生命周期的一部分, 而不是我们部署到实际环境中的事后。 下图显示了在软件开发生命周期中存在协作的机会。

![该图显示了软件生命周期中排列的步骤, 以显示每个阶段如何进入下一个循环。](../media/5-devops-cycle.png)

此方法与称为 "向左移位" 的 DevOps 概念对齐。 换言之, 将您的质量控制检查提前到部署和发布过程中。 这使您可以捕获之前的最终用户影响的问题。 当我们在连续循环中运行时, 我们限制手动交互的数量, 并尽可能实现自动化。 

我们在 DevOps 过程中进行性能的一种方法是执行性能或负载测试, 以验证应用程序在部署到生产环境之前是否满足非功能性要求。

理想情况下, 我们可以在与生产完全一样的环境中执行性能和负载测试, 而不会影响实际生产服务器。 利用云时, 您完全可以使用此功能。 您可以自动创建一个与生产类似的环境, 执行测试, 然后销毁环境以最大限度地减少成本。 此自动化方法可提供您的应用程序可以立即处理您所需的规模的保证, 以及对未来的增长做出响应。

应用程序性能监视成为此的核心部分。 如果我们在我们的应用程序上运行性能和负载测试或想要保持我们的生产性能, 请务必了解应用程序的哪些部分可能以非最佳方式执行。 让我们看一下执行此操作的一些方法。

## <a name="performance-monitoring-options-in-azure"></a>Azure 中的性能监视选项

监控是收集和分析数据以确定业务应用程序和相关资源的性能、运行状况和可用性的操作。

我们希望得到我们的应用程序顺利运行的通知。 主动通知可用于通知出现的关键问题。 有许多要考虑的监视层, 主要是基础结构层和应用程序层。

### <a name="azure-monitor"></a>Azure 监视器

azure Monitor 为大部分 Azure 服务提供了一个管理点, 用于基础结构级日志和监控。 它收集指标、活动日志和诊断日志等。 Azure Monitor 为我们提供了一系列功能, 包括:

- Azure 警报以主动通知或对所产生的指标或活动采取措施。
- 使用 Azure 仪表板将许多监视源组合到我们的应用程序的一个视图中。

若要了解所有接近的实时资源度量见解, 请务必从 Azure Monitor 入手。 许多 Azure 资源将在部署后自动开始输出指标。 例如, Azure Web 应用程序实例将输出计算和应用程序请求指标。 除了 VM 主机诊断指标之外, 还会在这里对 application Insights 中的指标进行排序。 选择加入后, VM 来宾诊断指标也会显示出来。

### <a name="log-analytics"></a>日志分析

集中日志记录可帮助您发现可能难以跟踪的隐藏问题。 使用日志分析, 可以跨日志查询和聚合数据。 此跨源关联可帮助您识别单独查看日志或指标时可能不明显的问题或性能问题。 下图显示了 Log Analytics 如何充当监视数据的中心中心。 日志分析接收来自 Azure 资源的监视数据, 并使其可供使用者进行分析或可视化。

![显示资源监控中的日志分析角色的插图。](../media/5-log-analytics.png)

您可以对各种数据源、安全日志、Azure 活动日志、服务器、网络和应用程序日志进行整理。 您还可以将本地 System Center Operations Manager 数据推送到混合部署方案中的日志分析, 并将 Azure SQL 数据库直接发送到 Log Analytics 以进行详细的性能监视。

集中日志记录对于解决各种类型的应用程序 (包括性能问题) 而言是非常有益的。 它是适用于任何体系结构的有效监视策略的关键部分。

## <a name="application-performance-management"></a>应用程序性能管理

较深的应用程序问题通常很难跟踪。 在这种情况下, 可以使用应用程序性能管理解决方案 (APM) 将遥测集成到应用程序中, 以跟踪低级别应用程序的性能和行为是有益的。 此遥测可以包括各个页面请求时间、应用程序中的异常, 甚至是跟踪业务逻辑的自定义度量值。 此遥测可提供丰富的内容, 以深入了解应用程序中的内容。

在 Azure 上, Application Insights 是一项提供此深层应用程序性能管理的服务。 在应用程序中安装小型规范包, 并在 Microsoft Azure 门户中设置 application Insights 资源。 该检测会监视您的应用程序, 并向门户发送遥测数据。

来自主机环境的遥测 (如性能计数器、Azure 诊断和 Docker 日志) 可以是引入。 您还可以设置将合成请求定期发送到 web 服务的 web 测试。 您甚至可以配置应用程序, 以发送您在客户端或服务器代码中自己编写的自定义事件和指标。 例如, 特定于应用程序的事件, 如已售出的项或游戏获胜。

Application Insights 将其数据存储在通用存储库中, 并与 Azure Monitor 共享指标。 它可以利用 Log Analytics 查询语言等共享功能 (如警报、仪表板和深入分析)。

用于确定 web 应用程序可用性的常见模式是运行状况终结点监视模式。 此模式用于监视 web 应用程序和相关联的后端服务, 以确保它们可用且正确执行。 模式是通过查询特定的 uri 来实现的。 终结点检查许多组件的状态, 包括应用程序所依赖的后端服务, 而不只是前端本身的可用性。 这可用作服务级别运行状况检查, 该检查将返回服务的整体运行状况的指示。

使用 APM 解决方案 (如 application Insights) 深入了解应用程序, 并在整个应用程序中关联活动。 这可以帮助您了解特定操作在客户端浏览器、服务器和下游服务中的工作方式。 此外, 它还可以深入了解趋势, 在出现问题时提供通知, 并帮助确定问题的位置以及如何修复该问题, 在用户意识到之前。

## <a name="performance-monitoring-at-lamna-healthcare"></a>Lamna 保健中的性能监控

Lamna 医疗保健已在两个 azure 区域中使用虚拟机和 Azure SQL 数据库实施了基于 web 的患者预订系统。 他们已决定使用 VM 代理和日志分析来监视基础前端虚拟机的性能。

他们使用 azure Monitor 了解其 Azure SQL 数据库的性能, 并捕获包括 CPU% 和死锁在内的关键性能指标。

Application Insights 已配置为可捕获可用性和遥测信息。 团队已将其新的预订功能更改为将自定义事件遥测发送到 Application Insights。 团队现在具有一种了解与业务相关的事件的数量的方法, 并且可以更好地了解其应用程序中发生的情况。

我们查看了一些过程、工具和最佳做法, 可帮助您跟踪性能问题, 并确保应用程序以最佳状态运行。