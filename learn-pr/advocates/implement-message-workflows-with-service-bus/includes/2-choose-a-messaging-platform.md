有很多通信平台可帮助提高分布式应用程序的可靠性, 其中包括多个 Azure。 这些工具中的每一个都可用于不同的用途;让我们查看 Azure 中的每个工具以帮助选择正确的工具。

我们的比萨饼订购和跟踪应用程序的体系结构需要几个组件: 网站、数据存储、后端服务等。我们可以通过多种不同的方式将应用程序的组件组合在一起, 而单个应用程序可以利用多种技术。 

我们需要决定要在 Contoso 切片应用程序中使用的技术。 第一步是评估多个部件之间存在通信的每个位置。 某些组件_必须_及时运行, 才能使应用程序完全执行作业。 有些可能很重要, 但不是时间关键。 最后, 其他组件 (如我们的移动应用程序通知) 更是可选的。

在这里, 你将了解 Azure 中提供的通信平台, 以便你可以在应用程序中为每个要求选择正确的平台。

## <a name="decide-between-messages-and-events"></a>在邮件和事件之间做出决定

消息和事件都是数据**报**: 从一个组件发送到另一个组件的数据包。 它们在最初看起来不同的方式上是不同的, 但在构建应用程序的方式方面可能会产生显著的差异。

### <a name="messages"></a>信息

在分布式应用程序的术语中, 定义邮件的特征是应用程序的整体完整性可能依赖于接收的邮件。 您可以将邮件作为一个组件发送到一个组件, 将 baton 的工作流传递给另一个组件。 整个工作流可能是一个重要的业务流程, 而邮件是将这些组件保持在一起的实体。

消息通常包含数据本身, 而不仅仅是数据的引用 (如 ID 或 URL)。 将数据作为数据报的一部分发送比发送引用的 brittle 少。 邮件传递体系结构可确保邮件的传递, 并且, 由于不需要其他查找, 因此可可靠地处理邮件。 但是, 发送应用程序需要准确知道要包含的数据, 以避免发送过多的数据, 这需要接收组件执行不必要的工作。 在这种意义上, 邮件的发件人和收件人通常由严格的数据合同结合使用。

在 Contoso 扇面的新体系结构中, 输入比萨饼订单时, 公司可能会使用邮件。 web 前端或移动应用将向后端处理组件发送一条消息。 在后端, 将在靠近客户和信用卡充电的步骤中进行路由。

### <a name="events"></a>事件

事件触发通知, 告知发生了某个事件。 事件比邮件 "亮", 最常用于广播通信。

事件具有以下特征:

* 该事件可能会发送到多个收件人, 或根本无法发送到任何收件人
* 事件通常用于 "扇出", 或者每个发布服务器具有大量订阅者
* 事件发布者没有预期接收组件所执行的操作

我们的比萨饼链可能会使用事件通知用户有关状态更改的通知。 可以将状态更改事件发送到 azure 事件网格, 然后发送到 azure 函数, 并将其发送到 azure 通知中心, 以获取完全_无服务器_解决方案。

事件和邮件之间的差异很重要, 因为通信平台通常旨在处理其中的一个或另一个。 服务总线旨在处理邮件。 如果要发送事件, 可能需要选择 "事件网格"。

azure 也有 azure 事件中心, 但它通常用于用于分析的一种特定类型的通信数据流。 例如, 如果我们的比萨饼微波炉上有网络传感器, 我们可以使用与 Azure Stream Analytics 结合使用的事件中心来监视温度变化中的模式, 这些变化可能表示意外的火灾或组件磨损。

## <a name="service-bus-topics-queues-and-relays"></a>服务总线主题、队列和中继

Azure 服务总线可以通过以下三种不同的方式交换邮件: 队列、主题和中继。

### <a name="what-is-a-queue"></a>什么是队列？

**队列**是邮件的简单临时存储位置。 发送组件向队列中添加一条消息。 目标组件用于选取队列前面的邮件。 在一般情况下, 每封邮件仅由一个接收器接收。

![该图显示了一个发件人将邮件发送到队列的示例邮件队列, 以及一个接收器从队列中逐个检索这些邮件。](../media/2-service-bus-queue.png)

队列将源和目标组件分开, 以将目标组件与高需求隔离开来。 

在高峰时段, 邮件可能会比目标组件处理速度更快。 由于源组件与目标无直接连接, 因此源不会受到影响, 并且队列将增长。 目标组件将从队列中删除邮件, 因为它们能够处理这些邮件。 当需求下降时, 目标组件可以追赶并缩短队列。

队列在不需要向系统添加资源的情况下响应高要求 (如这样做)。 但是, 对于需要相对快处理的邮件, 添加目标组件的其他实例可以允许它们共享负载。 每封邮件只能由一个实例处理。 这是一种扩展整个应用程序的有效方法, 只是将资源添加到实际需要它的组件。

### <a name="what-is-a-topic"></a>主题是什么？

**主题**类似于队列, 但可以具有多个订阅。 这意味着多个目标组件可以订阅单个主题, 因此每封邮件都将传递给多个接收器。 订阅还可以筛选主题中的邮件, 以便仅接收相关的邮件。 订阅提供与队列相同的分离通信, 并以相同方式响应高要求。 如果您希望将每封邮件传递给多个目标组件, 请使用主题。

基本定价层不支持的主题。

![显示一个发件人通过包含三个订阅的主题向多个收件人发送邮件的图。 三个接收器使用这些订阅来检索相关的邮件。](../media/2-service-bus-topic.png)

### <a name="what-is-a-relay"></a>什么是中继？

**中继**是在应用程序之间执行同步双向通信的对象。 与队列和主题不同的是, 它不是邮件的临时存储位置。 相反, 它提供跨网络边界 (如防火墙) 的双向无缓冲连接。 当您想要在组件之间进行直接通信时使用中继, 就像它们位于同一网段上但由网络安全设备分开一样。

> [!NOTE]
> 尽管中继是 Azure 服务总线的一部分, 但它们不会实现松散耦合邮件工作流, 也不会在本模块中进一步考虑。

## <a name="service-bus-queues-and-storage-queues"></a>服务总线队列和存储队列

有两个包含邮件队列的 Azure 功能: 服务总线和 Azure 存储帐户。 作为一般指南, 存储队列更易于使用, 但不如服务总线队列复杂且灵活。

服务总线队列的主要优势包括:

* 支持较大的邮件大小 (每条消息为 256 kb, 而不是 64 kb)
* 同时支持最少一次和一次性传递-选择邮件丢失的可能性非常小, 或者一小部分处理两次
* 确保**先进先出 (FIFO)** 顺序消息按其添加顺序进行处理 (尽管 FIFO 是队列的正常运行, 但不能保证每条消息都有)
* 可以将多个邮件组合到一个事务中-如果事务中的一封邮件无法传递, 则将不会传递事务中的所有邮件
* 支持基于角色的安全性
* 不需要目标组件连续轮询队列

存储队列的优势:

* 支持无限队列大小 (相对于服务总线队列为 80 GB 的限制)
* 维护所有邮件的日志

## <a name="how-to-choose-a-communications-technology"></a>如何选择通信技术

我们已看到 Azure 提供的不同概念和实现。 我们来讨论我们的决策过程应针对每个通信的外观。

#### <a name="consider-the-following-questions"></a>请考虑以下问题:

1. 通信是否为事件？ 如果是这样, 请考虑使用事件网格或事件中心。

1. 是否应将单个邮件传递到多个目标？ 如果是这样, 请使用服务总线主题。 否则, 请使用队列。

如果您决定需要队列:

#### <a name="choose-service-bus-queues-if"></a>在以下情况中选择服务总线队列:

* 您需要一项最多的交付保证
* 您需要一个 FIFO 保证
* 您需要将邮件分组为事务
* 您希望在不轮询队列的情况下接收邮件
* 您需要提供对队列的基于角色的访问
* 您需要处理大于 64 kb 但小于 256 kb 的邮件
* 您的队列大小不会增长大于 80 GB
* 你希望能够发布和使用批量邮件

#### <a name="choose-queue-storage-if"></a>在以下情况中选择队列存储:

* 您需要一个无特殊附加要求的简单队列
* 您需要通过队列的所有邮件的审核跟踪
* 您希望队列的大小超过 80 GB
* 您希望跟踪队列中的邮件处理进度

尽管分布式应用程序的组件可以直接进行通信, 但通常可以通过使用中间通信平台 (如 azure 服务总线或 azure 事件网格) 提高该通信的可靠性。

事件网格是为事件而设计的, 这将仅通知收件人一个事件, 而不包含与该事件关联的原始数据。 Azure 事件中心是针对高流分析类型的事件而设计的。 Azure 服务总线和存储队列适用于邮件, 可用于绑定任何应用程序工作流的核心部分。

如果您的要求很简单, 如果想要将每封邮件仅发送到一个目标, 或者您希望尽快编写代码, 则存储队列可能是最佳选择。 否则, 服务总线队列可提供更多的选项和灵活性。

如果要将邮件发送到多个订阅者, 请使用服务总线主题。
