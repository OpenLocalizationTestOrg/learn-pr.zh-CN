在多个区域中复制数据之后, 可以利用 Azure Cosmos DB 提供的自动故障转移解决方案。 自动故障转移是指当灾难或其他事件需要脱机读取或写入区域时进入播放的功能, 并将来自脱机区域的请求重定向到下一个优先级最高的区域。 

对于您刚复制到美国西部2、东 us 和日本地区的您的在线衣物网站, 您可以设置优先级, 如果美国东部离线, 则可以将读取重定向到美国西部 (而不是日本东部), 以限制延迟。

在此单元中, 你将了解故障转移的工作原理, 并为已复制公司数据的区域设置优先级。

## <a name="failover-basics"></a>故障转移基础知识

在出现 Azure 区域中断或数据中心中断的罕见事件时, azure Cosmos db 会自动触发所有 Azure Cosmos DB 帐户的故障转移, 并在受影响的区域中显示状态。

**如果某个读取区域发生中断, 会发生什么情况？**

在受影响区域中具有读取区域的 Azure Cosmos DB 帐户将自动从其写入区域断开连接, 并标记为脱机。 Cosmos DB sdk 实施了一个区域发现协议, 使其能够自动检测区域何时可用, 并将读取呼叫重定向到首选区域列表中的下一个可用区域。 如果未提供首选区域列表中的任何区域, 则呼叫将自动回退到当前写入区域。 在应用程序代码中, 不需要进行任何更改即可处理区域故障转移。 在整个过程中, 一致性保证继续受 Azure Cosmos DB 的认可。

在受影响的区域从中断中恢复后, 该区域中所有受影响的 Azure Cosmos 数据库帐户将由服务自动恢复。 在受影响区域中具有读取区域的 Azure Cosmos DB 帐户将自动与当前的写入区域同步并启用 online。 Azure Cosmos DB sdk 发现新区域的可用性, 并评估是否应根据应用程序配置的首选区域列表将区域选择为当前读取区域。 随后的读取操作将重定向到恢复的区域, 而无需对应用程序代码进行任何更改。

**如果写入区域发生中断, 会发生什么情况？**

如果受影响的区域是当前的写入区域, 并且已为 Azure Cosmos DB 帐户启用了自动故障转移, 则会自动将该区域标记为脱机。 然后, 将替代区域作为受影响的 Azure Cosmos DB 帐户的写入区域进行升级。

在自动故障转移期间, Azure Cosmos DB 将根据指定的优先级顺序自动为给定的 Azure Cosmos DB 帐户选择下一个写入区域。 应用程序可以使用 DocumentClient 类的 WriteEndpoint 属性来检测写入区域中的更改。

在受影响的区域从中断中恢复后, 该区域中的所有受影响的 Cosmos 数据库帐户将由服务自动恢复。

现在, 让我们修改数据库的读取区域。

## <a name="set-read-region-priorities"></a>设置读取区域优先级

1. 在 Azure 门户中, 在 "在**全局复制数据**" 屏幕上, 单击 "**自动故障转移**"。 仅当数据库已复制到多个区域时, 才会启用自动故障转移。
2. 在 "**自动故障转移**" 屏幕上, 更改 "**启用自动故障转移**到 **"**。
3. 在 "**阅读区域**" 部分中, 单击 "**美国东部**时间" 行的左侧部分, 然后拖放到顶部位置。
4. 单击**日本东**行的左侧部分, 然后拖放到第二个位置。
5. 单击"确定"。

    ![更改门户中的读取区域](../media/4-change-priorities/change-read-priorities.gif)

## <a name="summary"></a>摘要

在此单元中, 您已经了解了自动故障转移提供了什么, 如何使用它来防止不可预见的中断, 以及如何修改读取区域优先级。