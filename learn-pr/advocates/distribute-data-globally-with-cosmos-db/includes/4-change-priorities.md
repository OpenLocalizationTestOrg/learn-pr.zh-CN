<span data-ttu-id="29b4e-101">在多个区域中复制数据之后, 可以利用 Azure Cosmos DB 提供的自动故障转移解决方案。</span><span class="sxs-lookup"><span data-stu-id="29b4e-101">Once you've replicated your data in multiple regions, you can take advantage of the automated failover solutions Azure Cosmos DB provides.</span></span> <span data-ttu-id="29b4e-102">自动故障转移是指当灾难或其他事件需要脱机读取或写入区域时进入播放的功能, 并将来自脱机区域的请求重定向到下一个优先级最高的区域。</span><span class="sxs-lookup"><span data-stu-id="29b4e-102">Automated failover is a feature that comes into play when there's a disaster or other event that takes one of your read or write regions offline, and it redirects requests from the offline region to the next most prioritized region.</span></span> 

<span data-ttu-id="29b4e-103">对于您刚复制到美国西部2、东 us 和日本地区的您的在线衣物网站, 您可以设置优先级, 如果美国东部离线, 则可以将读取重定向到美国西部 (而不是日本东部), 以限制延迟。</span><span class="sxs-lookup"><span data-stu-id="29b4e-103">For your online clothing site, which you just replicated into West US 2, East US, and Japan East, you can prioritize that if the East US goes offline, you can redirect reads to West US 2 instead of Japan East, to limit latency.</span></span>

<span data-ttu-id="29b4e-104">在此单元中, 你将了解故障转移的工作原理, 并为已复制公司数据的区域设置优先级。</span><span class="sxs-lookup"><span data-stu-id="29b4e-104">In this unit you'll learn about how failover works and set the priority for the regions in which your company's data has been replicated.</span></span>

## <a name="failover-basics"></a><span data-ttu-id="29b4e-105">故障转移基础知识</span><span class="sxs-lookup"><span data-stu-id="29b4e-105">Failover basics</span></span>

<span data-ttu-id="29b4e-106">在出现 Azure 区域中断或数据中心中断的罕见事件时, azure Cosmos db 会自动触发所有 Azure Cosmos DB 帐户的故障转移, 并在受影响的区域中显示状态。</span><span class="sxs-lookup"><span data-stu-id="29b4e-106">In the rare event of an Azure regional outage or data center outage, Azure Cosmos DB automatically triggers failovers of all Azure Cosmos DB accounts with a presence in the affected region.</span></span>

<span data-ttu-id="29b4e-107">**如果某个读取区域发生中断, 会发生什么情况？**</span><span class="sxs-lookup"><span data-stu-id="29b4e-107">**What happens if a read region has an outage?**</span></span>

<span data-ttu-id="29b4e-108">在受影响区域中具有读取区域的 Azure Cosmos DB 帐户将自动从其写入区域断开连接, 并标记为脱机。</span><span class="sxs-lookup"><span data-stu-id="29b4e-108">Azure Cosmos DB accounts with a read region in one of the affected regions are automatically disconnected from their write region and marked offline.</span></span> <span data-ttu-id="29b4e-109">Cosmos DB sdk 实施了一个区域发现协议, 使其能够自动检测区域何时可用, 并将读取呼叫重定向到首选区域列表中的下一个可用区域。</span><span class="sxs-lookup"><span data-stu-id="29b4e-109">The Cosmos DB SDKs implement a regional discovery protocol that allows them to automatically detect when a region is available and redirect read calls to the next available region in the preferred region list.</span></span> <span data-ttu-id="29b4e-110">如果未提供首选区域列表中的任何区域, 则呼叫将自动回退到当前写入区域。</span><span class="sxs-lookup"><span data-stu-id="29b4e-110">If none of the regions in the preferred region list is available, calls automatically fall back to the current write region.</span></span> <span data-ttu-id="29b4e-111">在应用程序代码中, 不需要进行任何更改即可处理区域故障转移。</span><span class="sxs-lookup"><span data-stu-id="29b4e-111">No changes are required in your application code to handle regional failovers.</span></span> <span data-ttu-id="29b4e-112">在整个过程中, 一致性保证继续受 Azure Cosmos DB 的认可。</span><span class="sxs-lookup"><span data-stu-id="29b4e-112">During this entire process, consistency guarantees continue to be honored by Azure Cosmos DB.</span></span>

<span data-ttu-id="29b4e-113">在受影响的区域从中断中恢复后, 该区域中所有受影响的 Azure Cosmos 数据库帐户将由服务自动恢复。</span><span class="sxs-lookup"><span data-stu-id="29b4e-113">Once the affected region recovers from the outage, all the affected Azure Cosmos DB accounts in the region are automatically recovered by the service.</span></span> <span data-ttu-id="29b4e-114">在受影响区域中具有读取区域的 Azure Cosmos DB 帐户将自动与当前的写入区域同步并启用 online。</span><span class="sxs-lookup"><span data-stu-id="29b4e-114">Azure Cosmos DB accounts that had a read region in the affected region will then automatically sync with current write region and turn online.</span></span> <span data-ttu-id="29b4e-115">Azure Cosmos DB sdk 发现新区域的可用性, 并评估是否应根据应用程序配置的首选区域列表将区域选择为当前读取区域。</span><span class="sxs-lookup"><span data-stu-id="29b4e-115">The Azure Cosmos DB SDKs discover the availability of the new region and evaluate whether the region should be selected as the current read region based on the preferred region list configured by the application.</span></span> <span data-ttu-id="29b4e-116">随后的读取操作将重定向到恢复的区域, 而无需对应用程序代码进行任何更改。</span><span class="sxs-lookup"><span data-stu-id="29b4e-116">Subsequent reads are redirected to the recovered region without requiring any changes to your application code.</span></span>

<span data-ttu-id="29b4e-117">**如果写入区域发生中断, 会发生什么情况？**</span><span class="sxs-lookup"><span data-stu-id="29b4e-117">**What happens if a write region has an outage?**</span></span>

<span data-ttu-id="29b4e-118">如果受影响的区域是当前的写入区域, 并且已为 Azure Cosmos DB 帐户启用了自动故障转移, 则会自动将该区域标记为脱机。</span><span class="sxs-lookup"><span data-stu-id="29b4e-118">If the affected region is the current write region and automatic failover is enabled for the Azure Cosmos DB account, then the region is automatically marked as offline.</span></span> <span data-ttu-id="29b4e-119">然后, 将替代区域作为受影响的 Azure Cosmos DB 帐户的写入区域进行升级。</span><span class="sxs-lookup"><span data-stu-id="29b4e-119">Then, an alternative region is promoted as the write region for the affected Azure Cosmos DB account.</span></span>

<span data-ttu-id="29b4e-120">在自动故障转移期间, Azure Cosmos DB 将根据指定的优先级顺序自动为给定的 Azure Cosmos DB 帐户选择下一个写入区域。</span><span class="sxs-lookup"><span data-stu-id="29b4e-120">During automatic failovers, Azure Cosmos DB automatically chooses the next write region for a given Azure Cosmos DB account based on the specified priority order.</span></span> <span data-ttu-id="29b4e-121">应用程序可以使用 DocumentClient 类的 WriteEndpoint 属性来检测写入区域中的更改。</span><span class="sxs-lookup"><span data-stu-id="29b4e-121">Applications can use the WriteEndpoint property of DocumentClient class to detect the change in write region.</span></span>

<span data-ttu-id="29b4e-122">在受影响的区域从中断中恢复后, 该区域中的所有受影响的 Cosmos 数据库帐户将由服务自动恢复。</span><span class="sxs-lookup"><span data-stu-id="29b4e-122">Once the affected region recovers from the outage, all the affected Cosmos DB accounts in the region are automatically recovered by the service.</span></span>

<span data-ttu-id="29b4e-123">现在, 让我们修改数据库的读取区域。</span><span class="sxs-lookup"><span data-stu-id="29b4e-123">Now let's modify the read region for your database.</span></span>

## <a name="set-read-region-priorities"></a><span data-ttu-id="29b4e-124">设置读取区域优先级</span><span class="sxs-lookup"><span data-stu-id="29b4e-124">Set read region priorities</span></span>

1. <span data-ttu-id="29b4e-125">在 Azure 门户中, 在 "在**全局复制数据**" 屏幕上, 单击 "**自动故障转移**"。</span><span class="sxs-lookup"><span data-stu-id="29b4e-125">In the Azure portal, on the **Replicate data globally** screen, click **Automatic Failover**.</span></span> <span data-ttu-id="29b4e-126">仅当数据库已复制到多个区域时, 才会启用自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="29b4e-126">Automatic failover is only enabled if the database has already been replicated to more than one region.</span></span>
2. <span data-ttu-id="29b4e-127">在 "**自动故障转移**" 屏幕上, 更改 "**启用自动故障转移**到 **"**。</span><span class="sxs-lookup"><span data-stu-id="29b4e-127">On the **Automatic Failover** screen, change **Enable Automatic Failover** to **ON**.</span></span>
3. <span data-ttu-id="29b4e-128">在 "**阅读区域**" 部分中, 单击 "**美国东部**时间" 行的左侧部分, 然后拖放到顶部位置。</span><span class="sxs-lookup"><span data-stu-id="29b4e-128">In the **Read regions** section, click the left portion of the **East US** row, and then drag and drop at the top position.</span></span>
4. <span data-ttu-id="29b4e-129">单击**日本东**行的左侧部分, 然后拖放到第二个位置。</span><span class="sxs-lookup"><span data-stu-id="29b4e-129">Click the left portion of the **Japan East** row, and then drag and drop to the second position.</span></span>
5. <span data-ttu-id="29b4e-130">单击"确定"。</span><span class="sxs-lookup"><span data-stu-id="29b4e-130">Click **OK**.</span></span>

    ![更改门户中的读取区域](../media/4-change-priorities/change-read-priorities.gif)

## <a name="summary"></a><span data-ttu-id="29b4e-132">摘要</span><span class="sxs-lookup"><span data-stu-id="29b4e-132">Summary</span></span>

<span data-ttu-id="29b4e-133">在此单元中, 您已经了解了自动故障转移提供了什么, 如何使用它来防止不可预见的中断, 以及如何修改读取区域优先级。</span><span class="sxs-lookup"><span data-stu-id="29b4e-133">In this unit, you've learned what automatic failover provides, how you can use it to protect against unforeseen outages, and how to modify read region priorities.</span></span>