通过 Azure Cosmos DB, 开发人员可以在一致性频谱 (强、受限制过期、会话、一致前缀和最终) 之间选择五个定义明确的一致性模型。 根据您的需求, 这些一致性级别使您能够最大限度地提高数据库的可用性和性能。 在必须以特定顺序处理数据的情况下, 强一致性可能是正确的选择。 或者, 在数据不需要立即保持一致的情况下, 最终一致性可能是正确的选择。 

在此单元中, 你将熟悉 Azure Cosmos DB 中的可用一致性级别, 并为你的在线衣物网站确定正确的一致性级别。

## <a name="consistency-basics"></a>一致性基础

每个数据库帐户都有一个默认的一致性级别, 用于确定帐户中的数据的一致性。 在一个色谱的一端是强大的一致性, 它提供了保证可返回项目的最新版本的读取的 linearizability 保证。 该色谱的另一端最终是一致性, 这可以保证在缺少任何进一步的写入时, 组中的副本最终聚合。 中间是会话一致性, 这是最常见的原因, 因为它可保证 monotonic 读取、monotonic 写入和读取自己的写入 (RYW) 保证。

![Azure Cosmos DB 中的五个一致性级别](../media/5-change-consistency/five-consistency-levels.png)

下表列出了每个一致性级别的相关保证。
 
**一致性级别和保证**

| 一致性级别 | 保证 |
| --- | --- |
| 有效 | Linearizability。 保证能够返回项的最新版本的读取。|
| 限制过期 | 一致的前缀。 以最多 k 个前缀或 t 个间隔读取延隔时间的写入次数。 |
| Session   | 一致的前缀。 Monotonic 读取、Monotonic 写入、读写后接下来的读取。 |
| 一致前缀 | 返回的更新是所有更新的前缀, 没有间隔。 |
| 仍然  | 无序读取。 |

您可以在 azure Cosmos DB 帐户上配置默认的一致性级别 (并在随后覆盖特定读取请求的一致性) 在 azure 门户中。 在内部, 默认的一致性级别适用于分区集内的数据, 这可能会跨越区域。

在 Azure Cosmos DB 中, 在会话、一致的前缀和最终一致性方面, 在请求单元消耗方面的成本两倍, 因为具有强或限制过期一致性的读取。

### <a name="use-of-consistency-levels"></a>使用一致性级别

大约 73% 的 Azure Cosmos DB 租户使用会话一致性和 20% 首选限制过期。 最初, 大约 3% 的 Azure Cosmos DB 客户在对其应用程序的特定一致性选择进行结算之前, 先试验各种一致性级别。 每个请求的基础上只有 2% 的 Azure Cosmos DB 租户替代一致性级别。

## <a name="consistency-levels-in-detail"></a>详细的一致性级别

若要了解有关一致性级别的详细信息, 请查看 Azure 门户中提供的基于音乐注释的一致性示例, 然后查看有关每个级别的信息。

1. 在 Azure 门户中, 单击 "**默认一致性**"。
2. 在每个不同的一致性模型中单击, 并观看音乐示例。 了解如何将数据写入不同的区域以及选择的一致性如何影响写入笔记数据的方式。 请注意, "强" 将灰显, 因为它仅适用于写入单个区域的数据。

    ![了解门户中的一致性设置](../media/5-change-consistency/consistency.gif)

我们来了解有关一致性级别的详细信息。 请考虑每种一致性级别如何针对你的产品和用户数据为你的衣服零售网站工作。

### <a name="strong-consistency"></a>强大的一致性

* 强大的一致性提供了保证返回项目的最新版本的读取的[linearizability](https://aphyr.com/posts/313-strong-consistency-models)保证。
* 强一致性可确保写入仅在 durably 由多数仲裁副本提交后才可见。 写入既可以由辅助副本的主和仲裁同时以同步方式提交 durably, 也可以被中止。 读取始终由多数读取仲裁确认, 客户端永远不会看到未提交或部分写入, 并且始终保证能够阅读最新的确认写入。 
* 配置为使用强一致性的 azure Cosmos db 帐户无法将多个 azure 区域与它们的 azure Cosmos DB 帐户关联。  
* 具有强一致性的读取操作 (使用请求单元) 的成本高于会话和最终, 但与绑定失效的成本相同。

### <a name="bounded-staleness-consistency"></a>限制过期一致性

* 限制过期的一致性可保证读取延迟的时间可能是最多*K*个版本或前缀或*t*时间间隔的写入次数。
* 因此, 在选择 "限制过期" 时, 可以通过两种方式配置 "失效时间": 在写入后读取延迟的项目的版本数*K* , 以及时间间隔*t*。
* 除了在 "失效的窗口" 之外, 限制过期可提供总全局订单。 "失效时间" 窗口内和外部的区域中存在 monotonic 读保证。
* 与会话、一致前缀或最终一致性相比, 绑定过期可提供更强的一致性保证。 对于全局分布式应用程序, 我们建议您在希望具有强一致性但又希望 99.99% 可用性和低延迟的情况下使用限制过期。
* 使用限制过期一致性配置的 azure Cosmos db 帐户可将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。 
* 具有有限过期的读取操作 (在使用 RUs 方面) 的成本高于会话和最终一致性, 但与强一致性相同。

### <a name="session-consistency"></a>会话一致性

* 与强和受限制过期一致性级别提供的全局一致性模型不同, 会话一致性的作用范围为客户端会话。
* 在涉及设备或用户会话的所有情况下, 会话一致性非常适合, 因为它可保证 monotonic 读取、monotonic 写入和读取您自己的写入 (RYW) 保证。
* 会话一致性为会话提供了可预测的一致性, 并提供了最大读取吞吐量, 同时提供最低的延迟写入和读取。
* 使用会话一致性配置的 azure Cosmos db 帐户可以将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。
* 具有会话一致性级别的读取操作 (使用的 RUs) 的开销小于强和限制过期, 但最终不一致。

### <a name="consistent-prefix-consistency"></a>一致的前缀一致性

* 一致的前缀可确保在没有任何进一步的写入时, 组中的副本最终聚合。 
* 一致的前缀保证读取不会出现顺序写入。 如果`A, B, C`按顺序执行写入操作, 则客户端会看到`A`、 `A,B`或`A,B,C`, 但从不以类似`A,C`或`B,A,C`的顺序出现的情况。
* 使用一致前缀一致性配置的 azure Cosmos db 帐户可将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。 

### <a name="eventual-consistency"></a>最终一致性

* 最终一致性保证在缺少任何进一步的写入时, 组中的副本最终聚合。
* 最终一致性是一种最脆弱的一致性形式, 客户端可以获取比以前所见过的值更早的值。
* 最终一致性提供了最脆弱的读取一致性, 但为读取和写入提供了最低的延迟。
* 配置为最终一致性的 azure Cosmos db 帐户可以将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。 
* 具有最终一致性级别的读取操作 (在使用 RUs 的角度而言) 的成本是所有 Azure Cosmos DB 一致性级别的最低级别。

## <a name="summary"></a>摘要

在此单元中, 您已了解如何使用一致性级别最大限度地提高高可用性并最大限度地减少延迟。