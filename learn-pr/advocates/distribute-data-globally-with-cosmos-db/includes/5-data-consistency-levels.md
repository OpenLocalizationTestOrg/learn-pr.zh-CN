<span data-ttu-id="0aa43-101">通过 Azure Cosmos DB, 开发人员可以在一致性频谱 (强、受限制过期、会话、一致前缀和最终) 之间选择五个定义明确的一致性模型。</span><span class="sxs-lookup"><span data-stu-id="0aa43-101">Azure Cosmos DB allows developers to choose between five well-defined consistency models along the consistency spectrum – strong, bounded staleness, session, consistent prefix, and eventual.</span></span> <span data-ttu-id="0aa43-102">根据您的需求, 这些一致性级别使您能够最大限度地提高数据库的可用性和性能。</span><span class="sxs-lookup"><span data-stu-id="0aa43-102">These consistency levels enable you to maximize the availability and performance of your database, depending on your needs.</span></span> <span data-ttu-id="0aa43-103">在必须以特定顺序处理数据的情况下, 强一致性可能是正确的选择。</span><span class="sxs-lookup"><span data-stu-id="0aa43-103">For cases when data must be processed in a specific order, strong consistency might be the right choice.</span></span> <span data-ttu-id="0aa43-104">或者, 在数据不需要立即保持一致的情况下, 最终一致性可能是正确的选择。</span><span class="sxs-lookup"><span data-stu-id="0aa43-104">Or for cases when data doesn't need to be immediately consistent, eventual consistency might be the right choice.</span></span> 

<span data-ttu-id="0aa43-105">在此单元中, 你将熟悉 Azure Cosmos DB 中的可用一致性级别, 并为你的在线衣物网站确定正确的一致性级别。</span><span class="sxs-lookup"><span data-stu-id="0aa43-105">In this unit, you'll familiarize yourself with the available consistency levels in Azure Cosmos DB and determine the correct consistency level for your online clothing site.</span></span>

## <a name="consistency-basics"></a><span data-ttu-id="0aa43-106">一致性基础</span><span class="sxs-lookup"><span data-stu-id="0aa43-106">Consistency basics</span></span>

<span data-ttu-id="0aa43-107">每个数据库帐户都有一个默认的一致性级别, 用于确定帐户中的数据的一致性。</span><span class="sxs-lookup"><span data-stu-id="0aa43-107">Each database account has a default consistency level, which determines the consistency of data within the account.</span></span> <span data-ttu-id="0aa43-108">在一个色谱的一端是强大的一致性, 它提供了保证可返回项目的最新版本的读取的 linearizability 保证。</span><span class="sxs-lookup"><span data-stu-id="0aa43-108">At one end of the spectrum is Strong consistency, which offers a linearizability guarantee with the reads guaranteed to return the most recent version of an item.</span></span> <span data-ttu-id="0aa43-109">该色谱的另一端最终是一致性, 这可以保证在缺少任何进一步的写入时, 组中的副本最终聚合。</span><span class="sxs-lookup"><span data-stu-id="0aa43-109">At the other end of the spectrum is Eventual consistency, which guarantees that in absence of any further writes, the replicas within the group eventually converge.</span></span> <span data-ttu-id="0aa43-110">中间是会话一致性, 这是最常见的原因, 因为它可保证 monotonic 读取、monotonic 写入和读取自己的写入 (RYW) 保证。</span><span class="sxs-lookup"><span data-stu-id="0aa43-110">In the middle is Session consistency, which is the most popular because it guarantees monotonic reads, monotonic writes, and read your own writes (RYW) guarantees.</span></span>

![Azure Cosmos DB 中的五个一致性级别](../media/5-change-consistency/five-consistency-levels.png)

<span data-ttu-id="0aa43-112">下表列出了每个一致性级别的相关保证。</span><span class="sxs-lookup"><span data-stu-id="0aa43-112">Guarantees about each consistency level are listed in the following table.</span></span>
 
<span data-ttu-id="0aa43-113">**一致性级别和保证**</span><span class="sxs-lookup"><span data-stu-id="0aa43-113">**Consistency levels and guarantees**</span></span>

| <span data-ttu-id="0aa43-114">一致性级别</span><span class="sxs-lookup"><span data-stu-id="0aa43-114">Consistency Level</span></span> | <span data-ttu-id="0aa43-115">保证</span><span class="sxs-lookup"><span data-stu-id="0aa43-115">Guarantees</span></span> |
| --- | --- |
| <span data-ttu-id="0aa43-116">有效</span><span class="sxs-lookup"><span data-stu-id="0aa43-116">Strong</span></span> | <span data-ttu-id="0aa43-117">Linearizability。</span><span class="sxs-lookup"><span data-stu-id="0aa43-117">Linearizability.</span></span> <span data-ttu-id="0aa43-118">保证能够返回项的最新版本的读取。</span><span class="sxs-lookup"><span data-stu-id="0aa43-118">Reads are guaranteed to return the most recent version of an item.</span></span>|
| <span data-ttu-id="0aa43-119">限制过期</span><span class="sxs-lookup"><span data-stu-id="0aa43-119">Bounded Staleness</span></span> | <span data-ttu-id="0aa43-120">一致的前缀。</span><span class="sxs-lookup"><span data-stu-id="0aa43-120">Consistent Prefix.</span></span> <span data-ttu-id="0aa43-121">以最多 k 个前缀或 t 个间隔读取延隔时间的写入次数。</span><span class="sxs-lookup"><span data-stu-id="0aa43-121">Reads lag behind writes by at most k prefixes or t interval.</span></span> |
| <span data-ttu-id="0aa43-122">Session</span><span class="sxs-lookup"><span data-stu-id="0aa43-122">Session</span></span>   | <span data-ttu-id="0aa43-123">一致的前缀。</span><span class="sxs-lookup"><span data-stu-id="0aa43-123">Consistent Prefix.</span></span> <span data-ttu-id="0aa43-124">Monotonic 读取、Monotonic 写入、读写后接下来的读取。</span><span class="sxs-lookup"><span data-stu-id="0aa43-124">Monotonic reads, monotonic writes, read-your-writes, write-follows-reads.</span></span> |
| <span data-ttu-id="0aa43-125">一致前缀</span><span class="sxs-lookup"><span data-stu-id="0aa43-125">Consistent Prefix</span></span> | <span data-ttu-id="0aa43-126">返回的更新是所有更新的前缀, 没有间隔。</span><span class="sxs-lookup"><span data-stu-id="0aa43-126">Updates returned are some prefix of all the updates, with no gaps.</span></span> |
| <span data-ttu-id="0aa43-127">仍然</span><span class="sxs-lookup"><span data-stu-id="0aa43-127">Eventual</span></span>  | <span data-ttu-id="0aa43-128">无序读取。</span><span class="sxs-lookup"><span data-stu-id="0aa43-128">Out of order reads.</span></span> |

<span data-ttu-id="0aa43-129">您可以在 azure Cosmos DB 帐户上配置默认的一致性级别 (并在随后覆盖特定读取请求的一致性) 在 azure 门户中。</span><span class="sxs-lookup"><span data-stu-id="0aa43-129">You can configure the default consistency level on your Azure Cosmos DB account (and later override the consistency on a specific read request) in the Azure portal.</span></span> <span data-ttu-id="0aa43-130">在内部, 默认的一致性级别适用于分区集内的数据, 这可能会跨越区域。</span><span class="sxs-lookup"><span data-stu-id="0aa43-130">Internally, the default consistency level applies to data within the partition sets, which may span regions.</span></span>

<span data-ttu-id="0aa43-131">在 Azure Cosmos DB 中, 在会话、一致的前缀和最终一致性方面, 在请求单元消耗方面的成本两倍, 因为具有强或限制过期一致性的读取。</span><span class="sxs-lookup"><span data-stu-id="0aa43-131">In Azure Cosmos DB, reads served at session, consistent prefix and eventual consistency are twice as cheap, in terms of request unit consumption, as reads with strong or bounded staleness consistency.</span></span>

### <a name="use-of-consistency-levels"></a><span data-ttu-id="0aa43-132">使用一致性级别</span><span class="sxs-lookup"><span data-stu-id="0aa43-132">Use of consistency levels</span></span>

<span data-ttu-id="0aa43-133">大约 73% 的 Azure Cosmos DB 租户使用会话一致性和 20% 首选限制过期。</span><span class="sxs-lookup"><span data-stu-id="0aa43-133">About 73% of Azure Cosmos DB tenants use session consistency and 20% prefer bounded staleness.</span></span> <span data-ttu-id="0aa43-134">最初, 大约 3% 的 Azure Cosmos DB 客户在对其应用程序的特定一致性选择进行结算之前, 先试验各种一致性级别。</span><span class="sxs-lookup"><span data-stu-id="0aa43-134">Approximately 3% of Azure Cosmos DB customers experiment with various consistency levels initially before settling on a specific consistency choice for their application.</span></span> <span data-ttu-id="0aa43-135">每个请求的基础上只有 2% 的 Azure Cosmos DB 租户替代一致性级别。</span><span class="sxs-lookup"><span data-stu-id="0aa43-135">Only 2% of Azure Cosmos DB tenants override consistency levels on a per request basis.</span></span>

## <a name="consistency-levels-in-detail"></a><span data-ttu-id="0aa43-136">详细的一致性级别</span><span class="sxs-lookup"><span data-stu-id="0aa43-136">Consistency levels in detail</span></span>

<span data-ttu-id="0aa43-137">若要了解有关一致性级别的详细信息, 请查看 Azure 门户中提供的基于音乐注释的一致性示例, 然后查看有关每个级别的信息。</span><span class="sxs-lookup"><span data-stu-id="0aa43-137">To learn more about the consistency levels, review the music-note based consistency examples provided in the Azure portal, then review the information below about each level.</span></span>

1. <span data-ttu-id="0aa43-138">在 Azure 门户中, 单击 "**默认一致性**"。</span><span class="sxs-lookup"><span data-stu-id="0aa43-138">In the Azure portal, click **Default consistency**.</span></span>
2. <span data-ttu-id="0aa43-139">在每个不同的一致性模型中单击, 并观看音乐示例。</span><span class="sxs-lookup"><span data-stu-id="0aa43-139">Click through each of the different consistency models and watch the musical examples.</span></span> <span data-ttu-id="0aa43-140">了解如何将数据写入不同的区域以及选择的一致性如何影响写入笔记数据的方式。</span><span class="sxs-lookup"><span data-stu-id="0aa43-140">See how data is written to the different regions and how the choice of consistency impacts how the note data is written.</span></span> <span data-ttu-id="0aa43-141">请注意, "强" 将灰显, 因为它仅适用于写入单个区域的数据。</span><span class="sxs-lookup"><span data-stu-id="0aa43-141">Note that Strong is grayed out as it is only available for data written to a single region.</span></span>

    ![了解门户中的一致性设置](../media/5-change-consistency/consistency.gif)

<span data-ttu-id="0aa43-143">我们来了解有关一致性级别的详细信息。</span><span class="sxs-lookup"><span data-stu-id="0aa43-143">Let's learn more about the consistency levels.</span></span> <span data-ttu-id="0aa43-144">请考虑每种一致性级别如何针对你的产品和用户数据为你的衣服零售网站工作。</span><span class="sxs-lookup"><span data-stu-id="0aa43-144">Think about how each of these consistency levels could work for your product and user data for your clothing retail site.</span></span>

### <a name="strong-consistency"></a><span data-ttu-id="0aa43-145">强大的一致性</span><span class="sxs-lookup"><span data-stu-id="0aa43-145">Strong consistency</span></span>

* <span data-ttu-id="0aa43-146">强大的一致性提供了保证返回项目的最新版本的读取的[linearizability](https://aphyr.com/posts/313-strong-consistency-models)保证。</span><span class="sxs-lookup"><span data-stu-id="0aa43-146">Strong consistency offers a [linearizability](https://aphyr.com/posts/313-strong-consistency-models) guarantee with the reads guaranteed to return the most recent version of an item.</span></span>
* <span data-ttu-id="0aa43-147">强一致性可确保写入仅在 durably 由多数仲裁副本提交后才可见。</span><span class="sxs-lookup"><span data-stu-id="0aa43-147">Strong consistency guarantees that a write is only visible after it is committed durably by the majority quorum of replicas.</span></span> <span data-ttu-id="0aa43-148">写入既可以由辅助副本的主和仲裁同时以同步方式提交 durably, 也可以被中止。</span><span class="sxs-lookup"><span data-stu-id="0aa43-148">A write is either synchronously committed durably by both the primary and the quorum of secondaries, or it is aborted.</span></span> <span data-ttu-id="0aa43-149">读取始终由多数读取仲裁确认, 客户端永远不会看到未提交或部分写入, 并且始终保证能够阅读最新的确认写入。</span><span class="sxs-lookup"><span data-stu-id="0aa43-149">A read is always acknowledged by the majority read quorum, a client can never see an uncommitted or partial write and is always guaranteed to read the latest acknowledged write.</span></span> 
* <span data-ttu-id="0aa43-150">配置为使用强一致性的 azure Cosmos db 帐户无法将多个 azure 区域与它们的 azure Cosmos DB 帐户关联。</span><span class="sxs-lookup"><span data-stu-id="0aa43-150">Azure Cosmos DB accounts that are configured to use strong consistency cannot associate more than one Azure region with their Azure Cosmos DB account.</span></span>  
* <span data-ttu-id="0aa43-151">具有强一致性的读取操作 (使用请求单元) 的成本高于会话和最终, 但与绑定失效的成本相同。</span><span class="sxs-lookup"><span data-stu-id="0aa43-151">The cost of a read operation (in terms of request units consumed) with strong consistency is higher than session and eventual, but the same as bounded staleness.</span></span>

### <a name="bounded-staleness-consistency"></a><span data-ttu-id="0aa43-152">限制过期一致性</span><span class="sxs-lookup"><span data-stu-id="0aa43-152">Bounded staleness consistency</span></span>

* <span data-ttu-id="0aa43-153">限制过期的一致性可保证读取延迟的时间可能是最多*K*个版本或前缀或*t*时间间隔的写入次数。</span><span class="sxs-lookup"><span data-stu-id="0aa43-153">Bounded staleness consistency guarantees that the reads may lag behind writes by at most *K* versions or prefixes of an item or *t* time-interval.</span></span>
* <span data-ttu-id="0aa43-154">因此, 在选择 "限制过期" 时, 可以通过两种方式配置 "失效时间": 在写入后读取延迟的项目的版本数*K* , 以及时间间隔*t*。</span><span class="sxs-lookup"><span data-stu-id="0aa43-154">Therefore, when choosing bounded staleness, the "staleness" can be configured in two ways: number of versions *K* of the item by which the reads lag behind the writes, and the time interval *t*.</span></span>
* <span data-ttu-id="0aa43-155">除了在 "失效的窗口" 之外, 限制过期可提供总全局订单。</span><span class="sxs-lookup"><span data-stu-id="0aa43-155">Bounded staleness offers total global order except within the "staleness window."</span></span> <span data-ttu-id="0aa43-156">"失效时间" 窗口内和外部的区域中存在 monotonic 读保证。</span><span class="sxs-lookup"><span data-stu-id="0aa43-156">The monotonic read guarantees exist within a region both inside and outside the "staleness window."</span></span>
* <span data-ttu-id="0aa43-157">与会话、一致前缀或最终一致性相比, 绑定过期可提供更强的一致性保证。</span><span class="sxs-lookup"><span data-stu-id="0aa43-157">Bounded staleness provides a stronger consistency guarantee than session, consistent-prefix, or eventual consistency.</span></span> <span data-ttu-id="0aa43-158">对于全局分布式应用程序, 我们建议您在希望具有强一致性但又希望 99.99% 可用性和低延迟的情况下使用限制过期。</span><span class="sxs-lookup"><span data-stu-id="0aa43-158">For globally distributed applications, we recommend you use bounded staleness for scenarios where you would like to have strong consistency but also want 99.99% availability and low latency.</span></span>
* <span data-ttu-id="0aa43-159">使用限制过期一致性配置的 azure Cosmos db 帐户可将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="0aa43-159">Azure Cosmos DB accounts that are configured with bounded staleness consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span> 
* <span data-ttu-id="0aa43-160">具有有限过期的读取操作 (在使用 RUs 方面) 的成本高于会话和最终一致性, 但与强一致性相同。</span><span class="sxs-lookup"><span data-stu-id="0aa43-160">The cost of a read operation (in terms of RUs consumed) with bounded staleness is higher than session and eventual consistency, but the same as strong consistency.</span></span>

### <a name="session-consistency"></a><span data-ttu-id="0aa43-161">会话一致性</span><span class="sxs-lookup"><span data-stu-id="0aa43-161">Session consistency</span></span>

* <span data-ttu-id="0aa43-162">与强和受限制过期一致性级别提供的全局一致性模型不同, 会话一致性的作用范围为客户端会话。</span><span class="sxs-lookup"><span data-stu-id="0aa43-162">Unlike the global consistency models offered by strong and bounded staleness consistency levels, session consistency is scoped to a client session.</span></span>
* <span data-ttu-id="0aa43-163">在涉及设备或用户会话的所有情况下, 会话一致性非常适合, 因为它可保证 monotonic 读取、monotonic 写入和读取您自己的写入 (RYW) 保证。</span><span class="sxs-lookup"><span data-stu-id="0aa43-163">Session consistency is ideal for all scenarios where a device or user session is involved since it guarantees monotonic reads, monotonic writes, and read your own writes (RYW) guarantees.</span></span>
* <span data-ttu-id="0aa43-164">会话一致性为会话提供了可预测的一致性, 并提供了最大读取吞吐量, 同时提供最低的延迟写入和读取。</span><span class="sxs-lookup"><span data-stu-id="0aa43-164">Session consistency provides predictable consistency for a session, and maximum read throughput while offering the lowest latency writes and reads.</span></span>
* <span data-ttu-id="0aa43-165">使用会话一致性配置的 azure Cosmos db 帐户可以将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="0aa43-165">Azure Cosmos DB accounts that are configured with session consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span>
* <span data-ttu-id="0aa43-166">具有会话一致性级别的读取操作 (使用的 RUs) 的开销小于强和限制过期, 但最终不一致。</span><span class="sxs-lookup"><span data-stu-id="0aa43-166">The cost of a read operation (in terms of RUs consumed) with session consistency level is less than strong and bounded staleness, but more than eventual consistency.</span></span>

### <a name="consistent-prefix-consistency"></a><span data-ttu-id="0aa43-167">一致的前缀一致性</span><span class="sxs-lookup"><span data-stu-id="0aa43-167">Consistent prefix consistency</span></span>

* <span data-ttu-id="0aa43-168">一致的前缀可确保在没有任何进一步的写入时, 组中的副本最终聚合。</span><span class="sxs-lookup"><span data-stu-id="0aa43-168">Consistent prefix guarantees that in absence of any further writes, the replicas within the group eventually converge.</span></span> 
* <span data-ttu-id="0aa43-169">一致的前缀保证读取不会出现顺序写入。</span><span class="sxs-lookup"><span data-stu-id="0aa43-169">Consistent prefix guarantees that reads never see out of order writes.</span></span> <span data-ttu-id="0aa43-170">如果`A, B, C`按顺序执行写入操作, 则客户端会看到`A`、 `A,B`或`A,B,C`, 但从不以类似`A,C`或`B,A,C`的顺序出现的情况。</span><span class="sxs-lookup"><span data-stu-id="0aa43-170">If writes were performed in the order `A, B, C`, then a client sees either `A`, `A,B`, or `A,B,C`, but never out of order like `A,C` or `B,A,C`.</span></span>
* <span data-ttu-id="0aa43-171">使用一致前缀一致性配置的 azure Cosmos db 帐户可将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="0aa43-171">Azure Cosmos DB accounts that are configured with consistent prefix consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span> 

### <a name="eventual-consistency"></a><span data-ttu-id="0aa43-172">最终一致性</span><span class="sxs-lookup"><span data-stu-id="0aa43-172">Eventual consistency</span></span>

* <span data-ttu-id="0aa43-173">最终一致性保证在缺少任何进一步的写入时, 组中的副本最终聚合。</span><span class="sxs-lookup"><span data-stu-id="0aa43-173">Eventual consistency guarantees that in absence of any further writes, the replicas within the group eventually converge.</span></span>
* <span data-ttu-id="0aa43-174">最终一致性是一种最脆弱的一致性形式, 客户端可以获取比以前所见过的值更早的值。</span><span class="sxs-lookup"><span data-stu-id="0aa43-174">Eventual consistency is the weakest form of consistency where a client may get the values that are older than the ones it had seen before.</span></span>
* <span data-ttu-id="0aa43-175">最终一致性提供了最脆弱的读取一致性, 但为读取和写入提供了最低的延迟。</span><span class="sxs-lookup"><span data-stu-id="0aa43-175">Eventual consistency provides the weakest read consistency but offers the lowest latency for both reads and writes.</span></span>
* <span data-ttu-id="0aa43-176">配置为最终一致性的 azure Cosmos db 帐户可以将任意数量的 azure 区域与它们的 azure Cosmos DB 帐户相关联。</span><span class="sxs-lookup"><span data-stu-id="0aa43-176">Azure Cosmos DB accounts that are configured with eventual consistency can associate any number of Azure regions with their Azure Cosmos DB account.</span></span> 
* <span data-ttu-id="0aa43-177">具有最终一致性级别的读取操作 (在使用 RUs 的角度而言) 的成本是所有 Azure Cosmos DB 一致性级别的最低级别。</span><span class="sxs-lookup"><span data-stu-id="0aa43-177">The cost of a read operation (in terms of RUs consumed) with the eventual consistency level is the lowest of all the Azure Cosmos DB consistency levels.</span></span>

## <a name="summary"></a><span data-ttu-id="0aa43-178">摘要</span><span class="sxs-lookup"><span data-stu-id="0aa43-178">Summary</span></span>

<span data-ttu-id="0aa43-179">在此单元中, 您已了解如何使用一致性级别最大限度地提高高可用性并最大限度地减少延迟。</span><span class="sxs-lookup"><span data-stu-id="0aa43-179">In this unit, you've learned how consistency levels can be used to maximize high-availability and minimize latency.</span></span>