规划一致的云基础结构从设置策略开始。 您的策略将强制实施所创建资源的规则, 因此您的基础结构符合您与客户的公司标准、成本要求和服务级别协议 (sla)。

:::row:::
  :::column:::
    ![表示 Azure 蓝图的图标](../media/2-azurepolicy.png)
  :::column-end:::
    :::column span="3":::
**azure Policy**是 azure 中的一项服务, 可用于定义、分配和管理环境中资源的标准。 它可以阻止创建不允许的资源, 确保新资源应用了特定设置, 并运行现有资源的评估以扫描不合规性。 

Azure 策略附带了许多内置策略和计划定义, 您可以在 "存储"、"网络"、"计算"、"安全中心" 和 "监视" 等类别下使用这些定义。
  :::column-end:::
:::row-end:::

设想我们允许组织中的任何人创建虚拟机 (vm)。 我们想要控制开销, 因此 Azure 租户的管理员定义了一个策略, 该策略禁止创建超过4个 cpu 的任何 VM。 一旦实施了策略, Azure 策略将阻止任何人在允许的 sku 列表之外创建新的 VM。 此外, 如果您尝试_更新_现有 VM, 它将针对策略进行检查。 最后, Azure 策略将审核组织中的所有现有虚拟机, 以确保实施策略。 它可以审核不符合要求的资源、更改资源属性或停止创建资源。

> [!TIP]
> azure 策略可以与 azure DevOps 集成, 方法是应用任何持续的集成和传递管道策略, 这些策略会影响应用程序的预先部署和后期部署。

## <a name="creating-a-policy"></a>创建策略

创建和实现 Azure 策略的过程从创建_策略定义_开始。 每个策略定义都具有强制实施的条件。 而且, 在满足条件时, 会产生相应的效果。 若要应用策略, 您将:

1. 创建策略定义
2. 向资源范围分配定义
3. 查看策略评估结果

### <a name="what-is-a-policy-definition"></a>什么是策略定义？

*策略定义*表示要评估的内容以及要采取的操作。 例如, 可以确保所有公共网站都使用 HTTPS 进行保护、阻止创建特定存储类型或强制使用特定版本的 SQL Server。

下面是您可以应用的一些最常见的策略定义。

> [!div class="mx-tableFixed"]
> | 策略定义 | 说明 |
> |--------|-------------|
> | 允许的存储帐户 sku | 此策略定义具有一组条件/规则, 用于确定要部署的存储帐户是否在 SKU 大小集中。 其作用是拒绝不符合定义的 SKU 大小集的所有存储帐户。 |
> | 允许的资源类型 | 此策略定义具有一组条件/规则, 用于指定您的组织可以部署的资源类型。 其作用是拒绝不属于此定义列表的所有资源。 |
> | 允许的位置 | 通过此策略, 您可以限制组织在部署资源时可以指定的位置。 其效果用于强制实施您的地理符合性要求。 |
> | 允许的虚拟机 sku | 通过此策略, 您可以指定您的组织可以部署的一组 VM sku。 |
> | 不允许的资源类型 | 阻止部署资源类型的列表。 |

策略定义本身表示为 JSON 文件, 您可以在门户中使用预定义的定义, 也可以创建自己的定义 (修改现有定义或从头开始)。 [GitHub 上提供了数百个示例](https://github.com/Azure/azure-policy)。

下面的示例展示了仅允许特定虚拟机大小的计算策略:

```json
{
  "if": {
    "allOf": [
      {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
      },
      {
        "not": {
          "field": "Microsoft.Compute/virtualMachines/sku.name",
          "in": "[parameters('listOfAllowedSKUs')]"
        }
      }
    ]
  },
  "then": {
    "effect": "Deny"
  }
}
```

请注意`[parameters('listofAllowedSKUs')]`值;这是在将策略定义应用于作用域时将填写的替换令牌。 定义参数时, 将为其指定一个名称, 并根据需要提供一个值。 

### <a name="assign-a-definition-to-a-scope-of-resources"></a>向资源范围分配定义

定义了一个或多个策略定义后, 需要对其进行分配。 _策略分配_是已分配为在特定范围内进行的策略定义。 

此范围的范围可以从完整订阅到资源组。 所有子资源都继承了策略分配。 这意味着, 如果将策略应用于资源组, 则该策略将应用于该资源组中的所有资源。 但是, 您可以从策略分配中排除 subscope。 例如, 我们可以为整个订阅强制实施一个策略, 然后排除几个选择资源组。

您可以通过 Azure 门户、PowerShell 或 azure CLI 分配这些策略中的任何一个。 分配策略定义时, 将需要提供已定义的任何参数。

![将策略分配给 Azure 门户中的作用域时显示参数的屏幕截图](../media/2-policy-parameters.png)

### <a name="policy-effects"></a>策略效果

通过 azure 策略首先评估通过 azure 资源管理器创建或更新资源的请求。 Policy 创建所有适用于该资源的工作分配的列表, 然后根据每个定义评估该资源。 在将请求处理到相应的资源提供程序之前, 策略将处理几个影响, 以避免在资源违反策略时任何不必要的处理。

Azure 策略中的每个策略定义都有一个单一的效果。 该效果确定在关联的策略规则匹配时会发生什么情况。 当发生这种情况时, Azure 策略将根据所分配的效果执行特定操作。

| 策略效果 | 会发生什么情况？ |
|---------------|---------------|
| 他们 | 由于策略, 资源创建/更新失败。 |
| 禁用 | 策略规则将被忽略 (已禁用)。 通常用于测试。 |
| Append | 在创建或更新过程中, 向请求的资源添加其他参数/字段。 一个常见的示例是添加标记, 如成本中心或为存储资源指定允许的 ip。 |
| Audit、AuditIfNotExists | 在评估不符合项的资源时, 在活动日志中创建一个警告事件, 但不会停止该请求。 |
| DeployIfNotExists | 满足特定条件时执行模板部署。 例如, 如果对数据库启用了 SQL 加密, 则它可以在创建数据库后运行一个模板, 以便以特定方式对其进行设置。 |

### <a name="view-policy-evaluation-results"></a>查看策略评估结果

即使未通过验证, Azure 策略也可以允许创建资源。 在这些情况下, 可以让它触发可在 Azure 策略门户或命令行工具中查看的审核事件。 最简单的方法是在门户中, 因为它提供了一个直观的图形概述, 可供您浏览。 您可以通过 "搜索" 字段或 "_所有服务_" 找到 "Azure 策略" 部分。

![显示 azure 门户概述屏幕的 azure 门户](../media/2-policy-portal.png)

在此屏幕上, 您可以找出不合规的资源, 并采取措施纠正这些问题。 

> [!TIP]
> 如果你在 azure 基础学习路径中继续, 你将在控件中更详细地看到 azure 策略[, 并使用 azure 资源管理器模块组织 azure 资源](https://docs.microsoft.com/learn/modules/control-and-organize-with-azure-resource-manager/)。