目前, 应用程序的最普遍的安全弱点是, 不能正确处理从外部源 (尤其是_用户输入_) 收到的输入。 应始终仔细查看是否有任何输入, 以确保它在使用之前已经过验证。 如果不这样做, 可能会导致数据丢失或泄露、特权提升, 甚至在其他用户的计算机上执行恶意代码。

tragic 的是, 这是一个容易解决的问题。 下面我们将介绍如何处理数据;在收到时, 它会显示在屏幕上, 并在存储时供以后使用。

## <a name="why-do-we-need-to-validate-our-input"></a>我们为什么需要验证输入？

假设您正在构建一个接口, 以允许用户在您的网站上创建帐户。 我们的配置文件数据包括名称、电子邮件和昵称, 我们将向访问该网站的所有人显示该数据。 如果新用户创建了配置文件, 并输入包含某些 SQL 命令的昵称, 该怎么办？ 例如, 如果我们的错误用户输入了类似的内容, 该怎么办:

```sql
Eve'); DROP TABLE Users;--
```

如果我们只是盲目地将此值插入到数据库中, 它可能会改变 SQL 语句以执行绝对不希望运行的命令! 这称为 "SQL 注入" 攻击, 是在未正确处理输入时可能会执行的_多种_类型的攻击之一。 那么, 我们可以采取什么措施来解决此问题？ 此单元将教你何时验证输入、如何编码输出以及如何创建参数化查询 (这可解决上述漏洞)。 下面是针对在应用程序中输入恶意输入的三种主要防护技术。

## <a name="when-do-i-need-to-validate-input"></a>何时需要验证输入？

答案_始终_为。 您必须验证应用程序的**每个**输入。 这包括 URL 中的参数、用户的输入、来自数据库的数据、来自 API 的数据以及用户可能会处理的明文传递的任何内容。 始终使用白名单方法, 这意味着您只接受 "已知正常" 的输入, 而不是黑名单 (在专门查找错误输入的位置), 因为不可能考虑可能存在危险的输入的完整列表。  在服务器而不是客户端 (或除了客户端) 上执行此操作, 以确保防御无法受到规避。 将**所有**数据视为不受信任, 并保护您自己免受大多数常见 web 应用漏洞的攻击。

如果您使用的是 ASP.NET, 则此框架为在客户端和服务器端[验证输入提供了极大的支持](https://docs.microsoft.com/aspnet/web-pages/overview/ui-layouts-and-themes/validating-user-input-in-aspnet-web-pages-sites)。

如果您使用的是另一个 web 框架, 则在[OWASP input 验证 Cheatsheet](https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet)上提供了用于执行输入验证的一些极好的方法。


## <a name="always-use-parameterized-queries"></a>始终使用参数化查询

SQL 数据库通常用于存储数据, 例如配置文件信息。  永远不要在代码中动态创建内联 SQL 或其他数据库查询, 并直接将其发送到数据库, 这是一个用于灾难的方法, 如我们在上面看到的。

例如, 不要**执行此**操作 (称为内联 SQL):

```csharp
string userName = ... // receive input from the user BEWARE!
...
string query = "SELECT *  FROM  [dbo].[users] WHERE userName = '" + userName + "'";
```

这里, 我们将文本字符串串联在一起, 以创建查询、获取用户的输入并生成一个动态 SQL 查询来查找用户。 同样, 如果恶意用户意识到我们执行了此操作, 或者刚_尝试_了不同的输入样式以查看是否存在漏洞, 我们可能最终会遇到重大灾难。 相反, 请使用参数化的 SQL 语句或存储过程, 如下所示:

```sql
-- Lookup a user
CREATE PROCEDURE sp_findUser
(
@UserName varchar(50)
)

SELECT *  FROM  [dbo].[users] WHERE userName = @UserName
```

使用此方法, 您可以从代码中安全地调用过程, 将`userName`字符串传递给它, 而无需担心它被视为 SQL 语句的一部分。

## <a name="always-encode-your-output"></a>始终对输出进行编码

无论是直观还是在文档中呈现的任何输出都应始终进行编码和转义。 这样可以保护您, 以防在净化传递中丢失了某些内容, 或者代码意外生成了可恶意使用的内容。 这将确保所有内容显示为_输出_, 而不是无意解释为应执行的操作。 这是另一种非常常见的称为 "跨站点脚本" (XSS) 的攻击技术。

由于这是常见要求, 因此这是 ASP.NET 将为您完成工作的另一个领域。 默认情况下, 已对所有输出进行编码。 如果使用的是其他 web 框架, 则可以使用[OWASP XSS 防护 Cheatsheet](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet)验证网站上的输出编码选项。

## <a name="summary"></a>摘要

Santizing 和验证输入是确保输入有效且可安全使用和存储的必需要求。 大多数新式 web 框架都提供了内置功能, 可以自动执行其中部分工作。 您可以查看您的首选框架文档, 并查看它所提供的功能。 虽然 web 应用程序是这种情况最常见的地方, 但请记住, 其他类型的应用程序可能会同样容易受到攻击。 不要认为您是安全的, 因为您的新应用程序是桌面应用程序。 您仍需要正确处理用户输入, 以确保有人不会使用您的应用程序损坏您的数据, 或损坏公司的声誉。