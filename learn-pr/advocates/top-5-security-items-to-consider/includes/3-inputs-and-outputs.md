<span data-ttu-id="b0dfc-101">目前, 应用程序的最普遍的安全弱点是, 不能正确处理从外部源 (尤其是_用户输入_) 收到的输入。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-101">The most prevalent security weakness of applications today is to not correctly process input received from external sources, particularly _user input_.</span></span> <span data-ttu-id="b0dfc-102">应始终仔细查看是否有任何输入, 以确保它在使用之前已经过验证。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-102">You should always take a close look at any input to make sure it has been validated before it is used.</span></span> <span data-ttu-id="b0dfc-103">如果不这样做, 可能会导致数据丢失或泄露、特权提升, 甚至在其他用户的计算机上执行恶意代码。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-103">Failing to do this can result in data loss or exposure, escalation of privilege, or even execution of malicious code on other users' computers.</span></span>

<span data-ttu-id="b0dfc-104">tragic 的是, 这是一个容易解决的问题。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-104">The tragic thing is that this is an easy problem to solve.</span></span> <span data-ttu-id="b0dfc-105">下面我们将介绍如何处理数据;在收到时, 它会显示在屏幕上, 并在存储时供以后使用。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-105">Here we will cover how to treat data; when it’s received, when it’s displayed on the screen, and when it's stored for later use.</span></span>

## <a name="why-do-we-need-to-validate-our-input"></a><span data-ttu-id="b0dfc-106">我们为什么需要验证输入？</span><span class="sxs-lookup"><span data-stu-id="b0dfc-106">Why do we need to validate our input?</span></span>

<span data-ttu-id="b0dfc-107">假设您正在构建一个接口, 以允许用户在您的网站上创建帐户。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-107">Imagine that you are building an interface to allow a user to create an account on your website.</span></span> <span data-ttu-id="b0dfc-108">我们的配置文件数据包括名称、电子邮件和昵称, 我们将向访问该网站的所有人显示该数据。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-108">Our profile data includes a name, email, and a nickname that we will display to everyone who visits the site.</span></span> <span data-ttu-id="b0dfc-109">如果新用户创建了配置文件, 并输入包含某些 SQL 命令的昵称, 该怎么办？</span><span class="sxs-lookup"><span data-stu-id="b0dfc-109">What if a new user creates a profile and enters a nickname that includes some SQL commands?</span></span> <span data-ttu-id="b0dfc-110">例如, 如果我们的错误用户输入了类似的内容, 该怎么办:</span><span class="sxs-lookup"><span data-stu-id="b0dfc-110">For example - what if our bad user enters something like:</span></span>

```sql
Eve'); DROP TABLE Users;--
```

<span data-ttu-id="b0dfc-111">如果我们只是盲目地将此值插入到数据库中, 它可能会改变 SQL 语句以执行绝对不希望运行的命令!</span><span class="sxs-lookup"><span data-stu-id="b0dfc-111">If we just blindly insert this value into a database, it could potentially alter the SQL statement to execute commands we absolutely don't want to run!</span></span> <span data-ttu-id="b0dfc-112">这称为 "SQL 注入" 攻击, 是在未正确处理输入时可能会执行的_多种_类型的攻击之一。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-112">This is referred to as a "SQL Injection" attack and is one of the _many_ types of exploits that can potentially be done when you don't properly handle inputs.</span></span> <span data-ttu-id="b0dfc-113">那么, 我们可以采取什么措施来解决此问题？</span><span class="sxs-lookup"><span data-stu-id="b0dfc-113">So, what can we do to fix this?</span></span> <span data-ttu-id="b0dfc-114">此单元将教你何时验证输入、如何编码输出以及如何创建参数化查询 (这可解决上述漏洞)。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-114">This unit will teach you when to validate input, how to encode output, and how to create parameterized queries (which solves the above exploit).</span></span> <span data-ttu-id="b0dfc-115">下面是针对在应用程序中输入恶意输入的三种主要防护技术。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-115">These are the three main defense techniques against malicious input being entered into your applications.</span></span>

## <a name="when-do-i-need-to-validate-input"></a><span data-ttu-id="b0dfc-116">何时需要验证输入？</span><span class="sxs-lookup"><span data-stu-id="b0dfc-116">When do I need to validate input?</span></span>

<span data-ttu-id="b0dfc-117">答案_始终_为。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-117">The answer is _always_.</span></span> <span data-ttu-id="b0dfc-118">您必须验证应用程序的**每个**输入。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-118">You must validate **every** input for your application.</span></span> <span data-ttu-id="b0dfc-119">这包括 URL 中的参数、用户的输入、来自数据库的数据、来自 API 的数据以及用户可能会处理的明文传递的任何内容。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-119">This includes parameters in the URL, input from the user, data from the database, data from an API and anything that is passed in the clear that a user could potentially manipulate.</span></span> <span data-ttu-id="b0dfc-120">始终使用白名单方法, 这意味着您只接受 "已知正常" 的输入, 而不是黑名单 (在专门查找错误输入的位置), 因为不可能考虑可能存在危险的输入的完整列表。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-120">Always use a whitelist approach, which means you only accept "known good" input, instead of a blacklist (where you specifically look for bad input) because it's impossible to think of a complete list of potentially dangerous input.</span></span>  <span data-ttu-id="b0dfc-121">在服务器而不是客户端 (或除了客户端) 上执行此操作, 以确保防御无法受到规避。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-121">Do this work on the server, not the client-side (or in addition to the client-side), to ensure that your defenses cannot be circumvented.</span></span> <span data-ttu-id="b0dfc-122">将**所有**数据视为不受信任, 并保护您自己免受大多数常见 web 应用漏洞的攻击。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-122">Treat **ALL** data as untrusted and you will protect yourself from most of the common web app vulnerabilities.</span></span>

<span data-ttu-id="b0dfc-123">如果您使用的是 ASP.NET, 则此框架为在客户端和服务器端[验证输入提供了极大的支持](https://docs.microsoft.com/aspnet/web-pages/overview/ui-layouts-and-themes/validating-user-input-in-aspnet-web-pages-sites)。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-123">If you are using ASP.NET, the framework provides [great support for validating input](https://docs.microsoft.com/aspnet/web-pages/overview/ui-layouts-and-themes/validating-user-input-in-aspnet-web-pages-sites) on both the client and server side.</span></span>

<span data-ttu-id="b0dfc-124">如果您使用的是另一个 web 框架, 则在[OWASP input 验证 Cheatsheet](https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet)上提供了用于执行输入验证的一些极好的方法。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-124">If you are using another web framework, there are some great techniques for doing input validation available on the [OWASP Input Validation Cheatsheet](https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet).</span></span>


## <a name="always-use-parameterized-queries"></a><span data-ttu-id="b0dfc-125">始终使用参数化查询</span><span class="sxs-lookup"><span data-stu-id="b0dfc-125">Always use parameterized queries</span></span>

<span data-ttu-id="b0dfc-126">SQL 数据库通常用于存储数据, 例如配置文件信息。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-126">SQL databases are commonly used to store data, for example profile information.</span></span>  <span data-ttu-id="b0dfc-127">永远不要在代码中动态创建内联 SQL 或其他数据库查询, 并直接将其发送到数据库, 这是一个用于灾难的方法, 如我们在上面看到的。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-127">Never create inline SQL or other database queries "on the fly" in your code and send it directly to the database, this is a recipe for disaster, as we saw above.</span></span>

<span data-ttu-id="b0dfc-128">例如, 不要**执行此**操作 (称为内联 SQL):</span><span class="sxs-lookup"><span data-stu-id="b0dfc-128">For example, **do not do this** (known as inline SQL):</span></span>

```csharp
string userName = ... // receive input from the user BEWARE!
...
string query = "SELECT *  FROM  [dbo].[users] WHERE userName = '" + userName + "'";
```

<span data-ttu-id="b0dfc-129">这里, 我们将文本字符串串联在一起, 以创建查询、获取用户的输入并生成一个动态 SQL 查询来查找用户。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-129">Here we concatenate text strings together to create the query, taking the input from the user and generating a dynamic SQL query to lookup the user.</span></span> <span data-ttu-id="b0dfc-130">同样, 如果恶意用户意识到我们执行了此操作, 或者刚_尝试_了不同的输入样式以查看是否存在漏洞, 我们可能最终会遇到重大灾难。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-130">Again, if a malicious user realized we were doing this, or just _tried_ different input styles to see if there was a vulnerability, we could end up with a major disaster.</span></span> <span data-ttu-id="b0dfc-131">相反, 请使用参数化的 SQL 语句或存储过程, 如下所示:</span><span class="sxs-lookup"><span data-stu-id="b0dfc-131">Instead, use parameterized SQL statements or stored procedures such as this:</span></span>

```sql
-- Lookup a user
CREATE PROCEDURE sp_findUser
(
@UserName varchar(50)
)

SELECT *  FROM  [dbo].[users] WHERE userName = @UserName
```

<span data-ttu-id="b0dfc-132">使用此方法, 您可以从代码中安全地调用过程, 将`userName`字符串传递给它, 而无需担心它被视为 SQL 语句的一部分。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-132">With this method you can invoke the procedure from your code safely, passing it the `userName` string without worrying about it being treated as part of the SQL statement.</span></span>

## <a name="always-encode-your-output"></a><span data-ttu-id="b0dfc-133">始终对输出进行编码</span><span class="sxs-lookup"><span data-stu-id="b0dfc-133">Always encode your output</span></span>

<span data-ttu-id="b0dfc-134">无论是直观还是在文档中呈现的任何输出都应始终进行编码和转义。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-134">Any output you present either visually or within a document should always be encoded and escaped.</span></span> <span data-ttu-id="b0dfc-135">这样可以保护您, 以防在净化传递中丢失了某些内容, 或者代码意外生成了可恶意使用的内容。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-135">This can protect you in case something was missed in the sanitization pass, or the code accidentally generates something that can be used maliciously.</span></span> <span data-ttu-id="b0dfc-136">这将确保所有内容显示为_输出_, 而不是无意解释为应执行的操作。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-136">This will make sure that everything is displayed as _output_ and not inadvertently interpreted as something that should be executed.</span></span> <span data-ttu-id="b0dfc-137">这是另一种非常常见的称为 "跨站点脚本" (XSS) 的攻击技术。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-137">This is another very common attack technique referred to as "Cross-Site Scripting" (XSS).</span></span>

<span data-ttu-id="b0dfc-138">由于这是常见要求, 因此这是 ASP.NET 将为您完成工作的另一个领域。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-138">Since this is such as common requirement, this is another area where ASP.NET will do the work for you.</span></span> <span data-ttu-id="b0dfc-139">默认情况下, 已对所有输出进行编码。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-139">By default, all output is already encoded.</span></span> <span data-ttu-id="b0dfc-140">如果使用的是其他 web 框架, 则可以使用[OWASP XSS 防护 Cheatsheet](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet)验证网站上的输出编码选项。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-140">If you are using another web framework, you can verify your options for output encoding on websites with the [OWASP XSS Prevention Cheatsheet](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet).</span></span>

## <a name="summary"></a><span data-ttu-id="b0dfc-141">摘要</span><span class="sxs-lookup"><span data-stu-id="b0dfc-141">Summary</span></span>

<span data-ttu-id="b0dfc-142">Santizing 和验证输入是确保输入有效且可安全使用和存储的必需要求。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-142">Santizing and validating your input is a necessary requirement to ensure your input is valid and safe to use and store.</span></span> <span data-ttu-id="b0dfc-143">大多数新式 web 框架都提供了内置功能, 可以自动执行其中部分工作。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-143">Most modern web frameworks offer built-in features which can automate some of this work.</span></span> <span data-ttu-id="b0dfc-144">您可以查看您的首选框架文档, 并查看它所提供的功能。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-144">You can check your preferred framework's documentation and see what features it offers.</span></span> <span data-ttu-id="b0dfc-145">虽然 web 应用程序是这种情况最常见的地方, 但请记住, 其他类型的应用程序可能会同样容易受到攻击。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-145">While web applications are the most common place where this happens, keep in mind that other types of applications can be just as vulnerable.</span></span> <span data-ttu-id="b0dfc-146">不要认为您是安全的, 因为您的新应用程序是桌面应用程序。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-146">Don't think you're safe just because your new application is a desktop app.</span></span> <span data-ttu-id="b0dfc-147">您仍需要正确处理用户输入, 以确保有人不会使用您的应用程序损坏您的数据, 或损坏公司的声誉。</span><span class="sxs-lookup"><span data-stu-id="b0dfc-147">You will still need to properly handle user input to ensure someone doesn't use your app to corrupt your data, or damage your company's reputation.</span></span>