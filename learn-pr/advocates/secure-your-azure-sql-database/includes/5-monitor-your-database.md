设想您会收到来自贵公司的安全管理员的警报, 指出网络中检测到潜在的安全漏洞。 怀疑未经授权的个人可能已通过恶意活动访问您的数据库。 如何跟踪此问题？ 您知道您需要积极监控数据库是否有可疑的活动, 但您可以采取什么操作才能了解数据库中发生的情况, 同时还能防止恶意活动发生吗？

Azure SQL 数据库具有内置功能, 可帮助您跟踪数据库中发生的情况, 并将监视并在发现恶意活动时向您发出警报。

## <a name="azure-sql-database-auditing"></a>Azure SQL 数据库审核

通过启用审核, 可存储数据库中发生的操作, 以供以后检查或让自动化工具对它们进行分析。 审核还可用于合规性管理或了解您的数据库的使用方式。 如果您想要在 azure SQL 数据库上使用 azure 威胁检测, 也需要进行审核。

审核日志将写入到您指定的 Azure Blob 存储帐户中的附加 blob。 可以在服务器级别或数据库级别应用审核策略。 启用后, 可以使用 Azure 门户查看日志, 或将其发送到 Log Analytics 或 Event Hub 以进行进一步处理和分析。

我们来看看您在系统上设置审核需要执行的步骤。

1. 使用与激活沙盒时相同的帐户登录[Azure 门户](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true)。

1. 在门户顶部的搜索栏中, 搜索 " **server<12345>**", 然后在门户中选择服务器。

1. 在左侧菜单中的 "**安全性**" 部分, 选择 "**审核**" 选项。

1. 审核在默认情况下处于禁用状态。 若要在数据库服务器上启用它, 请点击 " **on** " 按钮。

1. 选择 "打开" 按钮后, 选中 "**存储**" 复选框, 然后单击 "**存储详细信息**" 以定义存储帐户。

1. 在 "**存储设置**" 对话框中, 您可以选择一个现有存储帐户, 也可以创建新的存储帐户以存储您的审核。 存储帐户必须配置为使用与服务器相同的区域。 在这种情况下, 我们将定义新的存储帐户。 单击 "**存储帐户**", 这将打开 "**创建存储帐户**" 对话框。 将存储帐户`server<12345>auditing`的名称替换`<12345>`为逻辑服务器名称中的数字。 保留其余选项的默认值, 然后选择 **"确定"**。 返回到 "**存储设置**" 对话框中, 保留默认值, 然后单击 **"确定"**。

1. 单击工具栏中的 "**保存**" 按钮以保存所做的更改并在数据库服务器上启用审核。

现在, 我们将生成一些审核记录, 并查看你可以预期的内容。

1. 让我们以_ApplicationUser_用户的形式重新登录到数据库。

    ```bash
    sqlcmd -S tcp:server<12345>.database.windows.net,1433 -d marketplaceDb -U 'ApplicationUser' -P '<password>' -N -l 30
    ```

1. 运行以下查询。

    ```sql
    SELECT FirstName, LastName, EmailAddress, Phone FROM SalesLT.Customer;
    GO
    ```

1. 返回到 sql server 上的门户, 在左侧菜单中选择 " **SQL 数据库**", 然后选择 " _marketplace_ " 数据库。

1. 在您的_marketplace_数据库的左侧菜单中的 "**安全性**" 部分, 选择 "**审核**"。

1. 由于我们在服务器级别启用了审核, 你应该会看到此处启用了审核。 选择顶部菜单栏中的 "**查看审核日志**" 以查看日志。

1. 您应该会看到一个或多个具有**主体名称**为_ApplicationUser_和**事件类型**为 "**批处理已完成**" 的审核记录。 其中一个应包含刚执行的查询的详细信息。 你可能还会看到其他事件, 例如身份验证失败和成功。 选择 "任意记录" 可查看事件的完整详细信息。

![显示审核日志中的事件的示例](../media/5-audit-log.png)

这些操作将在数据库服务器级别配置审核, 并将其应用于服务器上的所有数据库。 您还可以在数据库级别配置审核。

让我们看一下利用这些日志提高数据库安全性的另一项功能。

## <a name="advanced-threat-protection-for-azure-sql-database"></a>Azure SQL 数据库的高级威胁防护

高级威胁防护系统分析审核日志, 以查找针对您的数据库的潜在问题和威胁。 它包括用于发现和分类敏感数据的功能、呈现和缓解潜在的数据库漏洞以及检测可能指示对数据库的威胁的反常活动。 它提供了用于启用和管理这些功能的单一转到位置。 只需要单击一次, 即可在整个数据库服务器上启用 ATP, 并将其应用于服务器上的所有数据库。

### <a name="setup-and-configuration"></a>设置和配置

让我们对数据库启用高级威胁防护。 高级威胁防护是服务器级别的设置, 因此我们将从此处开始。

1. 返回门户, 导航到您的 SQL server。 在门户顶部的搜索栏中, 搜索 " **server<12345>**", 然后选择 "服务器"。

1. 在左侧菜单中的 "**安全性**" 部分, 选择 "**高级威胁防护**" 选项。

1. 单击 "**打开**" 按钮以启用高级威胁防护。

1. 您可以选择将通知电子邮件的传递位置定义为以分号分隔的电子邮件地址列表。 默认情况下会启用**电子邮件服务和协同管理员**, 以将威胁发送给服务管理员。

1. 您可以选择为已收到警报的可疑查询的历史记录指定一个存储帐户。 这不是启用高级威胁防护的必要条件, 但对历史跟踪很有用。 单击 "**存储详细信息**" 打开 "**存储设置**" 对话框。

1. 在 "**选择存储帐户**" 对话框中, 选择您在上一节中创建的**server<12345>auditing**存储帐户。 将其他设置保留为默认值, 然后单击 **"确定"**。

1. 最后, 选择**威胁检测类型**以快速查看这些类型。 首选选项是 "All", 这是默认设置。

    "**全部**" 表示以下值:
    - 出现 sql 注入攻击的 sql 注入报告;
    - sql 注入漏洞报告可能出现 sql 注入的情况。并
    - 反常客户端登录查看异常的登录, 并可能导致问题, 例如, 潜在的攻击者获取访问权限。

1. 单击 "**保存**" 按钮以应用更改并在服务器上启用高级威胁防护。

我们还需要启用一个数据库级设置, 这就是漏洞评估。

1. 导航到您的*marketplace*数据库。 在门户顶部的搜索栏中, 搜索 " **marketplace**", 然后选择门户中的 "数据库"。

1. 在左侧菜单中的 "**安全性**" 部分, 选择 "**高级威胁防护**" 选项。

1. 在 "**漏洞评估**" 框中, 您应该会看到一条消息, 指出 "单击此处可配置存储扫描结果的存储帐户"。 若要启用此功能, 您需要执行此操作, 请继续操作, 然后单击进行配置。

1. 在 "**选择存储帐户**" 对话框中, 选择您在上一节中创建的**server<12345>auditing**存储帐户。

1. 您还可以启用**定期定期扫描**, 以将漏洞评估配置为每周运行一次自动扫描。 扫描结果摘要将发送到您提供的电子邮件地址。 在这种情况下, 我们会将其**关闭**。 继续执行, 然后单击顶部的 "**保存**" 以保存设置并启用漏洞评估。

1. 回到 "主要漏洞评估" 面板中, 继续执行, 然后单击 "**扫描**" 以启动数据库扫描。 完成后, 你将看到提高数据库安全性的建议。

启用高级威胁防护后, 您将在数据库级别查看详细信息和结果。

你将收到电子邮件通知, 因为检测到安全漏洞。 该电子邮件将概述所发生的情况以及要采取的操作。

![来自高级威胁防护的示例通知警告](../media/5-email-with-warning.png)

### <a name="data-discovery--classification"></a>数据发现 & 分类

单击 "**数据发现 & 分类**" 面板。

"数据发现 & 分类" 面板显示了需要保护的表中的列。 某些列可能包含敏感信息, 或者可能被视为属于不同的国家或地区。

![数据发现 & 分类](../media/5-data-discovery-and-classification.png)

如果有任何列需要配置保护, 则会显示一条消息。 此邮件的格式如下所示: *"我们找到了10个包含分类建议的列"*。 您可以单击文本以查看建议。

通过单击列旁边的复选标记选择要分类的列, 或者选中架构标头左侧的复选框。 选择 "接受所选建议" 选项以应用分类建议。

接下来, 您将编辑列, 然后定义数据库的信息类型和敏感度标签。 单击 "保存" 按钮以保存更改。

如果你已成功管理建议, 则不应列出活动建议。

### <a name="vulnerability-assessment"></a>漏洞评估

单击**漏洞评估**面板中的。

![漏洞评估仪表板](../media/5-vulnerability-assessment-dashboard.png)

漏洞评估列出了数据库的配置问题以及相关的风险。 例如, 在上面的图像中, 您可以看到需要设置的服务器级别的防火墙。

单击 "漏洞评估" 面板以查看完整的漏洞列表。 在这里, 可以单击每个单独的漏洞。

在 "漏洞" 页面上, 您将看到详细信息, 如风险级别、应用于的数据库、安全漏洞的说明以及建议的用于修复问题的补救措施。 应用修正以修复问题。 请务必解决所有漏洞。

### <a name="threat-detection"></a>威胁检测

单击 "**威胁检测**" 面板。

这将显示检测到的威胁的列表。 例如, 在此列表中, 可能存在一种潜在的 SQL 注入攻击。

![威胁检测](../media/5-threat-detection-dashboard.png)

 按照建议解决任何问题。 对于诸如 SQL 注入警告这样的问题, 您将能够查看查询并向后工作, 以在代码中执行查询。 一旦找到, 您应重写代码, 这样它就不再有问题了。