_marketplaceDb_数据库存储敏感信息, 如物理地址、电子邮件地址和电话号码。 如果暴露, 恶意攻击者可利用此漏洞危害我们的业务或我们的客户。 让我们来看看如何使用加密和数据掩码来增强数据库的安全性。

## <a name="tls-network-encryption"></a>TLS 网络加密

Azure SQL 数据库将对所有连接始终强制执行传输层安全性 (TLS) 加密, 这样可确保在数据库和客户端之间的 "传输" 中加密所有数据。 通过使用 TLS 加密, 可以确保可能截获应用程序服务器和数据库之间的流量的任何人都无法读取数据。 TLS 加密是通过 internet 进行安全通信的标准, 在这种情况下, 可以确保进出 Azure SQL 数据库的网络流量在默认情况下是安全的。

## <a name="transparent-data-encryption"></a>透明数据加密

Azure SQL Database 使用透明数据加密 (TDE) 保护静态数据。 TDE 对数据库、关联备份和事务日志文件执行实时加密和解密, 而不需要对应用程序进行更改。 使用数据库加密密钥, 透明数据加密会对页面级别的数据执行实时 i/o 加密和解密。 每个页面在读取到内存中时进行解密, 然后在写入磁盘之前进行加密。

默认情况下, 将为所有新部署的 Azure SQL 数据库启用 TDE。 检查数据加密是否尚未关闭, 并且较旧的 Azure SQL Server 数据库可能未启用 TDE, 这一点非常重要。

我们来看一下门户, 其中 TDE 是在我们的_marketplaceDb_数据库上配置的。

1. 使用与激活沙盒时相同的帐户登录[Azure 门户](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true)。

1. 在门户顶部的搜索栏中, 搜索 " **marketplaceDb**", 然后选择门户中的 "数据库"。

1. 在左侧菜单中的 "**安全性**" 部分, 选择 "**透明数据加密**" 选项。

1. 在 "数据加密" 选项中, 验证是否已将**数据加密**设置为 **"开"**。 您还应看到加密状态为 "已**加密**"。

由于默认情况下会对新数据库进行加密, 因此我们可以确保在创建数据库后, 将在磁盘上加密数据。

> [!NOTE]
> azure 包含一个名为 azure security Center 的内置服务, 可让你了解环境的安全性 (包括 Azure SQL 数据库)。 Azure 安全中心将标记未在其上启用 TDE 的任何数据库, 从而使您能够报告并采取措施来保护您的数据。

## <a name="dynamic-data-masking"></a>动态数据掩码

当我们在上一个单元中运行查询时, 您可能会注意到数据库中的某些信息是敏感的;有一些电话号码、电子邮件地址和其他信息, 我们可能不希望让对数据具有访问权限的每个人完全显示这些信息。

或许我们不希望用户能够看到完整的电话号码或电子邮件地址, 但我们仍希望让客户服务代表提供可供客户服务代表识别客户的数据的一部分。 通过使用 Azure SQL 数据库的动态数据掩码功能, 我们可以限制向用户显示的数据。 动态数据掩码是一种基于策略的安全功能, 可隐藏对指定数据库字段的查询结果集中的敏感数据, 而数据库中的数据不会发生更改。

数据掩码规则包含要对其应用掩码的列, 以及应如何屏蔽数据。 您可以创建自己的掩码格式, 或使用其中一个标准掩码, 例如:

- 默认值, 它显示的是该数据类型的默认值。
- 信用卡值, 仅显示数字的后四个数字, 将所有其他数字转换为小写字母 x。
- 电子邮件, 它会隐藏电子邮件帐户名称的域名和除第一个字符之外的所有字符。
- 数字, 用于指定值范围之间的随机数字。 例如, 在信用卡到期月和年中, 可以选择从1到12的随机月数, 并将年范围设置为2018到3000。
- 自定义字符串。 这使您可以设置从数据的开头公开的字符数、从数据末尾公开的字符数以及为其余数据重复的字符数。

查询列时, 数据库管理员仍将看到原始值, 但非管理员将看到掩码值。 您可以通过将其他用户添加到 "从掩码列表中排除的 SQL 用户" 来查看非屏蔽版本。

让我们来看看这在我们的_marketplaceDb_数据库中是如何工作的。

1. 仍在_marketplaceDb_ "数据库" 面板的门户中, 在左侧菜单中的 "**安全性**" 部分, 选择 " **Dyanmic 数据掩码**"。

    掩码规则屏幕显示现有动态数据掩码的列表, 以及可能应用了动态数据掩码的列的建议。

    ![显示示例数据库的各个数据库列的建议掩码列表的 Azure 门户屏幕截图。](../media/4-view-recommended-masked-columns.png)

1. 让我们为仅显示最后四位数字的电话号码添加一个掩码。 单击顶部的 " **+ 添加掩码**" 按钮以打开 "**添加掩码规则**" 对话框。

1. 选择下列值。

    | _設定_                | _値_                                 |
    | ------------------------ | --------------------------------------- |
    | **架构**               | SalesLT                                 |
    | **Table**                | 客户                                |
    | **Column**               | 电话 (nvarchar)                        |
    | **掩码字段格式** | 自定义字符串 (前缀 [填充] 后缀) |
    | **公开的前缀**       | 0                                       |
    | **填充字符串**       | XXX-XXX-                                |
    | **公开的后缀**       | 4                                       |

    单击 "**添加**" 以添加掩码规则。

    ![显示要添加掩码规则的值的 Azure 门户屏幕截图。](../media/4-add-masking-rule.png)

1. 让我们再为电子邮件地址添加一个更多的。 再次单击顶部的 " **+ 添加掩码**" 按钮, 打开 "**添加掩码规则**" 对话框。

    | _設定_                | _値_                                 |
    | ------------------------ | --------------------------------------- |
    | **架构**               | SalesLT                                 |
    | **Table**                | 客户                                |
    | **Column**               | EmailAddress (nvarchar)                 |
    | **掩码字段格式** | 电子邮件 (aXXX@XXX.com)                    |

    单击 "**添加**" 以添加掩码规则。

1. 每个新掩码都将添加到掩码规则列表中。 单击 "**保存**" 按钮以应用掩码。

我们来看看这是如何更改我们的查询的。

1. 现在, 让我们重新登录到数据库, 但作为_ApplicationUser_用户。

    ```bash
    sqlcmd -S tcp:server<12345>.database.windows.net,1433 -d marketplaceDb -U 'ApplicationUser' -P '<password>' -N -l 30
    ```

1. 运行以下查询。

    ```sql
    SELECT FirstName, LastName, EmailAddress, Phone FROM SalesLT.Customer;
    GO
    ```

    查看如何对输出进行屏蔽。

    ```output
    FirstName     LastName      EmailAddress         Phone
    ------------- ------------- -------------------- ------------
    Orlando       Gee           oXXX@XXXX.com        XXX-XXX-0173
    Keith         Harris        kXXX@XXXX.com        XXX-XXX-0127
    Donna         Carreras      dXXX@XXXX.com        XXX-XXX-0130
    Janet         Gates         jXXX@XXXX.com        XXX-XXX-0173
    ...
    ```

使用我们创建的掩码规则, 我们的数据将采用我们指定的格式进行屏蔽。 这允许我们的客户服务代表使用其电话号码的后四位数字来验证客户, 但不需要从代表视图中隐藏完整号码和客户的电子邮件地址。