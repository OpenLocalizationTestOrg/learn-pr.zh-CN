你的公司已决定使用 vm 从 Azure 中的流量相机管理视频数据。 为了运行多个编解码器, 我们首先需要创建虚拟机。 我们还需要连接虚拟机并与之交互。 在此单元中, 你将了解如何使用 Azure 门户创建 VM。 您将配置虚拟机以进行远程访问, 选择虚拟机映像, 然后选择正确的存储选项。

## <a name="introduction-to-windows-virtual-machines-in-azure"></a>Azure 中的 Windows 虚拟机简介

Azure 虚拟机是按需可扩展的云计算资源。 它们类似于在 Windows hyper-v 中托管的虚拟机。 其中包括处理器、内存、存储和网络资源。 你可以随时启动和停止虚拟机, 就像使用 hyper-v 一样, 还可以从 azure 门户或 azure CLI 中进行管理。 您还可以使用远程桌面协议 (RDP) 客户端直接连接到 Windows 桌面用户界面 (UI), 并使用 VM, 就像您登录到本地 Windows 计算机一样。

## <a name="creating-an-azure-vm"></a>创建 Azure 虚拟机

可以通过以下几种方式在 Azure 上定义和部署 vm: azure 门户、脚本 (使用 Azure CLI 或 azure PowerShell) 或通过 Azure 资源管理器模板。 在所有情况下, 您都需要提供几条信息, 我们将很快介绍。

Azure Marketplace 还提供预先配置的图像, 其中包括在特定情况下安装的操作系统和受欢迎的软件工具。

![显示虚拟机的 Azure 市场列表的屏幕截图。](../media/2-marketplace-vm-choices.png)

## <a name="resources-used-in-a-windows-vm"></a>Windows VM 中使用的资源

在 Azure 中创建 Windows VM 时, 还会创建用于承载 VM 的资源。 这些资源协同工作以虚拟化计算机并运行 Windows 操作系统。 这些项必须存在 (并在创建 vm 时选择), 否则将使用 vm 创建它们。

- 提供 CPU 和内存资源的虚拟机。
- 用于保存虚拟硬盘的 Azure 存储帐户。
- 用于存放 OS、应用程序和数据的虚拟磁盘。
- 用于将 VM 连接到其他 Azure 服务或你自己的本地硬件的虚拟网络 (VNet)。
- 与 VNet 通信的网络接口。
- 公共 IP 地址, 以便您可以访问 VM。 这是可选的。

与其他 Azure 服务一样, 你将需要一个**资源组**来包含 VM (并可选择将这些资源组合在一起进行管理)。 创建新的 VM 时, 可以使用现有的资源组, 也可以创建一个新的虚拟机。

## <a name="choose-the-vm-image"></a>选择虚拟机映像

选择图像是创建 VM 时第一次也是最重要的决策之一。 图像是用于创建虚拟机的模板。 这些模板包括操作系统, 通常是其他软件, 如开发工具或 web 托管环境。

计算机可以支持的任何应用程序都可以包含在 VM 映像中。 您可以从预先配置为完全符合要求的映像创建 VM, 如托管 ASP.Net Core app。

> [!TIP]
> 您还可以创建和上载自己的图像, 请查看文档以了解详细信息。

## <a name="sizing-your-vm"></a>调整你的 VM 的大小
正如物理计算机具有一定数量的内存和 CPU 功能一样, 虚拟机也是如此。 Azure 以不同的价位提供了一系列不同大小的虚拟机。 您选择的大小将确定 vm 处理能力、内存和最大存储容量。

> [!WARNING]
> 对可以影响 VM 创建的每个订阅都有配额限制。 默认情况下, 一个区域中的所有虚拟机上的虚拟_核心_不能超过20个。 您可以跨区域拆分 vm, 也可以通过文件[在线请求](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request)来增加您的限制。

VM 大小按类别进行分组, 从 B 系列开始, 以进行基本测试, 并在高达 H 系列中为大型计算任务运行。 应根据要执行的工作负荷选择 VM 的大小。 在创建虚拟机后, 可以更改它的大小, 但必须先停止 vm, 以便在可能的情况下能够正确地调整其大小。

#### <a name="here-are-some-guidelines-based-on-the-scenario-you-are-targeting"></a>下面是基于您所针对的方案的一些准则。

| 你在做什么？ | 考虑这些大小
|-------|------------------|
| **常规使用计算/web**测试和开发、小型到中型数据库或低到中型流量 web 服务器。 | B、Dsv3、Dv3、DSv2、Dv2 |
| **繁重的计算任务**中型流量 web 服务器、网络设备、批处理过程和应用程序服务器。 | Fsv2, Fs, F |
| **大内存使用率**关系数据库服务器、大型缓存中和内存中的分析。 | Esv3、Ev3、M、GS、G、DSv2、Dv2 |
| **数据存储和处理**需要高磁盘吞吐量和 IO 的大型数据、SQL 和 NoSQL 数据库。 | ! |
| **较高的图形呈现**或视频编辑, 以及深入学习的模型培训和 inferencing (ND)。 | NV、NC、NCv2、NCv3、ND |
| **高性能计算 (HPC)** 如果你需要具有最快、性能最强大的 CPU 虚拟机 (可选的高吞吐量网络接口)。 | 水平 |

## <a name="choosing-storage-options"></a>选择存储选项

下一组决策围绕存储。 首先, 可以选择磁盘技术。 选项包括传统的基于磁盘驱动器的硬盘驱动器 (HDD) 或更新式的固态驱动器 (SSD)。 就像购买的硬件一样, SSD 存储成本更高, 但提供了更好的性能。

> [!TIP]
> 有两个级别的 SSD 存储可供使用: 标准版和高级版。 如果你具有正常工作负载但需要更好的性能, 请选择标准 SSD 磁盘。 如果您具有需要非常快地处理数据的 i/o 密集型工作负荷或任务关键型系统, 请选择 "高级 SSD 磁盘"。

### <a name="mapping-storage-to-disks"></a>将存储映射到磁盘

Azure 使用虚拟硬盘 (vhd) 来表示虚拟机的物理磁盘。 vhd 复制磁盘驱动器的逻辑格式和数据, 但存储为 Azure 存储帐户中的页面 blob。 可以基于每个磁盘选择它应使用的存储类型 (SSD 或 HDD)。 这使您可以控制每个磁盘的性能, 这可能取决于您计划在其上执行的 i/o。

默认情况下, 将为你的 Windows VM 创建两个虚拟硬盘 (vhd):

1. **操作系统磁盘**。 这是主驱动器或 C: 驱动器, 最大容量为 2048 GB。

1. **临时磁盘**。 这将为 OS 或任何应用程序提供临时存储空间。 默认情况下, 将其配置为 D: drive, 并根据 VM 大小调整其大小, 使其成为 Windows 页面文件的理想位置。

> [!WARNING]
> 临时磁盘不是永久性的。 您应该只向此磁盘写入一次您愿意丢失的数据。

#### <a name="what-about-data"></a>数据是什么？

您可以在 C: 驱动器上存储数据以及操作系统, 但更好的方法是创建专用的_数据磁盘_。 你可以创建其他磁盘并将其附加到 VM。 每个磁盘最多可以包含 4095 GB 的数据, 最大存储量取决于所选的 VM 大小。

> [!NOTE]
> 一种有趣的功能是从实际磁盘创建 VHD 映像。 这使您可以轻松地将_现有_信息从本地计算机迁移到云。

### <a name="unmanaged-vs-managed-disks"></a>非托管磁盘与托管磁盘

你将做出的最终存储选择是使用**非托管**磁盘还是**托管**磁盘。

对于非托管磁盘, 您负责处理用于保存与您的 VM 磁盘对应的 vhd 的存储帐户。 您为所使用的空间量支付存储帐户费率。 一个存储帐户的速率限制为每秒20000个 i/o 操作数。这意味着单个存储帐户能够在完全限制的情况支持40标准虚拟硬盘。 如果需要向外扩展, 则需要多个存储帐户, 这可能会变得复杂。

托管磁盘是较新的推荐磁盘存储模型。 它们通过将管理存储帐户的负担放到 Azure 上来解决此复杂性。 elegantly 指定磁盘类型 (最优或标准), 磁盘和 Azure 的大小将创建并管理它使用的磁盘_和_存储。 您无需担心存储帐户限制, 这样就可以更轻松地向外扩展。它们还提供了其他几项好处:

- **增强了可靠性**: azure 可确保与高可靠性虚拟机相关联的 vhd 放置在 Azure 存储的不同部分, 以提供类似的恢复级别。
- **更好的安全性**: 托管磁盘是资源组中真正管理的资源。 这意味着他们可以使用基于角色的访问控制来限制可处理 VHD 数据的人员。
- **快照支持**: 快照可用于创建 VHD 的只读副本。 您必须关闭拥有的 VM, 但创建快照只需几秒钟。 完成后, 您可以打开 vm 并使用快照创建一个重复的 vm 来解决生产问题, 或将 vm 回滚到拍摄快照的时间点。
- **备份支持**: 可以将托管磁盘自动备份到不同区域以使用 Azure 备份进行灾难恢复, 而不会影响 VM 的服务。

## <a name="network-communication"></a>网络通信

虚拟机使用虚拟网络 (VNet) 与外部资源进行通信。 VNet 表示您的资源在单个区域中进行通信的专用网络。 虚拟网络就像您在本地管理的网络一样。 您可以使用子网将它们划分为隔离资源, 将它们连接到其他网络 (包括您的本地网络), 并应用流量规则来控制入站和出站连接。

### <a name="planning-your-network"></a>规划网络

创建新的 VM 时, 可以选择创建新的虚拟网络, 也可以选择使用区域中现有的 VNet。

将 Azure 与 VM 一起创建的网络非常简单, 但很可能不适合大多数方案。 最好为您的体系结构中的__ 所有组件预先规划您的网络要求, 并创建您将单独需要的 VNet 结构。 然后, 创建虚拟机并将其放入已创建的 vnet。

在此模块后面的部分, 我们将在虚拟网络上查看更多内容。 让我们应用其中一些知识, 并在 Azure 中创建 VM。