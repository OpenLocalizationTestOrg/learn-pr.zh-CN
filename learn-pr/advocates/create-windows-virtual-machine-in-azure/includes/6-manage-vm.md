<span data-ttu-id="47bae-101">我们已安装自定义软件、设置 FTP 服务器并将 VM 配置为接收视频文件。</span><span class="sxs-lookup"><span data-stu-id="47bae-101">We've installed our custom software, set up an FTP server, and configured the VM to receive our video files.</span></span> <span data-ttu-id="47bae-102">但是, 如果我们尝试使用 FTP 连接公共 IP 地址, 我们会发现它已被阻止。</span><span class="sxs-lookup"><span data-stu-id="47bae-102">However, if we try to connect to our public IP address with FTP, we'll find that it's blocked.</span></span> 

<span data-ttu-id="47bae-103">对服务器配置进行调整通常是在本地环境中使用设备执行的。</span><span class="sxs-lookup"><span data-stu-id="47bae-103">Making adjustments to server configuration is commonly performed with equipment in your on-premises environment.</span></span> <span data-ttu-id="47bae-104">在这种意义上, 可以将 Azure 虚拟机视为该环境的扩展。</span><span class="sxs-lookup"><span data-stu-id="47bae-104">In this sense, you can consider Azure VMs to be an extension of that environment.</span></span> <span data-ttu-id="47bae-105">您可以通过 azure 门户、azure CLI 或 azure PowerShell 工具进行配置更改、管理网络、打开或阻止流量。</span><span class="sxs-lookup"><span data-stu-id="47bae-105">You can make configuration changes, manage networks, open or block traffic, and more through the Azure portal, Azure CLI, or Azure PowerShell tools.</span></span>

<span data-ttu-id="47bae-106">您已看到虚拟机的**概述**面板中的一些基本信息和管理选项。</span><span class="sxs-lookup"><span data-stu-id="47bae-106">You've already seen some of the basic information and management options in the **Overview** panel for the virtual machine.</span></span> <span data-ttu-id="47bae-107">让我们再探索一下网络配置。</span><span class="sxs-lookup"><span data-stu-id="47bae-107">Let's explore network configuration a bit more.</span></span>

## <a name="opening-ports-in-azure-vms"></a><span data-ttu-id="47bae-108">在 Azure 虚拟机中打开端口</span><span class="sxs-lookup"><span data-stu-id="47bae-108">Opening ports in Azure VMs</span></span>

<span data-ttu-id="47bae-109">默认情况下, 新的 vm 将被锁定。</span><span class="sxs-lookup"><span data-stu-id="47bae-109">By default, new VMs are locked down.</span></span> 

<span data-ttu-id="47bae-110">应用可以发出传出请求, 但仅允许来自虚拟网络 (例如, 同一本地网络上的其他资源) 的入站流量, 以及 Azure 的负载平衡器 (探测器检查)。</span><span class="sxs-lookup"><span data-stu-id="47bae-110">Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g. other resources on the same local network), and from Azure's Load Balancer (probe checks).</span></span>

<span data-ttu-id="47bae-111">可通过两个步骤来调整配置以支持 FTP。</span><span class="sxs-lookup"><span data-stu-id="47bae-111">There are two steps to adjusting the configuration to support FTP.</span></span> <span data-ttu-id="47bae-112">当您创建新的 VM 时, 您有机会打开几个常用端口 (RDP、HTTP、HTTPS 和 SSH)。</span><span class="sxs-lookup"><span data-stu-id="47bae-112">When you create a new VM you have an opportunity to open a few common ports (RDP, HTTP, HTTPS, and SSH).</span></span> <span data-ttu-id="47bae-113">但是, 如果需要对防火墙进行其他更改, 您将需要自己执行这些更改。</span><span class="sxs-lookup"><span data-stu-id="47bae-113">However, if you require other changes to the firewall, you will need to do them yourself.</span></span>

<span data-ttu-id="47bae-114">此过程的过程包括两个步骤:</span><span class="sxs-lookup"><span data-stu-id="47bae-114">The process for this involves two steps:</span></span>

1. <span data-ttu-id="47bae-115">创建网络安全组。</span><span class="sxs-lookup"><span data-stu-id="47bae-115">Create a Network Security Group.</span></span>
2. <span data-ttu-id="47bae-116">创建允许在端口20和21上的流量进行主动 FTP 支持的入站规则。</span><span class="sxs-lookup"><span data-stu-id="47bae-116">Create an inbound rule allowing traffic on port 20 and 21 for active FTP support.</span></span>

### <a name="what-is-a-network-security-group"></a><span data-ttu-id="47bae-117">什么是网络安全组？</span><span class="sxs-lookup"><span data-stu-id="47bae-117">What is a Network Security Group?</span></span>

<span data-ttu-id="47bae-118">虚拟网络 (vnet) 是 Azure 网络模型的基础, 提供隔离和保护。</span><span class="sxs-lookup"><span data-stu-id="47bae-118">Virtual networks (VNets) are the foundation of the Azure networking model and provide isolation and protection.</span></span> <span data-ttu-id="47bae-119">网络安全组 (NSGs) 是用于在网络级别强制和控制网络流量规则的主要工具。</span><span class="sxs-lookup"><span data-stu-id="47bae-119">Network Security Groups (NSGs) are the main tool you use to enforce and control network traffic rules at the networking level.</span></span> <span data-ttu-id="47bae-120">NSGs 是一个可选的安全层, 它通过筛选 VNet 中的入站和出站流量来提供软件防火墙。</span><span class="sxs-lookup"><span data-stu-id="47bae-120">NSGs are an optional security layer that provides a software firewall by filtering inbound and outbound traffic on the VNet.</span></span> 

<span data-ttu-id="47bae-121">安全组可以与网络接口 (针对每个主机的规则)、虚拟网络中的子网 (应用于多个资源) 或这两个级别相关联。</span><span class="sxs-lookup"><span data-stu-id="47bae-121">Security groups can be associated to a network interface (for per-host rules), a subnet in the virtual network (to apply to multiple resources), or both levels.</span></span> 

#### <a name="security-group-rules"></a><span data-ttu-id="47bae-122">安全组规则</span><span class="sxs-lookup"><span data-stu-id="47bae-122">Security group rules</span></span>

<span data-ttu-id="47bae-123">NGSs 使用_规则_来允许或拒绝在网络中移动的流量。</span><span class="sxs-lookup"><span data-stu-id="47bae-123">NGSs use _rules_ to allow or deny traffic moving through the network.</span></span> <span data-ttu-id="47bae-124">每个规则标识源地址和目标地址 (或范围)、协议、端口 (或范围)、方向 (入站或出站)、数字优先级以及是否允许或拒绝匹配该规则的流量。</span><span class="sxs-lookup"><span data-stu-id="47bae-124">Each rule identifies the source and destination address (or range), protocol, port (or range), direction (inbound or outbound), a numeric priority, and whether to allow or deny the traffic that matches the rule.</span></span> <span data-ttu-id="47bae-125">下图显示了在子网和网络接口级别应用的 NSG 规则。</span><span class="sxs-lookup"><span data-stu-id="47bae-125">The following illustration shows NSG rules applied at the subnet and network interface levels.</span></span>

![该图显示了两个不同子网中的网络安全组的体系结构。](../media/7-nsg-rules.png)

<span data-ttu-id="47bae-129">每个安全组都有一组默认的安全规则, 以应用上面所述的默认网络规则。</span><span class="sxs-lookup"><span data-stu-id="47bae-129">Each security group has a set of default security rules to apply the default network rules described above.</span></span> <span data-ttu-id="47bae-130">无法修改这些默认规则, 但_可以_将其覆盖。</span><span class="sxs-lookup"><span data-stu-id="47bae-130">These default rules cannot be modified, but _can_ be overridden.</span></span>

#### <a name="how-azure-uses-network-rules"></a><span data-ttu-id="47bae-131">Azure 如何使用网络规则</span><span class="sxs-lookup"><span data-stu-id="47bae-131">How Azure uses network rules</span></span>

<span data-ttu-id="47bae-132">对于入站流量, Azure 将处理与子网关联的安全组, 然后处理应用于网络接口的安全组。</span><span class="sxs-lookup"><span data-stu-id="47bae-132">For inbound traffic, Azure processes the security group associated to the subnet, then the security group applied to the network interface.</span></span> <span data-ttu-id="47bae-133">以相反顺序处理出站通信 (首先是网络接口, 然后是子网)。</span><span class="sxs-lookup"><span data-stu-id="47bae-133">Outbound traffic is processed in the opposite order (the network interface first, followed by the subnet).</span></span>

> [!WARNING]
> <span data-ttu-id="47bae-134">请记住, 安全组在这两个级别都是可选的。</span><span class="sxs-lookup"><span data-stu-id="47bae-134">Keep in mind that security groups are optional at both levels.</span></span> <span data-ttu-id="47bae-135">如果未应用安全组, 则 Azure**允许所有流量**。</span><span class="sxs-lookup"><span data-stu-id="47bae-135">If no security group is applied then **all traffic is allowed** by Azure.</span></span> <span data-ttu-id="47bae-136">如果 VM 具有公用 IP, 则这可能会导致严重风险, 尤其是在操作系统不提供某种防火墙的情况下。</span><span class="sxs-lookup"><span data-stu-id="47bae-136">If the VM has a public IP, this could be a serious risk particularly if the OS doesn't provide some sort of firewall.</span></span>

<span data-ttu-id="47bae-137">这些规则按_优先级顺序_评估, 从**最低优先级**规则开始。</span><span class="sxs-lookup"><span data-stu-id="47bae-137">The rules are evaluated in _priority-order_, starting with the **lowest priority** rule.</span></span> <span data-ttu-id="47bae-138">拒绝规则总是**停止**求值。</span><span class="sxs-lookup"><span data-stu-id="47bae-138">Deny rules always **stop** the evaluation.</span></span> <span data-ttu-id="47bae-139">例如, 如果某个出站请求被网络接口规则阻止, 则任何应用于该子网的规则都不会被检查。</span><span class="sxs-lookup"><span data-stu-id="47bae-139">For example, if an outbound request is blocked by a network interface rule, any rules applied to the subnet will not be checked.</span></span> <span data-ttu-id="47bae-140">若要通过安全组允许通信, 它必须通过_所有_已应用的组。</span><span class="sxs-lookup"><span data-stu-id="47bae-140">In order for traffic to be allowed through the security group, it must pass through _all_ applied groups.</span></span>

<span data-ttu-id="47bae-141">最后一个规则始终是 "**全部拒绝**" 规则。</span><span class="sxs-lookup"><span data-stu-id="47bae-141">The last rule is always a **Deny All** rule.</span></span> <span data-ttu-id="47bae-142">这是添加到优先级为65500的入站和出站通信的每个安全组的默认规则。</span><span class="sxs-lookup"><span data-stu-id="47bae-142">This is a default rule added to every security group for both inbound and outbound traffic with a priority of 65500.</span></span> <span data-ttu-id="47bae-143">这意味着通过安全组的流量_必须具有允许规则,_ 否则将被默认的最终规则阻止。</span><span class="sxs-lookup"><span data-stu-id="47bae-143">That means to have traffic pass through the security group _you must have an allow rule_ or it will be blocked by the default final rule.</span></span>

> [!NOTE]
> <span data-ttu-id="47bae-144">SMTP (端口 25) 是一种特殊情况, 具体情况取决于您的订阅级别和创建帐户时, 可能会阻止出站 SMTP 流量。</span><span class="sxs-lookup"><span data-stu-id="47bae-144">SMTP (port 25) is a special case, depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked.</span></span> <span data-ttu-id="47bae-145">您可以发出请求以删除此限制和业务理由。</span><span class="sxs-lookup"><span data-stu-id="47bae-145">You can make a request to remove this restriction with business justification.</span></span>

<span data-ttu-id="47bae-146">由于我们没有为此 VM 创建安全组, 因此, 请执行此操作并应用它。</span><span class="sxs-lookup"><span data-stu-id="47bae-146">Since we didn't create a security group for this VM, let's do that and apply it.</span></span>

## <a name="creating-network-security-groups"></a><span data-ttu-id="47bae-147">创建网络安全组</span><span class="sxs-lookup"><span data-stu-id="47bae-147">Creating Network Security Groups</span></span>

<span data-ttu-id="47bae-148">安全组是托管资源, 如 azure 中的大多数内容, 您可以在 azure 门户中或通过命令行脚本工具创建它们。</span><span class="sxs-lookup"><span data-stu-id="47bae-148">Security groups are managed resources like most everything in Azure, you can create them in the Azure portal or through command-line scripting tools.</span></span> <span data-ttu-id="47bae-149">困难在于定义规则。</span><span class="sxs-lookup"><span data-stu-id="47bae-149">The challenge is in defining the rules.</span></span> <span data-ttu-id="47bae-150">让我们来看一下如何定义新规则以允许 FTP 访问。</span><span class="sxs-lookup"><span data-stu-id="47bae-150">Let's look at defining a new rule to allow FTP access.</span></span>