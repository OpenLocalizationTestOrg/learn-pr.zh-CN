您的第一步可能是在云中重新创建本地配置。

这一基本配置将让你了解如何配置网络, 以及网络流量在 Azure 中的移动方式。

## <a name="your-e-commerce-site-at-a-glance"></a>你的电子商务网站概览

较大的企业系统通常由多个相互连接的应用程序和可协同工作的服务组成。 您可能有一个显示清单的前端 web 系统, 并允许客户创建订单。 这可能会与各种 web 服务通信, 以提供库存数据、管理用户配置文件、处理信用卡以及请求执行已处理的订单。

软件架构师和设计人员采用几种策略和模式, 使这些复杂系统更易于设计、构建、管理和维护。 让我们来看看其中的几个问题, 从_松散结合的体系结构_开始。

### <a name="benefits-of-loosely-coupled-architectures"></a>松散耦合体系结构的好处

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yHrc]

### <a name="using-an-n-tier-architecture"></a>使用 N 层体系结构

可用于构建松散耦合系统的体系结构模式为_N 层_。

[N 层体系结构](https://docs.microsoft.com/azure/architecture/guide/architecture-styles/n-tier)将应用程序划分为两个或更多个逻辑层。 在体系结构上, 更高的层可以从较低层访问服务, 但较低层不应访问更高的层。

层帮助分离问题, 并理想设计为可重用。 使用分层体系结构还可以简化维护。 层可以独立进行更新或替换, 并且可以根据需要插入新的层。

_三层_指具有三个层的 n 层应用程序。 您的电子商务 web 应用程序遵循以下三层体系结构:

* **web 层**通过浏览器向你的用户提供 web 界面。
* **应用程序层**运行业务逻辑。
* **数据层**包括保存产品信息和客户订单的数据库和其他存储。

下图显示了从用户到数据层的请求流。

![图中显示了三层体系结构, 其中每个层都托管在专用虚拟机中。](../media/2-three-tier.png)

当用户单击按钮来下订单时, 请求将发送到 web 层, 以及用户的地址和付款信息。 web 层将此信息传递到应用程序层, 这将验证付款信息和检查库存。 然后, 应用程序层可能会将订单存储在数据层中, 以便稍后将其用于履单。

## <a name="your-e-commerce-site-running-on-azure"></a>在 Azure 上运行的电子商务网站

Azure 提供了多种不同的方式来托管您的 web 应用程序, 从托管您的代码的完全预配置环境到您配置、自定义和管理的虚拟机。

假设你选择在虚拟机上运行你的电子商务网站。 以下是在 Azure 上运行的测试环境中可能的外观。 下图显示了在启用了安全功能的虚拟机上运行的三层体系结构来限制入站请求。 

![图中显示了三层体系结构, 其中每个层在单独的虚拟机上运行。 每个虚拟机都使用其 IP 地址进行标记, 并且位于其自己的虚拟网络中。 每个虚拟网络都有一个列出打开端口的网络安全组。](../media/2-test-deployment.png)

让我们将其断开。

:::row:::
  :::column:::
    ![代表 Azure 区域的地球上的固定位置](../media/2-azure-region.png)
  :::column-end:::
    :::column span="3":::
**什么是 Azure 区域？**

_区域_是特定地理位置中的 Azure 数据中心。 美国东部、美国西部和北欧是区域的示例。 在此示例中, 您将看到应用程序正在美国东部地区运行。

  :::column-end:::
:::row-end:::
:::row:::
  :::column:::
    ![在虚拟网络上运行的两个虚拟机](../media/2-azure-vnet.png)
  :::column-end:::
    :::column span="3":::
**什么是虚拟网络？**

_虚拟网络_是 Azure 上逻辑隔离的网络。 如果你已在 hyper-v、VMware 甚至其他公共云上设置了网络, 则 Azure 虚拟网络将非常熟悉。 虚拟网络允许 Azure 资源与彼此、internet 和本地网络之间的安全通信。 虚拟网络的范围限定为单个区域;但是, 可以使用虚拟网络对等连接将不同区域中的多个虚拟网络连接在一起。 

可以将虚拟网络分成一个或多_个子网_。 子网可帮助您在不连续的分区中组织和保护资源。 web、应用程序和数据层都有一个虚拟机。 所有三个虚拟机都位于同一个虚拟网络中, 但位于不同的子网中。

用户直接与 web 层交互, 因此虚拟机具有一个公用 ip 地址和一个专用 ip 地址。 用户不会与应用程序或数据层进行交互, 因此, 每个虚拟机都仅具有专用 IP 地址。

您还可以将您的服务或数据层保留在本地网络中, 将您的 web 层放入云中, 但保持对应用程序的其他方面的严格控制。 _VPN 网关_(或虚拟网络网关) 启用此方案。 它可以提供 internet 上的 Azure 虚拟网络和本地位置的安全连接。

Azure 为你管理物理硬件。 通过软件配置虚拟网络和网关, 这使您可以像对待自己的网络那样对待虚拟网络。 您可以选择您的虚拟网络可以连接到的网络, 而不管它是公用 internet 还是专用 IP 地址空间中的其他网络。

  :::column-end:::
:::row-end:::
:::row:::
  :::column:::
    ![具有共享网络安全组的两台虚拟机](../media/2-azure-nsg.png)
  :::column-end:::
    :::column span="3":::
**什么是网络安全组？**

_网络安全组_(或 NSG) 允许或拒绝到 Azure 资源的入站网络流量。 将网络安全组视为网络的云级防火墙。

例如, 请注意, web 层中的 VM 允许端口 22 (SSH) 和 80 (HTTP) 上的入站流量。 此 VM 的网络安全组允许来自所有源的来自这些端口的入站流量。 可以将网络安全组配置为仅接受来自已知源 (如您信任的 IP 地址) 的通信。

> [!NOTE]
> 端口22使你能够通过 SSH 直接连接到 Linux 系统。 此处显示了端口22打开以供学习之用。 在实践中, 您可以配置对虚拟网络的 VPN 访问以提高安全性。

  :::column-end:::
:::row-end:::

## <a name="summary"></a>摘要

现在, 你的三层应用程序在美国东部地区的 Azure 上运行。 _区域_是特定地理位置中的 Azure 数据中心。

每个层只能从较低层访问服务。 在 web 层中运行的虚拟机具有公共 IP 地址, 因为它接收来自 internet 的流量。 较低层 (即应用程序和数据层) 中的 vm 都具有专用 IP 地址, 因为它们不会直接通过 internet 进行通信。

_虚拟网络_使您能够对相关系统进行分组和隔离。 您可以定义_网络安全组_, 以控制哪些流量可以通过虚拟网络流动。

您在此处看到的配置是一个很棒的开端。 但是, 当您将电子商务网站部署到云中的生产环境中时, 可能会遇到与您在本地部署中所做的相同问题。    