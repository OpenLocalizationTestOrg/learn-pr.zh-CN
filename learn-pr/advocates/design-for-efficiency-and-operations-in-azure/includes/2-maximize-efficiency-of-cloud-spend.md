您是解决方案架构师。 您的组织, Lamna 医疗保健已将其工作负荷转移到云。 最近, 这些资源和工作流的帐单的增长超过了 Lamna 的预期。 您已被要求确定是自然增长、高效增长, 还是可以通过更高效地使用组织的云资源来降低成本。

#### <a name="maximize-efficiency-of-cloud-spend"></a>最大限度地提高云支出的效率

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RWjTgy]

## <a name="how-the-cloud-changes-your-expenses"></a>云如何更改你的支出

公共云和本地基础结构之间的差异之一是您为所使用的服务付费的费用。 在本地数据中心内, 硬件采购时间很长, 将调整硬件大小以实现最大容量, 并且可以从消耗资源的业务单元中隐藏某些成本 (如电源和空间)。 购买物理基础结构将投资与长期资产结合在一起, 从而使您能够灵活地处理您的资源。

切换到云时, 会引入按使用付费的成本模型。 您不再需要占用资产的投资, 如果资源要求发生变化, 则可以通过添加、移动或删除资源来做出响应。 工作负载在服务之间有所不同, 需求可能是不可预测的, 并且随着时间的推移, 增长模式也会发生变化。 由于您只是为在云中使用而付费, 因此您的成本结构可以与资源中的更改进行同步。

云基础结构可以处理波动资源使用情况。 在不使用的情况下, 可以关闭处于不活动状态的资源, 而不会产生任何成本。 资源在增长时可以随着成功的服务增长, 而无需等待下一个采购周期。 可以动态添加和删除更多资源, 以响应可预测和不可预知的突发要求。 下图显示了为什么本地基础结构无法处理所有这些波动方案。

![展示了使用本地基础结构的缺点的图示。](../media/cloudcomputingpatterns.png)

在有效的体系结构中, 预配的资源符合对这些资源的需求。 如果虚拟机的大部分时间使用不到 10%, 则需要在计算和成本方面浪费资源。 相反, 运行 90% 的虚拟机使用的是大部分可用资源, 并且是有效使用资金的一种。 将系统运行到 100% 的使用率会给出性能问题带来的风险。 确保最大化效率不会对系统性能产生负面影响, 这一点非常重要。 Demand 很少变, 因此尽可能调整资源以满足需求是确保效率的重要。

## <a name="track-your-cloud-spend"></a>跟踪你的云花费

为了做出明智的决策, 您需要数据。 通过查看你的资金的发展位置, 你可以开始比较, 以揭示在你的环境中可能浪费的位置。

你的帐单数据的导出随时可用。 使用您的帐单数据, 您可以跟踪开销的位置以及在您的资源中分配这些数据的方式。 困难在于帐单数据显示成本而不是使用率。 你将拥有表明你为该大型 VM 付费的数据, 但你实际使用的是多少？

Azure 成本管理让你能够深入了解你的支出以及已充分利用的资源。 Azure 成本管理跟踪每个服务的总花费、成本和成本随时间推移。 您可以深入到资源类型和实例。 您还可以通过使用这些类别对资源进行标记来分解组织或成本中心的成本。

Azure Advisor 也具有成本组件。 它建议在成本较低时购买保留实例, 而不是随即付即用实例。 它标识未使用的 ExpressRoute 电路和空闲的虚拟网络网关。 Advisor 在性能、高可用性和安全性方面提出了更多建议。

重要的部分是花时间查看你的花费并评估你的金钱的发展方向。 确定效率低下的部分, 以确保您尽可能高效地运行。

## <a name="organize-to-optimize"></a>进行组织以优化

将一些组织放到你的资源中可帮助跟踪你的一些成本的发展。 有多种方法可以将资源组合在一起, 从而建立关系, 以便您知道成本的相关位置。 从记帐的角度来看, 可以轻松地对资源进行分组:

- 将资源分配给不同的订阅。
- 将资源分配给不同的资源组。
- 对资源应用标记。

使用订阅和资源组来组织资源是对资源进行逻辑分组的简单方法, 可在执行帐单数据时进行利用。 当资源关系跨越订阅和资源组的边界时, 标记将进入播放。 标记是可添加到任何资源并在记帐数据中公开的键/值对, 使您可以将部门或成本中心与您的资源相关联。 标记可提高您的成本报告能力, 并为组织中的每个部门提供自己的成本。 下图显示了如何将相同的标记应用于不同资源组中的资源, 甚至可以在不同的订阅中应用。

![显示使用标记、资源组和订阅组织的资源的插图。](../media/tagging.png)

将一些组织添加到你的资源可能会很长, 并且可以真正帮助你了解成本的进展情况。 现在, 我们来看看一些优化成本的方法。

## <a name="optimizing-iaas-costs"></a>优化 IaaS 成本

在将基础结构作为服务 (VM) 等资源 (作为解决方案的一部分) 使用时, 与虚拟机相关的成本通常是花费的最大一部分。 计算成本通常是最大的一段, 后跟存储。 花费时间来优化使用情况的资源可能会对您的月度帐单的规模产生很大影响。

让我们来看看可降低您的计算和存储成本的最佳做法。

### <a name="compute"></a>计算

有几种不同的选项可用于实现虚拟机的成本节约。

- 选择一个较小的虚拟机实例大小。
- 减少虚拟机运行的小时数。
- 对计算成本使用折扣。

#### <a name="right-size-virtual-machines"></a>正确大小虚拟机

正确调整虚拟机的大小是将虚拟机大小与 VM 所需的资源需求相匹配的过程。 如果 vm 运行的是 25% 空闲, 则减小 vm 的大小将会立即降低成本。 虚拟机的成本在实例系列中是线性的;下一个较大的大小将使您的成本加倍。 反之, 将 VM 减少为单个实例大小会降低一半的成本。 下图显示了通过在同一个系列中向下移动一个大小而实现的 50% 的节省。

![说明如何通过 downsizing 未充分利用的虚拟机来实现节省的成本。](../media/vm-resize.png)

Azure Advisor 可识别哪些虚拟机未充分利用。 Advisor 将虚拟机使用率监视14天, 然后识别未充分利用的虚拟机。 CPU 利用率为 5% 或更低且网络使用率为 7 MB 或更少的虚拟机被视为使用不足的虚拟机。

#### <a name="implement-shutdown-schedules-for-virtual-machines"></a>为虚拟机实施关闭计划

如果您有仅定期使用但连续运行的 VM 工作负载, 则会浪费资金。 这些 vm 可在不使用时关闭保存 vm 时计算成本。 例如, 开发环境是一个很好的候选方案, 因为开发通常只在工作时间发生。

有几个选项可用于取消分配 VM。 您可以使用 Azure 自动化仅在工作负荷需要的时间段内运行虚拟机。 您可以在虚拟机上使用自动关闭功能安排一次性自动关闭。 最后, 您可以在 Azure 门户中手动停止 VM。 应始终使用 Azure 控件停止 vm;从 VM 中关闭 OS 不会取消分配其 Azure 资源, 因此您将继续累计成本。

#### <a name="apply-compute-cost-discounts"></a>应用计算成本折扣

通过允许你将本地 Windows server 或 sql server 许可证与软件保障结合使用, 以在对这些 vm 的计算成本进行折扣时使用 Azure 混合优势, 可以进一步优化 Windows server 和 sql server 的成本, 从而消除了 Windows 和 SQL Server 在启用的实例上的成本。

某些虚拟机需要随时启动并运行。 可能有一个用于生产工作负荷的 web 应用程序服务器场, 也可能有一个支持虚拟网络上的各种服务器的域控制器。 如果你知道这些虚拟机将在未来一年或更长时间内运行, 则可以通过购买保留实例来获得更多的成本节约。 Azure 保留的虚拟机实例可购买一年或三年的计算能力, 每个折扣与按即点即用计算资源相比。 Azure 保留的虚拟机实例可显著降低虚拟机的成本, 最高可达 72% 的即付即用价格, 为期一年或三年的提前承诺。 下图显示了将本地许可证与 azure 混合优势结合使用时以及将本地许可证与 azure RI 和 azure 混合优势结合使用时实现的节省。

![该图显示了在使用具有软件保证的本地许可证时, 在 Azure 产品上节省的成本。](../media/ahub-save.png)

### <a name="virtual-machine-disk-storage-cost-optimization"></a>虚拟机磁盘存储成本优化

对于不需要高可靠性和性能磁盘的工作负荷, 可以使用成本低廉的标准存储。 您可以选择对开发和测试环境使用标准存储, 而无需与生产工作负载完全相同。

确保您的环境中没有剩余的孤立磁盘。 与 VM 不关联的磁盘仍会导致存储成本。 如果已删除虚拟机而不是磁盘, 则可以使用孤立磁盘来降低存储成本。

类似于孤立的磁盘, 如果你有任何孤立的快照延迟, 请花些时间清理这些快照。 这些资源的定价低于磁盘本身, 但仍为消除不必要的资源成本的最佳做法。

## <a name="optimizing-paas-costs"></a>优化 PaaS 成本

平台即服务 (PaaS) 服务通常针对 IaaS 服务的成本进行优化, 但有机会确定浪费并优化为最低成本。 让我们来看看降低 azure SQL 数据库和 azure Blob 存储成本的方法。

### <a name="optimizing-azure-sql-database-costs"></a>优化 Azure SQL 数据库成本

创建 azure sql 数据库时, 必须选择 azure sql Server 并决定性能层。 每个层都提供数据库事务单元 (dtu) 或虚拟核心 (vCores) 中的性能级别。 对于稳定的数据库负载, 可以通过选择适当的级别来实现所需的性能来优化。 但如果您的数据库在活动中有不可预测的突发或峰值, 该怎么办？ 弹性池可以降低不可预测工作负载的成本。

SQL 数据库弹性池是一个简单且经济高效的解决方案, 用于管理和扩展多个具有不同且不可预测的使用要求的数据库。 弹性池中的数据库位于单个 Azure SQL 数据库服务器上, 并按设置的价格共享一组资源数。 池非常适合于具有特定使用率模式的大量数据库。 对于给定数据库, 此模式的特征是低平均利用率, 使用率峰值相对较少。
可以添加到池的数据库越多, 节省的空间就越多。 下图显示了三种类型的弹性数据库池的功能: basic、standard 和 premium。  基本自动扩展能力高达5个 eDTUs 每个 db, 标准自动扩展到每个数据库100个 eDTUs, 并可自动扩展到每个数据库的 1000 eDTUs。

![该图显示了不同类型弹性数据库池的自动扩展容量。](../media/sqldb-elastic-pools.png)

弹性池是跨多个数据库扩展成本的一种极好的方法, 它会对减少 Azure SQL 数据库成本产生重大影响。

### <a name="optimizing-blob-storage-costs"></a>优化 Blob 存储成本

Blob 存储是存储数据的一种经济高效的方法, 但是随着数据量的增加, 您的帐单可以从优化数据存储方式中受益。

让我们回到 Lamna 保健。 您有一个在 blob 存储中存储图像的医学图像应用程序。 由于图像的数量和大小, 存储最终将成为应用程序的显著成本。 如果为患者拍摄了图像, 则在第一周中可能会多次查看该图像, 并且图像检索的性能预计较高。 相反, 在两年前拍摄的图像可能很少访问, 并且检索性能的预期较低。 您可以使用存储分层来优化图像检索的成本, 假定图像老化所需的性能降低。

Azure 存储为 blob 对象存储提供了三个存储层。 Azure 热存储层针对存储经常访问的数据进行了优化。 Azure 酷存储层已优化为存储在至少30天内不经常访问和存储的数据。 Azure 存档存储层已经过优化, 可用于存储在至少180天内少使用和存储的数据以及灵活的延迟要求。

- "**快速访问" 层**-最高存储成本, 但访问成本最低。
- **冷却访问层**-与热存储相比, 降低了存储成本和更高的访问成本。 此层适用于将在很少30天内保留在酷层中的数据。
- **存档访问层**-与热和酷存储相比, 最低的存储成本和最高的数据检索成本。 此层适用于可容许几个小时的检索延迟的数据, 并将在存档层中持续至少180天。

对于 Lamna 保健, 将新图像保留在即时访问层上是有意义的, 以便查看最新的图像的速度尽可能快。 然后, 您可以将图像在一年前移动到存档层, 因为这可能会导致无法检索这些图像。 这将降低与存储这些图像相关的成本。

### <a name="leverage-consumption-pricing-models"></a>利用消费定价模型

移动到 PaaS 服务还可以采用 "即点即用" 模式, 甚至可以将其作为真正的消费定价模型。 Azure 函数等服务能够使用_消耗计划_。 使用消耗计划时, 将根据传入事件数动态添加和删除 Azure 函数主机的实例。 此无服务器计划将自动扩展, 并且您仅在运行您的功能时才对计算资源收取费用。 在消耗计划中, 函数执行将在可配置的一段时间后超时。

计费基于执行次数、执行时间和使用的内存。 在函数应用程序内的所有函数中聚合记帐。

移动到使用消费定价模型的服务后, 可以采用新方法在体系结构中节省成本。

## <a name="cost-optimization-at-lamna-healthcare"></a>Lamna 保健中的成本优化

Lamna 医疗保健在降低成本方面取得了努力。 他们按月对成本进行组织, 每个部门都有权访问 Azure 成本管理, 在这种管理中, 他们可以在每个月中查看其成本。 他们已确定可使用保留实例的多个位置, 并已购买多个位置以利用此折扣。 他们已实施自动化的过程以在非工作时间停止开发环境, 并在未使用这些资源的时间内节省额外成本。 

除了为映像存储优化 blob 存储外, 它们还在过去几个月内被管理, 以丢弃其记帐的特别数。

## <a name="summary"></a>摘要

优化云基础结构的成本涉及到跟踪你的花费并确保资源利用率符合工作负载的需求。 对你的资源使用正确的质量和性能层可以进一步优化你的云花费。
