监控是收集和分析数据以确定业务应用程序的性能、运行状况和可用性以及它所依赖的资源的操作。 如果你运行的操作团队负责在 Azure 上运行的资源, 该怎么办？ 你应采取什么操作来确保你的系统的运行状况可见？ 如果发生了什么情况, 谁会发现您的团队或最终用户？ 有效的监控策略可帮助您将重点放在应用程序的运行状况上。 它还可帮助您通过主动向您发出严重问题的通知来增加正常运行时间, 以便您可以在问题变得问题之前解决这些问题。 

在 Azure 上进行监控和分析时, 我们可以将服务捆绑到以下三个特定领域: 深层应用监视、深入基础结构监视和核心监控。 在此单元中, 我们将深入了解每个捆绑包以及 Azure 服务如何为你的体系结构启用这些功能。 尽管我们已将这些服务组合在一起, 但它们之间有多个集成点, 允许在它们之间共享重要的监控数据点。 下图显示了已组合到逻辑组中的可用监视服务。

![列出了 Azure 监视和分析服务的说明。](../media/monitoring-products-overview.png)

## <a name="core-monitoring"></a>核心监控

核心监控提供了跨 Azure 资源的基本、必需的监控。 当我们谈论基本监控时, 您可以将其视为监视 Azure 平台级别的资源所发生的情况。 此焦点区域使您可以深入了解 Azure 平台的运行状况、对资源所做更改的见解以及性能指标。 使用此区域中的服务使您能够监视需要保持应用程序运行的基本部分。

Azure 提供了服务, 使您可以深入了解四个关键的核心监视领域: 活动日志记录、服务的运行状况、指标和诊断以及最佳实践建议。 这些服务内置于 Azure 中, 几乎不需要启用和设置配置。 让我们进一步了解一下。

### <a name="activity-logging"></a>活动日志记录

活动日志记录对于获取有关在 Azure 平台级别的资源所发生情况的信息极为重要。 提交到 azure 平台的每项更改都将记录到 azure 活动日志中, 从而能够跟踪对资源执行的任何操作。 活动日志将包含活动的详细信息, 以帮助您解答类似的问题:

- 谁已将磁盘附加到此虚拟机？
- 何时关闭此计算机？
- 谁更改了负载平衡器配置？
- 为什么我的虚拟机规模设置的自动缩放操作失败？

使用活动日志回答这些类型的问题将帮助您解决问题、跟踪更改, 并提供对 Azure 环境中发生的操作的审核。 活动日志数据仅在90天内保留, 并且可以存档到存储帐户或发送到 Azure 日志分析, 以便进行更长的保留和进一步分析。

### <a name="health-of-cloud-services"></a>云服务的运行状况

在某些情况下, 任何系统都可能存在问题, 并且也适用于 Azure 服务。 及时了解 azure 服务的运行状况, 可帮助你了解影响 azure 服务的问题是否会影响你的环境。 看起来好像已本地化的问题可能是一个更广泛的问题的结果, 而 Azure 服务运行状况提供了这种洞察力。 azure 服务运行状况确定可能会影响应用程序的 azure 服务的任何问题。 服务运行状况还有助于规划计划的维护。

### <a name="metrics-and-diagnostics"></a>指标和诊断

对于本质上更具本地化的问题, 请务必了解系统或服务实例上发生的情况。 查看指标和诊断信息的能力是解决性能问题并在出现问题时保持通知的关键。 为了提供此可见性, Azure 服务有一种显示运行状况、指标或诊断信息的常用方法。 azure Monitor 允许对指标、活动日志和诊断日志进行收集、聚合和可视化, 从而为 azure 服务启用核心监控。

提供的指标可提供针对不同资源甚至虚拟机中的操作系统的性能统计信息。 您可以使用 Azure 门户中的一个资源管理器查看此数据, 并根据这些指标创建警报。 Azure Monitor 提供最快的指标管道 (5 分钟到1分钟), 因此应将其用于时间严重的警报和通知。

### <a name="recommendations-on-best-practices"></a>有关最佳实践的建议

当我们考虑监控时, 我们通常会考虑资源的当前运行状况。 但是, 即使某个资源正常运行, 也可能会有一些调整, 从而导致更高的可用性、成本降低或更好地提高安全性。 Azure Advisor 可帮助你了解资源中的潜在性能、成本、高可用性或安全问题。 Advisor 根据资源配置和遥测制定个性化建议, 提供大多数传统监控平台不提供的指导。

## <a name="deep-infrastructure-monitoring"></a>深入的基础结构监控

到目前为止, 我们介绍的监控组件在提供见解方面非常强大, 它们仅提供对 Azure 平台的可见性。 对于典型的 IaaS 工作负载, 需要从网络或实际操作系统中收集更多指标和诊断信息。 从 SQL Server 中提取信息, 以确保它已正确配置、分析环境中的所有服务器上的可用磁盘空间, 或者使系统和服务之间的网络依赖项可视化, 这是日志分析可以在其中进行的所有示例提供深入见解。

在设计监视策略时, 一定要在应用程序链中包含每个组件, 以便可以跨服务和资源关联事件。 对于支持 Azure 监视器的服务, 可以轻松地将其配置为将其数据发送到 Log Analytics 工作区。 虚拟机 (在云中和内部部署中) 可以安装代理以将数据发送到日志分析。 您可以通过 log analytics API 将自定义数据提交到 log analytics。 下图显示了 Log Analytics 如何充当监视数据的中心中心。 日志分析接收来自 Azure 资源的监视数据, 并使其可供使用者进行分析或可视化。

![显示资源监控中的日志分析角色的插图。](../media/collecting-data.png)

使用 Log Analytics 中的此数据, 可以查询用于故障排除、根本原因识别和审核目的的原始数据。 对于几个已知的服务 (SQL Server, Windows Server Active Directory), 有一些管理解决方案随时可用来可视化监控数据并发现最佳做法符合性。

日志分析允许您创建查询并与基于这些查询的其他系统进行交互。 最常见的示例是一个警告。 可能需要在系统磁盘空间不足或 SQL Server 上的最佳实践已不再遵循时接收电子邮件。 日志分析可以发送警报、启动自动化功能, 甚至可以在集成与 IT 服务管理 (ITSM) 的情况下将其挂接到自定义 api 中。

## <a name="deep-application-monitoring"></a>深入的应用程序监视

了解核心服务和基础结构的执行方式非常重要, 但你可以深入了解你的应用程序以确定性能问题、使用趋势和总体可用性, 从而进一步提高你的监控功能您开发和依赖的服务。 通过使用应用程序性能管理工具, 可以更好地检测和诊断 web 应用程序和服务中发生的问题。

Azure Application Insights 使你能够完全做到这一点。 Application Insights 提供遥测集合、查询和可视化功能。 几乎不需要更改代码。 您只需将小型规范包安装到应用程序中。 application Insights 是跨平台, 支持 .net、node.js 或 Java。

例如, 应用程序的响应时间可能很复杂, 无法进行故障排除。 是 web 服务器正在过载吗？ 它是否是未优化的特定 SQL 查询？ 您要调用的 API 速度比平时慢吗？ 应用程序性能监视解决方案可帮助揭示基本指标监视无法公开的实际问题。 下面的屏幕截图显示了由 Azure application Insights 提供的应用程序的性能详细信息的图形化显示。

![Azure Application Insights 的用户界面的屏幕截图。](../media/perfmetrics.png)

应用程序性能监视解决方案可帮助您监视使用情况、性能和可用性, 使您能够更快地响应故障, 并且应包括在任何监控策略中。

## <a name="monitoring-at-lamna-healthcare"></a>在 Lamna 医疗保健中进行监控

Lamna 医疗保健已 revamping 其监视策略, 因为它将其资源移动到云。 在性能问题可能影响其资源时, 他们使用监视器进行故障排除和警报。 他们将通知配置为将任何服务运行状况通知发送到其运营团队以立即参与。 他们有一个定期查看 Advisor 的过程, 以确保在适用的环境中实施建议。 

它们将日志数据从所有 Azure 和本地资源发送到 log Analytics 工作区, 以便能够跨日志源搜索事件关联并使用 Windows Server Active Directory 和 SQL Server 的管理解决方案。

他们的开发团队已开始将 application Insights 集成到其应用程序中, 并且它们已发现影响以前未检测到的性能的两个缺陷。

## <a name="summary"></a>摘要

在体系结构的多个层中, 从支持基础结构到深入的应用程序遥测, 这是一种优质的监视策略。 它将帮助您了解应用程序的不同组件的详细操作。 它通过主动向您发出严重问题通知, 使您可以在出现问题之前解决问题, 并允许您在系统中关联日志和遥测, 以发现问题, 从而增加正常运行时间。 我们在 Azure 上查看了大量可在监视策略中利用的服务。