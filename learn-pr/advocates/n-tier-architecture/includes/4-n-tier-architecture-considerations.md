我们查看了组成 N 层体系结构的内容, 并部署了三层体系结构的示例。 让我们来了解这种体系结构样式的优势和挑战, 以及最佳做法以优化性能和安全性。

## <a name="benefits"></a>效益

这种体系结构样式在简单方面非常有用。 它通常用于内部部署和云部署, 并可与各种应用程序一起使用, 这两种体系结构模式通常都是使用和定义完善的。

它是一个平台不可知的体系结构, 并适合在 Windows 或 Linux 上部署的应用程序。 如我们在示例环境中演示的那样, 可以在任何层使用 PaaS 或 IaaS 服务。

将应用程序分成分层后, 可以单独对每个层进行扩展、更新或升级。 如果对网站的请求增加了, 我们可以将更多的 web 服务器添加到负载中, 而不会影响其他层。 同样, 如果对数据层的请求增加了, 我们可以扩展数据库以获得更多的容量来处理请求。

网络分离是此体系结构的自然 byproduct。 由于应用程序分到了各个层中, 因此应隔离每个层并仅允许所需的网络访问。 可以向 internet 公开表示层, 数据库可在多个网络层中完全保护, 并且应用程序的功能完全相同。 通过保护各层之间的网络访问, 我们减少了应用程序的攻击面并提高了安全性。

## <a name="challenges-and-considerations"></a>挑战和注意事项

当您将应用程序分成多个层时, 应避免仅执行数据库操作的中间层。 每个层应添加特定值。 其他分层增加了对最终用户的复杂性、处理时间、延迟和最终延迟。

由于每个应用程序级域的 api 不会分成单独的服务, 因此必须将它们一起扩展。 如果单个应用程序方法需要更多的处理能力或需要处理多于其他请求的请求, 则应用层必须整体扩展以处理负载, 而不是单个服务。

在某些情况下, 您可能会将应用程序开发为 N 层体系结构, 但仍以 monolith 的形式进行部署。 通过完全分离每个层, 应分别部署每个层。 这涉及到删除共享依赖项, 并更多地依赖层之间的 API 调用。 在正确完成后, 这可确保应用程序部署的灵活性。

N 层体系结构中的应用程序通常会在虚拟机上进行部署。 这是一个很棒的第一步, 但如果要将应用程序发展为使用 PaaS 服务, 在安全性、可伸缩性和管理方面提供了诸多好处。 通常情况下, 这种演变是被忽略的, 而 N 层体系结构仍保留在虚拟机上。

这是一种经典体系结构样式, 但在许多情况下, 它已被其他新式设计模式 (如 microservices 体系结构) 取代。 通常值得花些时间来评估其他体系结构, 以查看它们是否更适合您的应用程序。

## <a name="best-practices-for-n-tier-architectures"></a>适用于 N 层体系结构的最佳做法

您应该执行几项操作, 以确保您的 N 层体系结构运行得最佳。 下图显示了如何对 N 层体系结构进行改进的可视化方式。

![N 层体系结构的可视化](../media/4-n-tier-logical.svg)

### <a name="optimize-performance"></a>优化性能

让我们来看一下优化 N 层体系结构以提高性能和安全性的方法。

#### <a name="autoscaling"></a>缩放

通过将应用程序分成多级, 我们可以使用云功能 (如自动缩放) 适应系统负载。 随着用户或请求的增加, 可在多个层使用自动缩放以添加更多资源来处理请求。 当请求丢弃时, 自动缩放会减少计算资源, 同时减少您的帐单。 自动缩放使您能够轻松地确保您的用户获得最佳体验, 并且您的成本仍保持较低的水平。 azure VM 规模集可用于基于 VM 的工作负载, 而许多 PaaS 服务 (如 Azure App Service) 都具有内置的自动缩放功能。

#### <a name="load-balancing"></a>负载平衡

在使用自动缩放扩展应用程序时, 使用负载平衡成为体系结构的必要部分。 通过负载平衡, 在将更多的计算资源添加到层时, 它们将被添加到您的负载平衡器分发中, 以充分利用额外的处理能力。 相反, 当系统出现故障时, 会将其从负载中删除, 以通过较差的性能或 erred 请求来最大限度地减少对最终用户的影响。 这可确保用户请求进入正常状态的系统。 Azure 负载平衡器是网络功能的内置功能, 应用程序网关提供了功能更丰富的 HTTP 负载平衡解决方案。

#### <a name="messaging"></a>讯息

在层之间使用消息服务会对性能产生积极影响, 尤其是在自然为异步请求。 将在队列中放置一条消息, 在该队列中, 它将一直保留, 直到被处理为止, 从而抵消下游负载的影响。 这还可以确保在发生系统中断时, 仍将处理您的邮件。 它将保留在队列中, 并将在系统重新联机后处理。 Azure 有多个邮件解决方案可供选择, 具体取决于您的要求。 在查找邮件服务时, 可以查看 azure 服务总线、azure 存储队列和 azure 事件中心。

#### <a name="caching-data"></a>缓存数据

对频繁访问且具有较低更改速率的数据使用缓存, 或者对不需要长期持久性的数据 (如会话状态) 使用缓存。 缓存系统在各层之间等待, 并减少这些数据类型的数据检索时间。 适用于 Redis 的 Azure 缓存是一种非常适合此方案的 PaaS 服务。

### <a name="optimize-security"></a>优化安全性

在针对安全性进行优化时, 这通常是一个永远不会 "完成" 的作业。 尽管应用程序分到了各个层中, 但仍必须在体系结构中具有良好计划的安全做法。 添加的层越多, 您需要保护的信息越多, 系统中引入的复杂性也越多。 您应该执行几项操作, 以确保体系结构提供了运行应用程序的安全环境。

#### <a name="network-isolation"></a>网络隔离

确保在虚拟机上运行 N 层体系结构时, 每个层都位于自己的子网中。 此子网充当安全边界, 使您可以通过网络访问控制列表隔离连接, 但通过确保子网中的新系统接收相同的规则来实现简化管理。 在 Azure 上, 这是通过网络安全组 (NSG) 本身完成的。 应针对 PaaS 服务进行类似的考虑, 但网络集成功能在服务之间有所不同, 应自行评估。 最佳做法是确保每个层只能与它下面的下一层进行通信。 演示层应仅能够与应用层对话, 并且应用层应只能与数据层对话。 最小化此连接可提供分层的网络安全方法, 并提高体系结构的总体安全状态。

#### <a name="web-application-firewall"></a>Web 应用程序防火墙

在就地子网之间进行安全隔离时, 您需要确保公开公开的前端是安全的, 并且只允许访问所需的内容。 只有你的演示文稿层应公开到入站 internet 流量, 且你的演示层前面的 web 应用程序防火墙 (WAF) 技术将增强此层的安全性。 WAFs 检查流量以查找恶意活动, 确保对通信进行加密, 并在某些内容不正常时向您发出警报。 在 Azure 上, 应用程序网关是一个包含可启用的内置 WAF 的 HTTP 负载平衡器。