<span data-ttu-id="5aa22-101">我们查看了组成 N 层体系结构的内容, 并部署了三层体系结构的示例。</span><span class="sxs-lookup"><span data-stu-id="5aa22-101">We've looked at what makes up an N-tier architecture and we've deployed an example of a three-tier architecture.</span></span> <span data-ttu-id="5aa22-102">让我们来了解这种体系结构样式的优势和挑战, 以及最佳做法以优化性能和安全性。</span><span class="sxs-lookup"><span data-stu-id="5aa22-102">Let's explore some of the benefits and challenges of this architectural style, and best practices to optimize it for performance and security.</span></span>

## <a name="benefits"></a><span data-ttu-id="5aa22-103">效益</span><span class="sxs-lookup"><span data-stu-id="5aa22-103">Benefits</span></span>

<span data-ttu-id="5aa22-104">这种体系结构样式在简单方面非常有用。</span><span class="sxs-lookup"><span data-stu-id="5aa22-104">This style of architecture is beneficial in its simplicity.</span></span> <span data-ttu-id="5aa22-105">它通常用于内部部署和云部署, 并可与各种应用程序一起使用, 这两种体系结构模式通常都是使用和定义完善的。</span><span class="sxs-lookup"><span data-stu-id="5aa22-105">It's an often used and well-defined architectural pattern, both for on-premises and cloud deployments, and can work with a wide range of applications.</span></span>

<span data-ttu-id="5aa22-106">它是一个平台不可知的体系结构, 并适合在 Windows 或 Linux 上部署的应用程序。</span><span class="sxs-lookup"><span data-stu-id="5aa22-106">It's a platform-agnostic architecture, and fits applications deployed on Windows or Linux.</span></span> <span data-ttu-id="5aa22-107">如我们在示例环境中演示的那样, 可以在任何层使用 PaaS 或 IaaS 服务。</span><span class="sxs-lookup"><span data-stu-id="5aa22-107">As we showed in our example environment, PaaS or IaaS services can be used at any tier.</span></span>

<span data-ttu-id="5aa22-108">将应用程序分成分层后, 可以单独对每个层进行扩展、更新或升级。</span><span class="sxs-lookup"><span data-stu-id="5aa22-108">With the application separated into tiers, each tier can be scaled, updated, or upgraded independently.</span></span> <span data-ttu-id="5aa22-109">如果对网站的请求增加了, 我们可以将更多的 web 服务器添加到负载中, 而不会影响其他层。</span><span class="sxs-lookup"><span data-stu-id="5aa22-109">If requests for our web site increase, we can add more web servers to the load without impacting the other tiers.</span></span> <span data-ttu-id="5aa22-110">同样, 如果对数据层的请求增加了, 我们可以扩展数据库以获得更多的容量来处理请求。</span><span class="sxs-lookup"><span data-stu-id="5aa22-110">Similarly, if requests against our data tier increase, we can scale our database to have more capacity to handle the requests.</span></span>

<span data-ttu-id="5aa22-111">网络分离是此体系结构的自然 byproduct。</span><span class="sxs-lookup"><span data-stu-id="5aa22-111">Network separation is a natural byproduct of this architecture.</span></span> <span data-ttu-id="5aa22-112">由于应用程序分到了各个层中, 因此应隔离每个层并仅允许所需的网络访问。</span><span class="sxs-lookup"><span data-stu-id="5aa22-112">Since the application is separated into tiers, we should isolate each tier and only allow necessary network access.</span></span> <span data-ttu-id="5aa22-113">可以向 internet 公开表示层, 数据库可在多个网络层中完全保护, 并且应用程序的功能完全相同。</span><span class="sxs-lookup"><span data-stu-id="5aa22-113">The presentation tier can be exposed to the internet, the database can be fully secured behind multiple network tiers, and our application functions just the same.</span></span> <span data-ttu-id="5aa22-114">通过保护各层之间的网络访问, 我们减少了应用程序的攻击面并提高了安全性。</span><span class="sxs-lookup"><span data-stu-id="5aa22-114">By securing network access between tiers, we reduce the attack surface of the application and increase its security.</span></span>

## <a name="challenges-and-considerations"></a><span data-ttu-id="5aa22-115">挑战和注意事项</span><span class="sxs-lookup"><span data-stu-id="5aa22-115">Challenges and considerations</span></span>

<span data-ttu-id="5aa22-116">当您将应用程序分成多个层时, 应避免仅执行数据库操作的中间层。</span><span class="sxs-lookup"><span data-stu-id="5aa22-116">As you separate your application into multiple tiers, avoid middle tiers that only perform database operations.</span></span> <span data-ttu-id="5aa22-117">每个层应添加特定值。</span><span class="sxs-lookup"><span data-stu-id="5aa22-117">Each tier should add specific value.</span></span> <span data-ttu-id="5aa22-118">其他分层增加了对最终用户的复杂性、处理时间、延迟和最终延迟。</span><span class="sxs-lookup"><span data-stu-id="5aa22-118">Additional tiers add complexity, processing time, latency, and ultimately delay to the end user.</span></span>

<span data-ttu-id="5aa22-119">由于每个应用程序级域的 api 不会分成单独的服务, 因此必须将它们一起扩展。</span><span class="sxs-lookup"><span data-stu-id="5aa22-119">Since the APIs for each application-level domain are not separated into individual services, they must be scaled together.</span></span> <span data-ttu-id="5aa22-120">如果单个应用程序方法需要更多的处理能力或需要处理多于其他请求的请求, 则应用层必须整体扩展以处理负载, 而不是单个服务。</span><span class="sxs-lookup"><span data-stu-id="5aa22-120">If a single application method requires more processing power or needs to handle more requests than others, the application tier must be scaled out as a whole to handle the load, instead of an individual service.</span></span>

<span data-ttu-id="5aa22-121">在某些情况下, 您可能会将应用程序开发为 N 层体系结构, 但仍以 monolith 的形式进行部署。</span><span class="sxs-lookup"><span data-stu-id="5aa22-121">In some cases, you might develop an application as an N-tier architecture, but still do deployments as a monolith.</span></span> <span data-ttu-id="5aa22-122">通过完全分离每个层, 应分别部署每个层。</span><span class="sxs-lookup"><span data-stu-id="5aa22-122">By fully separating out each tier, you should deploy each independently.</span></span> <span data-ttu-id="5aa22-123">这涉及到删除共享依赖项, 并更多地依赖层之间的 API 调用。</span><span class="sxs-lookup"><span data-stu-id="5aa22-123">This involves the removal of shared dependencies, and a greater reliance on API calls between tiers.</span></span> <span data-ttu-id="5aa22-124">在正确完成后, 这可确保应用程序部署的灵活性。</span><span class="sxs-lookup"><span data-stu-id="5aa22-124">When done properly, this ensures your application deployments are flexible.</span></span>

<span data-ttu-id="5aa22-125">N 层体系结构中的应用程序通常会在虚拟机上进行部署。</span><span class="sxs-lookup"><span data-stu-id="5aa22-125">Applications in an N-tier architecture often get deployed on virtual machines.</span></span> <span data-ttu-id="5aa22-126">这是一个很棒的第一步, 但如果要将应用程序发展为使用 PaaS 服务, 在安全性、可伸缩性和管理方面提供了诸多好处。</span><span class="sxs-lookup"><span data-stu-id="5aa22-126">This is a good first step, but evolving your application to use PaaS services provides numerous benefits in security, scalability, and administration.</span></span> <span data-ttu-id="5aa22-127">通常情况下, 这种演变是被忽略的, 而 N 层体系结构仍保留在虚拟机上。</span><span class="sxs-lookup"><span data-stu-id="5aa22-127">Often times this evolution is overlooked, and N-tier architectures remain resident on virtual machines.</span></span>

<span data-ttu-id="5aa22-128">这是一种经典体系结构样式, 但在许多情况下, 它已被其他新式设计模式 (如 microservices 体系结构) 取代。</span><span class="sxs-lookup"><span data-stu-id="5aa22-128">This is a classic architectural style, but in many scenarios it has been superseded by other modern design patterns, such as a microservices architecture.</span></span> <span data-ttu-id="5aa22-129">通常值得花些时间来评估其他体系结构, 以查看它们是否更适合您的应用程序。</span><span class="sxs-lookup"><span data-stu-id="5aa22-129">It's often worth investing some time to evaluate other architectures to see if they are a better fit for your application.</span></span>

## <a name="best-practices-for-n-tier-architectures"></a><span data-ttu-id="5aa22-130">适用于 N 层体系结构的最佳做法</span><span class="sxs-lookup"><span data-stu-id="5aa22-130">Best practices for N-tier architectures</span></span>

<span data-ttu-id="5aa22-131">您应该执行几项操作, 以确保您的 N 层体系结构运行得最佳。</span><span class="sxs-lookup"><span data-stu-id="5aa22-131">There are several things you should do to ensure your N-tier architecture runs at its best.</span></span> <span data-ttu-id="5aa22-132">下图显示了如何对 N 层体系结构进行改进的可视化方式。</span><span class="sxs-lookup"><span data-stu-id="5aa22-132">The following diagram shows visually how you can make improvements to an N-tier architecture.</span></span>

![N 层体系结构的可视化](../media/4-n-tier-logical.svg)

### <a name="optimize-performance"></a><span data-ttu-id="5aa22-134">优化性能</span><span class="sxs-lookup"><span data-stu-id="5aa22-134">Optimize performance</span></span>

<span data-ttu-id="5aa22-135">让我们来看一下优化 N 层体系结构以提高性能和安全性的方法。</span><span class="sxs-lookup"><span data-stu-id="5aa22-135">Let's look at ways to optimize an N-tier architecture for both performance and security.</span></span>

#### <a name="autoscaling"></a><span data-ttu-id="5aa22-136">缩放</span><span class="sxs-lookup"><span data-stu-id="5aa22-136">Autoscaling</span></span>

<span data-ttu-id="5aa22-137">通过将应用程序分成多级, 我们可以使用云功能 (如自动缩放) 适应系统负载。</span><span class="sxs-lookup"><span data-stu-id="5aa22-137">With the application separated into tiers, we can use cloud features such as autoscaling to adapt to system load.</span></span> <span data-ttu-id="5aa22-138">随着用户或请求的增加, 可在多个层使用自动缩放以添加更多资源来处理请求。</span><span class="sxs-lookup"><span data-stu-id="5aa22-138">As users or requests increase, use autoscaling at multiple tiers to add more resources to handle requests.</span></span> <span data-ttu-id="5aa22-139">当请求丢弃时, 自动缩放会减少计算资源, 同时减少您的帐单。</span><span class="sxs-lookup"><span data-stu-id="5aa22-139">As requests drop, autoscaling reduces the compute resources, also reducing your bill.</span></span> <span data-ttu-id="5aa22-140">自动缩放使您能够轻松地确保您的用户获得最佳体验, 并且您的成本仍保持较低的水平。</span><span class="sxs-lookup"><span data-stu-id="5aa22-140">Autoscaling makes it easy to ensure your users have the best experience and that your costs remain low.</span></span> <span data-ttu-id="5aa22-141">azure VM 规模集可用于基于 VM 的工作负载, 而许多 PaaS 服务 (如 Azure App Service) 都具有内置的自动缩放功能。</span><span class="sxs-lookup"><span data-stu-id="5aa22-141">Azure VM scale sets can be used for VM-based workloads, and many PaaS services such as Azure App Service have built in autoscaling capabilities.</span></span>

#### <a name="load-balancing"></a><span data-ttu-id="5aa22-142">负载平衡</span><span class="sxs-lookup"><span data-stu-id="5aa22-142">Load balancing</span></span>

<span data-ttu-id="5aa22-143">在使用自动缩放扩展应用程序时, 使用负载平衡成为体系结构的必要部分。</span><span class="sxs-lookup"><span data-stu-id="5aa22-143">As you scale out your application with autoscaling, the use of load balancing becomes a necessary piece of your architecture.</span></span> <span data-ttu-id="5aa22-144">通过负载平衡, 在将更多的计算资源添加到层时, 它们将被添加到您的负载平衡器分发中, 以充分利用额外的处理能力。</span><span class="sxs-lookup"><span data-stu-id="5aa22-144">With load balancing, as you add more compute resources to your tier, they are added to your load balancer distribution to take advantage of the additional processing power.</span></span> <span data-ttu-id="5aa22-145">相反, 当系统出现故障时, 会将其从负载中删除, 以通过较差的性能或 erred 请求来最大限度地减少对最终用户的影响。</span><span class="sxs-lookup"><span data-stu-id="5aa22-145">Conversely, when a system fails, it is removed from the load to minimize end-user impact through poor performance or erred requests.</span></span> <span data-ttu-id="5aa22-146">这可确保用户请求进入正常状态的系统。</span><span class="sxs-lookup"><span data-stu-id="5aa22-146">This ensures user requests go to systems in a healthy state.</span></span> <span data-ttu-id="5aa22-147">Azure 负载平衡器是网络功能的内置功能, 应用程序网关提供了功能更丰富的 HTTP 负载平衡解决方案。</span><span class="sxs-lookup"><span data-stu-id="5aa22-147">Azure load balancer is a built-in feature of the networking capabilities, and Application Gateway provides a more feature-rich HTTP load balancing solution.</span></span>

#### <a name="messaging"></a><span data-ttu-id="5aa22-148">讯息</span><span class="sxs-lookup"><span data-stu-id="5aa22-148">Messaging</span></span>

<span data-ttu-id="5aa22-149">在层之间使用消息服务会对性能产生积极影响, 尤其是在自然为异步请求。</span><span class="sxs-lookup"><span data-stu-id="5aa22-149">The use of a messaging service between tiers brings have a positive impact on performance, especially on requests that are asynchronous in nature.</span></span> <span data-ttu-id="5aa22-150">将在队列中放置一条消息, 在该队列中, 它将一直保留, 直到被处理为止, 从而抵消下游负载的影响。</span><span class="sxs-lookup"><span data-stu-id="5aa22-150">A message is be placed on a queue, where it remains until it's processed, offsetting the impact of downstream load.</span></span> <span data-ttu-id="5aa22-151">这还可以确保在发生系统中断时, 仍将处理您的邮件。</span><span class="sxs-lookup"><span data-stu-id="5aa22-151">This also ensures that if there is a system outage, that your message will still be handled.</span></span> <span data-ttu-id="5aa22-152">它将保留在队列中, 并将在系统重新联机后处理。</span><span class="sxs-lookup"><span data-stu-id="5aa22-152">It would remain in the queue and would be processed once the system is back online.</span></span> <span data-ttu-id="5aa22-153">Azure 有多个邮件解决方案可供选择, 具体取决于您的要求。</span><span class="sxs-lookup"><span data-stu-id="5aa22-153">Azure has several messaging solutions to choose from, depending on your requirements.</span></span> <span data-ttu-id="5aa22-154">在查找邮件服务时, 可以查看 azure 服务总线、azure 存储队列和 azure 事件中心。</span><span class="sxs-lookup"><span data-stu-id="5aa22-154">Azure Service Bus, Azure Storage queues, and Azure Event Hubs are a few to look at when looking for a messaging service.</span></span>

#### <a name="caching-data"></a><span data-ttu-id="5aa22-155">缓存数据</span><span class="sxs-lookup"><span data-stu-id="5aa22-155">Caching data</span></span>

<span data-ttu-id="5aa22-156">对频繁访问且具有较低更改速率的数据使用缓存, 或者对不需要长期持久性的数据 (如会话状态) 使用缓存。</span><span class="sxs-lookup"><span data-stu-id="5aa22-156">Use a cache for data that is frequently accessed and has a low change rate, or for data that doesn't require long-term persistence, such as session state.</span></span> <span data-ttu-id="5aa22-157">缓存系统在各层之间等待, 并减少这些数据类型的数据检索时间。</span><span class="sxs-lookup"><span data-stu-id="5aa22-157">Caching systems sit between tiers, and reduce data retrieval times for these types of data.</span></span> <span data-ttu-id="5aa22-158">适用于 Redis 的 Azure 缓存是一种非常适合此方案的 PaaS 服务。</span><span class="sxs-lookup"><span data-stu-id="5aa22-158">Azure Cache for Redis is a PaaS service that is well suited for this scenario.</span></span>

### <a name="optimize-security"></a><span data-ttu-id="5aa22-159">优化安全性</span><span class="sxs-lookup"><span data-stu-id="5aa22-159">Optimize security</span></span>

<span data-ttu-id="5aa22-160">在针对安全性进行优化时, 这通常是一个永远不会 "完成" 的作业。</span><span class="sxs-lookup"><span data-stu-id="5aa22-160">When optimizing for security, this is often a job that is never "done".</span></span> <span data-ttu-id="5aa22-161">尽管应用程序分到了各个层中, 但仍必须在体系结构中具有良好计划的安全做法。</span><span class="sxs-lookup"><span data-stu-id="5aa22-161">Even though the application is separated into tiers, there still must be well planned security practices woven into the architecture.</span></span> <span data-ttu-id="5aa22-162">添加的层越多, 您需要保护的信息越多, 系统中引入的复杂性也越多。</span><span class="sxs-lookup"><span data-stu-id="5aa22-162">The more tiers added, the more you need to secure, and the more complexity that is introduced into the system.</span></span> <span data-ttu-id="5aa22-163">您应该执行几项操作, 以确保体系结构提供了运行应用程序的安全环境。</span><span class="sxs-lookup"><span data-stu-id="5aa22-163">There are several things you should do to ensure your architecture provides a secure environment to run your application.</span></span>

#### <a name="network-isolation"></a><span data-ttu-id="5aa22-164">网络隔离</span><span class="sxs-lookup"><span data-stu-id="5aa22-164">Network isolation</span></span>

<span data-ttu-id="5aa22-165">确保在虚拟机上运行 N 层体系结构时, 每个层都位于自己的子网中。</span><span class="sxs-lookup"><span data-stu-id="5aa22-165">Ensure that when running an N-tier architecture on VMs that each tier is in its own subnet.</span></span> <span data-ttu-id="5aa22-166">此子网充当安全边界, 使您可以通过网络访问控制列表隔离连接, 但通过确保子网中的新系统接收相同的规则来实现简化管理。</span><span class="sxs-lookup"><span data-stu-id="5aa22-166">This subnet acts as a security boundary, allowing you to isolate connectivity through network access control lists but easing management by ensuring new systems in the subnet receive the same rules.</span></span> <span data-ttu-id="5aa22-167">在 Azure 上, 这是通过网络安全组 (NSG) 本身完成的。</span><span class="sxs-lookup"><span data-stu-id="5aa22-167">On Azure, this is done natively with network security groups (NSG).</span></span> <span data-ttu-id="5aa22-168">应针对 PaaS 服务进行类似的考虑, 但网络集成功能在服务之间有所不同, 应自行评估。</span><span class="sxs-lookup"><span data-stu-id="5aa22-168">Similar considerations should be made for PaaS services, but network integration capabilities vary between services and should be evaluated on their own.</span></span> <span data-ttu-id="5aa22-169">最佳做法是确保每个层只能与它下面的下一层进行通信。</span><span class="sxs-lookup"><span data-stu-id="5aa22-169">It's a best practice to ensure that each tier may only communicate to the next tier below it.</span></span> <span data-ttu-id="5aa22-170">演示层应仅能够与应用层对话, 并且应用层应只能与数据层对话。</span><span class="sxs-lookup"><span data-stu-id="5aa22-170">The presentation tier should only be able to talk to the application tier, and the application tier should only be able to talk to the data tier.</span></span> <span data-ttu-id="5aa22-171">最小化此连接可提供分层的网络安全方法, 并提高体系结构的总体安全状态。</span><span class="sxs-lookup"><span data-stu-id="5aa22-171">Minimizing this connectivity provides a layered approach to network security, and improves the overall security posture of an architecture.</span></span>

#### <a name="web-application-firewall"></a><span data-ttu-id="5aa22-172">Web 应用程序防火墙</span><span class="sxs-lookup"><span data-stu-id="5aa22-172">Web application firewall</span></span>

<span data-ttu-id="5aa22-173">在就地子网之间进行安全隔离时, 您需要确保公开公开的前端是安全的, 并且只允许访问所需的内容。</span><span class="sxs-lookup"><span data-stu-id="5aa22-173">With the security isolation between subnets in place, you want to ensure that your publicly exposed front-end is secure, and only allows access to what is needed.</span></span> <span data-ttu-id="5aa22-174">只有你的演示文稿层应公开到入站 internet 流量, 且你的演示层前面的 web 应用程序防火墙 (WAF) 技术将增强此层的安全性。</span><span class="sxs-lookup"><span data-stu-id="5aa22-174">Only your presentation tier should be exposed to inbound internet traffic, and a web application firewall (WAF) technology in front of your presentation tier will enhance the security at this tier.</span></span> <span data-ttu-id="5aa22-175">WAFs 检查流量以查找恶意活动, 确保对通信进行加密, 并在某些内容不正常时向您发出警报。</span><span class="sxs-lookup"><span data-stu-id="5aa22-175">WAFs inspect traffic for malicious activity, ensure communications are encrypted, and alert you if something is out of the ordinary.</span></span> <span data-ttu-id="5aa22-176">在 Azure 上, 应用程序网关是一个包含可启用的内置 WAF 的 HTTP 负载平衡器。</span><span class="sxs-lookup"><span data-stu-id="5aa22-176">On Azure, Application Gateway is an HTTP load balancer that has a built-in WAF that you can enable.</span></span>