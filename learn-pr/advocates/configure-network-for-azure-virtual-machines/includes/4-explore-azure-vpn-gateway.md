若要将您的本地环境与 Azure 集成, 您需要能够创建加密连接。 您可以通过 Internet 或通过专用链接进行连接。 在这里, 我们将查看 Azure VPN 网关, 该网关提供来自本地环境的传入连接的终结点。

你已设置 azure 虚拟网络, 并需要确保从 azure 到你的网站以及在 azure 虚拟网络之间的任何数据传输均已加密。 此外, 还需要了解如何在区域和订阅之间连接虚拟网络。

## <a name="what-is-a-vpn-gateway"></a>什么是 VPN 网关？

azure VPN 网关提供了一个终结点, 用于从内部部署位置到 Azure 通过 Internet 传入加密连接。 它还可以在 Microsoft 专用网络上的 azure 虚拟网络之间发送加密的流量, 该网络在不同区域中链接 azure 数据中心。 此配置使您可以安全地链接不同区域中的虚拟机和服务。

每个虚拟网络只能有一个 VPN 网关。 与该 VPN 网关的所有连接都共享可用的网络带宽。

在每个虚拟网络网关中有两个或多个虚拟机 (vm)。 这些虚拟机已部署到您指定的特殊子网, 称为_网关子网_。 它们包含与其他网络的连接的路由表, 以及特定的网关服务。 这些虚拟机和网关子网类似于强化的网络设备。 您无需直接配置这些虚拟机, 也不应将任何其他资源部署到网关子网中。

创建虚拟网络网关可能需要一些时间才能完成, 因此您必须进行适当的规划, 这一点非常重要。 创建虚拟网络网关时, 设置过程将生成网关虚拟机并将其部署到网关子网。 这些虚拟机将具有您在网关上配置的设置。

"密钥" 设置是**_网关类型_**, vpn 网关的类型为 "vpn"。 VPN 网关的选项包括:

- 通过 IPsec/IKE VPN 隧道的网络到网络连接, 将 VPN 网关链接到其他 vpn 网关。

- 跨界 IPsec/IKE VPN 隧道, 用于通过专用的 VPN 设备将本地网络连接到 Azure, 以创建站点到站点连接。

- 通过 IKEv2 或 SSTP 的点到站点连接, 可将客户端计算机链接到 Azure 中的资源。

现在, 让我们来看看您在规划 VPN 网关时需要考虑的因素。

## <a name="plan-a-vpn-gateway"></a>规划 VPN 网关

在规划 VPN 网关时, 需要考虑以下三个体系结构:

- 通过 Internet 指向网站
- 通过 Internet 的网站
- 通过专用网络的站点到站点, 如 Azure ExpressRoute

### <a name="planning-factors"></a>规划因素

在规划过程中需要满足的因素包括:

- 吞吐量-Mbps 或 Gbps
- 主干-Internet 或专用？
- 公用 (静态) IP 地址的可用性
- VPN 设备兼容性
- 多个客户端连接或站点到站点链接？
- VPN 网关类型
- Azure VPN 网关 SKU

下表汇总了其中一些规划问题。 后面将对其余部分进行讨论。

|                           |  指向 "网站"            | 站点到站点                          |  ExpressRoute                 |
| -------------             | -------------             | -------------                         | ---------                     |
| Azure 支持的服务  | 云服务和虚拟机    | 云服务和虚拟机                | 所有受支持的服务        |
| 典型带宽         | 取决于 VPN 网关 SKU    | 最高配置 1 Gbps 和聚合         | 从 50 Mbps 到 10 Gbps       |
| 支持的协议       | SSTP 和 IPsec            | IPsec                                 | 直接连接、vlan      |
| 路径                   | RouteBased (动态)      | PolicyBased (静态) 和 RouteBased   | BGP                           |
| 连接弹性     | 主动-被动            | 主动-被动或主动-主动       | 主动-主动                 |
| 用例                  | 测试和原型设计   | 开发、测试和小型生产  | 企业/任务关键型   |

### <a name="gateway-skus"></a>网关 sku

Azure 为网关服务提供以下 sku:

| SKU              |  S2S/网络到网络隧道 | P2S 连接  |  聚合吞吐量基准   | 用于                         |
| -------------    | -------------             | -------------    | ---------                         | ---------                       |
| vba            | 最多10                    | 最大128          | 100 Mbps                          | 开发/测试/POC                    |
| VpnGw1           | 最多30                    | 最大128          | 650 Mbps                          | 生产/关键工作负载   |
| VpnGw2           | 最多30                    | 最大128          | 1 Gbps                            | 生产/关键工作负载   |
| VpnGw3           | 最多30                    | 最大128          | 1.25 Gbps                          | 生产/关键工作负载   |

> [!Note]
> 请务必选择正确的 SKU。 如果您设置了不正确的 VPN 网关, 则必须将其关闭并重新生成网关, 这可能需要很长时间。

## <a name="workflow"></a>工作流

在使用 Azure 上的虚拟专用网络设计云连接策略时, 应应用以下工作流:

1. 设计连接拓扑, 并列出所有连接网络的地址空间。

1. 创建 Azure 虚拟网络。

1. 为虚拟网络创建 VPN 网关。

1. 根据需要, 创建并配置到本地网络或其他虚拟网络的连接。

1. 如果需要, 为 Azure VPN 网关创建和配置点到站点连接。

### <a name="design-considerations"></a>设计注意事项

在设计 VPN 网关以连接虚拟网络时, 必须考虑以下因素:

- 子网不能重叠

    一个位置中的子网不包含与另一个位置相同的地址空间, 这一点非常重要。

- IP 地址必须是唯一的

    在不同位置不能有两个具有相同 IP 地址的主机, 因为这两个主机之间的通信无法路由, 网络到网络连接将会失败。

- VPN 网关需要一个名为**GatewaySubnet**的网关子网

    它必须具有此名称, 网关才能正常工作, 并且它不应包含任何其他资源。

### <a name="create-an-azure-virtual-network"></a>创建 Azure 虚拟网络

在创建 VPN 网关之前, 需要创建 Azure 虚拟网络。

### <a name="create-a-vpn-gateway"></a>创建 VPN 网关

您创建的 VPN 网关的类型将取决于您的体系结构。 选项包括:

- RouteBased

    基于路由的 VPN 设备使用任意对任意 (通配符) 流量选择器, 并允许路由/转发表将通信定向到不同的 IPsec 隧道。 基于路由的连接通常建立在路由器平台上, 其中每个 IPsec 隧道都作为网络接口或 VTI (虚拟隧道接口) 进行建模。

- PolicyBased

    基于策略的 VPN 设备使用这两个网络中的前缀的组合来定义如何通过 IPsec 隧道对流量进行加密/解密。 基于策略的连接通常建立在执行数据包筛选的防火墙设备上。 IPsec 隧道加密和解密将添加到数据包筛选和处理引擎中。

## <a name="set-up-a-vpn-gateway"></a>设置 VPN 网关

您需要执行的步骤取决于要安装的 VPN 网关的类型。 例如, 若要使用 Azure 门户创建点到站点 VPN 网关, 请执行以下步骤:

1. 创建虚拟网络

2. 添加网关子网

3. 指定 DNS 服务器 (可选)

4. 创建虚拟网络网关

5. 生成证书

6. 添加客户端地址池

7. 配置隧道类型

8. 配置身份验证类型

9. 上传根证书公共证书数据

10. 安装导出的客户端证书

11. 生成并安装 VPN 客户端配置包

12. 连接到 Azure

由于存在多个具有多个选项的 Azure VPN 网关的配置路径, 因此不可能在此课程中涵盖每个设置。 有关详细信息, 请参阅 "其他资源" 部分。

## <a name="configure-the-gateway"></a>配置网关

创建网关后, 你需要对其进行配置。  需要提供几个配置设置, 如名称、位置、DNS 服务器等。在练习中, 我们将更详细地介绍这些内容。

azure VPN 网关是 azure 虚拟网络中的一个组件, 可启用点到站点、站点到站点或网络到网络的连接。 azure VPN 网关使单个客户端计算机能够连接到 azure 中的资源, 将本地网络扩展到 azure, 或者促进不同区域和订阅中的虚拟网络之间的连接。
