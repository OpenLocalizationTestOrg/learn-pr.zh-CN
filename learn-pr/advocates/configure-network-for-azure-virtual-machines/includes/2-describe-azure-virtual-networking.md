你有一个你计划保留的本地数据中心, 但你想要使用 azure 来使用 azure 中托管的虚拟机 (vm) 分担峰值流量。 您想要保留现有的 IP 寻址方案和网络设备, 同时确保任何数据传输是安全的。

## <a name="what-is-azure-virtual-networking"></a>什么是 Azure 虚拟网络？

**azure 虚拟网络**允许 azure 资源 (例如虚拟机、web 应用和数据库) 与 Internet 上的用户、Internet 上的用户以及本地客户端计算机进行通信。 你可以将 Azure 网络视为一组链接到其他 Azure 资源的资源。

Azure 虚拟网络提供了关键网络功能:

- 隔离和分段
- Internet 通信
- 在 Azure 资源之间进行通信
- 与本地资源进行通信
- 路由网络流量
- 筛选网络流量
- 连接虚拟网络
 
#### <a name="network-configurations-for-virtual-machines"></a>虚拟机的网络配置

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yEve]

### <a name="isolation-and-segmentation"></a>隔离和分段

Azure 允许您创建多个独立的虚拟网络。 设置虚拟网络时, 可以使用公用或专用 IP 地址范围定义专用 Internet 协议 (IP) 地址空间。 然后, 可以将该 IP 地址空间划分为子网, 并将部分定义的地址空间分配给每个已命名的子网。

对于名称解析, 可以使用 Azure 中内置的名称解析服务, 也可以将虚拟网络配置为使用内部或外部域名系统 (DNS) 服务器。

### <a name="internet-communications"></a>Internet 通信

默认情况下, Azure 中的 VM 可连接到 Internet。 您可以通过定义公共 IP 地址或公用负载平衡器来启用来自 Internet 的传入连接。 对于虚拟机管理, 可以通过 Azure CLI、远程桌面协议 (RDP) 或安全命令行管理程序 (SSH) 进行连接。

### <a name="communicate-between-azure-resources"></a>在 Azure 资源之间进行通信

你将需要使 Azure 资源能够彼此安全地相互通信。 可以通过以下两种方式之一执行此操作:

- **虚拟网络**

    虚拟网络不仅可以连接虚拟机, 还可以连接其他 Azure 资源, 如 App Service 环境、azure Kubernetes Service 和 azure 虚拟机规模集。

- **服务终结点**

     您可以使用服务终结点连接到其他 azure 资源类型, 如 azure SQL 数据库和存储帐户。 利用此方法, 您可以将多个 Azure 资源链接到虚拟网络, 从而提高安全性并提供资源之间的最佳路由。

### <a name="communicate-with-on-premises-resources"></a>与本地资源进行通信

使用 azure 虚拟网络, 您可以将内部部署环境和 Azure 订阅中的资源链接在一起, 这实际上是创建一个同时跨越本地和云环境的网络。 您可以通过三种机制实现此连接:

- **点到站点虚拟专用网络**

   此方法类似于虚拟专用网络 (VPN) 连接, 组织外部的计算机会将其返回到公司网络, 但它的工作方向相反。 在这种情况下, 客户端计算机会启动到 azure 的加密 VPN 连接, 并将该计算机连接到 azure 虚拟网络。

- **站点到站点虚拟专用网络**站点到站点 vpn 将本地 VPN 设备或网关链接到虚拟网络中的 Azure VPN 网关。 实际上, Azure 中的设备可能显示为位于本地网络上。 该连接通过 Internet 进行加密和工作。

- **Azure ExpressRoute**

    对于需要更大带宽甚至更高的安全性的环境, Azure ExpressRoute 是最佳方法。 azure ExpressRoute 提供到 azure 的专用专用连接, 不通过 Internet 传输。

### <a name="route-network-traffic"></a>路由网络流量

默认情况下, Azure 将路由任何连接的虚拟网络、本地网络和 Internet 上的子网之间的流量。 但是, 您可以控制路由和重写这些设置, 如下所示:

- **路由表**

    路由表允许您定义应如何定向流量的规则。 您可以创建自定义路由表, 这些表控制如何在子网之间路由数据包。

- **边界网关协议**

    边界网关协议 (BGP) 可与 azure VPN 网关或 ExpressRoute 配合使用, 以将本地 BGP 路由传播到 azure 虚拟网络。

### <a name="filter-network-traffic"></a>筛选网络流量

使用 Azure 虚拟网络, 可以通过以下方法来筛选子网之间的流量:

- **网络安全组**

    网络安全组是可以包含多个入站和出站安全规则的 Azure 资源。 您可以根据诸如源和目标 IP 地址、端口和协议等因素, 定义这些规则以允许或阻止流量。

- **网络虚拟设备**

    网络虚拟设备是一种专用的 VM, 可与强化的网络设备进行比较。 网络虚拟设备将执行特定的网络功能, 如运行防火墙或执行 WAN 优化。

## <a name="connect-virtual-networks"></a>连接虚拟网络

您可以使用虚拟网络对_等_链接将虚拟网络链接在一起。 对等功能使每个虚拟网络中的资源能够相互通信。 这些虚拟网络可以位于不同的区域, 从而使您可以通过 Azure 创建全局互联网络。

## <a name="azure-virtual-network-settings"></a>Azure 虚拟网络设置

您可以从 azure 门户、本地计算机上的 azure PowerShell 或 azure 云命令行管理程序中创建和配置 azure 虚拟网络。

### <a name="create-a-virtual-network"></a>创建虚拟网络

创建 Azure 虚拟网络时, 可以配置许多基本设置。 你可以选择配置高级设置, 如多个子网、分布式拒绝服务 (DDoS) 保护和服务终结点。

![显示创建虚拟网络刀片字段的示例的 Azure 门户屏幕截图。](../media/2-create-virtual-network.PNG)

你将为基本虚拟网络配置以下设置:

- **网络名称**

    网络名称在订阅中必须是唯一的, 但不需要全局唯一。 使名称成为易于记忆的描述性的名称, 并可从其他虚拟网络进行识别。

- **地址空间**

    设置虚拟网络时, 需要在无类别的域间路由 (CIDR) 格式中定义内部地址空间。 此地址空间在你的订阅和你连接到的任何其他网络中都必须是唯一的。

    假设您为第一个虚拟网络选择了 10.0.0.0/24 的地址空间。 此地址空间中定义的地址的范围为 10.0.0.1-10.0.0.254。 然后, 创建第二个虚拟网络并选择10.1.0.0 的地址空间。 此地址空间中的地址范围为 10.0.0.1-10.255.255.254。 某些地址重叠, 不能用于两个虚拟网络。

    但是, 可以使用 10.0.0.0/16, 地址范围为 10.0.0.1-10.0.255.254 和 10.1.0.0/16, 地址范围从 10.1.0.1-10.1.255.254。 你可以将这些地址空间分配给虚拟网络, 因为没有地址重叠。

    > [!NOTE]
    > 可以在创建虚拟网络后添加地址空间。

- **订购**

    仅当您有多个订阅可供选择时才适用。

- **资源组**

    与任何其他 Azure 资源一样, 虚拟网络需要存在于资源组中。 您可以选择现有的资源组, 也可以创建一个新的资源组。

- **Location**

    选择您希望虚拟网络存在的位置。

- **子网**

    在每个虚拟网络地址范围内, 您可以创建一个或多个对虚拟网络的地址空间进行分区的子网。 然后, 在子网之间路由将取决于默认流量路由, 也可以定义自定义路由。 或者, 您可以定义一个包含所有虚拟网络地址范围的子网。

    > [!NOTE]
    > 子网名称必须以字母或数字开头, 以字母、数字或下划线结尾, 并且只能包含字母、数字、下划线、句点或连字符。

- **分布式拒绝服务 (DDoS) 保护**

    您可以选择 "基本" 或 "标准" DDoS 保护。 标准 DDoS 保护是一项高级服务。 [Azure DDoS 保护标准](https://docs.microsoft.com/azure/virtual-network/ddos-protection-overview)提供了有关标准 DDoS 保护的详细信息。

- **服务终结点**

    在此处, 启用服务终结点, 然后从列表中选择您要启用的 Azure 服务终结点。 选项包括 azure Cosmos DB、azure 服务总线、azure Key Vault 等。

配置这些设置后, 单击 "**创建**" 按钮。

### <a name="define-additional-settings"></a>定义其他设置

创建虚拟网络后, 可以进一步定义设置。 这些内容包括:

- **网络安全组**

    网络安全组具有安全规则, 使您能够筛选出可以流入和传出虚拟网络子网和网络接口的网络通信的类型。 您可以单独创建网络安全组, 然后将其与虚拟网络相关联。

- **路由表**

    azure 自动为 Azure 虚拟网络中的每个子网创建路由表, 并将系统默认路由添加到表中。 但是, 可以添加自定义路由表以修改虚拟网络之间的流量。

您还可以修正服务终结点。

![显示用于编辑虚拟网络设置的示例边栏的 Azure 门户的屏幕截图。](../media/2-virtual-network-additional-settings.PNG)

### <a name="configure-virtual-networks"></a>配置虚拟网络

创建虚拟网络后, 可以在 Azure 门户中更改虚拟网络刀片中的任何其他设置。 或者, 也可以使用云命令行管理程序中的 PowerShell 命令或命令进行更改。

![显示用于配置虚拟网络的示例边栏的 Azure 门户的屏幕截图。](../media/2-configure-virtual-network.PNG)

然后, 您可以查看和更改其他子刀片中的设置。
这些设置包括:

- 地址空间: 可以向初始定义中添加更多地址空间

- 连接的设备: 使用虚拟网络连接计算机

- 子网: 添加更多子网

- Peerings: 在对等排列中链接虚拟网络

您还可以监视虚拟网络并对其进行故障排除, 或者创建一个自动化脚本来生成当前的虚拟网络。

虚拟网络是用于连接 Azure 中的实体的功能强大且高度可配置的机制。 你可以将 Azure 资源连接到另一台, 也可以将 Azure 资源连接到内部部署的资源。 你可以隔离、筛选和路由你的网络流量, Azure 允许你在你认为需要它的情况下提高安全性。
